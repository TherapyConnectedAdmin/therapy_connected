{% extends "base.html" %}
{% load static %}
{% block content %}
<script src="{% static 'home.js' %}"></script>
<script>
  document.addEventListener('alpine:init', () => {
  Alpine.store('profileModal', {
      currentUserId: {% if request.user.is_authenticated %}{{ request.user.id }}{% else %}null{% endif %},
      show: false,
      therapist: {},
      loading: false,
      error: null,
      contentVisible: false,
      open(id) {
        console.log('[profileModal] open called with id', id, 'at', Date.now());
        // If already showing this therapist, just ensure focus & exit
        if (this.show && this.therapist && this.therapist.id === id) {
          return;
        }
        this.error = null;
        this.loading = true;
        this.contentVisible = false;
        this.therapist = { id }; // optimistic id placeholder
        // Show immediately so backdrop appears without perceived flash
        if (!this.show) {
          this.show = true;
          document.documentElement.classList.add('overflow-hidden');
          document.body.classList.add('overflow-hidden');
        }
        fetch(`/users/api/therapists/${id}/profile_full/`)
          .then(r => { if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
          .then(d => { this.therapist = d; })
          .catch(e => { console.error(e); this.error = e.message; })
          .finally(() => { this.loading = false; this.contentVisible = true; });
      },
      close(){
    console.log('[profileModal] close called at', Date.now());
        this.show=false;
        this.contentVisible = false;
        // Unlock background scroll (delay to allow transition end if needed)
        requestAnimationFrame(()=>{
          document.documentElement.classList.remove('overflow-hidden');
          document.body.classList.remove('overflow-hidden');
        });
      }
    });
  });
</script>
<div class="flex-1 flex flex-col" style="background-color: #FAF9F9;">
  {% include "partials/hero_section.html" %}
  {% include "partials/carousel_section.html" %}
  {% include "partials/top_therapists_section.html" with therapists=therapists %}
</div>
{# Modal markup placed at end so page hero/content are not nested within (avoids hidden-on-load issue) #}
{% include "partials/profile_modal.html" %}
{% endblock %}
