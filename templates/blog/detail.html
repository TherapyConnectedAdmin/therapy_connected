{% extends "base.html" %}
{% block content %}
<section class="py-10 w-full" style="{% if in_members %}background-color:#F6FBFA;{% else %}background-color:#FFF6ED;{% endif %}">
  <div class="max-w-7xl mx-auto px-4 lg:px-8">
    <div class="mb-6 flex items-center justify-between gap-4">
  <a href="{% if in_members %}{% url 'members_blog' %}{% else %}{% url 'blog_index' %}{% endif %}" class="text-sm font-semibold px-4 py-2 rounded-full bg-white border border-[#BEE3DB] text-[#116466] hover:bg-[#FAF9F9] transition" style="box-shadow:0 2px 4px rgba(0,0,0,0.04);">&larr; Back to Blog</a>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-10 items-start">
      <!-- Main Content -->
      <article class="lg:col-span-9 xl:col-span-9 rounded-2xl shadow-lg p-8 sm:p-12 bg-[#FAF9F9]" style="box-shadow:0 4px 18px -4px #555B6E22;">
        <header class="mb-8">
          <h1 class="text-4xl font-bold mb-4 leading-tight" style="color:#555B6E;">{{ post.title }}</h1>
          {% load therapist_extras %}
          {% with profile=post.author.therapistprofile %}
          <div class="flex items-center gap-4">
            {% if profile.profile_photo %}
              {% profile_photo_srcset profile 'webp' as ss_webp %}
              {% profile_photo_srcset profile 'jpg' as ss_jpg %}
              {% if ss_webp or ss_jpg %}
                <picture>
                  <source type="image/webp" srcset="{{ ss_webp }}" sizes="56px">
                  <img src="{% profile_photo_variant profile 'thumb' 'jpg' %}" srcset="{{ ss_jpg }}" sizes="56px" alt="{{ profile.first_name }} {{ profile.last_name }}" class="w-14 h-14 rounded-full object-cover border-2 border-[#BEE3DB] shadow" loading="lazy" decoding="async" />
                </picture>
              {% else %}
                <img src="{{ profile.profile_photo.url }}" alt="{{ profile.first_name }} {{ profile.last_name }}" class="w-14 h-14 rounded-full object-cover border-2 border-[#BEE3DB] shadow" loading="lazy" decoding="async" />
              {% endif %}
            {% else %}
              <div class="flex-shrink-0 w-14 h-14 rounded-full bg-[#BEE3DB] flex items-center justify-center text-2xl font-bold" style="color:#555B6E;">
                {{ profile.first_name|slice:":1" }}{{ profile.last_name|slice:":1" }}
              </div>
            {% endif %}
            <div class="leading-tight">
              <div class="font-semibold text-xl" style="color:#555B6E;">{{ profile.first_name }} {{ profile.last_name }}</div>
              {% with lic=profile.license_type %}
              <div class="text-sm text-[#89B0AE] font-medium">
                {% if lic %}{% if lic.short_description %}{{ lic.short_description }}{% else %}{{ lic.name }}{% endif %}{% elif profile.credentials_note %}{{ profile.credentials_note|truncatechars:80 }}{% elif profile.mental_health_role %}{{ profile.mental_health_role }}{% else %}&nbsp;{% endif %}
              </div>
              {% endwith %}
              <div class="text-xs text-[#555B6E] mt-1">Published {{ post.created_at|date:"M d, Y" }}</div>
            </div>
          </div>
          {% endwith %}
        </header>
  {% if post.image %}
          {% image_srcset post 'webp' as post_ss_webp %}
          {% image_srcset post 'jpg' as post_ss_jpg %}
          <figure class="mb-8">
            {% if post_ss_webp or post_ss_jpg %}
            <picture>
              <source type="image/webp" srcset="{{ post_ss_webp }}" sizes="(max-width: 1024px) 100vw, 900px">
              <img src="{% image_variant post 'medium' 'jpg' %}" srcset="{{ post_ss_jpg }}" sizes="(max-width: 1024px) 100vw, 900px" alt="{{ post.title }}" class="w-full h-80 object-cover rounded-xl shadow" loading="lazy" decoding="async" />
            </picture>
            {% else %}
            <img src="{{ post.image.url }}" alt="{{ post.title }}" class="w-full h-80 object-cover rounded-xl shadow" loading="lazy" decoding="async" />
            {% endif %}
          </figure>
        {% endif %}
        {% if post.media.all %}
          {% with media_list=post.media.all %}
            {% if media_list %}
            <div class="mb-8">
              {% if media_list|length == 1 %}
                {% for m in media_list %}
                  {% if m.type == 'image' %}
                    <img src="{{ m.file.url }}" alt="" class="w-full max-h-[640px] object-cover rounded-xl shadow" />
                  {% else %}
                    <video class="w-full rounded-xl shadow" controls src="{{ m.file.url }}"></video>
                  {% endif %}
                {% endfor %}
              {% else %}
                <div class="grid grid-cols-2 gap-2">
                  {% for m in media_list %}
                    {% if m.type == 'image' %}
                      <img src="{{ m.file.url }}" alt="" class="w-full h-60 object-cover rounded" />
                    {% else %}
                      <video class="w-full" controls src="{{ m.file.url }}"></video>
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
            </div>
            {% endif %}
          {% endwith %}
        {% endif %}
  <!-- Content -->
  {% load blog_extras %}
  <div id="article-body" class="prose prose-lg max-w-none mb-10" style="color:#555B6E;">{% render_blog_content post %}</div>
        <!-- Tags -->
        <div class="flex flex-wrap gap-2 mb-10">
          {% for tag in post.tags.all %}
            {% if in_members %}
              <a href="{% url 'members_blog' %}?q={{ tag.name|urlencode }}" class="bg-[#BEE3DB] text-[#555B6E] px-3 py-1 rounded-full text-xs font-semibold hover:bg-[#A5D6CE] transition">{{ tag.name }}</a>
            {% else %}
              <a href="{% url 'blog_index' %}?tag={{ tag.id }}" class="bg-[#BEE3DB] text-[#555B6E] px-3 py-1 rounded-full text-xs font-semibold hover:bg-[#A5D6CE] transition">{{ tag.name }}</a>
            {% endif %}
          {% empty %}
            <span class="text-xs text-[#555B6E]/60">No tags</span>
          {% endfor %}
        </div>
        <!-- Author Bio Box -->
        {% with profile=post.author.therapistprofile %}
        <div class="rounded-xl border border-[#BEE3DB] bg-white/70 backdrop-blur-sm p-6 flex gap-5 items-start mb-6">
          {% if profile.profile_photo %}
            <img src="{% profile_photo_variant profile 'thumb' 'jpg' %}" alt="{{ profile.first_name }} {{ profile.last_name }}" class="w-20 h-20 rounded-full object-cover border-2 border-[#BEE3DB] shadow" />
          {% else %}
            <div class="w-20 h-20 rounded-full bg-[#BEE3DB] flex items-center justify-center text-2xl font-bold" style="color:#555B6E;">{{ profile.first_name|slice:':1' }}{{ profile.last_name|slice:':1' }}</div>
          {% endif %}
          <div class="flex-1">
            <div class="font-semibold text-lg mb-1" style="color:#555B6E;">About {{ profile.first_name }}</div>
            <p class="text-sm leading-relaxed mb-2 text-[#555B6E]">{{ profile.credentials_note|default:'This therapist has not added a bio yet.'|truncatechars:280 }}</p>
            {% if in_members %}
              <a href="{% url 'members_blog' %}?q={{ profile.first_name|urlencode }}+{{ profile.last_name|urlencode }}" class="text-sm font-semibold text-[#116466] hover:text-[#0d4c4d] underline-offset-2 hover:underline">More posts by {{ profile.first_name }}</a>
            {% else %}
              <a href="{% url 'blog_index' %}?author={{ profile.user.id }}" class="text-sm font-semibold text-[#116466] hover:text-[#0d4c4d] underline-offset-2 hover:underline">More posts by {{ profile.first_name }}</a>
            {% endif %}
          </div>
        </div>
        {% endwith %}
      </article>
      <!-- Sidebar -->
  <aside class="lg:col-span-3 xl:col-span-3 space-y-8 relative">
        <div class="sticky top-6 space-y-8">
          <!-- Search within blog -->
          <form action="{% if in_members %}{% url 'members_blog' %}{% else %}{% url 'blog_index' %}{% endif %}" method="get" class="rounded-2xl bg-[#FAF9F9] shadow p-5 border border-[#BEE3DB] w-full">
            <label for="search" class="sr-only">Search blog</label>
            <div class="flex w-full">
              <input id="search" name="q" type="text" placeholder="Search posts..." class="flex-1 min-w-0 rounded-l-full px-4 py-2.5 text-sm border border-[#89B0AE] focus:outline-none focus:ring-2 focus:ring-[#89B0AE] bg-white" />
              <button class="rounded-r-full px-5 py-2.5 text-sm font-semibold bg-[#89B0AE] text-white hover:bg-[#555B6E] transition whitespace-nowrap" type="submit">Go</button>
            </div>
          </form>
          <!-- Table of Contents (basic: h2 anchors) -->
          <div x-data="{ headings: [] }" x-init="headings=[...document.querySelectorAll('#article-body h2')].map(h=>({id:h.id||(h.id=('h2-'+Math.random().toString(36).slice(2))),text:h.textContent}))" class="rounded-2xl bg-[#FAF9F9] shadow p-5 border border-[#BEE3DB]">
            <h3 class="text-sm font-bold mb-3 tracking-wide text-[#555B6E] uppercase">On this page</h3>
            <template x-if="!headings.length"><p class="text-xs text-[#555B6E]/60">Sections will appear here.</p></template>
            <ul class="space-y-2" x-show="headings.length">
              <template x-for="h in headings" :key="h.id">
                <li>
                  <a :href="'#'+h.id" class="text-sm text-[#116466] hover:text-[#0d4c4d] hover:underline underline-offset-2 block leading-snug" x-text="h.text"></a>
                </li>
              </template>
            </ul>
          </div>
          <!-- Recent Posts -->
          <div class="rounded-2xl bg-[#FAF9F9] shadow p-5 border border-[#BEE3DB]">
            <h3 class="text-sm font-bold mb-3 tracking-wide text-[#555B6E] uppercase">Recent Posts</h3>
            <ul class="divide-y divide-[#E5F4F2]">
              {% for p in recent_posts %}
              <li class="py-2 first:pt-0 last:pb-0">
                <a href="{% if in_members %}{% url 'members_blog_detail' slug=p.slug %}{% else %}{% url 'blog_detail' slug=p.slug %}{% endif %}" class="text-sm text-[#116466] hover:text-[#0d4c4d] font-medium line-clamp-2">{{ p.title }}</a>
                <div class="text-[10px] text-[#555B6E]/60 mt-0.5">{{ p.created_at|date:"M d, Y" }}</div>
              </li>
              {% empty %}
              <li class="py-2 text-xs text-[#555B6E]/60">No other posts yet.</li>
              {% endfor %}
            </ul>
          </div>
          <!-- Related Posts -->
            {% if related_posts %}
          <div class="rounded-2xl bg-[#FAF9F9] shadow p-5 border border-[#BEE3DB]">
            <h3 class="text-sm font-bold mb-3 tracking-wide text-[#555B6E] uppercase">Related</h3>
            <ul class="space-y-3">
              {% for p in related_posts %}
              <li>
                <a href="{% if in_members %}{% url 'members_blog_detail' slug=p.slug %}{% else %}{% url 'blog_detail' slug=p.slug %}{% endif %}" class="block text-sm text-[#116466] hover:text-[#0d4c4d] font-medium">{{ p.title|truncatechars:72 }}</a>
              </li>
              {% endfor %}
            </ul>
          </div>
            {% endif %}
          <!-- Tag Cloud -->
          <div class="rounded-2xl bg-[#FAF9F9] shadow p-5 border border-[#BEE3DB]">
            <h3 class="text-sm font-bold mb-3 tracking-wide text-[#555B6E] uppercase">Tags</h3>
            <div class="flex flex-wrap gap-2">
              {% for t in popular_tags %}
                {% if in_members %}
                  <a href="{% url 'members_blog' %}?q={{ t.name|urlencode }}" class="px-3 py-1 rounded-full bg-[#BEE3DB] text-[#555B6E] text-[11px] font-semibold hover:bg-[#A5D6CE] transition">{{ t.name }}</a>
                {% else %}
                  <a href="{% url 'blog_index' %}?tag={{ t.id }}" class="px-3 py-1 rounded-full bg-[#BEE3DB] text-[#555B6E] text-[11px] font-semibold hover:bg-[#A5D6CE] transition">{{ t.name }}</a>
                {% endif %}
              {% empty %}
                <span class="text-xs text-[#555B6E]/60">No tags yet.</span>
              {% endfor %}
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>
</section>
{% endblock %}
