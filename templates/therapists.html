{% extends "base.html" %}
{% load static %}
{% block content %}
<script>
  document.addEventListener('alpine:init', () => {
    if(!Alpine.store('profileModal')) {
      Alpine.store('profileModal', {
        currentUserId: {% if request.user.is_authenticated %}{{ request.user.id }}{% else %}null{% endif %},
        show:false,
        therapist:{},
        loading:false,
        error:null,
        contentVisible:false,
        ids:[{% for therapist in therapists %}{{ therapist.user.id }}{% if not forloop.last %}, {% endif %}{% endfor %}],
        currentIndex:-1,
        _controller:null,
        get therapistIds(){ return this.ids; },
        open(id, preserve=false){
          if(this.show && this.therapist && this.therapist.id === id && !preserve){ return; }
          if(!this.show){
            this.show=true;
            document.documentElement.classList.add('overflow-hidden');
            document.body.classList.add('overflow-hidden');
          }
            this.error=null; this.loading=true; this.contentVisible=false;
          if(!preserve){ this.therapist={ id }; }
          if(this.ids && this.ids.length){ const idx = this.ids.indexOf(id); if(idx!==-1) this.currentIndex = idx; }
          try { if(this._controller){ this._controller.abort(); } } catch(e){}
          this._controller = new AbortController();
          fetch(`/users/api/therapists/${id}/profile_full/`, { signal:this._controller.signal })
            .then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
            .then(d=>{ this.therapist=d; })
            .catch(e=>{ if(e.name!== 'AbortError'){ this.error=e.message; } })
            .finally(()=>{ if(this._controller && this._controller.signal.aborted){ return; } this.loading=false; this.contentVisible=true; });
        },
        next(){
          if(!this.ids || !this.ids.length) return;
          if(this.currentIndex === -1){ this.currentIndex = 0; return; }
          const isLastOnPage = this.currentIndex === this.ids.length - 1;
          if(isLastOnPage){
            // At end of current page: paginate forward if possible, else stop.
            const hasNextPage = {% if page_obj.has_next %}true{% else %}false{% endif %};
            if(hasNextPage){
              const nextPageUrl = {% if page_obj.has_next %}"?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}{% if request.GET.tier %}tier={{ request.GET.tier|urlencode }}&{% endif %}{% if request.GET.specialty %}specialty={{ request.GET.specialty|urlencode }}&{% endif %}page={{ page_obj.next_page_number }}"{% else %}null{% endif %};
              if(nextPageUrl){ window.location = nextPageUrl + '#openfirst'; }
            }
            return;
          }
          this.open(this.ids[this.currentIndex+1], true);
        },
        prev(){
          if(!this.ids || !this.ids.length) return;
            if(this.currentIndex === -1){ this.currentIndex = 0; return; }
          const isFirstOnPage = this.currentIndex === 0;
          if(isFirstOnPage){
            const hasPrevPage = {% if page_obj.has_previous %}true{% else %}false{% endif %};
            if(hasPrevPage){
              const prevPageUrl = {% if page_obj.has_previous %}"?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}{% if request.GET.tier %}tier={{ request.GET.tier|urlencode }}&{% endif %}{% if request.GET.specialty %}specialty={{ request.GET.specialty|urlencode }}&{% endif %}page={{ page_obj.previous_page_number }}"{% else %}null{% endif %};
              if(prevPageUrl){ window.location = prevPageUrl + '#openlast'; }
            }
            return;
          }
          this.open(this.ids[this.currentIndex-1], true);
        },
        close(){ this.show=false; this.contentVisible=false; requestAnimationFrame(()=>{ document.documentElement.classList.remove('overflow-hidden'); document.body.classList.remove('overflow-hidden'); }); }
      });
    }
  });
</script>
<section class="pt-8 w-full" style="background-color: #BEE3DB;">
  <div class="max-w-3xl mx-auto text-center px-2 sm:px-4" style="padding-bottom:30px;">
    <h2 class="text-3xl font-bold mb-2 text-center" style="color: #555B6E;">Find a Therapist</h2>
    <p class="text-base sm:text-lg mb-8" style="color: #555B6E;">Search and filter to find the right therapist for you.</p>
    <form method="get" class="flex flex-col md:flex-row gap-4 justify-center items-center mb-4 w-full max-w-2xl mx-auto">
      <div class="flex w-full">
        <input type="text" name="q" value="{{ filter_query }}" placeholder="Search therapists, practices, or specialties..." class="homepage-search-input border rounded-l-full px-4 py-3 w-full focus:ring-2 text-sm sm:text-base" style="border-color: #89B0AE; color: #555B6E; background-color: #FAF9F9;" />
        <button type="submit" class="homepage-search-btn font-semibold rounded-r-full px-4 sm:px-6 py-3 text-sm sm:text-base transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-[#89B0AE] cursor-pointer" style="background-color: #89B0AE; color: #FAF9F9; border-left: 0 !important; border-left-color: transparent !important;" onmouseover="this.style.backgroundColor='#555B6E'; this.style.color='#fff';" onmouseout="this.style.backgroundColor='#89B0AE'; this.style.color='#FAF9F9';">Search</button>
      </div>
    </form>
  </div>
  <div class="w-full px-3 sm:px-6 md:px-8 lg:px-10 max-w-screen-xl mx-auto -mt-6">
    <form method="get" x-data="{ open:false }" class="w-full">
      <input type="hidden" name="q" value="{{ filter_query }}" />
      <div class="flex items-center justify-center gap-4 mb-4">
        <button type="button" @click="open=!open" class="group flex items-center gap-2 px-5 py-2.5 bg-white border border-[#BEE3DB] rounded-full shadow-sm text-[#116466] font-semibold focus:outline-none focus:ring-2 focus:ring-[#89B0AE] hover:bg-[#FAF9F9] transition">
          <svg class="w-5 h-5 text-[#116466]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5h18M6 12h12M10 19h4"/></svg>
          <span>Advanced Filters</span>
          <svg :class="{ 'rotate-180': open }" class="w-5 h-5 text-[#555B6E] transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
        </button>
      </div>
      <div x-show="open" x-transition.opacity x-cloak class="mt-5 mb-6 w-full bg-white border border-[#BEE3DB] rounded-2xl shadow-lg p-6">
  <fieldset class="advanced-filters grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-6">
          <div x-data="{open:false,label:'Any',update(){const boxes=[...$refs.boxes.querySelectorAll('input[type=checkbox]')];const chosen=boxes.filter(b=>b.checked).map(b=>b.nextElementSibling.textContent.trim());this.label = chosen.length? (chosen.length===1? chosen[0]: `${chosen.length} selected`):'Any';},init(){this.update();}}" class="relative">
            <label class="filter-label">License Type</label>
            <button type="button" @click="open=!open" :aria-expanded="open" aria-haspopup="listbox" :class="{'has-value':label!=='Any'}" class="w-full filter-select flex items-center justify-between gap-2 pr-3 cursor-pointer !rounded-lg items-center">
              <span class="truncate text-left" x-text="label"></span>
              <svg :class="{'rotate-180':open}" class="w-4 h-4 text-[#116466] transition-transform" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
            </button>
            <div x-show="open" x-transition @click.outside="open=false" class="absolute z-30 mt-1 w-56 max-h-64 overflow-auto rounded-xl border border-[#89B0AE] bg-white shadow-lg p-2 flex flex-col gap-1" x-ref="boxes">
              {% for lt in license_types %}
              <label class="flex items-center gap-2 px-2 py-1 rounded hover:bg-[#F2FAF9] text-xs cursor-pointer">
                <input type="checkbox" name="license" value="{{ lt.id }}" class="rounded text-[#116466] focus:ring-[#116466]" {% if lt.id|stringformat:'s' in filter_license %}checked{% endif %} @change="update()">
                <span class="flex-1">{{ lt.name }}</span>
              </label>
              {% endfor %}
              <div class="mt-1 pt-1 border-t border-[#E5F4F2] flex gap-2">
                <button type="button" class="text-[10px] px-2 py-1 rounded bg-[#E5F4F2] text-[#116466] font-semibold" @click="$el.closest('.relative').querySelectorAll('input[type=checkbox]').forEach(c=>c.checked=false); update()">Clear</button>
                <button type="button" class="text-[10px] px-2 py-1 rounded bg-[#116466] text-white font-semibold" @click="open=false">Done</button>
              </div>
            </div>
          </div>
          <div x-data="{open:false,label:'Any',update(){const boxes=[...$refs.boxes.querySelectorAll('input[type=checkbox]')];const chosen=boxes.filter(b=>b.checked).map(b=>b.nextElementSibling.textContent.trim());this.label = chosen.length? (chosen.length===1? chosen[0]: `${chosen.length} selected`):'Any';},init(){this.update();}}" class="relative">
            <label class="filter-label">Participant Type</label>
            <button type="button" @click="open=!open" :aria-expanded="open" aria-haspopup="listbox" :class="{'has-value':label!=='Any'}" class="w-full filter-select flex items-center justify-between gap-2 pr-3 cursor-pointer !rounded-lg items-center">
              <span class="truncate text-left" x-text="label"></span>
              <svg :class="{'rotate-180':open}" class="w-4 h-4 text-[#116466] transition-transform" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
            </button>
            <div x-show="open" x-transition @click.outside="open=false" class="absolute z-30 mt-1 w-56 max-h-64 overflow-auto rounded-xl border border-[#89B0AE] bg-white shadow-lg p-2 flex flex-col gap-1" x-ref="boxes">
              {% for pt in participant_types_list %}
              <label class="flex items-center gap-2 px-2 py-1 rounded hover:bg-[#F2FAF9] text-xs cursor-pointer">
                <input type="checkbox" name="participant" value="{{ pt.id }}" class="rounded text-[#116466] focus:ring-[#116466]" {% if pt.id|stringformat:'s' in filter_participant %}checked{% endif %} @change="update()">
                <span class="flex-1">{{ pt.name }}</span>
              </label>
              {% endfor %}
              <div class="mt-1 pt-1 border-t border-[#E5F4F2] flex gap-2">
                <button type="button" class="text-[10px] px-2 py-1 rounded bg-[#E5F4F2] text-[#116466] font-semibold" @click="$el.closest('.relative').querySelectorAll('input[type=checkbox]').forEach(c=>c.checked=false); update()">Clear</button>
                <button type="button" class="text-[10px] px-2 py-1 rounded bg-[#116466] text-white font-semibold" @click="open=false">Done</button>
              </div>
            </div>
          </div>
          <div x-data="{open:false,label:'Any',update(){const boxes=[...$refs.boxes.querySelectorAll('input[type=checkbox]')];const chosen=boxes.filter(b=>b.checked).map(b=>b.nextElementSibling.textContent.trim());this.label = chosen.length? (chosen.length===1? chosen[0]: `${chosen.length} selected`):'Any';},init(){this.update();}}" class="relative">
            <label class="filter-label">Age Group</label>
            <button type="button" @click="open=!open" :aria-expanded="open" aria-haspopup="listbox" :class="{'has-value':label!=='Any'}" class="w-full filter-select flex items-center justify-between gap-2 pr-3 cursor-pointer !rounded-lg items-center">
              <span class="truncate text-left" x-text="label"></span>
              <svg :class="{'rotate-180':open}" class="w-4 h-4 text-[#116466] transition-transform" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
            </button>
            <div x-show="open" x-transition @click.outside="open=false" class="absolute z-30 mt-1 w-56 max-h-64 overflow-auto rounded-xl border border-[#89B0AE] bg-white shadow-lg p-2 flex flex-col gap-1" x-ref="boxes">
              {% for ag in age_groups_list %}
              <label class="flex items-center gap-2 px-2 py-1 rounded hover:bg-[#F2FAF9] text-xs cursor-pointer">
                <input type="checkbox" name="age" value="{{ ag.id }}" class="rounded text-[#116466] focus:ring-[#116466]" {% if ag.id|stringformat:'s' in filter_age %}checked{% endif %} @change="update()">
                <span class="flex-1">{{ ag.name }}</span>
              </label>
              {% endfor %}
              <div class="mt-1 pt-1 border-t border-[#E5F4F2] flex gap-2">
                <button type="button" class="text-[10px] px-2 py-1 rounded bg-[#E5F4F2] text-[#116466] font-semibold" @click="$el.closest('.relative').querySelectorAll('input[type=checkbox]').forEach(c=>c.checked=false); update()">Clear</button>
                <button type="button" class="text-[10px] px-2 py-1 rounded bg-[#116466] text-white font-semibold" @click="open=false">Done</button>
              </div>
            </div>
          </div>
          <div x-data="{open:false,label:'Any',update(){const boxes=[...$refs.ttBoxes.querySelectorAll('input[type=checkbox]')];const chosen=boxes.filter(b=>b.checked).map(b=>b.nextElementSibling.textContent.trim());this.label=chosen.length?(chosen.length===1?chosen[0]:`${chosen.length} selected`):'Any';},init(){this.update();}}" class="relative">
            <label class="filter-label">Therapy Type</label>
            <button type="button" @click="open=!open" :aria-expanded="open" aria-haspopup="listbox" :class="{'has-value':label!=='Any'}" class="w-full filter-select flex items-center justify-between gap-2 pr-3 cursor-pointer !rounded-lg items-center">
              <span class="truncate text-left" x-text="label"></span>
              <svg :class="{'rotate-180':open}" class="w-4 h-4 text-[#116466] transition-transform" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
            </button>
            <div x-show="open" x-transition @click.outside="open=false" class="absolute z-30 mt-1 w-56 max-h-64 overflow-auto rounded-xl border border-[#89B0AE] bg-white shadow-lg p-2 flex flex-col gap-1" x-ref="ttBoxes">
              {% for tt in therapy_types_list %}
              <label class="flex items-center gap-2 px-2 py-1 rounded hover:bg-[#F2FAF9] text-xs cursor-pointer">
                <input type="checkbox" name="therapy_type" value="{{ tt.id }}" class="rounded text-[#116466] focus:ring-[#116466]" {% if tt.id|stringformat:'s' in filter_therapy_type %}checked{% endif %} @change="update()">
                <span class="flex-1">{{ tt.name }}</span>
              </label>
              {% endfor %}
              <div class="mt-1 pt-1 border-t border-[#E5F4F2] flex gap-2">
                <button type="button" class="text-[10px] px-2 py-1 rounded bg-[#E5F4F2] text-[#116466] font-semibold" @click="$el.closest('.relative').querySelectorAll('input[type=checkbox]').forEach(c=>c.checked=false); update()">Clear</button>
                <button type="button" class="text-[10px] px-2 py-1 rounded bg-[#116466] text-white font-semibold" @click="open=false">Done</button>
              </div>
            </div>
          </div>
          <div x-data="{open:false,label:'Any',update(){const boxes=[...$refs.spBoxes.querySelectorAll('input[type=checkbox]')];const chosen=boxes.filter(b=>b.checked).map(b=>b.nextElementSibling.textContent.trim());this.label=chosen.length?(chosen.length===1?chosen[0]:`${chosen.length} selected`):'Any';},init(){this.update();}}" class="relative">
            <label class="filter-label">Specialties</label>
            <button type="button" @click="open=!open" :aria-expanded="open" aria-haspopup="listbox" :class="{'has-value':label!=='Any'}" class="w-full filter-select flex items-center justify-between gap-2 pr-3 cursor-pointer !rounded-lg items-center">
              <span class="truncate text-left" x-text="label"></span>
              <svg :class="{'rotate-180':open}" class="w-4 h-4 text-[#116466] transition-transform" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
            </button>
            <div x-show="open" x-transition @click.outside="open=false" class="absolute z-30 mt-1 w-56 max-h-64 overflow-auto rounded-xl border border-[#89B0AE] bg-white shadow-lg p-2 flex flex-col gap-1" x-ref="spBoxes">
              {% for sp in specialties_list %}
              <label class="flex items-center gap-2 px-2 py-1 rounded hover:bg-[#F2FAF9] text-xs cursor-pointer">
                <input type="checkbox" name="specialty" value="{{ sp.id }}" class="rounded text-[#116466] focus:ring-[#116466]" {% if sp.id|stringformat:'s' in filter_specialty %}checked{% endif %} @change="update()">
                <span class="flex-1">{{ sp.name }}</span>
              </label>
              {% endfor %}
              <div class="mt-1 pt-1 border-t border-[#E5F4F2] flex gap-2">
                <button type="button" class="text-[10px] px-2 py-1 rounded bg-[#E5F4F2] text-[#116466] font-semibold" @click="$el.closest('.relative').querySelectorAll('input[type=checkbox]').forEach(c=>c.checked=false); update()">Clear</button>
                <button type="button" class="text-[10px] px-2 py-1 rounded bg-[#116466] text-white font-semibold" @click="open=false">Done</button>
              </div>
            </div>
          </div>
          <div x-data="{open:false,label:'Any',update(){const boxes=[...$refs.boxes.querySelectorAll('input[type=checkbox]')];const chosen=boxes.filter(b=>b.checked).map(b=>b.nextElementSibling.textContent.trim());this.label = chosen.length? (chosen.length===1? chosen[0]: `${chosen.length} selected`):'Any';},init(){this.update();}}" class="relative">
            <label class="filter-label">Gender</label>
            <button type="button" @click="open=!open" :aria-expanded="open" aria-haspopup="listbox" :class="{'has-value':label!=='Any'}" class="w-full filter-select flex items-center justify-between gap-2 pr-3 cursor-pointer !rounded-lg items-center">
              <span class="truncate text-left" x-text="label"></span>
              <svg :class="{'rotate-180':open}" class="w-4 h-4 text-[#116466] transition-transform" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
            </button>
            <div x-show="open" x-transition @click.outside="open=false" class="absolute z-30 mt-1 w-56 max-h-64 overflow-auto rounded-xl border border-[#89B0AE] bg-white shadow-lg p-2 flex flex-col gap-1" x-ref="boxes">
              {% for g in genders %}
              <label class="flex items-center gap-2 px-2 py-1 rounded hover:bg-[#F2FAF9] text-xs cursor-pointer">
                <input type="checkbox" name="gender" value="{{ g.id }}" class="rounded text-[#116466] focus:ring-[#116466]" {% if g.id|stringformat:'s' in filter_gender %}checked{% endif %} @change="update()">
                <span class="flex-1">{{ g.name }}</span>
              </label>
              {% endfor %}
              <div class="mt-1 pt-1 border-t border-[#E5F4F2] flex gap-2">
                <button type="button" class="text-[10px] px-2 py-1 rounded bg-[#E5F4F2] text-[#116466] font-semibold" @click="$el.closest('.relative').querySelectorAll('input[type=checkbox]').forEach(c=>c.checked=false); update()">Clear</button>
                <button type="button" class="text-[10px] px-2 py-1 rounded bg-[#116466] text-white font-semibold" @click="open=false">Done</button>
              </div>
            </div>
          </div>
          <div x-data="{open:false,label:'Any',update(){const boxes=[...$refs.boxes.querySelectorAll('input[type=checkbox]')];const chosen=boxes.filter(b=>b.checked).map(b=>b.nextElementSibling.textContent.trim());this.label = chosen.length? (chosen.length===1? chosen[0]: `${chosen.length} selected`):'Any';},init(){this.update();}}" class="relative">
            <label class="filter-label">Race / Ethnicity</label>
            <button type="button" @click="open=!open" :aria-expanded="open" aria-haspopup="listbox" :class="{'has-value':label!=='Any'}" class="w-full filter-select flex items-center justify-between gap-2 pr-3 cursor-pointer !rounded-lg items-center">
              <span class="truncate text-left" x-text="label"></span>
              <svg :class="{'rotate-180':open}" class="w-4 h-4 text-[#116466] transition-transform" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
            </button>
            <div x-show="open" x-transition @click.outside="open=false" class="absolute z-30 mt-1 w-56 max-h-64 overflow-auto rounded-xl border border-[#89B0AE] bg-white shadow-lg p-2 flex flex-col gap-1" x-ref="boxes">
              {% for r in race_ethnicities %}
              <label class="flex items-center gap-2 px-2 py-1 rounded hover:bg-[#F2FAF9] text-xs cursor-pointer">
                <input type="checkbox" name="race" value="{{ r.id }}" class="rounded text-[#116466] focus:ring-[#116466]" {% if r.id|stringformat:'s' in filter_race %}checked{% endif %} @change="update()">
                <span class="flex-1">{{ r.name }}</span>
              </label>
              {% endfor %}
              <div class="mt-1 pt-1 border-t border-[#E5F4F2] flex gap-2">
                <button type="button" class="text-[10px] px-2 py-1 rounded bg-[#E5F4F2] text-[#116466] font-semibold" @click="$el.closest('.relative').querySelectorAll('input[type=checkbox]').forEach(c=>c.checked=false); update()">Clear</button>
                <button type="button" class="text-[10px] px-2 py-1 rounded bg-[#116466] text-white font-semibold" @click="open=false">Done</button>
              </div>
            </div>
          </div>
          <div x-data="{open:false,label:'Any',update(){const boxes=[...$refs.boxes.querySelectorAll('input[type=checkbox]')];const chosen=boxes.filter(b=>b.checked).map(b=>b.nextElementSibling.textContent.trim());this.label = chosen.length? (chosen.length===1? chosen[0]: `${chosen.length} selected`):'Any';},init(){this.update();}}" class="relative">
            <label class="filter-label">Faith</label>
            <button type="button" @click="open=!open" :aria-expanded="open" aria-haspopup="listbox" :class="{'has-value':label!=='Any'}" class="w-full filter-select flex items-center justify-between gap-2 pr-3 cursor-pointer !rounded-lg items-center">
              <span class="truncate text-left" x-text="label"></span>
              <svg :class="{'rotate-180':open}" class="w-4 h-4 text-[#116466] transition-transform" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
            </button>
            <div x-show="open" x-transition @click.outside="open=false" class="absolute z-30 mt-1 w-56 max-h-64 overflow-auto rounded-xl border border-[#89B0AE] bg-white shadow-lg p-2 flex flex-col gap-1" x-ref="boxes">
              {% for f in faiths %}
              <label class="flex items-center gap-2 px-2 py-1 rounded hover:bg-[#F2FAF9] text-xs cursor-pointer">
                <input type="checkbox" name="faith" value="{{ f.id }}" class="rounded text-[#116466] focus:ring-[#116466]" {% if f.id|stringformat:'s' in filter_faith %}checked{% endif %} @change="update()">
                <span class="flex-1">{{ f.name }}</span>
              </label>
              {% endfor %}
              <div class="mt-1 pt-1 border-t border-[#E5F4F2] flex gap-2">
                <button type="button" class="text-[10px] px-2 py-1 rounded bg-[#E5F4F2] text-[#116466] font-semibold" @click="$el.closest('.relative').querySelectorAll('input[type=checkbox]').forEach(c=>c.checked=false); update()">Clear</button>
                <button type="button" class="text-[10px] px-2 py-1 rounded bg-[#116466] text-white font-semibold" @click="open=false">Done</button>
              </div>
            </div>
          </div>
          <div x-data="{open:false,label:'Any',update(){const boxes=[...$refs.boxes.querySelectorAll('input[type=checkbox]')];const chosen=boxes.filter(b=>b.checked).map(b=>b.nextElementSibling.textContent.trim());this.label = chosen.length? (chosen.length===1? chosen[0]: `${chosen.length} selected`):'Any';},init(){this.update();}}" class="relative">
            <label class="filter-label">LGBTQIA+</label>
            <button type="button" @click="open=!open" :aria-expanded="open" aria-haspopup="listbox" :class="{'has-value':label!=='Any'}" class="w-full filter-select flex items-center justify-between gap-2 pr-3 cursor-pointer !rounded-lg items-center">
              <span class="truncate text-left" x-text="label"></span>
              <svg :class="{'rotate-180':open}" class="w-4 h-4 text-[#116466] transition-transform" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
            </button>
            <div x-show="open" x-transition @click.outside="open=false" class="absolute z-30 mt-1 w-56 max-h-64 overflow-auto rounded-xl border border-[#89B0AE] bg-white shadow-lg p-2 flex flex-col gap-1" x-ref="boxes">
              {% for l in lgbtqia_identities %}
              <label class="flex items-center gap-2 px-2 py-1 rounded hover:bg-[#F2FAF9] text-xs cursor-pointer">
                <input type="checkbox" name="lgbtqia" value="{{ l.id }}" class="rounded text-[#116466] focus:ring-[#116466]" {% if l.id|stringformat:'s' in filter_lgbtqia %}checked{% endif %} @change="update()">
                <span class="flex-1">{{ l.name }}</span>
              </label>
              {% endfor %}
              <div class="mt-1 pt-1 border-t border-[#E5F4F2] flex gap-2">
                <button type="button" class="text-[10px] px-2 py-1 rounded bg-[#E5F4F2] text-[#116466] font-semibold" @click="$el.closest('.relative').querySelectorAll('input[type=checkbox]').forEach(c=>c.checked=false); update()">Clear</button>
                <button type="button" class="text-[10px] px-2 py-1 rounded bg-[#116466] text-white font-semibold" @click="open=false">Done</button>
              </div>
            </div>
          </div>
          <div x-data="{open:false,label:'Any',update(){const boxes=[...$refs.boxes.querySelectorAll('input[type=checkbox]')];const chosen=boxes.filter(b=>b.checked).map(b=>b.nextElementSibling.textContent.trim());this.label = chosen.length? (chosen.length===1? chosen[0]: `${chosen.length} selected`):'Any';},init(){this.update();}}" class="relative">
            <label class="filter-label">Other Identity</label>
            <button type="button" @click="open=!open" :aria-expanded="open" aria-haspopup="listbox" :class="{'has-value':label!=='Any'}" class="w-full filter-select flex items-center justify-between gap-2 pr-3 cursor-pointer !rounded-lg items-center">
              <span class="truncate text-left" x-text="label"></span>
              <svg :class="{'rotate-180':open}" class="w-4 h-4 text-[#116466] transition-transform" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
            </button>
            <div x-show="open" x-transition @click.outside="open=false" class="absolute z-30 mt-1 w-56 max-h-64 overflow-auto rounded-xl border border-[#89B0AE] bg-white shadow-lg p-2 flex flex-col gap-1" x-ref="boxes">
              {% for oi in other_identities %}
              <label class="flex items-center gap-2 px-2 py-1 rounded hover:bg-[#F2FAF9] text-xs cursor-pointer">
                <input type="checkbox" name="other_identity" value="{{ oi.id }}" class="rounded text-[#116466] focus:ring-[#116466]" {% if oi.id|stringformat:'s' in filter_other_identity %}checked{% endif %} @change="update()">
                <span class="flex-1">{{ oi.name }}</span>
              </label>
              {% endfor %}
              <div class="mt-1 pt-1 border-t border-[#E5F4F2] flex gap-2">
                <button type="button" class="text-[10px] px-2 py-1 rounded bg-[#E5F4F2] text-[#116466] font-semibold" @click="$el.closest('.relative').querySelectorAll('input[type=checkbox]').forEach(c=>c.checked=false); update()">Clear</button>
                <button type="button" class="text-[10px] px-2 py-1 rounded bg-[#116466] text-white font-semibold" @click="open=false">Done</button>
              </div>
            </div>
          </div>
        </fieldset>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-6 mt-6">
          <div x-data="{open:false,value:'{{ filter_sort|default:'distance' }}',options:[{v:'distance',t:'Distance{% if not user_zip %} (Recent){% endif %}'},{v:'name',t:'Name (A-Z)'}],
            label(){const o=this.options.find(o=>o.v===this.value);return o?o.t:'Distance';}}" class="relative">
            <label class="filter-label">Sort By</label>
            <button type="button" @click="open=!open" :aria-expanded="open" aria-haspopup="listbox" :class="{'has-value':true}" class="w-full filter-select flex items-center justify-between gap-2 pr-3 cursor-pointer !rounded-lg">
              <span class="truncate text-left" x-text="label()"></span>
              <svg :class="{'rotate-180':open}" class="w-4 h-4 text-[#116466] transition-transform" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
            </button>
            <div x-show="open" x-transition @click.outside="open=false" class="absolute z-30 mt-1 w-full max-h-64 overflow-auto rounded-xl border border-[#89B0AE] bg-white shadow-lg p-2 flex flex-col gap-1">
              <template x-for="opt in options" :key="opt.v">
                <label class="flex items-center gap-2 px-2 py-1 rounded hover:bg-[#F2FAF9] text-xs cursor-pointer">
                  <input type="radio" name="sort" :value="opt.v" :checked="value===opt.v" @change="value=opt.v; open=false" class="text-[#116466] focus:ring-[#116466]">
                  <span class="flex-1" x-text="opt.t"></span>
                </label>
              </template>
            </div>
          </div>
        </div>
  <!-- Active Filters Summary -->
  <div class="mt-6" x-data>
          <div class="flex flex-wrap gap-2" id="active-filters-wrapper">
            {% for lt in license_types %}{% if lt.id|stringformat:'s' in filter_license %}<span class="px-2 py-1 rounded-full bg-[#E5F4F2] text-[#116466] text-[11px] font-semibold">License: {{ lt.name }}</span>{% endif %}{% endfor %}
            {% for pt in participant_types_list %}{% if pt.id|stringformat:'s' in filter_participant %}<span class="px-2 py-1 rounded-full bg-[#E5F4F2] text-[#116466] text-[11px] font-semibold">Participant: {{ pt.name }}</span>{% endif %}{% endfor %}
            {% for ag in age_groups_list %}{% if ag.id|stringformat:'s' in filter_age %}<span class="px-2 py-1 rounded-full bg-[#E5F4F2] text-[#116466] text-[11px] font-semibold">Age: {{ ag.name }}</span>{% endif %}{% endfor %}
            {% for tt in therapy_types_list %}{% if tt.id|stringformat:'s' in filter_therapy_type %}<span class="px-2 py-1 rounded-full bg-[#E5F4F2] text-[#116466] text-[11px] font-semibold">Therapy: {{ tt.name }}</span>{% endif %}{% endfor %}
            {% for sp in specialties_list %}{% if sp.id|stringformat:'s' in filter_specialty %}<span class="px-2 py-1 rounded-full bg-[#E5F4F2] text-[#116466] text-[11px] font-semibold">Specialty: {{ sp.name }}</span>{% endif %}{% endfor %}
            {% for g in genders %}{% if g.id|stringformat:'s' in filter_gender %}<span class="px-2 py-1 rounded-full bg-[#E5F4F2] text-[#116466] text-[11px] font-semibold">Gender: {{ g.name }}</span>{% endif %}{% endfor %}
            {% for r in race_ethnicities %}{% if r.id|stringformat:'s' in filter_race %}<span class="px-2 py-1 rounded-full bg-[#E5F4F2] text-[#116466] text-[11px] font-semibold">Race: {{ r.name }}</span>{% endif %}{% endfor %}
            {% for f in faiths %}{% if f.id|stringformat:'s' in filter_faith %}<span class="px-2 py-1 rounded-full bg-[#E5F4F2] text-[#116466] text-[11px] font-semibold">Faith: {{ f.name }}</span>{% endif %}{% endfor %}
            {% for l in lgbtqia_identities %}{% if l.id|stringformat:'s' in filter_lgbtqia %}<span class="px-2 py-1 rounded-full bg-[#E5F4F2] text-[#116466] text-[11px] font-semibold">LGBTQIA+: {{ l.name }}</span>{% endif %}{% endfor %}
            {% for oi in other_identities %}{% if oi.id|stringformat:'s' in filter_other_identity %}<span class="px-2 py-1 rounded-full bg-[#E5F4F2] text-[#116466] text-[11px] font-semibold">Identity: {{ oi.name }}</span>{% endif %}{% endfor %}
            
            {% if filter_sort and filter_sort != 'distance' %}<span class="px-2 py-1 rounded-full bg-[#E5F4F2] text-[#116466] text-[11px] font-semibold">Sort: {{ filter_sort|title }}</span>{% endif %}
          </div>
            {% if not filter_license and not filter_participant and not filter_age and not filter_therapy_type and not filter_specialty and not filter_gender and not filter_race and not filter_faith and not filter_lgbtqia and not filter_other_identity and filter_sort == 'distance' %}
            <p class="mt-2 text-[11px] text-[#555B6E] opacity-60">No active filters.</p>
          {% endif %}
        </div>
  <div class="mt-6 flex flex-wrap gap-4 justify-center items-stretch">
          <button type="submit" class="px-7 py-3 rounded-full bg-[#116466] text-white font-semibold text-sm shadow hover:bg-[#0d4c4d] focus:outline-none focus:ring-2 focus:ring-[#89B0AE] transition">Apply Filters</button>
          <a href="{{ request.path }}" class="px-7 py-3 rounded-full bg-[#E5F4F2] text-[#116466] font-semibold text-sm shadow hover:bg-[#D2E7E4] focus:outline-none focus:ring-2 focus:ring-[#89B0AE] transition text-center">Reset</a>
        </div>
        <p class="mt-2 text-center text-[11px] text-[#555B6E] opacity-70">Results limited to first 150 matches after sorting.</p>
        <style>
          .filter-label{display:block;font-size:11px;font-weight:600;letter-spacing:.05em;color:#555B6E;margin-bottom:4px;text-transform:uppercase;}
          .advanced-filters .select-wrapper{position:relative;}
          .advanced-filters .select-wrapper .select-arrow{position:absolute;top:50%;right:.75rem;transform:translateY(-50%);display:flex;align-items:center;color:#116466;pointer-events:none;}
          /* Use flex so inner text sits perfectly centered vertically */
          .advanced-filters .filter-select{display:flex;align-items:center;justify-content:space-between;width:100%;border:1px solid #89B0AE;border-radius:1rem;padding:.5rem .75rem;background:#FAF9F9;color:#555B6E;font-size:.75rem;line-height:1rem;font-weight:500;box-shadow:0 1px 2px rgba(0,0,0,.05);transition:.15s;-webkit-appearance:none;-moz-appearance:none;appearance:none;min-height:2.75rem;}
          .advanced-filters select[multiple]{background:#fff;overflow:auto;}
          .advanced-filters select[multiple] option{padding:.25rem .5rem;font-size:.7rem;}
          .advanced-filters .filter-select:hover{background:#fff;}
          .advanced-filters .filter-select:focus{outline:none;border-color:#116466;box-shadow:0 0 0 2px rgba(137,176,174,.45);background:#fff;}
          .advanced-filters .filter-select.has-value{color:#116466;border-color:#116466;font-weight:600;}
        </style>
  <!-- Dynamic highlight handled via Alpine :class bindings on each custom dropdown -->
      </div>
    </form>
  </div>
  <div class="flex flex-col gap-2 py-8 pb-16 px-2 sm:px-4" style="background-color:#FFF6ED;">
    {% for therapist in therapists %}
      {% include "partials/therapist_card.html" with therapist=therapist %}
    {% empty %}
      <div class="col-span-full text-center text-[#555B6E] text-lg">No therapists found matching your criteria.</div>
    {% endfor %}
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const hash = (window.location.hash || '').trim();
        if(!hash) return;
        const store = window.Alpine && Alpine.store('profileModal');
        const collectIds = () => ([...document.querySelectorAll('[data-therapist-id]')].map(n=>parseInt(n.getAttribute('data-therapist-id'))).filter(Boolean));
        const ids = collectIds();
        const openById = (id) => { if(store && id){ store.open(id); } };
        if(hash.startsWith('#autoopen=')){
          const id = parseInt(hash.split('=')[1]);
          openById(id);
        } else if(hash === '#openfirst') {
          if(ids.length) openById(ids[0]);
        } else if(hash === '#openlast') {
          if(ids.length) openById(ids[ids.length-1]);
        }
        history.replaceState(null, '', window.location.pathname + window.location.search);
      });
    </script>
    {% if paginator.num_pages > 1 %}
    <nav class="flex justify-center items-center mt-6" aria-label="Pagination">
      <ul class="flex gap-4 items-center">
        <li>
          {% if page_obj.has_previous %}
            <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.tier %}tier={{ request.GET.tier }}&{% endif %}{% if request.GET.specialty %}specialty={{ request.GET.specialty }}&{% endif %}page={{ page_obj.previous_page_number }}" class="get-started-btn rounded-full px-6 py-2 text-base font-semibold transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-[#89B0AE] bg-[#89B0AE] text-[#FAF9F9] hover:bg-[#555B6E] hover:text-white">Previous</a>
          {% else %}
            <span class="get-started-btn rounded-full px-6 py-2 text-base font-semibold bg-[#BEE3DB] text-[#555B6E] opacity-50 cursor-not-allowed">Previous</span>
          {% endif %}
        </li>
        <li><span class="text-[#555B6E] font-medium text-base bg-[#FAF9F9] rounded-full px-5 py-2 border border-[#BEE3DB] shadow-sm">Page {{ page_obj.number }} of {{ paginator.num_pages }}</span></li>
        <li>
          {% if page_obj.has_next %}
            <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.tier %}tier={{ request.GET.tier }}&{% endif %}{% if request.GET.specialty %}specialty={{ request.GET.specialty }}&{% endif %}page={{ page_obj.next_page_number }}" class="get-started-btn rounded-full px-6 py-2 text-base font-semibold transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-[#89B0AE] bg-[#89B0AE] text-[#FAF9F9] hover:bg-[#555B6E] hover:text-white">Next</a>
          {% else %}
            <span class="get-started-btn rounded-full px-6 py-2 text-base font-semibold bg-[#BEE3DB] text-[#555B6E] opacity-50 cursor-not-allowed">Next</span>
          {% endif %}
        </li>
      </ul>
    </nav>
    {% endif %}
  </div>
  {% include "partials/profile/profile_display.html" %}
</section>
{% endblock %}
