{% extends "base.html" %}
{% load static %}
{% block content %}
<script>
  document.addEventListener('alpine:init', () => {
    if(!Alpine.store('profileModal')) {
      Alpine.store('profileModal', {
        show:false, therapist:{}, loading:false, error:null,
        open(id){
          console.log('[profileModal] open called (therapists page) with id', id, 'at', Date.now());
          this.show=true; this.error=null; this.loading=true; this.therapist={};
          document.documentElement.classList.add('overflow-hidden');
          document.body.classList.add('overflow-hidden');
          fetch(`/users/api/therapists/${id}/profile_full/`).then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }).then(d=>{ this.therapist=d; }).catch(e=>{ console.error(e); this.error=e.message; }).finally(()=>this.loading=false);
        },
        close(){
          console.log('[profileModal] close called (therapists page) at', Date.now());
          this.show=false;
          requestAnimationFrame(()=>{
            document.documentElement.classList.remove('overflow-hidden');
            document.body.classList.remove('overflow-hidden');
          });
        }
      });
    }
  });
</script>
<section class="pt-8 w-full" style="background-color: #BEE3DB;">
  <div class="max-w-3xl mx-auto text-center px-2 sm:px-4" style="padding-bottom:30px;">
    <h2 class="text-3xl font-bold mb-2 text-center" style="color: #555B6E;">Find a Therapist</h2>
    <p class="text-base sm:text-lg mb-8" style="color: #555B6E;">Search and filter to find the right therapist for you.</p>
    <form method="get" class="flex flex-col md:flex-row gap-4 justify-center items-center mb-4 w-full max-w-2xl mx-auto">
      <div class="flex w-full">
        <input type="text" name="q" placeholder="Search therapists, practices, or specialties..." class="homepage-search-input border rounded-l-full px-4 py-3 w-full focus:ring-2 text-sm sm:text-base" style="border-color: #89B0AE; color: #555B6E; background-color: #FAF9F9;" />
        <button type="submit" class="homepage-search-btn font-semibold rounded-r-full px-4 sm:px-6 py-3 text-sm sm:text-base transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-[#89B0AE] cursor-pointer" style="background-color: #89B0AE; color: #FAF9F9; border-left: 0 !important; border-left-color: transparent !important;" onmouseover="this.style.backgroundColor='#555B6E'; this.style.color='#fff';" onmouseout="this.style.backgroundColor='#89B0AE'; this.style.color='#FAF9F9';">Search</button>
      </div>
    </form>
    <div x-data="{ open: false }" class="w-full mt-2">
      <button type="button" @click="open = !open" class="flex items-center gap-2 px-4 py-2 bg-white border border-[#89B0AE] rounded-full shadow text-[#555B6E] font-semibold focus:outline-none focus:ring-2 focus:ring-[#89B0AE] mx-auto">
        <span>Advanced Filters</span>
        <svg :class="{ 'rotate-180': open }" class="w-5 h-5 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
      </button>
      <div x-show="open" x-transition:enter="transition-all ease-out duration-300" x-transition:enter-start="max-height:0;opacity:0;" x-transition:enter-end="max-height:500px;opacity:1;" x-transition:leave="transition-all ease-in duration-200" x-transition:leave-start="max-height:500px;opacity:1;" x-transition:leave-end="max-height:0;opacity:0;" class="w-full max-w-7xl bg-white border border-[#BEE3DB] rounded-xl shadow-lg p-8 mt-4 overflow-hidden mx-auto">
        <div class="flex flex-col md:flex-row gap-8">
          <div class="flex-1">
            <label class="block text-sm font-medium text-[#555B6E] mb-1">Tier</label>
            <select name="tier" class="border border-gray-300 rounded px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-[#89B0AE] text-[#555B6E] bg-[#FAF9F9]">
              <option value="">All Tiers</option>
              <option value="Starter">Starter</option>
              <option value="Professional">Professional</option>
            </select>
          </div>
          <div class="flex-1">
            <label class="block text-sm font-medium text-[#555B6E] mb-1">Specialty</label>
            <select name="specialty" class="border border-gray-300 rounded px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-[#89B0AE] text-[#555B6E] bg-[#FAF9F9]">
              <option value="">All Specialties</option>
              {% for tag in practice_areas_tags %}
              <option value="{{ tag.id }}">{{ tag.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Therapist Cards & Pagination (pagination moved inside same background container) -->
  <div class="flex flex-col gap-2 py-8 pb-16 px-2 sm:px-4" style="background-color: #FFF6ED;">
    {% for therapist in therapists %}
      {% include "partials/therapist_card.html" with therapist=therapist %}
    {% empty %}
      <div class="col-span-full text-center text-[#555B6E] text-lg">No therapists found matching your criteria.</div>
    {% endfor %}
    {% if paginator.num_pages > 1 %}
    <nav class="flex justify-center items-center mt-6" aria-label="Pagination">
      <ul class="flex gap-4 items-center">
        <li>
          {% if page_obj.has_previous %}
            <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.tier %}tier={{ request.GET.tier }}&{% endif %}{% if request.GET.specialty %}specialty={{ request.GET.specialty }}&{% endif %}page={{ page_obj.previous_page_number }}"
              class="get-started-btn rounded-full px-6 py-2 text-base font-semibold transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-[#89B0AE] bg-[#89B0AE] text-[#FAF9F9] hover:bg-[#555B6E] hover:text-white"
            >Previous</a>
          {% else %}
            <span class="get-started-btn rounded-full px-6 py-2 text-base font-semibold bg-[#BEE3DB] text-[#555B6E] opacity-50 cursor-not-allowed">Previous</span>
          {% endif %}
        </li>
        <li>
          <span class="text-[#555B6E] font-medium text-base bg-[#FAF9F9] rounded-full px-5 py-2 border border-[#BEE3DB] shadow-sm">Page {{ page_obj.number }} of {{ paginator.num_pages }}</span>
        </li>
        <li>
          {% if page_obj.has_next %}
            <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.tier %}tier={{ request.GET.tier }}&{% endif %}{% if request.GET.specialty %}specialty={{ request.GET.specialty }}&{% endif %}page={{ page_obj.next_page_number }}"
              class="get-started-btn rounded-full px-6 py-2 text-base font-semibold transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-[#89B0AE] bg-[#89B0AE] text-[#FAF9F9] hover:bg-[#555B6E] hover:text-white"
            >Next</a>
          {% else %}
            <span class="get-started-btn rounded-full px-6 py-2 text-base font-semibold bg-[#BEE3DB] text-[#555B6E] opacity-50 cursor-not-allowed">Next</span>
          {% endif %}
        </li>
      </ul>
    </nav>
    {% endif %}
  </div>
  {% include "partials/profile_modal.html" %}
</section>
{% endblock %}
