{% load location_extras %}
{% load therapist_extras %}

<section class="py-10 w-full" style="background-color: #FAF9F9;" x-data="{}">
  <div class="max-w-7xl mx-auto px-4">
    <h2 class="text-2xl sm:text-3xl font-bold mb-8 text-center" style="color: #555B6E;">Top Therapists in Your Area</h2>
    <div class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 xl:grid-cols-3 gap-10 justify-items-center">
      {% for therapist in therapists %}
      <div class="relative w-full max-w-sm rounded-2xl shadow-lg bg-white overflow-hidden flex flex-col" style="box-shadow:0 4px 18px -4px #555B6E33; min-height:430px;">
        <!-- Image -->
        <div class="relative w-full h-48 overflow-hidden">
          {% if therapist.profile_photo %}
            {% profile_photo_srcset therapist 'webp' as ss_webp %}
            {% profile_photo_srcset therapist 'jpg' as ss_jpg %}
            {% if ss_webp or ss_jpg %}
              <picture>
                <source type="image/webp" srcset="{{ ss_webp }}" sizes="(max-width:640px) 160px, (max-width:1024px) 400px, 800px">
                <img src="{% profile_photo_variant therapist 'medium' 'jpg' %}" srcset="{{ ss_jpg }}" sizes="(max-width:640px) 160px, (max-width:1024px) 400px, 800px" alt="{{ therapist.first_name }} {{ therapist.last_name }}" class="w-full h-full object-cover object-center" loading="lazy" decoding="async" />
              </picture>
            {% else %}
              <img src="{{ therapist.profile_photo.url }}" alt="{{ therapist.first_name }} {{ therapist.last_name }}" class="w-full h-full object-cover object-center" loading="lazy" decoding="async" />
            {% endif %}
          {% else %}
            <img src="https://randomuser.me/api/portraits/lego/1.jpg" alt="Therapist" class="w-full h-full object-cover object-center" loading="lazy" decoding="async" />
          {% endif %}
          {% if therapist.distance is not None %}
            <span class="absolute top-3 left-3 bg-[#F5E2D6] text-[#555B6E] px-3 py-1 rounded-full text-[11px] font-semibold shadow-sm border border-[#FF9950]/30">{{ therapist.distance }} mi</span>
          {% endif %}
        </div>
        <!-- Body -->
        <div class="flex-1 flex flex-col p-5 gap-3">
          <div>
            <h3 class="text-xl font-extrabold flex flex-wrap items-baseline gap-x-2 leading-snug text-[#555B6E]">
              <span>{{ therapist.first_name }} {{ therapist.last_name }}</span>
              {% if therapist.license_type %}<span class="text-sm font-semibold text-[#116466]">{{ therapist.license_type.name }}</span>{% endif %}
            </h3>
            {% with primary=therapist.locations.all|get_primary_location %}
              {% if primary and primary.practice_name %}
                <div class="text-sm font-semibold mt-0.5 text-[#555B6E]">{{ primary.practice_name }}</div>
              {% endif %}
              <div class="text-xs opacity-80 text-[#555B6E]">
                {% if therapist.closest_location %}
                  {{ therapist.closest_location.city }}, {{ therapist.closest_location.state }}
                {% elif primary %}
                  {{ primary.city }}, {{ primary.state }}
                {% endif %}
              </div>
            {% endwith %}
            {# First text field: Intro note #}
            {% if therapist.intro_statement %}
              <div class="mt-2 text-xs font-medium text-[#89B0AE]">{{ therapist.intro_statement|slice:":200" }}</div>
            {% endif %}
          </div>
          <!-- Chips -->
          <div class="flex flex-wrap gap-2 text-[10px] leading-tight">
            {% for pt in therapist.participant_types.all %}
              <span class="px-2 py-1 rounded-full bg-[#BEE3DB] text-[#444] font-semibold shadow-sm">{{ pt.name }}</span>
            {% endfor %}
            {% for ag in therapist.age_groups.all %}
              <span class="px-2 py-1 rounded-full bg-[#E5F4F2] text-[#444] font-medium shadow-sm">{{ ag.name }}</span>
            {% endfor %}
            {% for s in therapist.specialties.all %}{% if s.is_top_specialty and s.specialty %}
              <span class="px-2 py-1 rounded-full bg-[#FFDDD0] text-[#444] font-medium shadow-sm">{{ s.specialty.name }}</span>
            {% endif %}{% endfor %}
          </div>
          {# Personal Statement 1 moved below chips #}
          {% if therapist.personal_statement_q1 %}
            <div class="mt-2 text-xs leading-relaxed text-[#555B6E]">{{ therapist.personal_statement_q1|slice:":200" }}</div>
          {% endif %}
          
          <div class="mt-auto pt-1">
            <button
              type="button"
              class="get-started-btn font-semibold rounded-lg px-4 py-2 cursor-pointer bg-[#116466] text-white hover:bg-[#0d4c4d] text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#89B0AE] transition"
              @click="
                fetch('/users/api/profile_click/', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ user_id: {{ therapist.user.id }} })
                });
                $store.profileModal.open({{ therapist.user.id }});
              "
            >View Profile</button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  {# Modal included globally on parent page; removed here to avoid duplicates #}
  </div>
</section>
