{% load therapist_extras %}
{% if editable %}
<script>
// Ensure time picker helper available in editable mode
window.tcTimePicker = window.tcTimePicker || function tcTimePicker(row, start){
  return {
    row,start, open:false, query:'',
    options: Array.from({length: 24*4}, (_,i)=>{ // 15 min increments
      const totalMinutes = i*15;
      const h = Math.floor(totalMinutes/60);
      const m = totalMinutes%60;
      const v = String(h).padStart(2,'0')+ ':' + String(m).padStart(2,'0');
      const hr12 = ((h + 11) % 12) + 1;
      const ampm = h>=12 ? 'PM':'AM';
      const l = hr12 + ':' + String(m).padStart(2,'0') + ' ' + ampm;
      return {v,l};
    }),
    label(){ return this.row[this.start] ? this.toLabel(this.row[this.start]) : 'Select time'; },
    toLabel(v){ if(!v) return ''; const [h,m] = v.split(':').map(n=>parseInt(n)); const hr12 = ((h + 11) % 12) + 1; const ampm = h>=12? 'PM':'AM'; return hr12 + ':' + String(m).padStart(2,'0') + ' ' + ampm; },
    toggle(){ this.open=!this.open; if(this.open){ this.$nextTick(()=>{ const el=this.$el.querySelector('input'); el && el.focus(); }); }},
    select(v){ this.row[this.start]=v; this.open=false; },
    clear(){ this.row[this.start]=''; this.query=''; },
    quick(v){ this.select(v); },
    filtered(){ const q=this.query.trim().toLowerCase(); if(!q) return this.options; return this.options.filter(o=> o.l.toLowerCase().includes(q) || o.v.startsWith(q)); }
  }
};
</script>
<div class="mx-auto w-full max-w-[1200px] px-4 md:px-6">
  <section id="section-locations" class="tc-section relative p-4 md:p-5 mt-4 md:mt-6 mb-6 md:mb-8 rounded-2xl bg-white/80 ring-1 ring-[#BEE3DB] shadow" style="box-shadow:0 4px 18px -6px #555B6E33;" x-data="locationManager()">
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-5">
      <div class="flex flex-col gap-1">
        <h2 class="text-[22px] md:text-[24px] font-extrabold tracking-tight text-[#2e4a49] flex items-center gap-2">
          <svg class="w-7 h-7 text-[#116466]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21s-6-4.686-6-10a6 6 0 1 1 12 0c0 5.314-6 10-6 10Z"/><circle cx="12" cy="11" r="3"/></svg>
          Locations
        </h2>
        <p class="text-[11px] font-medium tracking-wide text-[#587a79] uppercase">Practice sites & presence</p>
      </div>
      <button type="button" @click="startAdd()" class="text-[11px] px-3 py-1.5 rounded-full bg-[#116466] text-white font-semibold shadow hover:bg-[#0d4c4d] transition" x-show="!form.show">Add</button>
    </div>
  <!-- Delete Confirmation Modal -->
  <template x-if="confirmDelete.show">
    <div class="fixed inset-0 z-[6000] flex items-center justify-center">
      <div class="absolute inset-0 bg-[#2e4a49]/50 backdrop-blur-sm" @click="cancelDelete()"></div>
      <div class="relative w-full max-w-sm mx-auto bg-white rounded-2xl shadow-2xl ring-1 ring-[#BEE3DB] p-5 flex flex-col gap-4 animate-[fadeIn_.25s_ease]">
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 rounded-full bg-[#FFE8E5] flex items-center justify-center text-[#9b4d49]">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v4m0 4h.01M5.07 19h13.86A2 2 0 0 0 21 17.07L12.93 3.64a2 2 0 0 0-3.86 0L3 17.07A2 2 0 0 0 5.07 19Z"/></svg>
          </div>
          <div class="flex-1">
            <h4 class="text-sm font-semibold text-[#555B6E] tracking-wide">Delete Location?</h4>
            <p class="mt-1 text-[12px] leading-snug text-[#555B6E]/80">You're about to remove <span class="font-semibold" x-text="confirmDelete.targetName"></span>. This will also delete any office hours associated with it. This action can't be undone.</p>
          </div>
        </div>
        <div class="flex items-center justify-end gap-3 pt-1">
          <button type="button" @click="cancelDelete()" class="px-4 py-1.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[11px] font-medium text-[#555B6E] hover:bg-[#E5F4F2]">Cancel</button>
          <button type="button" @click="confirmDeleteAction()" class="px-4 py-1.5 rounded-full bg-[#9b4d49] text-white text-[11px] font-semibold hover:bg-[#7f3d39]">Delete</button>
        </div>
      </div>
    </div>
  </template>
  <div x-show="form.show" class="mb-6 rounded-xl p-4 bg-statement shadow-lg ring-1 ring-[#BEE3DB] flex flex-col gap-4" style="box-shadow:0 4px 14px -4px #555B6E22;">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <input type="text" x-model="form.practice_name" placeholder="Practice Name" class="tc-input" />
      <input type="text" x-model="form.street_address" placeholder="Street Address" class="tc-input" />
      <input type="text" x-model="form.address_line_2" placeholder="Address Line 2" class="tc-input" />
      <input type="text" x-model="form.city" placeholder="City" class="tc-input" />
      <div class="relative">
        <select x-model="form.state" class="tc-input appearance-none pr-9">
          <template x-for="s in states" :key="s.code">
            <option :value="s.code" x-text="s.name"></option>
          </template>
        </select>
        <div class="pointer-events-none absolute inset-y-0 right-2 flex items-center text-[#116466] opacity-70">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6"/></svg>
        </div>
      </div>
      <input type="text" x-model="form.zip" placeholder="ZIP" class="tc-input" />
    </div>
    <label class="flex items-center gap-2 text-[11px] font-medium text-[#555B6E]"><input type="checkbox" x-model="form.is_primary_address" class="accent-[#116466]" /> Primary Location</label>
    <div class="flex gap-2 pt-1">
      <button type="button" @click="save()" class="px-4 py-1.5 rounded-full bg-[#116466] text-white text-[11px] font-semibold shadow disabled:opacity-50 disabled:cursor-not-allowed" x-text="form.mode==='add' ? 'Save Location' : 'Update Location'" :disabled="saving"></button>
      <button type="button" @click="cancel()" class="px-4 py-1.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[11px] font-medium hover:bg-[#E5F4F2]">Cancel</button>
      <template x-if="form.mode==='edit'"><button type="button" @click="remove()" class="ml-auto px-4 py-1.5 rounded-full bg-[#FFE8E5] text-[#9b4d49] text-[11px] font-semibold hover:bg-[#FFD5CF] shadow">Delete</button></template>
    </div>
    <template x-if="error"><div class="text-[11px] text-[#9b4d49]" x-text="error"></div></template>
  </div>
    <template x-if="!$store.profileModal.therapist.locations || !$store.profileModal.therapist.locations.length">
      <p class="text-[13px] italic text-[#89B0AE]">No locations added yet.</p>
    </template>
    <div class="space-y-6" x-show="$store.profileModal.therapist.locations && $store.profileModal.therapist.locations.length">
    <template x-for="loc in $store.profileModal.therapist.locations" :key="loc.id">
      <div class="text-sm text-[#2e4a49] flex flex-col gap-2 rounded-xl p-4 bg-statement shadow-lg ring-1 ring-[#BEE3DB] relative group transition hover:ring-[#116466]" style="box-shadow:0 4px 14px -4px #555B6E22;">
        <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 focus-within:opacity-100 transition pointer-events-none group-hover:pointer-events-auto">
          <button type="button" @click="edit(loc)" class="text-[10px] px-2 py-0.5 rounded-full bg-[#116466] text-white font-semibold hover:bg-[#0d4c4d] shadow">Edit</button>
          <button type="button" @click="removeLoc(loc)" class="text-[10px] px-2 py-0.5 rounded-full bg-[#FFE8E5] text-[#9b4d49] font-semibold hover:bg-[#FFD5CF] shadow">Del</button>
        </div>
        <div class="font-semibold text-[#555B6E] tracking-tight" x-text="(loc.practice_name || 'Practice Location') + (loc.is_primary_address ? ' (Primary)' : '')"></div>
        <div class="text-[12px] opacity-90" x-text="[loc.street_address, loc.address_line_2].filter(Boolean).join(', ')"></div>
        <div class="text-[12px] opacity-90" x-text="[loc.city, loc.state, loc.zip].filter(Boolean).join(', ')"></div>
        <!-- Office Hours (editable) -->
        <div class="mt-2" x-data="{}">
          <template x-if="hoursEdit.openFor !== loc.id">
            <button type="button" @click="openHours(loc)" class="text-[10px] px-3 py-1 rounded-full bg-white ring-1 ring-[#BEE3DB] hover:bg-[#E5F4F2] font-semibold text-[#116466] shadow-sm">Edit Office Hours</button>
          </template>
          <template x-if="hoursEdit.openFor === loc.id">
            <div class="mt-3 p-3 rounded-xl bg-white/80 ring-1 ring-[#BEE3DB] flex flex-col gap-3 shadow-inner">
              <div class="flex items-center justify-between">
                <span class="text-[12px] font-semibold text-[#116466] tracking-wide">Office Hours</span>
                <div class="flex gap-2">
                  <button type="button" @click="saveHours()" :disabled="hoursEdit.saving" class="px-3 py-1 rounded-full bg-[#116466] text-white text-[10px] font-semibold disabled:opacity-50 shadow">Save</button>
                  <button type="button" @click="closeHours()" :disabled="hoursEdit.saving" class="px-3 py-1 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[10px] font-medium hover:bg-[#E5F4F2]">Close</button>
                </div>
              </div>
              <template x-if="hoursEdit.error"><div class="text-[10px] text-[#9b4d49]" x-text="hoursEdit.error"></div></template>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <template x-for="row in hoursEdit.rows" :key="row.weekday">
                  <div class="p-2 rounded-lg bg-statement ring-1 ring-[#BEE3DB]/70 flex flex-col gap-1">
                    <div class="flex items-center justify-between">
                      <span class="text-[11px] font-medium text-[#555B6E]" x-text="weekdayNames[row.weekday]"></span>
                      <div class="flex gap-1">
                        <button type="button" @click="toggleClosed(row)" class="text-[9px] px-1.5 py-0.5 rounded-full transition" :class="row.is_closed ? 'bg-[#116466] text-white' : 'bg-[#E5F4F2] text-[#116466]'">Closed</button>
                        <button type="button" @click="toggleAppt(row)" class="text-[9px] px-1.5 py-0.5 rounded-full transition" :class="row.by_appointment_only ? 'bg-[#116466] text-white' : 'bg-[#E5F4F2] text-[#116466]'">Appt</button>
                      </div>
                    </div>
                    <template x-if="!row.is_closed && !row.by_appointment_only">
                      <div class="flex flex-col gap-1">
                        <!-- Segment 1 -->
                        <div class="flex items-center gap-1">
                          <div class="flex-1 relative" x-data="tcTimePicker(row,'start_time_1')">
                            <button type="button" @click="toggle()" @keydown.enter.prevent="toggle()" :aria-expanded="open" :aria-label="'Start time segment 1 ' + (row[start] ? toLabel(row[start]) : 'not set')" class="w-full text-left px-2 py-1 rounded border text-[10px] font-medium flex items-center justify-between bg-white hover:border-[#116466] focus:outline-none focus:ring-2 focus:ring-[#116466]/50" :class="row[start] ? 'text-[#116466]' : 'text-[#555B6E]/60'">
                              <span x-text="label()"></span>
                              <svg class="w-3 h-3 opacity-60" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6"/></svg>
                            </button>
                            <div x-show="open" x-transition.origin.top.left @click.outside="open=false" @keydown.escape.window="open=false" class="absolute z-[3000] mt-1 left-0 w-48 rounded-lg bg-white shadow-lg ring-1 ring-[#BEE3DB] p-2 flex flex-col gap-2" style="display:none;">
                              <div class="flex items-center gap-1">
                                <input type="text" x-model="query" placeholder="Search" class="flex-1 border rounded px-1 py-0.5 text-[10px]" />
                                <button type="button" @click="clear()" class="px-1.5 py-0.5 text-[9px] rounded bg-[#E5F4F2] text-[#116466] font-semibold">X</button>
                              </div>
                              <div class="h-40 overflow-y-auto thin-scroll pr-1">
                                <template x-for="opt in filtered()" :key="opt.v">
                                  <button type="button" @click="select(opt.v)" class="w-full text-left px-2 py-1 rounded text-[10px] hover:bg-[#E5F4F2] flex items-center justify-between" :class="row[start]===opt.v ? 'bg-[#116466] text-white hover:bg-[#0d4c4d]' : 'text-[#2e4a49]'">
                                    <span x-text="opt.l"></span>
                                    <template x-if="row[start]===opt.v"><svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="m5 13 4 4L19 7"/></svg></template>
                                  </button>
                                </template>
                              </div>
                              <div class="flex flex-wrap gap-1 pt-1">
                                <button type="button" @click="quick('09:00')" class="px-2 py-0.5 rounded-full bg-[#E5F4F2] text-[9px] font-semibold text-[#116466]">9a</button>
                                <button type="button" @click="quick('13:00')" class="px-2 py-0.5 rounded-full bg-[#E5F4F2] text-[9px] font-semibold text-[#116466]">1p</button>
                                <button type="button" @click="clear()" class="px-2 py-0.5 rounded-full bg-[#FFE8E5] text-[9px] font-semibold text-[#9b4d49]">Clear</button>
                              </div>
                            </div>
                          </div>
                          <span class="text-[10px] text-[#555B6E]">-</span>
                          <div class="flex-1 relative" x-data="tcTimePicker(row,'end_time_1')">
                            <button type="button" @click="toggle()" @keydown.enter.prevent="toggle()" :aria-expanded="open" :aria-label="'End time segment 1 ' + (row[start] ? toLabel(row[start]) : 'not set')" class="w-full text-left px-2 py-1 rounded border text-[10px] font-medium flex items-center justify-between bg-white hover:border-[#116466] focus:outline-none focus:ring-2 focus:ring-[#116466]/50" :class="row[start] ? 'text-[#116466]' : 'text-[#555B6E]/60'">
                              <span x-text="label()"></span>
                              <svg class="w-3 h-3 opacity-60" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6"/></svg>
                            </button>
                            <div x-show="open" x-transition.origin.top.left @click.outside="open=false" @keydown.escape.window="open=false" class="absolute z-[3000] mt-1 left-0 w-48 rounded-lg bg-white shadow-lg ring-1 ring-[#BEE3DB] p-2 flex flex-col gap-2" style="display:none;">
                              <div class="flex items-center gap-1">
                                <input type="text" x-model="query" placeholder="Search" class="flex-1 border rounded px-1 py-0.5 text-[10px]" />
                                <button type="button" @click="clear()" class="px-1.5 py-0.5 text-[9px] rounded bg-[#E5F4F2] text-[#116466] font-semibold">X</button>
                              </div>
                              <div class="h-40 overflow-y-auto thin-scroll pr-1">
                                <template x-for="opt in filtered()" :key="opt.v">
                                  <button type="button" @click="select(opt.v)" class="w-full text-left px-2 py-1 rounded text-[10px] hover:bg-[#E5F4F2] flex items-center justify-between" :class="row[start]===opt.v ? 'bg-[#116466] text-white hover:bg-[#0d4c4d]' : 'text-[#2e4a49]'">
                                    <span x-text="opt.l"></span>
                                    <template x-if="row[start]===opt.v"><svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="m5 13 4 4L19 7"/></svg></template>
                                  </button>
                                </template>
                              </div>
                              <div class="flex flex-wrap gap-1 pt-1">
                                <button type="button" @click="quick('12:00')" class="px-2 py-0.5 rounded-full bg-[#E5F4F2] text-[9px] font-semibold text-[#116466]">12p</button>
                                <button type="button" @click="quick('17:00')" class="px-2 py-0.5 rounded-full bg-[#E5F4F2] text-[9px] font-semibold text-[#116466]">5p</button>
                                <button type="button" @click="clear()" class="px-2 py-0.5 rounded-full bg-[#FFE8E5] text-[9px] font-semibold text-[#9b4d49]">Clear</button>
                              </div>
                            </div>
                          </div>
                        </div>
                        <!-- Segment 2 -->
                        <div class="flex items-center gap-1">
                          <div class="flex-1 relative" x-data="tcTimePicker(row,'start_time_2')">
                            <button type="button" @click="toggle()" @keydown.enter.prevent="toggle()" :aria-expanded="open" :aria-label="'Start time segment 2 ' + (row[start] ? toLabel(row[start]) : 'not set')" class="w-full text-left px-2 py-1 rounded border text-[10px] font-medium flex items-center justify-between bg-white hover:border-[#116466] focus:outline-none focus:ring-2 focus:ring-[#116466]/50" :class="row[start] ? 'text-[#116466]' : 'text-[#555B6E]/60'">
                              <span x-text="label()"></span>
                              <svg class="w-3 h-3 opacity-60" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6"/></svg>
                            </button>
                            <div x-show="open" x-transition.origin.top.left @click.outside="open=false" @keydown.escape.window="open=false" class="absolute z-[3000] mt-1 left-0 w-48 rounded-lg bg-white shadow-lg ring-1 ring-[#BEE3DB] p-2 flex flex-col gap-2" style="display:none;">
                              <div class="flex items-center gap-1">
                                <input type="text" x-model="query" placeholder="Search" class="flex-1 border rounded px-1 py-0.5 text-[10px]" />
                                <button type="button" @click="clear()" class="px-1.5 py-0.5 text-[9px] rounded bg-[#E5F4F2] text-[#116466] font-semibold">X</button>
                              </div>
                              <div class="h-40 overflow-y-auto thin-scroll pr-1">
                                <template x-for="opt in filtered()" :key="opt.v">
                                  <button type="button" @click="select(opt.v)" class="w-full text-left px-2 py-1 rounded text-[10px] hover:bg-[#E5F4F2] flex items-center justify-between" :class="row[start]===opt.v ? 'bg-[#116466] text-white hover:bg-[#0d4c4d]' : 'text-[#2e4a49]'">
                                    <span x-text="opt.l"></span>
                                    <template x-if="row[start]===opt.v"><svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="m5 13 4 4L19 7"/></svg></template>
                                  </button>
                                </template>
                              </div>
                              <div class="flex flex-wrap gap-1 pt-1">
                                <button type="button" @click="quick('13:00')" class="px-2 py-0.5 rounded-full bg-[#E5F4F2] text-[9px] font-semibold text-[#116466]">1p</button>
                                <button type="button" @click="quick('18:00')" class="px-2 py-0.5 rounded-full bg-[#E5F4F2] text-[9px] font-semibold text-[#116466]">6p</button>
                                <button type="button" @click="clear()" class="px-2 py-0.5 rounded-full bg-[#FFE8E5] text-[9px] font-semibold text-[#9b4d49]">Clear</button>
                              </div>
                            </div>
                          </div>
                          <span class="text-[10px] text-[#555B6E]">-</span>
                          <div class="flex-1 relative" x-data="tcTimePicker(row,'end_time_2')">
                            <button type="button" @click="toggle()" @keydown.enter.prevent="toggle()" :aria-expanded="open" :aria-label="'End time segment 2 ' + (row[start] ? toLabel(row[start]) : 'not set')" class="w-full text-left px-2 py-1 rounded border text-[10px] font-medium flex items-center justify-between bg-white hover:border-[#116466] focus:outline-none focus:ring-2 focus:ring-[#116466]/50" :class="row[start] ? 'text-[#116466]' : 'text-[#555B6E]/60'">
                              <span x-text="label()"></span>
                              <svg class="w-3 h-3 opacity-60" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6"/></svg>
                            </button>
                            <div x-show="open" x-transition.origin.top.left @click.outside="open=false" @keydown.escape.window="open=false" class="absolute z-[3000] mt-1 left-0 w-48 rounded-lg bg-white shadow-lg ring-1 ring-[#BEE3DB] p-2 flex flex-col gap-2" style="display:none;">
                              <div class="flex items-center gap-1">
                                <input type="text" x-model="query" placeholder="Search" class="flex-1 border rounded px-1 py-0.5 text-[10px]" />
                                <button type="button" @click="clear()" class="px-1.5 py-0.5 text-[9px] rounded bg-[#E5F4F2] text-[#116466] font-semibold">X</button>
                              </div>
                              <div class="h-40 overflow-y-auto thin-scroll pr-1">
                                <template x-for="opt in filtered()" :key="opt.v">
                                  <button type="button" @click="select(opt.v)" class="w-full text-left px-2 py-1 rounded text-[10px] hover:bg-[#E5F4F2] flex items-center justify-between" :class="row[start]===opt.v ? 'bg-[#116466] text-white hover:bg-[#0d4c4d]' : 'text-[#2e4a49]'">
                                    <span x-text="opt.l"></span>
                                    <template x-if="row[start]===opt.v"><svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="m5 13 4 4L19 7"/></svg></template>
                                  </button>
                                </template>
                              </div>
                              <div class="flex flex-wrap gap-1 pt-1">
                                <button type="button" @click="quick('15:00')" class="px-2 py-0.5 rounded-full bg-[#E5F4F2] text-[9px] font-semibold text-[#116466]">3p</button>
                                <button type="button" @click="quick('20:00')" class="px-2 py-0.5 rounded-full bg-[#E5F4F2] text-[9px] font-semibold text-[#116466]">8p</button>
                                <button type="button" @click="clear()" class="px-2 py-0.5 rounded-full bg-[#FFE8E5] text-[9px] font-semibold text-[#9b4d49]">Clear</button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </template>
                    <input type="text" maxlength="64" placeholder="Notes" x-model="row.notes" class="border rounded px-1 py-0.5 text-[10px]" />
                  </div>
                </template>
              </div>
              <p class="text-[10px] text-[#555B6E] italic">Closed overrides times; Appt indicates by appointment only.</p>
            </div>
          </template>
        </div>
      </div>
      </template>
    </div>
  </section>
</div>
{% else %}
{% comment %}Server fallback for standalone public profile (non-edit) so locations appear immediately before Alpine loads.{% endcomment %}
{% if standalone and not editable and profile_obj and profile_obj.locations.all %}
<div class="mx-auto w-full max-w-[1200px] px-4 md:px-6" data-server-locations-fallback>
  <section class="tc-section relative p-5 md:p-7 mt-4 md:mt-6 mb-6 md:mb-10 rounded-2xl bg-gradient-to-b from-white/90 to-[#F2FAF9]/90 ring-1 ring-[#BEE3DB] shadow-lg" style="box-shadow:0 6px 28px -10px #25454433;">
    <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4 mb-6">
      <div class="flex flex-col gap-1">
        <h2 class="text-[22px] md:text-[24px] font-extrabold tracking-tight text-[#2e4a49] flex items-center gap-2">
          <svg class="w-6 h-6 text-[#116466]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21s-6-4.686-6-10a6 6 0 1 1 12 0c0 5.314-6 10-6 10Z"/><circle cx="12" cy="11" r="3"/></svg>
          Locations
        </h2>
        <p class="text-[11px] font-medium tracking-wide text-[#587a79] uppercase">Practice Sites & Presence</p>
      </div>
      {% if profile_obj.locations.count > 1 %}
        <div class="flex flex-wrap gap-1.5 text-[9px] font-semibold text-[#116466]">
          <span class="px-2 py-0.5 rounded-full bg-[#E5F4F2] border border-[#BEE3DB]/70">Total: {{ profile_obj.locations.count }}</span>
        </div>
      {% endif %}
    </div>
    <div class="grid gap-6 md:gap-7 {% if profile_obj.locations.count > 1 %}md:grid-cols-2{% endif %}">
      {% for loc in profile_obj.locations.all %}
      <article class="group relative flex flex-col rounded-2xl bg-white/90 ring-1 ring-[#BEE3DB] shadow-md transition overflow-hidden {% if loc.is_primary_address %}border-2 border-[#116466] ring-[#116466]/40{% endif %}" style="box-shadow:0 4px 18px -8px #25454422;">
        <div class="absolute inset-x-0 top-0 h-1.5 bg-gradient-to-r from-[#116466] via-[#89B0AE] to-[#BEE3DB] {% if not loc.is_primary_address %}opacity-0{% endif %}"></div>
        <div class="p-4 md:p-5 flex flex-col gap-4 flex-1">
          <header class="flex flex-col gap-1">
            <h3 class="text-sm md:text-[15px] font-bold tracking-wide text-[#2e4a49] flex flex-wrap items-center gap-2">
              <span>{{ loc.practice_name|default:'Practice Location' }}</span>
              {% if loc.is_primary_address %}
              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-semibold bg-[#116466] text-white">
                <svg class="w-3.5 h-3.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 0 1 0 1.414l-7.364 7.364a1 1 0 0 1-1.414 0L3.293 9.435a1 1 0 0 1 1.414-1.414l3.222 3.221 6.657-6.657a1 1 0 0 1 1.414 0Z" clip-rule="evenodd"/></svg>
                Primary
              </span>
              {% endif %}
            </h3>
            <div class="text-[11px] leading-snug text-[#466867]">
              {% if loc.street_address %}<div>{{ loc.street_address }}{% if loc.address_line_2 %}, {{ loc.address_line_2 }}{% endif %}</div>{% endif %}
              <div>{{ loc.city }}, {{ loc.state }} {{ loc.zip }}</div>
            </div>
          </header>
          <!-- Server fallback map placeholder (will be hydrated by initTherapistLocationMaps) -->
          <div class="relative rounded-xl overflow-hidden ring-1 ring-[#BEE3DB] bg-[#F5FCFB] aspect-[16/10]" id="profile-map-{{ forloop.counter0 }}-wrapper">
            <div id="profile-map-{{ forloop.counter0 }}" class="absolute inset-0"></div>
            <div class="absolute inset-0 flex items-center justify-center text-[10px] text-[#555B6E] bg-gradient-to-br from-[#E5F4F2] via-white to-[#E5F4F2] animate-pulse" data-map-loading data-loading-msg>Loading map...</div>
          </div>
          {% if loc.office_hours.all %}
          <details class="border border-[#BEE3DB] rounded-xl bg-white/60 overflow-hidden">
            <summary class="cursor-pointer px-3 py-2 text-[11px] font-semibold tracking-wide text-[#116466] flex items-center justify-between">
              <span class="flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l2.5 1.5M4 12a8 8 0 1 1 16 0 8 8 0 0 1-16 0Z"/></svg>
                Office Hours
              </span>
              <svg class="w-4 h-4 transition" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6"/></svg>
            </summary>
            <div class="px-4 pt-2 pb-3 text-[11px] text-[#2e4a49] space-y-1">
              {% for oh in loc.office_hours.all %}
              <div class="flex justify-between border-b border-[#BEE3DB]/50 last:border-b-0 py-0.5">
                <span class="font-medium">{{ oh.weekday|weekday_short }}</span>
                <span>
                  {% if oh.is_closed %}Closed{% elif oh.by_appointment_only %}By Appointment{% else %}
                    {{ oh.start_time_1|to_ampm|default:'' }}{% if oh.end_time_1 %} - {{ oh.end_time_1|to_ampm }}{% endif %}
                    {% if oh.start_time_2 %} / {{ oh.start_time_2|to_ampm }}{% if oh.end_time_2 %} - {{ oh.end_time_2|to_ampm }}{% endif %}{% endif %}
                  {% endif %}
                </span>
              </div>
              {% endfor %}
            </div>
          </details>
          {% endif %}
          <div class="mt-4 flex flex-wrap gap-2 text-[10px] font-semibold">
            <a href="https://www.google.com/maps/search/?api=1&query={{ loc.street_address|urlencode }}%2C+{{ loc.city|urlencode }}%2C+{{ loc.state|urlencode }}+{{ loc.zip|urlencode }}" target="_blank" rel="noopener" class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-[#116466] text-white shadow hover:bg-[#0d4c4d]">
              <svg class="w-3.5 h-3.5" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l.563 1.733a1 1 0 0 0 .95.69h1.823c.969 0 1.371 1.24.588 1.81l-1.475 1.072a1 1 0 0 0-.364 1.118l.563 1.733c.3.921-.755 1.688-1.54 1.118l-1.475-1.072a1 1 0 0 0-1.175 0L7.916 13.2c-.784.57-1.838-.197-1.539-1.118l.563-1.733a1 1 0 0 0-.364-1.118L5.101 7.16c-.783-.57-.38-1.81.588-1.81h1.823a1 1 0 0 0 .95-.69l.587-1.733Z"/></svg>
              Open in Maps
            </a>
          </div>
        </div>
      </article>
      {% endfor %}
    </div>
    <div class="mt-8 rounded-2xl bg-[#E5F4F2]/60 ring-1 ring-[#BEE3DB] p-4 text-[10px] md:text-[11px] text-[#466867] flex items-start gap-3">
      <svg class="w-5 h-5 mt-0.5 text-[#116466]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 11.5v4m0 4h.01M12 7h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg>
      <p>(Map markers approximate & may show generalized areas. Confirm exact address with the therapist prior to travel.)</p>
    </div>
  </section>
</div>
{% endif %}
<template x-if="$store.profileModal && $store.profileModal.therapist && $store.profileModal.therapist.locations && $store.profileModal.therapist.locations.length">
  <div class="mx-auto w-full max-w-[1200px] px-4 md:px-6" data-dynamic-locations-wrapper x-data x-init="document.querySelector('[data-server-locations-fallback]')?.remove()">
    <section data-dynamic-locations class="tc-section relative p-5 md:p-7 mt-4 md:mt-6 mb-6 md:mb-10 rounded-2xl bg-gradient-to-b from-white/90 to-[#F2FAF9]/90 ring-1 ring-[#BEE3DB] shadow-lg" style="box-shadow:0 6px 28px -10px #25454433;" x-data="{ mapsInit:false }" x-effect="$store.profileModal && $store.profileModal.show && !$store.profileModal.loading && !mapsInit && (mapsInit=true, $nextTick(()=> window.initTherapistLocationMaps && window.initTherapistLocationMaps()))">
      <!-- Section Header -->
      <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4 mb-6">
        <div class="flex flex-col gap-1">
          <h2 class="text-[22px] md:text-[24px] font-extrabold tracking-tight text-[#2e4a49] flex items-center gap-2">
            <svg class="w-6 h-6 text-[#116466]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21s-6-4.686-6-10a6 6 0 1 1 12 0c0 5.314-6 10-6 10Z"/><circle cx="12" cy="11" r="3"/></svg>
            Locations
          </h2>
          <p class="text-[11px] font-medium tracking-wide text-[#587a79] uppercase">Practice Sites & Presence</p>
        </div>
        <div class="flex flex-wrap gap-1.5 text-[9px] font-semibold text-[#116466]" x-show="$store.profileModal.therapist.locations.length > 1">
          <span class="px-2 py-0.5 rounded-full bg-[#E5F4F2] border border-[#BEE3DB]/70">Total: <span x-text="$store.profileModal.therapist.locations.length"></span></span>
          <template x-if="$store.profileModal.therapist.locations.filter(l=>l.is_primary_address).length">
            <span class="px-2 py-0.5 rounded-full bg-[#116466] text-white border border-[#0d4c4d]">Primary Listed</span>
          </template>
        </div>
      </div>
      <!-- Locations Grid -->
      <div class="grid gap-6 md:gap-7" :class="$store.profileModal.therapist.locations.length > 1 ? 'md:grid-cols-2' : ''">
        <template x-for="(loc, idx) in $store.profileModal.therapist.locations" :key="(loc.practice_name||'') + (loc.city||'') + (loc.state||'') + (loc.zip||'') + idx">
          <article class="group relative flex flex-col rounded-2xl bg-white/90 ring-1 ring-[#BEE3DB] shadow-md hover:shadow-xl transition overflow-hidden" :class="loc.is_primary_address ? 'border-2 border-[#116466] ring-[#116466]/40' : ''" x-data="tcHoursHelper()">
            <!-- Accent bar -->
            <div class="absolute inset-x-0 top-0 h-1.5 bg-gradient-to-r from-[#116466] via-[#89B0AE] to-[#BEE3DB] opacity-0 group-hover:opacity-100 transition" :class="loc.is_primary_address ? 'opacity-100' : ''"></div>
            <div class="p-4 md:p-5 flex flex-col gap-4 flex-1">
              <!-- Title & Badges -->
              <header class="flex flex-col gap-1">
                <h3 class="text-sm md:text-[15px] font-bold tracking-wide text-[#2e4a49] flex flex-wrap items-center gap-2">
                  <span x-text="loc.practice_name || 'Practice Location'"></span>
                  <template x-if="loc.is_primary_address">
                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-semibold bg-[#116466] text-white">
                      <svg class="w-3.5 h-3.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 0 1 0 1.414l-7.364 7.364a1 1 0 0 1-1.414 0L3.293 9.435a1 1 0 0 1 1.414-1.414l3.222 3.221 6.657-6.657a1 1 0 0 1 1.414 0Z" clip-rule="evenodd"/></svg>
                      Primary
                    </span>
                  </template>
                </h3>
                <div class="text-[11px] leading-snug text-[#466867]">
                  <div x-text="[loc.street_address, loc.address_line_2].filter(Boolean).join(', ')"></div>
                  <div x-text="[loc.city, loc.state, loc.zip].filter(Boolean).join(', ')"></div>
                </div>
              </header>
              <!-- Map -->
              <div class="relative rounded-xl overflow-hidden ring-1 ring-[#BEE3DB] bg-[#F5FCFB] aspect-[16/10]" x-data="{ failed:false, t:null }" x-init="t=setTimeout(()=>{ if(!loc.lat || !loc.lng) failed=true },4500)" @alpine:destroy="clearTimeout(t)">
                <!-- Loading shimmer -->
                <div class="absolute inset-0 animate-pulse bg-gradient-to-br from-[#E5F4F2] via-white to-[#E5F4F2]" x-show="!failed && (!loc.lat || !loc.lng)"></div>
                <!-- Map root -->
                <div class="absolute inset-0" :id="'profile-map-' + idx" x-show="!failed"></div>
                <!-- Fallback placeholder if map fails/slow -->
                <div class="absolute inset-0 flex flex-col items-center justify-center gap-2 text-[#466867] text-[10px]" x-show="failed">
                  <div class="w-12 h-12 rounded-full bg-[#E5F4F2] flex items-center justify-center ring-1 ring-[#BEE3DB]">
                    <svg class="w-6 h-6 text-[#89B0AE]" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21s-6-4.686-6-10a6 6 0 1 1 12 0c0 5.314-6 10-6 10Z"/><circle cx="12" cy="11" r="3"/></svg>
                  </div>
                  <span class="font-medium">Map unavailable</span>
                  <button type="button" class="px-2 py-0.5 rounded-full bg-white border border-[#BEE3DB] text-[9px] font-semibold hover:bg-[#E5F4F2]" @click="failed=false; clearTimeout(t); t=setTimeout(()=>{ if(!loc.lat || !loc.lng) failed=true },4500); window.initTherapistLocationMaps && window.initTherapistLocationMaps();">Retry</button>
                </div>
                <div class="absolute bottom-1 right-1 text-[9px] px-2 py-0.5 rounded-full bg-white/80 backdrop-blur border border-[#BEE3DB] text-[#116466] font-semibold" x-show="loc.lat && loc.lng && !failed" x-text="(loc.lat && loc.lat.toFixed ? loc.lat.toFixed(2) : loc.lat) + ', ' + (loc.lng && loc.lng.toFixed ? loc.lng.toFixed(2) : loc.lng)"></div>
              </div>
              <!-- Hours & Actions -->
              <div class="mt-1 flex flex-col gap-3">
                <template x-if="loc.office_hours && loc.office_hours.length">
                  <div x-data="{ open:false }" class="border border-[#BEE3DB] rounded-xl bg-white/60 overflow-hidden">
                    <button type="button" @click="open=!open" class="w-full flex items-center justify-between px-3 py-2 text-[11px] font-semibold tracking-wide text-[#116466] hover:bg-[#E5F4F2] transition">
                      <span class="flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l2.5 1.5M4 12a8 8 0 1 1 16 0 8 8 0 0 1-16 0Z"/></svg>
                        Office Hours
                      </span>
                      <svg class="w-4 h-4 transform transition" :class="open ? 'rotate-180' : ''" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6"/></svg>
                    </button>
                    <div x-show="open" x-transition:enter="transition-all ease-out duration-250" x-transition:enter-start="opacity-0 -translate-y-1" x-transition:enter-end="opacity-100 translate-y-0" x-transition:leave="transition-all ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0" x-transition:leave-end="opacity-0 -translate-y-1" x-data="{ h:null }" x-init="h=$el.scrollHeight" @resize.window="h=$el.scrollHeight" class="px-4 pt-2 pb-3" style="overflow:hidden;">
                      <div class="grid grid-cols-1 gap-1 text-[11px] leading-snug">
                        <template x-for="oh in loc.office_hours" :key="oh.weekday">
                          <div class="flex justify-between py-0.5 border-b border-[#BEE3DB]/50 last:border-b-0" x-show="oh">
                            <span class="font-medium text-[#555B6E]" x-text="weekdayNames[oh.weekday] || oh.weekday"></span>
                            <span class="text-[#116466] text-right" x-text="fmt(oh)"></span>
                          </div>
                        </template>
                      </div>
                    </div>
                  </div>
                </template>
                <div class="flex flex-wrap gap-3 text-[11px]">
                  <a :href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent([loc.street_address, loc.city, loc.state, loc.zip].filter(Boolean).join(', '))" target="_blank" rel="noopener" class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-[#116466] text-white font-semibold shadow hover:bg-[#0d4c4d] transition">
                    <svg class="w-3.5 h-3.5" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l.563 1.733a1 1 0 0 0 .95.69h1.823c.969 0 1.371 1.24.588 1.81l-1.475 1.072a1 1 0 0 0-.364 1.118l.563 1.733c.3.921-.755 1.688-1.54 1.118l-1.475-1.072a1 1 0 0 0-1.175 0L7.916 13.2c-.784.57-1.838-.197-1.539-1.118l.563-1.733a1 1 0 0 0-.364-1.118L5.101 7.16c-.783-.57-.38-1.81.588-1.81h1.823a1 1 0 0 0 .95-.69l.587-1.733Z"/></svg>
                    Open in Maps
                  </a>
                </div>
              </div>
            </div>
          </article>
        </template>
      </div>
      <!-- Disclaimer -->
      <div class="mt-8 rounded-2xl bg-[#E5F4F2]/60 ring-1 ring-[#BEE3DB] p-4 text-[10px] md:text-[11px] text-[#466867] flex items-start gap-3">
        <svg class="w-5 h-5 mt-0.5 text-[#116466]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 11.5v4m0 4h.01M12 7h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg>
        <p>(Map markers approximate & may show generalized areas. Confirm exact address with the therapist prior to travel.)</p>
      </div>
      <!-- Hours Helper (unchanged logic) -->
      <script>
      window.tcHoursHelper = window.tcHoursHelper || function tcHoursHelper(){
        return {
          weekdayNames:['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],
          to12(t){
            if(!t) return '';
            const parts=(t+'').split(':');
            const h=parseInt(parts[0]);
            const m=parseInt(parts[1]||'0');
            if(isNaN(h)||isNaN(m)) return '';
            const ampm = h>=12 ? 'PM':'AM';
            const hr = ((h + 11) % 12) + 1;
            return hr + ':' + String(m).padStart(2,'0') + ' ' + ampm;
          },
          fmt(interval){
            if(!interval) return '';
            const {is_closed,by_appointment_only,start_time_1,end_time_1,start_time_2,end_time_2,notes} = interval;
            if(by_appointment_only) return 'By appointment';
            if(is_closed) return 'Closed';
            const seg = (a,b)=> (a && b) ? (this.to12(a) + ' - ' + this.to12(b)) : '';
            const seg1 = seg(start_time_1,end_time_1);
            const seg2 = seg(start_time_2,end_time_2);
            const core = [seg1,seg2].filter(Boolean).join(', ');
            return core + (notes ? (' ('+notes+')') : '');
          }
        }
      };
      window.tcTimePicker = window.tcTimePicker || function tcTimePicker(row, start){
        return {
          row,start, open:false, query:'',
          options: Array.from({length: 24*4}, (_,i)=>{ // 15 min increments
            const totalMinutes = i*15;
            const h = Math.floor(totalMinutes/60);
            const m = totalMinutes%60;
            const v = String(h).padStart(2,'0')+ ':' + String(m).padStart(2,'0');
            const hr12 = ((h + 11) % 12) + 1;
            const ampm = h>=12 ? 'PM':'AM';
            const l = hr12 + ':' + String(m).padStart(2,'0') + ' ' + ampm;
            return {v,l};
          }),
          label(){ return this.row[this.start] ? this.toLabel(this.row[this.start]) : 'Select time'; },
            toLabel(v){ if(!v) return ''; const [h,m] = v.split(':').map(n=>parseInt(n)); const hr12 = ((h + 11) % 12) + 1; const ampm = h>=12? 'PM':'AM'; return hr12 + ':' + String(m).padStart(2,'0') + ' ' + ampm; },
          toggle(){ this.open=!this.open; if(this.open){ this.$nextTick(()=>{ const el=this.$el.querySelector('input'); el && el.focus(); }); }},
          select(v){ this.row[this.start]=v; this.open=false; },
          clear(){ this.row[this.start]=''; this.query=''; },
          quick(v){ this.select(v); },
          filtered(){ const q=this.query.trim().toLowerCase(); if(!q) return this.options; return this.options.filter(o=> o.l.toLowerCase().includes(q) || o.v.startsWith(q)); }
        }
      };
      </script>
    </section>
  </div>
</template>
{% endif %}
