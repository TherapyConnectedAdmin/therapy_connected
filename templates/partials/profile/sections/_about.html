{# Clean About Me Section (statements, gallery, video) - now styled like Identity section #}
<div class="mx-auto w-full max-w-[1200px] px-4 md:px-6">
  <section id="section-about" class="tc-section relative overflow-hidden mt-4 md:mt-6 mb-6 md:mb-8 rounded-2xl ring-1 ring-[#BEE3DB] bg-white/90 shadow" style="box-shadow:0 6px 26px -8px #555B6E33;"
           x-data="{ editable: {{ editable|default:0|yesno:'true,false' }}, standalone: {{ standalone|default:0|yesno:'true,false' }} }"
           x-show="editable || (standalone ? ($store.profileModal.therapist.personal_statement_q1 || $store.profileModal.therapist.personal_statement_q2 || $store.profileModal.therapist.personal_statement_q3 || ($store.profileModal.therapist.gallery_images && $store.profileModal.therapist.gallery_images.length) || ($store.profileModal.therapist.video_gallery && $store.profileModal.therapist.video_gallery.length)) : ($store.profileModal.therapist.personal_statement_q1 || $store.profileModal.therapist.personal_statement_q2 || $store.profileModal.therapist.personal_statement_q3 || ($store.profileModal.therapist.gallery_images && $store.profileModal.therapist.gallery_images.length) || ($store.profileModal.therapist.video_gallery && $store.profileModal.therapist.video_gallery.length)))"
           x-cloak>
  {% if standalone %}
  <div class="pointer-events-none absolute inset-0 opacity-45 mix-blend-normal z-0 bg-[radial-gradient(circle_at_22%_18%,#E5F4F2,transparent_55%),radial-gradient(circle_at_82%_74%,#FFDDD0,transparent_62%)]"></div>
  {% endif %}
  <div class="relative z-10 p-4 md:p-6 flex flex-col gap-8">
      {# Always use modal body when editable so video manager + edit UIs present #}
      {% if editable %}
        {% include 'partials/profile/sections/_about_modal_body.html' %}
      {% elif standalone %}
        {% include 'partials/profile/sections/_about_standalone_body.html' %}
      {% else %}
        {% include 'partials/profile/sections/_about_modal_body.html' %}
      {% endif %}
    </div>
  </section>
</div>

<!-- Fallback JS definitions (only if not already present from full edit page) -->
<script>
if(typeof galleryManager !== 'function'){
  function galleryManager(){
    const csrf = window.TC_CSRF;
    return {
      images:(Alpine.store('profileModal')?.therapist?.gallery_images||[]).slice(), file:null, caption:'', is_primary:false, uploading:false, progress:0, error:'', drag:false,
      // delete modal state
      confirm:{ show:false, target:null, deleting:false, error:''},
      onFile(e){ this.file=e.target.files[0]; },
      onDrop(ev){ this.drag=false; const f=ev.dataTransfer?.files?.[0]; if(f) this.file=f; },
      reset(){ this.file=null; this.caption=''; this.is_primary=false; this.progress=0; this.error=''; if(this.$refs.file) this.$refs.file.value=''; },
      upload(){ if(!this.file) return; if(this.images.length>=12){ this.error='Maximum 12 images.'; return;} this.error=''; this.uploading=true; const form=new FormData(); form.append('file',this.file); if(this.caption) form.append('caption',this.caption); if(this.is_primary) form.append('is_primary','1'); fetch('/users/api/profile/gallery/upload/',{method:'POST',headers:{'X-CSRFToken':csrf},body:form}).then(r=>r.json().then(d=>[r,d])).then(([r,d])=>{ if(!r.ok){ this.error=d.error||'Upload failed'; return;} this.images=d.gallery_images||[]; const s=Alpine.store('profileModal'); if(s?.therapist) s.therapist.gallery_images=this.images; this.reset(); }).catch(()=> this.error='Network error').finally(()=> this.uploading=false); },
      saveMeta(img){ fetch('/users/api/profile/gallery/'+img.id+'/',{method:'PATCH',headers:{'Content-Type':'application/json','X-CSRFToken':csrf},body:JSON.stringify({caption:img.caption})}).then(r=>r.json().then(d=>[r,d])).then(([r,d])=>{ if(!r.ok){ this.error=d.error||'Save failed'; return;} this.images=d.gallery_images||[]; const s=Alpine.store('profileModal'); if(s?.therapist) s.therapist.gallery_images=this.images; }).catch(()=> this.error='Network error'); },
      setPrimary(img){ if(img.is_primary) return; fetch('/users/api/profile/gallery/'+img.id+'/',{method:'PATCH',headers:{'Content-Type':'application/json','X-CSRFToken':csrf},body:JSON.stringify({is_primary:true})}).then(r=>r.json().then(d=>[r,d])).then(([r,d])=>{ if(!r.ok){ this.error=d.error||'Update failed'; return;} this.images=d.gallery_images||[]; const s=Alpine.store('profileModal'); if(s?.therapist) s.therapist.gallery_images=this.images; }).catch(()=> this.error='Network error'); },
      openDelete(img){ this.confirm.show=true; this.confirm.target=img; this.confirm.deleting=false; this.confirm.error=''; setTimeout(()=>{ const modal=document.querySelector('[data-gallery-delete-modal]'); if(modal && modal.style.display==='none' && this.confirm.show){ modal.style.display='flex'; } }, 10); },
      cancelDelete(force=false){ if(this.confirm.deleting && !force) return; this.confirm.show=false; this.confirm.target=null; this.confirm.deleting=false; this.confirm.error=''; },
      confirmDeleteAction(){ const img=this.confirm.target; if(!img || this.confirm.deleting) return; this.confirm.deleting=true; fetch('/users/api/profile/gallery/'+img.id+'/',{method:'DELETE',headers:{'X-CSRFToken':csrf}})
        .then(r=>r.json().then(d=>[r,d]))
        .then(([r,d])=>{ if(!r.ok){ this.confirm.error=d.error||'Delete failed'; return;} this.images=d.gallery_images||[]; const s=Alpine.store('profileModal'); if(s?.therapist) s.therapist.gallery_images=this.images; this.cancelDelete(true); })
        .catch(()=> this.confirm.error='Network error')
        .finally(()=> this.confirm.deleting=false); },
      // legacy remove alias
      remove(img){ this.openDelete(img); }
    }; }
}
if(typeof videoManager !== 'function'){
  function videoManager(){
    const csrf=window.TC_CSRF;
  return { video:(Alpine.store('profileModal')?.therapist?.video_gallery||[])[0]||null, file:null, caption:'', uploading:false, progress:0, error:'', recording:false, mediaRecorder:null, chunks:[], stream:null, drag:false, chosenType:null, trackFailed:false, videoLoadError:false,
      reset(){
        if(this.recording){ this.stopRecording(); }
        this.stopStream();
        if(this.previewUrl){ try{ URL.revokeObjectURL(this.previewUrl); }catch(_){} }
        this.previewUrl=null; this.file=null; this.chunks=[]; this.chosenType=null; this.trackFailed=false;
        this.error=''; this.progress=0; this.caption='';
        if(this.$refs.file) this.$refs.file.value='';
      },
      onFile(e){ this.file=e.target.files[0]; },
      handleTrackFailure(msg){ if(this.recording){ this.error=msg||'Camera stream ended unexpectedly'; this.trackFailed=true; } },
      startRecording(){
        if(!navigator.mediaDevices?.getUserMedia){ this.error='Recording not supported'; return; }
        this.error=''; this.file=null; this.chunks=[]; this.chosenType=null; this.trackFailed=false;
        navigator.mediaDevices.getUserMedia({video:true,audio:true}).then(str=>{
          this.stream=str;
          const candidates=[
            'video/mp4;codecs=avc1.42E01E,mp4a.40.2',
            'video/mp4',
            'video/webm;codecs=vp9,opus',
            'video/webm;codecs=vp8,opus',
            'video/webm'
          ];
            let chosen=null;
            if(window.MediaRecorder && MediaRecorder.isTypeSupported){
              chosen=candidates.find(t=>{ try { return MediaRecorder.isTypeSupported(t); } catch(_) { return false; } })||null;
            }
            this.chosenType=chosen;
            // Track listeners
            str.getTracks().forEach(tr=>{
              tr.addEventListener('ended', ()=> this.handleTrackFailure('Camera stopped (ended)'));
            });
            try { this.mediaRecorder = chosen ? new MediaRecorder(str,{mimeType:chosen}) : new MediaRecorder(str); }
            catch(e){ try{ this.mediaRecorder=new MediaRecorder(str); } catch(e2){ this.error='Unable to start recorder'; this.stopStream(); return; } }
            this.chunks=[];
            this.mediaRecorder.ondataavailable=ev=>{ if(ev.data?.size>0) this.chunks.push(ev.data); };
            this.mediaRecorder.onstop=()=>{ const type=this.chosenType || (this.mediaRecorder && this.mediaRecorder.mimeType) || 'video/webm'; const ext=/mp4/.test(type)?'mp4':'webm'; const blob=new Blob(this.chunks,{type}); this.file=new File([blob],'recording.'+ext,{type}); this.stopStream(); };
            try { this.mediaRecorder.start(); } catch(e){ this.error='Recorder start failed'; this.stopStream(); return; }
            this.recording=true;
        }).catch(()=> this.error='Permission denied');
      },
      stopRecording(){ if(this.mediaRecorder && this.recording){ this.mediaRecorder.stop(); this.recording=false; } },
      stopStream(){ this.stream?.getTracks().forEach(t=>t.stop()); this.stream=null; },
      upload(){ if(!this.file){ this.error='No video selected'; return;} this.error=''; this.uploading=true; const form=new FormData(); form.append('file',this.file); if(this.caption) form.append('caption',this.caption); fetch('/users/api/profile/video/',{method:'POST',headers:{'X-CSRFToken':csrf},body:form}).then(r=>r.json().then(d=>[r,d])).then(([r,d])=>{ if(!r.ok){ this.error=d.error||'Upload failed'; return;} const s=Alpine.store('profileModal'); if(s?.therapist) s.therapist.video_gallery=d.video_gallery||[]; this.video=(d.video_gallery||[])[0]||null; this.reset(); }).catch(()=> this.error='Network error').finally(()=> this.uploading=false); },
      updateCaption(){ if(!this.video) return; fetch('/users/api/profile/video/',{method:'PATCH',headers:{'Content-Type':'application/json','X-CSRFToken':csrf},body:JSON.stringify({caption:this.video.caption||''})}).then(r=>r.json().then(d=>[r,d])).then(([r,d])=>{ if(!r.ok){ this.error=d.error||'Save failed'; return;} const s=Alpine.store('profileModal'); if(s?.therapist) s.therapist.video_gallery=d.video_gallery||[]; this.video=(d.video_gallery||[])[0]||null; }).catch(()=> this.error='Network error'); },
      remove(){ if(!this.video || !confirm('Delete video?')) return; fetch('/users/api/profile/video/',{method:'DELETE',headers:{'X-CSRFToken':csrf}}).then(r=>r.json().then(d=>[r,d])).then(([r,d])=>{ if(!r.ok){ this.error=d.error||'Delete failed'; return;} const s=Alpine.store('profileModal'); if(s?.therapist) s.therapist.video_gallery=d.video_gallery||[]; this.video=null; }).catch(()=> this.error='Network error'); }
    }; }
}
</script>
