{# Qualifications & Education section (edit page only) #}
<div id="section-qualifications" class="tc-section p-4 md:p-5 md:col-span-2 mb-6 md:mb-8" x-data="qualificationsManager()" x-init="init()" x-cloak>
  <div class="flex items-start justify-between mb-4">
    <h3 class="text-2xl md:text-[25px] font-semibold tracking-tight text-[#555B6E]">Qualifications &amp; Education</h3>
  </div>
  <div class="text-sm text-[#555B6E] space-y-8">
    {# License Editor #}
    <div x-data="{ editing:false, showLicenseNameOverride:false, form:{ license_type:'', license_number:'', license_state:'', license_expiration:'', license_first_name:'', license_last_name:'' }, states:['AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'], init(){ this.sync(); }, sync(){ const t=$store.profileModal.therapist||{}; this.form.license_type=t.license_type||''; this.form.license_number=t.license_number||''; this.form.license_state=t.license_state||''; this.form.license_expiration=t.license_expiration||''; this.form.license_first_name=t.license_first_name||''; this.form.license_last_name=t.license_last_name||''; this.showLicenseNameOverride = !!(this.form.license_first_name || this.form.license_last_name); }, save(){ if(this.saving) return; this.error=''; const payload={}; for(const k in this.form){ if(this.form[k]!==($store.profileModal.therapist[k]||'')) payload[k]=this.form[k]; } if(!this.showLicenseNameOverride){ if(this.form.license_first_name || this.form.license_last_name){ this.form.license_first_name=''; this.form.license_last_name=''; payload.license_first_name=''; payload.license_last_name=''; } } if(Object.keys(payload).length===0){ this.editing=false; return; } this.saving=true; fetch('/users/api/profile/update/', {method:'PATCH', headers:{'Content-Type':'application/json','X-CSRFToken': TC_CSRF}, body: JSON.stringify(payload)}).then(r=>r.json().then(d=>[r,d])).then(([r,d])=>{ if(!r.ok){ this.error=(d.errors && Object.values(d.errors)[0]) || d.error || 'Save failed'; return; } if(window.__profileEdit){ window.__profileEdit.applyData(d); window.__profileEdit.notify('Saved'); } this.editing=false; this.sync(); }).catch(()=> this.error='Network error').finally(()=> this.saving=false); }, cancel(){ this.editing=false; this.sync(); }, editing:false, error:'', saving:false, differentName(){ const t=$store.profileModal.therapist||{}; return this.showLicenseNameOverride || ( (t.first_name||'').trim() !== (t.license_first_name||'').trim() ) || ( (t.last_name||'').trim() !== (t.license_last_name||'').trim() ); } }" class="space-y-2">
      <div class="flex items-center justify-between">
        <div class="font-semibold text-[#116466]">Professional License</div>
        <div class="flex items-center gap-2" x-show="!editing">
          <button type="button" @click="editing=true" class="px-3 py-1.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[11px] font-semibold text-[#116466] hover:bg-[#E5F4F2]">Edit</button>
        </div>
      </div>
      <div x-show="!editing" class="text-[#2e4a49] text-sm space-y-0.5">
        <p>
          <span x-text="$store.profileModal.therapist.license_type || '—'"></span>
          <span x-show="$store.profileModal.therapist.license_number"> • <span x-text="$store.profileModal.therapist.license_number"></span></span>
          <span class="opacity-70" x-show="$store.profileModal.therapist.license_state"> (<span x-text="$store.profileModal.therapist.license_state"></span>)</span>
        </p>
        <p class="text-[11px] text-[#555B6E]/70" x-show="$store.profileModal.therapist.license_expiration">Expires <span x-text="$store.profileModal.therapist.license_expiration"></span></p>
        <template x-if="$store.profileModal.therapist.license_first_name || $store.profileModal.therapist.license_last_name">
          <p class="text-[11px] text-[#555B6E]/80">Licensed As: <span x-text="$store.profileModal.therapist.license_first_name || $store.profileModal.therapist.first_name"></span> <span x-text="$store.profileModal.therapist.license_last_name || $store.profileModal.therapist.last_name"></span></p>
        </template>
      </div>
      <form x-show="editing" @submit.prevent="save()" class="bg-white/60 rounded-lg p-3 ring-1 ring-[#BEE3DB] space-y-3">
        <div class="grid md:grid-cols-6 gap-3">
          <div class="md:col-span-2">
            <label class="block text-[11px] font-semibold mb-1">License Type</label>
            <button type="button" @click="$dispatch('edit-select',{field:'license_type', value: form.license_type, el:$el})" class="w-full text-left border border-[#BEE3DB] rounded-md px-2 py-1.5 text-[13px] bg-white hover:bg-[#F5F4F3]" x-text="form.license_type || 'Select License Type'"></button>
          </div>
          <div>
            <label class="block text-[11px] font-semibold mb-1">Number</label>
            <input type="text" x-model="form.license_number" maxlength="32" class="w-full border border-[#BEE3DB] rounded-md px-2 py-1.5 text-sm focus:border-[#116466] focus:ring-[#116466]" />
          </div>
          <div>
            <label class="block text-[11px] font-semibold mb-1">State</label>
            <div class="relative">
              <select x-model="form.license_state" class="w-full appearance-none border border-[#BEE3DB] rounded-md px-3 pr-9 py-2 text-[13px] leading-tight bg-white text-[#2e4a49] focus:outline-none focus:border-[#116466] focus:ring-2 focus:ring-[#116466]/30 uppercase transition shadow-sm">
                <option value="">--</option>
                <template x-for="st in states" :key="st">
                  <option :value="st" x-text="st"></option>
                </template>
              </select>
              <div class="pointer-events-none absolute inset-y-0 right-2 flex items-center">
                <svg class="w-4 h-4 text-[#116466] opacity-80" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6"/></svg>
              </div>
            </div>
          </div>
          <div>
            <label class="block text-[11px] font-semibold mb-1">Expiration (MM/YYYY)</label>
            <input type="text" x-model="form.license_expiration" maxlength="7" placeholder="08/2026" class="w-full border border-[#BEE3DB] rounded-md px-2 py-1.5 text-sm focus:border-[#116466] focus:ring-[#116466]" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-[11px] font-semibold mb-1" x-text="(() => { const fn=$store.profileModal.therapist.first_name||''; const ln=$store.profileModal.therapist.last_name||''; const full=[fn,ln].filter(Boolean).join(' '); return 'Name On License Matches Profile' + (full ? ' ('+ full +')' : '') + '?'; })()"></label>
            <div class="flex items-center gap-3 text-[11px]">
              <label class="inline-flex items-center gap-1"><input type="radio" name="licname" :checked="!showLicenseNameOverride" @change="showLicenseNameOverride=false; form.license_first_name=''; form.license_last_name='';" class="accent-[#116466]" /> <span>Yes</span></label>
              <label class="inline-flex items-center gap-1"><input type="radio" name="licname" :checked="showLicenseNameOverride" @change="showLicenseNameOverride=true; if(!(form.license_first_name||form.license_last_name)){ form.license_first_name=''; form.license_last_name=''; }" class="accent-[#116466]" /> <span>No</span></label>
            </div>
          </div>
          <template x-if="showLicenseNameOverride">
            <div class="md:col-span-3 flex gap-3">
              <div class="flex-1">
                <label class="block text-[11px] font-semibold mb-1">Licensed First Name</label>
                <input type="text" x-model="form.license_first_name" :placeholder="$store.profileModal.therapist.first_name || 'First'" maxlength="64" class="w-full border border-[#BEE3DB] rounded-md px-2 py-1.5 text-sm focus:border-[#116466] focus:ring-[#116466]" />
              </div>
              <div class="flex-1">
                <label class="block text-[11px] font-semibold mb-1">Licensed Last Name</label>
                <input type="text" x-model="form.license_last_name" :placeholder="$store.profileModal.therapist.last_name || 'Last'" maxlength="64" class="w-full border border-[#BEE3DB] rounded-md px-2 py-1.5 text-sm focus:border-[#116466] focus:ring-[#116466]" />
              </div>
            </div>
          </template>
        </div>
        <div class="flex items-center gap-2 pt-1">
          <button type="submit" :disabled="saving" class="px-3 py-1.5 rounded-full bg-[#116466] text-white text-[11px] font-semibold disabled:opacity-40" x-text="saving ? 'Saving…' : 'Save License'"></button>
          <button type="button" @click="cancel()" class="px-3 py-1.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[11px] font-medium hover:bg-[#E5F4F2]">Cancel</button>
          <p class="text-[11px] text-[#9b4d49]" x-show="error" x-text="error"></p>
        </div>
      </form>
    </div>

    {# Additional Credentials #}
    <div>
      <div class="flex items-center justify-between mb-2">
        <div class="font-semibold text-[#116466]">Additional Credentials</div>
        <div class="flex items-center gap-2" x-show="!addingCredential && !addingEducation">
          <button type="button" @click="startAddCredential()" class="px-3 py-1.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[11px] font-semibold text-[#116466] hover:bg-[#E5F4F2]">Add Credential</button>
        </div>
      </div>
      <template x-if="!($store.profileModal.therapist.additional_credentials && $store.profileModal.therapist.additional_credentials.length)">
        <p class="text-xs italic text-[#89B0AE]">No credentials added.</p>
      </template>
      <ul class="space-y-1 text-sm" x-show="$store.profileModal.therapist.additional_credentials && $store.profileModal.therapist.additional_credentials.length">
        <template x-for="c in $store.profileModal.therapist.additional_credentials" :key="c.id">
          <li class="group flex flex-wrap items-center gap-1 px-2 py-1 rounded-md hover:bg-[#F5F4F3]">
            <span class="font-medium" x-text="c.type || 'Credential'"></span>
            <span class="opacity-70">—</span>
            <span x-text="c.organization_name"></span>
            <span x-show="c.id_number">(<span x-text="c.id_number"></span>)</span>
            <span class="opacity-70" x-show="c.year_issued">,</span>
            <span x-text="c.year_issued"></span>
            <button type="button" @click="editCredential(c)" class="opacity-0 group-hover:opacity-100 ml-2 text-[10px] px-2 py-0.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[#116466] hover:bg-[#E5F4F2]">Edit</button>
            <button type="button" @click="deleteCredential(c)" class="opacity-0 group-hover:opacity-100 text-[10px] px-2 py-0.5 rounded-full bg-white ring-1 ring-[#FFB3A8] text-[#9b4d49] hover:bg-[#FFE8E5]">Delete</button>
          </li>
        </template>
      </ul>
      <form x-show="addingCredential" @submit.prevent="saveCredential()" class="mt-3 space-y-3 bg-white/60 rounded-lg p-3 ring-1 ring-[#BEE3DB]">
        <div class="grid md:grid-cols-4 gap-3">
          <div class="md:col-span-2">
            <label class="block text-[11px] font-semibold mb-1">Organization</label>
            <input type="text" x-model="credForm.organization_name" maxlength="64" class="w-full border border-[#BEE3DB] rounded-md px-2 py-1.5 text-sm focus:border-[#116466] focus:ring-[#116466]" required />
          </div>
          <div>
            <label class="block text-[11px] font-semibold mb-1">Type</label>
            <input type="text" x-model="credForm.type" maxlength="16" class="w-full border border-[#BEE3DB] rounded-md px-2 py-1.5 text-sm focus:border-[#116466] focus:ring-[#116466]" placeholder="Membership" />
          </div>
          <div>
            <label class="block text-[11px] font-semibold mb-1">Year Issued</label>
            <input type="text" x-model="credForm.year_issued" maxlength="4" class="w-full border border-[#BEE3DB] rounded-md px-2 py-1.5 text-sm focus:border-[#116466] focus:ring-[#116466]" required />
          </div>
          <div>
            <label class="block text-[11px] font-semibold mb-1">ID Number</label>
            <input type="text" x-model="credForm.id_number" maxlength="32" class="w-full border border-[#BEE3DB] rounded-md px-2 py-1.5 text-sm focus:border-[#116466] focus:ring-[#116466]" />
          </div>
        </div>
        <div class="flex items-center gap-2 pt-1">
          <button type="submit" :disabled="saving" class="px-3 py-1.5 rounded-full bg-[#116466] text-white text-[11px] font-semibold disabled:opacity-40" x-text="credForm.id ? 'Update Credential' : 'Add Credential'"></button>
          <button type="button" @click="cancelCredential()" class="px-3 py-1.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[11px] font-medium hover:bg-[#E5F4F2]">Cancel</button>
          <p class="text-[11px] text-[#9b4d49]" x-show="error" x-text="error"></p>
        </div>
      </form>
    </div>

    {# Education History #}
    <div>
      <div class="flex items-center justify-between mb-2">
        <div class="font-semibold text-[#116466]">Education</div>
        <div class="flex items-center gap-2" x-show="!addingEducation && !addingCredential">
          <button type="button" @click="startAddEducation()" class="px-3 py-1.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[11px] font-semibold text-[#116466] hover:bg-[#E5F4F2]">Add Education</button>
        </div>
      </div>
      <template x-if="!($store.profileModal.therapist.educations && $store.profileModal.therapist.educations.length)">
        <p class="text-xs italic text-[#89B0AE]">No education records added.</p>
      </template>
      <ul class="space-y-1 text-sm" x-show="$store.profileModal.therapist.educations && $store.profileModal.therapist.educations.length">
        <template x-for="e in $store.profileModal.therapist.educations" :key="e.id">
          <li class="group flex flex-wrap items-center gap-1 px-2 py-1 rounded-md hover:bg-[#F5F4F3]">
            <span class="font-medium" x-text="e.degree_diploma"></span>
            <span class="opacity-70">—</span>
            <span x-text="e.school"></span>
            <span class="opacity-70" x-show="e.year_graduated">(<span x-text="e.year_graduated"></span>)</span>
            <span class="text-[11px] ml-1 opacity-60" x-show="e.year_began_practice">• Began Practice <span x-text="e.year_began_practice"></span></span>
            <button type="button" @click="editEducation(e)" class="opacity-0 group-hover:opacity-100 ml-2 text-[10px] px-2 py-0.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[#116466] hover:bg-[#E5F4F2]">Edit</button>
            <button type="button" @click="deleteEducation(e)" class="opacity-0 group-hover:opacity-100 text-[10px] px-2 py-0.5 rounded-full bg-white ring-1 ring-[#FFB3A8] text-[#9b4d49] hover:bg-[#FFE8E5]">Delete</button>
          </li>
        </template>
      </ul>
      <form x-show="addingEducation" @submit.prevent="saveEducation()" class="mt-3 space-y-3 bg-white/60 rounded-lg p-3 ring-1 ring-[#BEE3DB]">
        <div class="grid md:grid-cols-5 gap-3">
          <div class="md:col-span-2">
            <label class="block text-[11px] font-semibold mb-1">School</label>
            <input type="text" x-model="eduForm.school" maxlength="64" class="w-full border border-[#BEE3DB] rounded-md px-2 py-1.5 text-sm focus:border-[#116466] focus:ring-[#116466]" required />
          </div>
          <div>
            <label class="block text-[11px] font-semibold mb-1">Degree</label>
            <input type="text" x-model="eduForm.degree_diploma" maxlength="32" class="w-full border border-[#BEE3DB] rounded-md px-2 py-1.5 text-sm focus:border-[#116466] focus:ring-[#116466]" required />
          </div>
          <div>
            <label class="block text-[11px] font-semibold mb-1">Year Graduated</label>
            <input type="text" x-model="eduForm.year_graduated" maxlength="4" class="w-full border border-[#BEE3DB] rounded-md px-2 py-1.5 text-sm focus:border-[#116466] focus:ring-[#116466]" required />
          </div>
          <div>
            <label class="block text-[11px] font-semibold mb-1">Year Began Practice</label>
            <input type="text" x-model="eduForm.year_began_practice" maxlength="4" class="w-full border border-[#BEE3DB] rounded-md px-2 py-1.5 text-sm focus:border-[#116466] focus:ring-[#116466]" />
          </div>
        </div>
        <div class="flex items-center gap-2 pt-1">
          <button type="submit" :disabled="saving" class="px-3 py-1.5 rounded-full bg-[#116466] text-white text-[11px] font-semibold disabled:opacity-40" x-text="eduForm.id ? 'Update Education' : 'Add Education'"></button>
          <button type="button" @click="cancelEducation()" class="px-3 py-1.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[11px] font-medium hover:bg-[#E5F4F2]">Cancel</button>
          <p class="text-[11px] text-[#9b4d49]" x-show="error" x-text="error"></p>
        </div>
      </form>
    </div>

    {# Year Started Practice #}
    <div x-data="{ editing:false, years:[], sel:'', init(){ const now=new Date().getFullYear(); const start=now-69; const out=[]; for(let y=now; y>=start; y--){ out.push(''+y); } this.years=out; const cur=$store.profileModal.therapist.year_started_practice||''; this.sel = cur && this.years.includes(cur) ? cur : ''; }, startEdit(){ this.editing=true; const cur=$store.profileModal.therapist.year_started_practice||''; this.sel = cur; }, cancel(){ this.editing=false; }, save(){ const v=this.sel||''; window.__tcSaveProfileField('year_started_practice', v); this.editing=false; }, clear(){ this.sel=''; window.__tcSaveProfileField('year_started_practice',''); this.editing=false; } }" class="space-y-1">
      <div class="flex items-center justify-between">
        <div class="font-semibold text-[#116466]">Year Started Practice</div>
        <div class="flex items-center gap-2" x-show="!editing">
          <button type="button" @click="startEdit()" class="px-3 py-1 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[11px] font-semibold text-[#116466] hover:bg-[#E5F4F2]">Edit</button>
          <button type="button" @click="clear()" x-show="$store.profileModal.therapist.year_started_practice" class="px-3 py-1 rounded-full bg-white ring-1 ring-[#FFB3A8] text-[11px] font-medium text-[#9b4d49] hover:bg-[#FFE8E5]">Clear</button>
        </div>
      </div>
      <p class="text-[#2e4a49] text-sm" x-show="!editing && $store.profileModal.therapist.year_started_practice" x-text="$store.profileModal.therapist.year_started_practice"></p>
      <p class="text-xs italic text-[#89B0AE]" x-show="!editing && !$store.profileModal.therapist.year_started_practice">Not set (will be inferred from earliest education record)</p>
      <form x-show="editing" @submit.prevent="save()" class="bg-white/60 rounded-lg p-3 ring-1 ring-[#BEE3DB] flex flex-wrap items-end gap-3">
        <div class="relative">
          <label class="block text-[11px] font-semibold mb-1">Select Year</label>
          <div class="relative">
            <select x-model="sel" class="w-36 appearance-none border border-[#BEE3DB] rounded-md px-3 pr-8 py-2 text-[13px] leading-tight bg-white text-[#2e4a49] focus:outline-none focus:border-[#116466] focus:ring-2 focus:ring-[#116466]/30 transition shadow-sm">
              <option value="">-- Not Set --</option>
              <template x-for="y in years" :key="y">
                <option :value="y" x-text="y"></option>
              </template>
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-2 flex items-center">
              <svg class="w-4 h-4 text-[#116466] opacity-80" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6"/></svg>
            </div>
          </div>
        </div>
        <div class="flex items-center gap-2 pb-1">
          <button type="submit" class="px-3 py-1.5 rounded-full bg-[#116466] text-white text-[11px] font-semibold">Save</button>
          <button type="button" @click="cancel()" class="px-3 py-1.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[11px] font-medium hover:bg-[#E5F4F2]">Cancel</button>
        </div>
      </form>
    </div>

    <div x-show="$store.profileModal.therapist.years_in_practice">
      <div class="font-semibold text-[#116466] mb-1">Years in Practice</div>
      <p class="text-[#2e4a49] text-sm"><span x-text="$store.profileModal.therapist.years_in_practice"></span></p>
    </div>
  </div>
</div>
