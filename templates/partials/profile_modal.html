{# Removed stray duplicated opening photo component div that caused invalid DOM nesting #}
{# Comprehensive Therapist Profile Modal (lazy-loaded) #}
<style>
  /* Profile Modal Scrollbar – refined to align with brand palette */
  /* Firefox / standards */
  .profile-modal-scroll {
    scrollbar-width: thin;
    scrollbar-gutter: stable both-edge; /* prevent layout shift when thumb appears */
    /* thumb color track color */
    scrollbar-color: #89B0AE #E6F2F0;
  overscroll-behavior: contain;
  }
  /* WebKit */
  .profile-modal-scroll::-webkit-scrollbar {
  width: 9px;
  }
  .profile-modal-scroll::-webkit-scrollbar-track {
  background: #F2FAF9 !important;
  border: 1px solid #D2E7E4 !important;
  border-radius: 12px !important;
  }
  .profile-modal-scroll::-webkit-scrollbar-thumb {
  background: #116466 !important;
  border-radius: 999px !important;
  border: 2px solid #F2FAF9 !important; /* creates pill gap against track */
  box-shadow: 0 0 0 1px #0d4c4d inset, 0 1px 2px rgba(0,0,0,0.2); /* subtle definition */
  }
  .profile-modal-scroll::-webkit-scrollbar-thumb:hover {
  background: #0d4c4d !important;
  }
  .profile-modal-scroll::-webkit-scrollbar-thumb:active {
  background: #0a3a3a !important; /* solid when actively dragging */
  }
  .profile-modal-scroll::-webkit-scrollbar-corner { background: transparent; }
  /* Remove legacy mask (caused white glow previously) */
  .profile-modal-scroll-mask { display:none; }
  @media (prefers-color-scheme: dark) {
  .profile-modal-scroll { scrollbar-color: #73c1bb #243030; }
  .profile-modal-scroll::-webkit-scrollbar-track { background:#1f2727 !important; border-color:#2d3939 !important; }
  .profile-modal-scroll::-webkit-scrollbar-thumb { background:#3f8e89 !important; border-color:#1f2727 !important; box-shadow:0 0 0 1px #2d3939 inset; }
  .profile-modal-scroll::-webkit-scrollbar-thumb:hover { background:#326f6b !important; }
  .profile-modal-scroll::-webkit-scrollbar-thumb:active { background:#295654 !important; }
  }
</style>
<script>
// Lightweight factory for profile photo component (avoids huge inline x-data expression parsing issues)
window.tcPhotoComponent = function(){
  const getCsrf = () => (window.TC_CSRF || (function(){ const m=document.cookie.split(';').map(c=>c.trim()).find(c=>c.startsWith('csrftoken=')); return m?decodeURIComponent(m.split('=')[1]):''; })());
  return {
    dragOver:false,
    uploading:false,
    progress:0,
    error:'',
    success:false,
    csrf:getCsrf(),
    trigger(){ this.$refs.file.click(); },
    onFiles(e){ const f = (e.target && e.target.files && e.target.files[0]) || null; if(f) this.upload(f); },
    onDrop(ev){ ev.preventDefault(); this.dragOver=false; const f = ev.dataTransfer && ev.dataTransfer.files && ev.dataTransfer.files[0]; if(f) this.upload(f); },
    remove(){
      this.error=''; this.success=false; this.uploading=true;
      fetch('/users/api/profile/upload/photo/', { method:'DELETE', headers:{'X-CSRFToken': this.csrf} })
        .then(r=>r.json().then(d=>[r,d]))
        .then(([r,d])=>{ if(!r.ok){ this.error = d.error || 'Remove failed'; return; } const s = Alpine.store('profileModal'); if(s && s.therapist){ s.therapist = {...s.therapist, ...d}; } this.success=true; setTimeout(()=> this.success=false, 1800); })
        .catch(()=>{ this.error='Network error'; })
        .finally(()=>{ this.uploading=false; });
    },
    upload(file){
      this.error=''; this.success=false;
      if(!file){ this.error='No file'; return; }
      if(!/^image\//i.test(file.type)){ this.error='Unsupported file type'; return; }
      if(file.size > 5*1024*1024){ this.error='File too large (max 5MB)'; return; }
      const form = new FormData(); form.append('file', file);
      this.uploading=true;
      fetch('/users/api/profile/upload/photo/', { method:'POST', headers:{'X-CSRFToken': this.csrf}, body: form })
        .then(r=>r.json().then(d=>[r,d]))
        .then(([r,d])=>{ if(!r.ok){ this.error = d.error || 'Upload failed'; return; } const s = Alpine.store('profileModal'); if(s && s.therapist){ s.therapist = {...s.therapist, ...d}; } this.success=true; setTimeout(()=> this.success=false, 1800); })
        .catch(()=>{ this.error='Network error'; })
        .finally(()=>{ this.uploading=false; this.progress=0; });
    }
  }
};
// Fallback stub for therapySpecialtiesManager so the partial can be safely included on pages
// that don't load the full edit script (prevents Alpine ReferenceErrors). If the full
// implementation is already defined globally, this no-op stub will NOT overwrite it.
if(typeof window.therapySpecialtiesManager !== 'function'){
  window.therapySpecialtiesManager = function(opts){
    return {
      editable: !!(opts && opts.editable),
      // Therapy types minimal reactive props
      therapyQuery:'', therapyResults:[], therapyOpen:false, therapyLoading:false, therapySelectedIndex:-1,
      // Specialties minimal reactive props
      specialtyQuery:'', specialtyResults:[], specialtyOpen:false, specialtyLoading:false, specialtySelectedIndex:-1,
      // Top specialties / saving state
      saveTimer:null, saving:false, error:'',
      init(){ /* no-op in read-only context */ },
      // Utility mirrors
      caseEq(a,b){ return (a||'').toLowerCase()===(b||'').toLowerCase(); },
      // No-op handlers (editing disabled when full manager absent)
      onTherapyInput(){}, onTherapyFocus(){}, therapyKeydown(){}, addTherapyType(){}, removeTherapyType(){},
      onSpecialtyInput(){}, onSpecialtyFocus(){}, specialtyKeydown(){}, addSpecialty(){}, removeSpecialty(){}, toggleTop(){},
      clickAwayTherapy(){ this.therapyOpen=false; }, clickAwaySpecialty(){ this.specialtyOpen=false; },
      scheduleSave(){}, saveAll(){}, syncTopList(){}
    };
  };
}
</script>
<style>
  /* Neutralize any global image overlay line artifacts */
  .profile-modal-scroll figure img { display:block; border:none; outline:none; }
  .profile-modal-scroll figure::before, .profile-modal-scroll figure::after { content:none !important; }
  .profile-modal-scroll figure img::before, .profile-modal-scroll figure img::after { content:none !important; }
  /* Unified off-white shade (slightly darker than previous #FAF9F9) */
  :root { --tc-offwhite: #F5F4F3; }
  .bg-offwhite { background-color: var(--tc-offwhite); }
  .bg-statement { background:#FCFCFB; }
  /* Unified section styling (standalone + modal) */
  .tc-section { position:relative; border-radius:1.5rem; background:var(--tc-offwhite,#F5F4F3); border:1px solid #BEE3DB; box-shadow:0 10px 40px -10px #555B6E33; }
  /* Ensure sections don't shrink when sidebar fixed; give them a max width and center */
  @media (min-width:1024px){
    /* Expanded wider content area */
    .tc-section { max-width: 1200px; margin-left:0; }
  }
  .tc-section.tc-tight { box-shadow:0 6px 24px -6px #555B6E22; }
  .tc-section.tc-soft { box-shadow:0 4px 14px -4px #555B6E22; }
  /* Remove any legacy negative margin hacks on sections */
  .tc-section[class*='-mx-1'] { margin-left:0 !important; margin-right:0 !important; }
</style>
{# Added defensive optional chaining so an undefined store doesn't throw and leave the modal visible #}
{# 'editable' passed by includes (truthy only where editing should be enabled). No custom set tag needed. #}
{% if standalone %}
<div x-data="{ lightboxImage:null, showAllFields:false, expectedFields:[
 'id','first_name','middle_name','last_name','name','intro_statement','personal_statement_q1','personal_statement_q2','personal_statement_q3','credentials_note','practice_name','phone_number','phone_extension','receive_calls_from_client','mobile_number','receive_texts_from_clients','practice_email','office_email','receive_emails_from_clients','receive_emails_when_client_calls','therapy_delivery_method','accepting_new_clients','offers_intro_call','individual_session_cost','couples_session_cost','sliding_scale_pricing_available','finance_note','practice_website_url','facebook_url','instagram_url','linkedin_url','twitter_url','tiktok_url','youtube_url','therapy_types_note','specialties_note','mental_health_role','license_type','license_type_description','license_type_short','license_number','license_expiration','license_state','year_started_practice','date_of_birth','gender','participant_types','age_groups','top_specialties','specialties','accepted_payment_methods','areas_of_expertise','types_of_therapy','therapy_types','other_therapy_types','gallery_images','video_gallery','locations','race_ethnicities','faiths','lgbtqia_identities','other_identities','insurance_details','additional_credentials','educations','years_in_practice','profile_photo_url','city','state'
 ], displayName(f){ const map={
   first_name:'First Name', last_name:'Last Name', middle_name:'Middle Name', intro_statement:'Intro Statement', personal_statement_q1:'About Me (Primary)', personal_statement_q2:'Personal Statement 2', personal_statement_q3:'Personal Statement 3', credentials_note:'Credentials Note', practice_name:'Practice Name', phone_number:'Phone Number', phone_extension:'Phone Extension', receive_calls_from_client:'Can Receive Calls', mobile_number:'Mobile Number', receive_texts_from_clients:'Can Receive Texts', practice_email:'Practice Email', office_email:'Office Email', receive_emails_from_clients:'Can Receive Client Emails', receive_emails_when_client_calls:'Email On Client Call', therapy_delivery_method:'Delivery Method', accepting_new_clients:'Availability', offers_intro_call:'Offers Intro Call', individual_session_cost:'Individual Session Cost', couples_session_cost:'Couples Session Cost', sliding_scale_pricing_available:'Sliding Scale Pricing', finance_note:'Finances Note', practice_website_url:'Website', facebook_url:'Facebook', instagram_url:'Instagram', linkedin_url:'LinkedIn', twitter_url:'Twitter', tiktok_url:'TikTok', youtube_url:'YouTube', therapy_types_note:'Therapy Types Note', specialties_note:'Specialties Note', mental_health_role:'Role', license_type:'License Type', license_type_description:'License Type Description', license_type_short:'License Abbrev', license_number:'License Number', license_expiration:'License Expiration', license_state:'License State', date_of_birth:'Date of Birth', participant_types:'Participant Types', age_groups:'Age Groups', top_specialties:'Top Specialties', accepted_payment_methods:'Accepted Payment Methods', areas_of_expertise:'Areas of Expertise', types_of_therapy:'Types of Therapy', therapy_types:'Therapy Types', other_therapy_types:'Other Therapy Types', gallery_images:'Gallery Images', video_gallery:'Video Gallery', race_ethnicities:'Race / Ethnicities', faiths:'Faiths', lgbtqia_identities:'LGBTQIA+ Identities', other_identities:'Other Identities', insurance_details:'Insurance Details', additional_credentials:'Additional Credentials', educations:'Educations', years_in_practice:'Years In Practice', profile_photo_url:'Profile Photo URL'}; return map[f] || f.replace(/_/g,' ').replace(/\b[a-z]/g,c=>c.toUpperCase()); } }" x-cloak class="relative w-full max-w-7xl mx-auto my-8">
{% else %}
<div x-data="{ lightboxImage:null, showAllFields:false, expectedFields:[
 'id','first_name','middle_name','last_name','name','intro_statement','personal_statement_q1','personal_statement_q2','personal_statement_q3','credentials_note','practice_name','phone_number','phone_extension','receive_calls_from_client','mobile_number','receive_texts_from_clients','practice_email','office_email','receive_emails_from_clients','receive_emails_when_client_calls','therapy_delivery_method','accepting_new_clients','offers_intro_call','individual_session_cost','couples_session_cost','sliding_scale_pricing_available','finance_note','practice_website_url','facebook_url','instagram_url','linkedin_url','twitter_url','tiktok_url','youtube_url','therapy_types_note','specialties_note','mental_health_role','license_type','license_type_description','license_type_short','license_number','license_expiration','license_state','year_started_practice','date_of_birth','gender','participant_types','age_groups','top_specialties','specialties','accepted_payment_methods','areas_of_expertise','types_of_therapy','therapy_types','other_therapy_types','gallery_images','video_gallery','locations','race_ethnicities','faiths','lgbtqia_identities','other_identities','insurance_details','additional_credentials','educations','years_in_practice','profile_photo_url','city','state'
 ], displayName(f){ const map={
   first_name:'First Name', last_name:'Last Name', middle_name:'Middle Name', intro_statement:'Intro Statement', personal_statement_q1:'About Me (Primary)', personal_statement_q2:'Personal Statement 2', personal_statement_q3:'Personal Statement 3', credentials_note:'Credentials Note', practice_name:'Practice Name', phone_number:'Phone Number', phone_extension:'Phone Extension', receive_calls_from_client:'Can Receive Calls', mobile_number:'Mobile Number', receive_texts_from_clients:'Can Receive Texts', practice_email:'Practice Email', office_email:'Office Email', receive_emails_from_clients:'Can Receive Client Emails', receive_emails_when_client_calls:'Email On Client Call', therapy_delivery_method:'Delivery Method', accepting_new_clients:'Availability', offers_intro_call:'Offers Intro Call', individual_session_cost:'Individual Session Cost', couples_session_cost:'Couples Session Cost', sliding_scale_pricing_available:'Sliding Scale Pricing', finance_note:'Finances Note', practice_website_url:'Website', facebook_url:'Facebook', instagram_url:'Instagram', linkedin_url:'LinkedIn', twitter_url:'Twitter', tiktok_url:'TikTok', youtube_url:'YouTube', therapy_types_note:'Therapy Types Note', specialties_note:'Specialties Note', mental_health_role:'Role', license_type:'License Type', license_type_description:'License Type Description', license_type_short:'License Abbrev', license_number:'License Number', license_expiration:'License Expiration', license_state:'License State', date_of_birth:'Date of Birth', participant_types:'Participant Types', age_groups:'Age Groups', top_specialties:'Top Specialties', accepted_payment_methods:'Accepted Payment Methods', areas_of_expertise:'Areas of Expertise', types_of_therapy:'Types of Therapy', therapy_types:'Therapy Types', other_therapy_types:'Other Therapy Types', gallery_images:'Gallery Images', video_gallery:'Video Gallery', race_ethnicities:'Race / Ethnicities', faiths:'Faiths', lgbtqia_identities:'LGBTQIA+ Identities', other_identities:'Other Identities', insurance_details:'Insurance Details', additional_credentials:'Additional Credentials', educations:'Educations', years_in_practice:'Years In Practice', profile_photo_url:'Profile Photo URL'}; return map[f] || f.replace(/_/g,' ').replace(/\b[a-z]/g,c=>c.toUpperCase()); } }" x-cloak x-show="$store.profileModal?.show" class="fixed inset-0 z-[70] backdrop-blur-sm p-4" style="background: rgba(30,30,30,0.45);" @keydown.window.escape="$store.profileModal && $store.profileModal.close()" @click.self="$store.profileModal && $store.profileModal.close()" @keydown.window.arrow-right.prevent="$store.profileModal?.next && $store.profileModal.next()" @keydown.window.arrow-left.prevent="$store.profileModal?.prev && $store.profileModal.prev()">
  <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[98vw] max-w-7xl max-h-[90vh] rounded-3xl shadow-2xl ring-1 ring-[#BEE3DB] overflow-visible relative opacity-0 scale-95 transition-opacity transition-transform duration-150 ease-out bg-[#ECEBE8] flex flex-col min-h-0" :class="$store.profileModal.contentVisible ? 'opacity-100 scale-100' : 'opacity-0 scale-95'" role="dialog" aria-modal="true" aria-labelledby="therapistProfileHeading" x-ref="dialog">
    <div class="pointer-events-none absolute inset-0 rounded-3xl bg-gradient-to-b from-[#E3E2DF] via-[#F5F4F3] to-[#E0DFDC]"></div>
  <div class="relative z-10 flex flex-col flex-1 min-h-0">
{% endif %}
    <!-- overflow-visible so external-positioned nav arrows (translated outside) are not clipped -->
    <!-- Internal edge-anchored navigation arrows -->
  <button x-show="$store.profileModal?.ids && $store.profileModal.ids.length && $store.profileModal.currentIndex>0" @click.stop="$store.profileModal.prev()" class="hidden md:flex absolute left-0 top-1/2 z-[85] w-11 h-11 -translate-y-1/2 rounded-full items-center justify-center bg-[#116466]/95 text-white shadow-lg hover:bg-[#0d4c4d] focus:outline-none focus:ring-2 focus:ring-[#89B0AE] transition" style="transform:translate(-120%, -50%);" aria-label="Previous profile">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.4" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
    </button>
  <button x-show="$store.profileModal?.ids && $store.profileModal.ids.length && $store.profileModal.currentIndex < ($store.profileModal.ids.length - 1)" @click.stop="$store.profileModal.next()" class="hidden md:flex absolute right-0 top-1/2 z-[85] w-11 h-11 -translate-y-1/2 rounded-full items-center justify-center bg-[#116466]/95 text-white shadow-lg hover:bg-[#0d4c4d] focus:outline-none focus:ring-2 focus:ring-[#89B0AE] transition" style="transform:translate(120%, -50%);" aria-label="Next profile">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.4" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
    </button>
  <!-- Clipping wrapper to keep scrollbar & sticky header inside rounded corners -->
  <div class="relative flex-1 flex flex-col rounded-3xl overflow-hidden min-h-0">
  <!-- Loading Overlay (inside clipping wrapper) -->
  <div x-show="$store.profileModal.loading" x-transition.opacity class="absolute inset-0 flex flex-col items-center justify-center bg-white/85 z-[80]">
      <div class="animate-spin h-10 w-10 rounded-full border-4 border-[#BEE3DB] border-t-[#116466]"></div>
      <p class="mt-4 text-sm font-medium text-[#555B6E]">Loading profile…</p>
    </div>
  <!-- Header / Content (refactored) -->
  <div class="flex-1 overflow-y-auto profile-modal-scroll min-h-0" style="scrollbar-width:thin; position:relative;">
      <div class="profile-modal-scroll-mask" aria-hidden="true"></div>
  {% if not standalone %}
  <!-- Sticky Compact Header (modal only) -->
  <div class="sticky top-0 z-[2100] bg-offwhite backdrop-blur-sm border-b border-[#BEE3DB] px-6 md:px-10 py-4 flex flex-col gap-3 md:flex-row md:items-center md:gap-4 shadow-sm">
        <!-- Heading / Name -->
        <template x-if="!$store.profileModal.loading">
          <h1 id="therapistProfileHeading" class="text-lg md:text-2xl font-extrabold leading-tight text-[#555B6E] flex items-center flex-wrap gap-2 md:min-w-[40%]">
            <span x-text="$store.profileModal.therapist.name || [$store.profileModal.therapist.first_name, $store.profileModal.therapist.last_name].filter(Boolean).join(' ')"></span>
            <template x-if="$store.profileModal.therapist.license_type || $store.profileModal.therapist.license_type_short">
              <span x-data="{showLT:false}" @mouseenter="showLT=true" @mouseleave="showLT=false" class="relative flex items-baseline gap-1 pl-2 ml-1 border-l border-[#BEE3DB] cursor-help group">
                <template x-if="$store.profileModal.therapist.license_type">
                  <span class="text-sm md:text-base font-semibold text-[#116466]" x-text="$store.profileModal.therapist.license_type"></span>
                </template>
                <template x-if="$store.profileModal.therapist.license_type && $store.profileModal.therapist.license_type_short">
                  <span class="text-[10px] md:text-xs font-medium text-[#89B0AE]" x-text="$store.profileModal.therapist.license_type_short"></span>
                </template>
                <template x-if="!$store.profileModal.therapist.license_type && $store.profileModal.therapist.license_type_short">
                  <span class="text-[10px] md:text-xs font-medium text-[#116466]" x-text="$store.profileModal.therapist.license_type_short"></span>
                </template>
                <!-- Tooltip -->
                <template x-if="showLT && $store.profileModal.therapist.license_type_description">
                  <span class="absolute left-0 top-full mt-3 z-[3000] px-4 py-3 rounded-xl bg-white/95 backdrop-blur-sm text-[#1f3636] text-[12px] md:text-[13px] leading-snug shadow-2xl ring-1 ring-[#89B0AE] max-w-md w-max font-medium tracking-normal tooltip-anim" style="filter:drop-shadow(0 6px 16px rgba(0,0,0,0.22));">
                    <span class="block whitespace-pre-line" x-text="$store.profileModal.therapist.license_type_description"></span>
                    <span class="absolute -top-2 left-6 w-3 h-3 rotate-45 bg-white/95 ring-1 ring-[#89B0AE]"></span>
                  </span>
                </template>
              </span>
            </template>
          </h1>
        </template>
        <template x-if="$store.profileModal.loading">
          <div class="h-6 md:h-8 w-56 md:w-72 rounded bg-[#E5F4F2] animate-pulse"></div>
        </template>
        <div class="flex flex-wrap items-center gap-2 text-[11px] md:flex-1 order-3 md:order-none">
          <!-- Delivery method first -->
          <template x-if="$store.profileModal.therapist.therapy_delivery_method">
            <span class="px-2 py-1 rounded-full bg-[#E5F4F2] text-[#116466] font-semibold" x-text="(() => { const raw = $store.profileModal.therapist.therapy_delivery_method || ''; const v = raw.toLowerCase(); if(/^(in[- ]?person)$/.test(v)) return 'In Person Only'; if(/^(online|telehealth)$/.test(v)) return 'Online Only'; if(/hybrid/.test(v) || (v.includes('person') && (v.includes('online')||v.includes('telehealth')))) return 'In Person & Online'; return raw; })()"></span>
          </template>
          <template x-if="$store.profileModal.therapist.accepting_new_clients">
            <span class="px-2 py-1 rounded-full bg-[#116466] text-white font-semibold">Accepting New Clients</span>
          </template>
        </div>
        <div class="flex items-center gap-3 md:gap-6 shrink-0 md:ml-auto order-2 md:order-none">
          {% if not editable and not hide_contact %}
          <a :href="'/users/contact/' + $store.profileModal.therapist.id + '/'" target="_blank" class="px-4 py-2 rounded-full bg-[#116466] text-white text-sm font-semibold hover:bg-[#0d4c4d] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#89B0AE] transition w-full text-center md:w-auto">Contact Me</a>
          {% endif %}
          <button type="button" x-show="$store.profileModal.currentUserId === $store.profileModal.therapist.id" @click="showAllFields=!showAllFields" class="px-4 py-2 rounded-full bg-[#E5F4F2] text-[#116466] text-sm font-semibold hover:bg-[#D2E7E4] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#89B0AE] transition" x-text="showAllFields ? 'Hide All Fields' : 'Show All Fields'"></button>
          {% if not standalone %}
          <button @click="$store.profileModal && $store.profileModal.close()" class="bg-[#FF9950] hover:bg-[#555B6E] text-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg transition md:relative md:top-auto md:right-auto" aria-label="Close profile modal">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
          {% endif %}
        </div>
  </div>
  {% endif %}
      <!-- Main Scroll Content -->
  <div class="px-6 md:px-10 pb-14 pt-8 flex flex-col gap-12">
        <!-- Hero Panel: Photo + Key Facts / Chips -->
  <div class="flex flex-col md:flex-row gap-8 md:items-start relative isolate">
          <div class="relative w-40 h-56 sm:w-48 sm:h-64 md:w-56 md:h-72 flex-shrink-0 rounded-2xl shadow-lg self-start z-0 group/photo overflow-hidden" x-data="window.tcPhotoComponent()" :class="dragOver ? 'ring-2 ring-[#116466] ring-offset-2' : ''" @dragover.prevent="dragOver=true" @dragleave.prevent="dragOver=false" @drop="onDrop($event)" style="box-shadow:0 8px 32px -6px #555B6E55;">
            <!-- Existing photo -->
            <template x-if="!$store.profileModal.loading && $store.profileModal.therapist.profile_photo_url">
              <img :src="$store.profileModal.therapist.profile_photo_url + (uploading ? '' : '')" :alt="$store.profileModal.therapist.name || 'Profile photo'" class="w-full h-full object-cover object-center" />
            </template>
            <!-- Placeholder (branded) -->
            <template x-if="!$store.profileModal.loading && !$store.profileModal.therapist.profile_photo_url">
              <div class="absolute inset-0 flex flex-col items-center justify-center gap-3 bg-gradient-to-br from-[#E5F4F2] via-[#F5F4F3] to-[#ECEBE8] text-center p-4">
                <div class="w-20 h-20 rounded-full bg-[#FFFFFF]/70 ring-2 ring-[#BEE3DB] flex items-center justify-center shadow-inner relative">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#116466" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4Z"/><path d="M4.8 20c1.02-3.21 3.92-5.5 7.2-5.5s6.18 2.29 7.2 5.5"/></svg>
                  <span class="absolute -bottom-1 -right-1 w-6 h-6 rounded-full bg-[#116466] text-white flex items-center justify-center text-[11px] font-bold shadow">+</span>
                </div>
                <div class="flex flex-col gap-1">
                  <p class="text-[11px] font-semibold tracking-wide text-[#555B6E] uppercase">Add Profile Photo</p>
                  <p class="text-[10px] leading-snug text-[#555B6E]/80">Clear head & shoulders, good lighting.</p>
                </div>
              </div>
            </template>
            <!-- Overlay actions (edit mode only) -->
            {% if editable %}
            <div class="absolute inset-0 flex flex-col items-center justify-end p-2 bg-gradient-to-t from-[#1f3636]/70 via-transparent to-transparent opacity-0 group-hover/photo:opacity-100 transition">
              <div class="w-full flex flex-col gap-1">
                <button type="button" @click.prevent="trigger()" class="w-full inline-flex items-center justify-center gap-2 px-3 py-2 rounded-lg bg-[#116466] text-white text-xs font-semibold shadow hover:bg-[#0d4c4d] focus:outline-none focus:ring-2 focus:ring-[#89B0AE]">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M12 5v14" /><path d="M5 12h14" /></svg>
                  <span x-text="$store.profileModal.therapist.profile_photo_url ? 'Change Photo' : 'Upload Photo'"></span>
                </button>
                <template x-if="$store.profileModal.therapist.profile_photo_url">
                  <button type="button" @click.prevent="remove()" class="w-full inline-flex items-center justify-center gap-2 px-3 py-1.5 rounded-lg bg-[#FFE8E5] text-[#9b4d49] text-[11px] font-semibold shadow hover:bg-[#FFD5CF] focus:outline-none focus:ring-2 focus:ring-[#FF9950]">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-3.5 h-3.5"><path d="M3 6h18"/><path d="M8 6v12c0 .55.45 1 1 1h6c.55 0 1-.45 1-1V6"/><path d="M10 6V4h4v2"/></svg>
                    <span>Remove Photo</span>
                  </button>
                </template>
                <div class="text-[9px] text-[#E5F4F2] leading-tight px-1">
                  <span class="font-medium">Requirements:</span> JPG or PNG, max 5MB. Recommended ≥ 400px tall. No filters.
                </div>
                <template x-if="error"><div class="text-[10px] text-[#FFDDD0] font-semibold" x-text="error"></div></template>
                <template x-if="success"><div class="text-[10px] text-[#BEE3DB] font-semibold">Uploaded</div></template>
                <template x-if="uploading"><div class="h-1 w-full bg-[#FFFFFF]/30 rounded overflow-hidden"><div class="h-full bg-[#FF9950] animate-pulse" style="width:100%"></div></div></template>
              </div>
            </div>
            {% if standalone and editable %}
            {% endif %}
            <input type="file" x-ref="file" class="hidden" accept="image/*" @change="onFiles($event)" />
            {% endif %}
          </div>
          <div class="flex-1 flex flex-col gap-4 min-w-0 relative z-10">
            {% if standalone %}
            <!-- Public page inline header (moved from sticky) -->
            <div class="flex flex-col gap-3 md:gap-4">
              <div class="flex flex-col gap-1">
                <h1 class="text-2xl md:text-3xl font-extrabold leading-tight text-[#555B6E] flex flex-wrap items-center gap-2 flex-wrap" data-edit-wrapper>
                  <span class="inline-flex items-center gap-2 {% if editable %}group/name relative cursor-pointer rounded-md{% endif %}" {% if editable %}@click.stop="$dispatch('edit-name',{el:$el})"{% endif %}
                        {% if editable %}x-data="{}" x-bind:class="(!$store.profileModal.therapist.first_name && !$store.profileModal.therapist.last_name) ? 'ring-1 ring-[#FF9950] bg-[#FFF5F0]/70 animate-pulse' : 'hover:bg-[#E5F4F2]/70 transition'"{% endif %}
                        {% if editable %}aria-label="Edit name and title" role="button" tabindex="0"{% endif %}>
                    <!-- Combined placeholder when completely empty -->
                    <template x-if="!$store.profileModal.therapist.first_name && !$store.profileModal.therapist.last_name && !$store.profileModal.therapist.title">
                      <span class="text-[#89B0AE] italic">Therapist Name &amp; Title</span>
                    </template>
                    <!-- Title -->
                    <template x-if="$store.profileModal.therapist.title">
                      <span class="text-[#116466] font-semibold" x-text="$store.profileModal.therapist.title"></span>
                    </template>
                    <!-- First Name (only if present) -->
                    <template x-if="$store.profileModal.therapist.first_name">
                      <span x-text="$store.profileModal.therapist.first_name"></span>
                    </template>
                    <!-- Middle Name (only if present) -->
                    <template x-if="$store.profileModal.therapist.middle_name">
                      <span x-text="$store.profileModal.therapist.middle_name" class="text-[#555B6E]"></span>
                    </template>
                    <!-- Last Name (only if present) -->
                    <template x-if="$store.profileModal.therapist.last_name">
                      <span x-text="$store.profileModal.therapist.last_name"></span>
                    </template>
                    {% if editable %}
                    <span class="flex items-center gap-1 text-[10px] px-2 py-0.5 rounded-full bg-[#E5F4F2] text-[#116466] font-semibold ml-1 opacity-0 group-hover/name:opacity-100 transition"
                          x-data="{}"
                          x-bind:class="(!$store.profileModal.therapist.first_name && !$store.profileModal.therapist.last_name) ? 'opacity-100 animate-pulse' : ''">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3.5 h-3.5"><path d="M13.586 2.586a2 2 0 0 1 2.828 2.828l-.793.793-2.828-2.828.793-.793Z"/><path d="M11.379 4.793 3 13.172V16h2.828l8.38-8.379-2.83-2.828Z"/></svg>
                      <span>Edit</span>
                    </span>
                    {% endif %}
                  </span>
                  <!-- Inline License Type (editable, separate from name click) -->
                  <span data-edit-wrapper data-field="license_type" x-data="{can_edit: {{ editable|default:0|yesno:'true,false' }} }" @click.prevent.stop="can_edit && $dispatch('edit-select',{field:'license_type',value:$store.profileModal.therapist.license_type || '', el: $el})" class="inline-flex items-center gap-1 ml-8" :class="[!$store.profileModal.therapist.license_type ? (can_edit ? 'cursor-pointer text-[#89B0AE] italic animate-pulse' : 'text-[#89B0AE] italic') : (can_edit ? 'cursor-pointer hover:bg-[#E5F4F2]/60 rounded-md px-1 -mx-1 transition' : '')]">
                    <template x-if="$store.profileModal.therapist.license_type">
                      <span class="text-base md:text-lg font-semibold text-[#116466]" x-text="$store.profileModal.therapist.license_type + ($store.profileModal.therapist.license_type_short ? ', ' + $store.profileModal.therapist.license_type_short : '')"></span>
                    </template>
                    <template x-if="!$store.profileModal.therapist.license_type">
                      <span x-text="can_edit ? 'Set License Type' : 'License Type'"></span>
                    </template>
                  </span>
                </h1>
                <div class="flex flex-wrap gap-2 mt-1 text-[11px]">
                  <span class="px-2 py-1 rounded-full bg-[#E5F4F2] text-[#116466] font-semibold" data-edit-wrapper data-field="therapy_delivery_method" x-data="{can_edit: {{ editable|default:0|yesno:'true,false' }} }" @click.prevent.stop="can_edit && $dispatch('edit-select',{field:'therapy_delivery_method',value:$store.profileModal.therapist.therapy_delivery_method, el: $el})" :class="[!$store.profileModal.therapist.therapy_delivery_method ? 'ring-1 ring-[#FF9950] ' + (can_edit ? 'animate-pulse cursor-pointer' : '') : '', can_edit ? 'cursor-pointer' : ''].join(' ')" x-text="(() => { const raw = $store.profileModal.therapist.therapy_delivery_method || ''; const v = raw.toLowerCase(); if(!raw) return can_edit ? 'Set Delivery Method' : 'Delivery Method'; if(/^(in[- ]?person)$/.test(v)) return 'In Person Only'; if(/^(online|telehealth)$/.test(v)) return 'Online Only'; if(/hybrid/.test(v) || (v.includes('person') && (v.includes('online')||v.includes('telehealth')))) return 'In Person & Online'; return raw; })()"></span>
                  <!-- Availability (Accepting / Not Accepting / Waitlist) -->
                  <span class="px-2 py-1 rounded-full font-semibold" data-edit-wrapper data-field="accepting_new_clients" x-data="{can_edit: {{ editable|default:0|yesno:'true,false' }} }" @click.prevent.stop="can_edit && $dispatch('edit-select',{field:'accepting_new_clients',value:$store.profileModal.therapist.accepting_new_clients||'', el:$el})" :class="(() => { let v=($store.profileModal.therapist.accepting_new_clients||'').toString().trim().toLowerCase(); if(v==='true'||v==='false') v=''; if(!v){ return 'bg-[#FFE8E5] text-[#9b4d49] ring-1 ring-[#FF9950] ' + (can_edit?'cursor-pointer animate-pulse':''); } if(v.startsWith('accept')) return 'bg-[#116466] text-white ' + (can_edit?'cursor-pointer':''); if(v.startsWith('not')) return 'bg-[#FFE8E5] text-[#9b4d49] ' + (can_edit?'cursor-pointer':''); if(v.includes('wait')) return 'bg-[#E5F4F2] text-[#116466] ' + (can_edit?'cursor-pointer':''); return 'bg-[#E5F4F2] text-[#116466]'; })()" x-text="(() => { let v=($store.profileModal.therapist.accepting_new_clients||'').toString().trim().toLowerCase(); if(v==='true'||v==='false') v=''; if(!v) return can_edit ? 'Set Availability' : 'Availability'; if(v.startsWith('accept')) return 'Accepting New Clients'; if(v.startsWith('not')) return 'Not Accepting New Clients'; if(v.includes('wait')) return 'I Have a Waitlist'; return $store.profileModal.therapist.accepting_new_clients; })()"></span>
                </div>
              </div>
              {# Contact button suppressed on standalone (public/edit) views; only shown inside modal include #}
              {% if not editable and not hide_contact %}
              <div>
                <a :href="'/users/contact/' + $store.profileModal.therapist.id + '/'" target="_blank" class="inline-block px-5 py-2.5 rounded-full bg-[#116466] text-white text-sm font-semibold hover:bg-[#0d4c4d] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#89B0AE] transition shadow">Contact Me</a>
              </div>
              {% endif %}
            </div>
            {% endif %}
            <!-- Credential Note + Intro Note panel (intro_note) -->
            <div class="bg-offwhite rounded-xl p-3 shadow-lg relative group cursor-default" style="box-shadow:0 4px 14px -4px #555B6E22;" data-edit-wrapper
                 x-data="{can_edit: {{ editable|default:0|yesno:'true,false' }} }"
                 @click="can_edit && $dispatch('edit-rich-text',{field:'intro_note',current:($store.profileModal.therapist.intro_note||''), el: $el})"
                 :class="[(!$store.profileModal.therapist.intro_note) ? (can_edit ? 'ring-1 ring-[#FF9950] animate-pulse' : '') : '', can_edit ? 'hover:ring-1 hover:ring-[#BEE3DB] transition' : '']">
              <div class="text-sm md:text-base leading-relaxed font-light text-[#2e4a49] min-h-[54px] flex flex-col gap-3 pr-14">
                <template x-if="$store.profileModal.therapist.credentials_note">
                  <p class="mb-0" x-text="$store.profileModal.therapist.credentials_note"></p>
                </template>
                <template x-if="$store.profileModal.therapist.intro_note">
                  <div class="prose prose-sm max-w-none" x-html="$store.profileModal.therapist.intro_note"></div>
                </template>
                <template x-if="!($store.profileModal.therapist.credentials_note || $store.profileModal.therapist.intro_note)">
                  <p class="italic text-[#89B0AE]" x-text="can_edit ? 'Add an introduction that helps new clients connect with you…' : 'No introduction provided.'"></p>
                </template>
              </div>
              {% if editable %}
              <div class="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition pointer-events-none group-hover:pointer-events-auto">
                <button type="button" class="text-[10px] px-2 py-1 rounded bg-[#116466] text-white shadow" @click.stop="$dispatch('edit-rich-text',{field:'intro_note',current:($store.profileModal.therapist.intro_note||''), el: $el})">Edit</button>
              </div>
              {% endif %}
            </div>
            <!-- Aggregated Locations (replaces single primary city/state line) -->
            <template x-if="!$store.profileModal.loading && $store.profileModal.therapist.locations && $store.profileModal.therapist.locations.length">
              <div class="text-xs text-[#555B6E] opacity-80">
                <span class="font-semibold block mb-1">Locations:</span>
                <div class="flex flex-col gap-0.5">
                  <template x-for="loc in [...new Set(($store.profileModal.therapist.locations || []).map(l => [l.city, l.state].filter(Boolean).join(', ')).filter(Boolean))]" :key="loc">
                    <span x-text="loc"></span>
                  </template>
                </div>
              </div>
            </template>
            <template x-if="!$store.profileModal.loading && (!($store.profileModal.therapist.locations && $store.profileModal.therapist.locations.length)) && ($store.profileModal.therapist.city || $store.profileModal.therapist.state)">
              <div class="text-xs text-[#555B6E] opacity-80">
                <span x-text="[$store.profileModal.therapist.city, $store.profileModal.therapist.state].filter(Boolean).join(', ')"></span>
              </div>
            </template>
            <!-- Participant Types & Age Groups -->
            <template x-if="!$store.profileModal.loading && (($store.profileModal.therapist.participant_types && $store.profileModal.therapist.participant_types.length) || ($store.profileModal.therapist.age_groups && $store.profileModal.therapist.age_groups.length))">
              <div class="flex flex-col gap-3">
                <div class="flex flex-wrap gap-2 text-[11px]" x-show="$store.profileModal.therapist.participant_types && $store.profileModal.therapist.participant_types.length">
                  <template x-for="pt in $store.profileModal.therapist.participant_types" :key="'pt-' + pt"><span class="px-2 py-1 rounded-full bg-[#BEE3DB] text-[#444] font-semibold shadow-sm" x-text="pt"></span></template>
                </div>
                <div class="flex flex-wrap gap-2 text-[11px]" x-show="$store.profileModal.therapist.age_groups && $store.profileModal.therapist.age_groups.length">
                  <template x-for="ag in $store.profileModal.therapist.age_groups" :key="'ag-' + ag"><span class="px-2 py-1 rounded-full bg-[#E5F4F2] text-[#116466] font-semibold shadow-sm" x-text="ag"></span></template>
                </div>
              </div>
            </template>
            <!-- Top Specialties (moved after participant & age groups) -->
            <template x-if="!$store.profileModal.loading && $store.profileModal.therapist.top_specialties && $store.profileModal.therapist.top_specialties.length">
              <div>
                <h3 class="text-xs font-semibold mb-2 tracking-wide text-[#555B6E] uppercase">Top Specialties</h3>
                <div class="flex flex-wrap gap-2">
                  <template x-for="s in $store.profileModal.therapist.top_specialties" :key="'tops-' + s">
                    <span class='px-2 py-1 rounded-full bg-[#FFDDD0] text-[#444] text-xs font-medium shadow-sm' x-text="s"></span>
                  </template>
                </div>
              </div>
            </template>
          </div>
        </div>
        <!-- ABOUT / BIO + MEDIA -->
        {% if standalone and editable %}
  <!-- Anchor for General summary section -->
  <div id="section-general" class="absolute -top-24"></div>
  <!-- My Identity (shown only on edit page, above About Me) -->
  <div class="mx-auto w-full max-w-[1200px] px-4 md:px-6">
  <section id="section-identity" class="tc-section tc-tight relative px-4 md:px-5 py-5">
          <div class="flex flex-col gap-4">
            <h2 class="text-xl md:text-[22px] font-semibold tracking-tight text-[#555B6E] flex items-center gap-3">
              <span>My Identity</span>
              <span class="text-[10px] font-medium text-[#89B0AE]">(Helps clients feel seen)</span>
            </h2>
            <p class="text-[12px] text-[#89B0AE] italic -mt-1">Add identity details to help clients feel represented. None of this information is shared; it's only used to help clients connect with the right therapist.</p>
            <div class="flex flex-col gap-5 text-[13px] text-[#2e4a49]">
              <template x-if="$store.profileModal.therapist.gender">
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="font-semibold text-[#116466]">Gender:</span>
                  <span x-text="$store.profileModal.therapist.gender"></span>
                  <button type="button" class="text-[10px] px-2 py-0.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[#116466] hover:bg-[#E5F4F2]" @click.stop="$dispatch('edit-gender',{ el: $el, current: $store.profileModal.therapist.gender })">Edit</button>
                </div>
              </template>
              <template x-if="!$store.profileModal.therapist.gender">
                <div class="flex items-center gap-2 text-[12px] text-[#89B0AE]">
                  <button type="button" class="px-2 py-0.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[#116466] hover:bg-[#E5F4F2] text-[11px] font-semibold" @click.stop="$dispatch('edit-gender',{ el: $el, current: '' })">Add Gender</button>
                </div>
              </template>
              <template x-if="$store.profileModal.therapist.race_ethnicities && $store.profileModal.therapist.race_ethnicities.length">
                <div class="flex flex-col gap-1" x-data="{can_edit:true}">
                  <div class="flex items-center gap-2 flex-wrap" data-edit-wrapper>
                    <span class="font-semibold text-[#116466] mr-1">Race / Ethnicities:</span>
                    <template x-for="r in $store.profileModal.therapist.race_ethnicities" :key="r">
                      <span class="px-2 py-0.5 rounded-full bg-[#E5F4F2] text-[#116466] text-[11px] font-semibold shadow-sm" x-text="r"></span>
                    </template>
                    <button type="button" class="text-[10px] px-2 py-0.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[#116466] hover:bg-[#E5F4F2] transition" @click.stop="$dispatch('edit-race-ethnicities',{ el: $el, current: [...$store.profileModal.therapist.race_ethnicities] })">Edit</button>
                  </div>
                </div>
              </template>
              <template x-if="!($store.profileModal.therapist.race_ethnicities && $store.profileModal.therapist.race_ethnicities.length)">
                <div class="flex items-center gap-2 text-[12px] text-[#89B0AE]">
                  <button type="button" class="px-2 py-0.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[#116466] hover:bg-[#E5F4F2] text-[11px] font-semibold" @click.stop="$dispatch('edit-race-ethnicities',{ el: $el, current: [] })">Add Race/Ethnicity</button>
                </div>
              </template>
              <template x-if="$store.profileModal.therapist.faiths && $store.profileModal.therapist.faiths.length">
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="font-semibold text-[#116466]">Faiths:</span>
                  <span x-text="$store.profileModal.therapist.faiths.join(', ')"></span>
                  <button type="button" class="text-[10px] px-2 py-0.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[#116466] hover:bg-[#E5F4F2]" @click.stop="$dispatch('edit-faiths',{ el: $el, current: [...$store.profileModal.therapist.faiths] })">Edit</button>
                </div>
              </template>
              <template x-if="!($store.profileModal.therapist.faiths && $store.profileModal.therapist.faiths.length)">
                <div class="flex items-center gap-2 text-[12px] text-[#89B0AE]">
                  <button type="button" class="px-2 py-0.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[#116466] hover:bg-[#E5F4F2] text-[11px] font-semibold" @click.stop="$dispatch('edit-faiths',{ el: $el, current: [] })">Add Faith</button>
                </div>
              </template>
              <template x-if="$store.profileModal.therapist.lgbtqia_identities && $store.profileModal.therapist.lgbtqia_identities.length">
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="font-semibold text-[#116466]">LGBTQIA+ Identities:</span>
                  <span x-text="$store.profileModal.therapist.lgbtqia_identities.join(', ')"></span>
                  <button type="button" class="text-[10px] px-2 py-0.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[#116466] hover:bg-[#E5F4F2]" @click.stop="$dispatch('edit-lgbtqia',{ el: $el, current: [...$store.profileModal.therapist.lgbtqia_identities] })">Edit</button>
                </div>
              </template>
              <template x-if="!($store.profileModal.therapist.lgbtqia_identities && $store.profileModal.therapist.lgbtqia_identities.length)">
                <div class="flex items-center gap-2 text-[12px] text-[#89B0AE]">
                  <button type="button" class="px-2 py-0.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[#116466] hover:bg-[#E5F4F2] text-[11px] font-semibold" @click.stop="$dispatch('edit-lgbtqia',{ el: $el, current: [] })">Add LGBTQIA Identity</button>
                </div>
              </template>
              <template x-if="$store.profileModal.therapist.other_identities && $store.profileModal.therapist.other_identities.length">
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="font-semibold text-[#116466]">Other Identities:</span>
                  <span x-text="$store.profileModal.therapist.other_identities.join(', ')"></span>
                  <button type="button" class="text-[10px] px-2 py-0.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[#116466] hover:bg-[#E5F4F2]" @click.stop="$dispatch('edit-other-identities',{ el: $el, current: [...$store.profileModal.therapist.other_identities] })">Edit</button>
                </div>
              </template>
              <template x-if="!($store.profileModal.therapist.other_identities && $store.profileModal.therapist.other_identities.length)">
                <div class="flex items-center gap-2 text-[12px] text-[#89B0AE]">
                  <button type="button" class="px-2 py-0.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[#116466] hover:bg-[#E5F4F2] text-[11px] font-semibold" @click.stop="$dispatch('edit-other-identities',{ el: $el, current: [] })">Add Identity</button>
                </div>
              </template>
            </div>
          </div>
    </section>
  </div>
        {% endif %}
        <!-- ABOUT WRAPPER (visually separated) -->
  <!-- Unified Sections Wrapper START -->
  <div class="mx-auto w-full max-w-[1200px] px-4 md:px-6 flex flex-col gap-12">
  <section id="section-about" class="tc-section relative px-4 md:px-5 py-5">
    <h2 class="text-2xl md:text-[25px] font-semibold mb-5 tracking-tight text-[#555B6E]">About Me</h2>
    <div class="flex flex-col gap-10">
      <!-- Personal Statement 1 -->
      <div class="relative z-10 rounded-xl p-3 bg-statement shadow-lg" style="box-shadow:0 4px 14px -4px #555B6E22;">
        <div class="group relative cursor-pointer" data-edit-wrapper data-field="personal_statement_01" x-data="{can_edit: {{ editable|default:0|yesno:'true,false' }} }" role="button" tabindex="0"
             @keydown.enter.prevent="can_edit && $dispatch('edit-rich-text',{field:'personal_statement_01',current:$store.profileModal.therapist.personal_statement_01||'', el: $el})"
             @keydown.space.prevent="can_edit && $dispatch('edit-rich-text',{field:'personal_statement_01',current:$store.profileModal.therapist.personal_statement_01||'', el: $el})"
             @click.stop="can_edit && $dispatch('edit-rich-text',{field:'personal_statement_01',current:$store.profileModal.therapist.personal_statement_01||'', el: $el})">
          <span class="absolute inset-0" aria-hidden="true"></span>
          <template x-if="$store.profileModal.therapist.personal_statement_01">
            <div class="text-base md:text-lg leading-relaxed font-light text-[#2e4a49] prose prose-sm max-w-none" x-html="$store.profileModal.therapist.personal_statement_01"></div>
          </template>
          <template x-if="!$store.profileModal.therapist.personal_statement_01">
            <p class="italic text-[#89B0AE]" :class="can_edit ? 'animate-pulse' : ''" x-text="can_edit ? 'Tell us about yourself…' : 'No information provided.'"></p>
          </template>
          {% if editable %}
          <button type="button" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition text-[10px] px-2 py-1 rounded bg-[#116466] text-white"
                  @click.stop="$dispatch('edit-rich-text',{field:'personal_statement_01',current:$store.profileModal.therapist.personal_statement_01||'', el: $el})">Edit</button>
          {% endif %}
        </div>
      </div>
      <!-- Gallery / Statements / Video Group -->
      <div class="flex flex-col gap-10">
        <!-- placeholder to keep existing inner content grouping start -->
        <div class="p-0 m-0 contents">
          {% if standalone and editable %}
          <!-- Inline Gallery Manager (upload + manage) placed directly below About Me -->
          <div class="mt-2" x-data="galleryManager()">
            <h3 class="text-xl font-semibold text-[#555B6E] mb-3 flex items-center gap-3">Image Gallery <span class="text-[11px] font-medium text-[#89B0AE]" x-text="images.length + ' / 12'" aria-live="polite"></span></h3>
            <p class="text-[12px] text-[#555B6E]/80 mb-4">Upload up to 12 images that showcase your practice or therapeutic style. Mark one as Primary for emphasis.</p>
            <div class="flex flex-col md:flex-row gap-6">
              <div class="w-full md:w-72">
                <form @submit.prevent="upload()" class="space-y-3" x-ref="form">
                  <div class="border-2 border-dashed rounded-xl p-4 flex flex-col items-center justify-center gap-3 bg-white/70 text-center cursor-pointer relative" @click="$refs.file.click()" @dragover.prevent="drag=true" @dragleave.prevent="drag=false" @drop.prevent="onDrop($event)" :class="drag?'border-[#116466] bg-[#E5F4F2]':'border-[#BEE3DB]'">
                    <input type="file" x-ref="file" class="hidden" accept="image/*" @change="onFile($event)" />
                    <svg class="w-10 h-10 text-[#116466]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                    <div class="text-[11px] leading-snug text-[#555B6E]">
                      <p class="font-semibold">Click or Drop to Upload</p>
                      <p>JPG/PNG, up to 5MB each.</p>
                    </div>
                    <template x-if="progress>0 && progress<100"><div class="w-full h-1 bg-[#E5F4F2] rounded overflow-hidden"><div class="h-full bg-[#116466]" :style="'width:'+progress+'%'" aria-label="Upload progress"></div></div></template>
                  </div>
                  <input type="text" x-model="caption" maxlength="128" placeholder="Optional caption" class="w-full rounded-md border border-[#BEE3DB] bg-white px-3 py-2 text-sm focus:border-[#116466] focus:ring-[#116466]" />
                  <label class="flex items-center gap-2 text-xs font-medium text-[#555B6E]"><input type="checkbox" x-model="is_primary" class="accent-[#116466]" /> Set as Primary</label>
                  <div class="flex gap-2">
                    <button type="submit" :disabled="!file || uploading" class="px-4 py-2 rounded-full text-xs font-semibold transition disabled:opacity-40 disabled:cursor-not-allowed" :class="uploading ? 'bg-[#89B0AE] text-white' : 'bg-[#116466] text-white hover:bg-[#0d4c4d]'" x-text="uploading ? 'Uploading…' : 'Upload Image'"></button>
                    <button type="button" @click="reset()" class="px-3 py-2 rounded-full bg-white ring-1 ring-[#BEE3DB] text-xs font-medium hover:bg-[#E5F4F2]">Reset</button>
                  </div>
                  <template x-if="error"><p class="text-[11px] text-[#9b4d49]" x-text="error"></p></template>
                </form>
              </div>
              <div class="flex-1">
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                  <template x-for="img in images" :key="img.id || img.url">
                    <div class="group relative rounded-lg overflow-hidden bg-white ring-1 ring-[#BEE3DB]" :class="img.is_primary ? 'ring-2 ring-[#116466]' : ''">
                      <img :src="img.url" :alt="img.caption" class="w-full h-32 object-cover" />
                      <div class="absolute inset-0 flex flex-col justify-between opacity-0 group-hover:opacity-100 transition bg-black/40 p-2 text-white text-[11px]">
                        <textarea x-model="img.caption" @change="saveMeta(img)" class="w-full flex-1 rounded bg-white/90 text-[#555B6E] p-1 text-[10px] resize-none" maxlength="128" placeholder="Caption"></textarea>
                        <div class="flex items-center justify-between mt-1">
                          <button type="button" @click="setPrimary(img)" class="px-2 py-0.5 rounded-full text-[10px] font-semibold" :class="img.is_primary ? 'bg-[#116466] text-white' : 'bg-white/90 text-[#116466]'">Primary</button>
                          <button type="button" @click="remove(img)" class="px-2 py-0.5 rounded-full bg-[#FFE8E5] text-[#9b4d49] text-[10px] font-semibold">Delete</button>
                        </div>
                      </div>
                    </div>
                  </template>
                </div>
                <template x-if="!images.length"><p class="text-[12px] italic text-[#89B0AE] mt-2">No gallery images yet.</p></template>
              </div>
            </div>
          </div>
          {% endif %}
          <!-- Image Gallery -->
          <template x-if="$store.profileModal.therapist.gallery_images && $store.profileModal.therapist.gallery_images.length">
            <div class="mt-8 relative z-0" x-data="{
              build(){
                const imgs = $store.profileModal.therapist.gallery_images || [];
                let primaryIndex = imgs.findIndex(g=>g.is_primary);
                if(primaryIndex === -1) primaryIndex = 0;
                const spans = [];
                let rowRemaining = 6;
                for(let idx=0; idx<imgs.length; idx++){
                  if(idx === primaryIndex){
                    if(rowRemaining < 3) rowRemaining = 6;
                    spans[idx] = 3; rowRemaining -= 3; if(rowRemaining===0) rowRemaining=6; continue;
                  }
                  if(rowRemaining === 1){ spans[idx]=1; rowRemaining=6; continue; }
                  if(rowRemaining === 5){ spans[idx]=2; rowRemaining-=2; continue; }
                  if(rowRemaining === 4){ const r=(this.hash(idx+(imgs[idx].url||''))%100)/100; spans[idx]= r<0.7?2:1; rowRemaining -= spans[idx]; continue; }
                  if(rowRemaining === 3){ spans[idx]=1; rowRemaining-=1; if(rowRemaining===0) rowRemaining=6; continue; }
                  if(rowRemaining === 2){ spans[idx]=2; rowRemaining=6; continue; }
                  const r=(this.hash(idx+(imgs[idx].url||''))%100)/100; spans[idx]= r<0.5?2:1; rowRemaining -= spans[idx];
                }
                // Attach precomputed class to each image object (non-reactive enough for display)
                imgs.forEach((g, idx)=>{
                  const base = 'h-40 md:h-48';
                  if(idx===primaryIndex){ g._cls = 'col-span-4 sm:col-span-4 '+base; return; }
                  const span = spans[idx] || 1;
                  g._cls = (span===2 ? 'col-span-2 sm:col-span-2 ' : 'col-span-1 sm:col-span-1 ') + base;
                });
              },
              hash(str){ let h=0; for(let j=0;j<str.length;j++){ h=((h<<5)-h)+str.charCodeAt(j); h|=0;} return Math.abs(h); }
            }" x-init="build()">
              <h3 class="text-sm font-bold tracking-wide text-[#555B6E] mb-3">My Images</h3>
  <div class="grid grid-cols-4 sm:grid-cols-8 gap-0 overflow-hidden rounded-lg bg-statement">
                <template x-for="g in $store.profileModal.therapist.gallery_images" :key="g.url || Math.random()">
  <figure @click="($store.mediaLightbox ? $store.mediaLightbox.openImage(g.url) : ($store.profileModal.lightboxImage=g.url))" :data-lightbox-image="g.url" role="button" tabindex="0" @keydown.enter.prevent="$store.mediaLightbox ? $store.mediaLightbox.openImage(g.url) : ($store.profileModal.lightboxImage=g.url)" class="group relative cursor-zoom-in bg-statement select-none focus:outline-none focus:ring-2 focus:ring-[#89B0AE] flex items-start justify-start" :class="g._cls || 'col-span-1 sm:col-span-1 h-40 md:h-48'">
        <img :src="g.url" :alt="g.caption" class="w-full h-full object-contain transition-transform duration-300 group-hover:scale-105 block self-start" loading="lazy" />
                    <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity bg-black/20 pointer-events-none"></div>
                  </figure>
                </template>
              </div>
            </div>
          </template>
          <!-- Personal Statement 2 (styled like Statement 1) -->
          <div class="mt-8 relative z-10 rounded-xl p-3 bg-statement shadow-lg" style="box-shadow:0 4px 14px -4px #555B6E22;">
            <div class="group relative cursor-pointer" data-edit-wrapper data-field="personal_statement_q2" x-data="{can_edit: {{ editable|default:0|yesno:'true,false' }} }" role="button" tabindex="0"
                 @keydown.enter.prevent="can_edit && $dispatch('edit-rich-text',{field:'personal_statement_q2',current:$store.profileModal.therapist.personal_statement_q2||'', el: $el})"
                 @keydown.space.prevent="can_edit && $dispatch('edit-rich-text',{field:'personal_statement_q2',current:$store.profileModal.therapist.personal_statement_q2||'', el: $el})"
                 @click.stop="can_edit && $dispatch('edit-rich-text',{field:'personal_statement_q2',current:$store.profileModal.therapist.personal_statement_q2||'', el: $el})">
              <span class="absolute inset-0" aria-hidden="true"></span>
              <template x-if="$store.profileModal.therapist.personal_statement_q2">
                <div class="text-base md:text-lg leading-relaxed font-light text-[#2e4a49] prose prose-sm max-w-none" x-html="$store.profileModal.therapist.personal_statement_q2"></div>
              </template>
              <template x-if="!$store.profileModal.therapist.personal_statement_q2">
                <p class="italic text-[#89B0AE]" :class="can_edit ? 'animate-pulse' : ''" x-text="can_edit ? 'Tell us about your Education and Qualifications' : 'No information provided.'"></p>
              </template>
              {% if editable %}
              <button type="button" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition text-[10px] px-2 py-1 rounded bg-[#116466] text-white"
                      @click.stop="$dispatch('edit-rich-text',{field:'personal_statement_q2',current:$store.profileModal.therapist.personal_statement_q2||'', el: $el})">Edit</button>
              {% endif %}
            </div>
          </div>
          <!-- Single Intro Video (capture or upload) -->
          {% if editable %}
          <div class="mt-10 relative z-10" x-data="videoManager()">
            <h3 class="text-xl font-semibold text-[#555B6E] mb-3 flex items-center gap-3">Intro Video <span class="text-[11px] font-medium text-[#89B0AE]" x-text="video ? '1 / 1' : '0 / 1'"></span></h3>
            <p class="text-[12px] text-[#555B6E]/80 mb-4 max-w-2xl">Record or upload a short intro (recommended 30–90 seconds) to help clients connect. Keep lighting bright and speak clearly.</p>
            <div class="flex flex-col gap-6 md:flex-row">
              <!-- Left column: controls -->
              <div class="w-full md:w-72 flex flex-col gap-4">
                <template x-if="!video">
                  <div class="space-y-4">
                    <div class="border-2 border-dashed rounded-xl p-4 flex flex-col items-center justify-center gap-3 bg-white/70 text-center cursor-pointer relative" @click="$refs.file.click()" @dragover.prevent="drag=true" @dragleave.prevent="drag=false" @drop.prevent="drag=false; const f=$event.dataTransfer.files[0]; if(f) { file=f; }" :class="drag?'border-[#116466] bg-[#E5F4F2]':'border-[#BEE3DB]'">
                      <input type="file" x-ref="file" class="hidden" accept="video/*" @change="onFile($event)" />
                      <svg class="w-10 h-10 text-[#116466]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.6"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                      <div class="text-[11px] leading-snug text-[#555B6E]">
                        <p class="font-semibold">Click or Drop to Upload</p>
                        <p>MP4 / WebM up to 60MB.</p>
                      </div>
                    </div>
                    <div class="flex flex-col gap-3">
                      <div class="rounded-xl bg-black aspect-video flex items-center justify-center relative overflow-hidden" x-show="recording || stream">
                        <video x-ref="preview" autoplay playsinline muted class="w-full h-full object-cover" x-init="$watch('stream', s=>{ if(s && $refs.preview){ $refs.preview.srcObject=s; } })"></video>
                        <div class="absolute top-2 left-2 bg-red-600 text-white text-[10px] px-2 py-0.5 rounded-full flex items-center gap-1" x-show="recording"><span class="w-2 h-2 bg-white rounded-full animate-ping"></span><span>REC</span></div>
                      </div>
                      <div class="flex flex-wrap gap-2">
                        <button type="button" x-show="!recording" @click="startRecording()" class="px-3 py-2 rounded-full bg-[#116466] text-white text-xs font-semibold hover:bg-[#0d4c4d]">Record</button>
                        <button type="button" x-show="recording" @click="stopRecording()" class="px-3 py-2 rounded-full bg-[#FF9950] text-white text-xs font-semibold hover:bg-[#ff7d1c]">Stop</button>
                        <button type="button" @click="upload()" :disabled="!file || uploading" class="px-3 py-2 rounded-full text-xs font-semibold disabled:opacity-40" :class="uploading ? 'bg-[#89B0AE] text-white' : 'bg-[#116466] text-white hover:bg-[#0d4c4d]'" x-text="uploading ? 'Uploading…' : 'Upload'" ></button>
                        <button type="button" @click="reset()" class="px-3 py-2 rounded-full bg-white ring-1 ring-[#BEE3DB] text-xs font-medium hover:bg-[#E5F4F2]">Reset</button>
                      </div>
                      <input type="text" x-model="caption" maxlength="128" placeholder="Optional caption" class="w-full rounded-md border border-[#BEE3DB] bg-white px-3 py-2 text-sm focus:border-[#116466] focus:ring-[#116466]" />
                      <template x-if="error"><p class="text-[11px] text-[#9b4d49]" x-text="error"></p></template>
                    </div>
                  </div>
                </template>
                <template x-if="video">
                  <div class="space-y-3">
                    <div class="rounded-xl overflow-hidden bg-black aspect-video relative">
                      <video :src="video.video_url" controls playsinline class="w-full h-full object-cover"></video>
                    </div>
                    <textarea x-model="video.caption" @change="updateCaption()" maxlength="128" placeholder="Caption" class="w-full rounded-md border border-[#BEE3DB] bg-white px-3 py-2 text-sm focus:border-[#116466] focus:ring-[#116466]"></textarea>
                    <div class="flex gap-2">
                      <button type="button" @click="remove()" class="px-3 py-2 rounded-full bg-[#FFE8E5] text-[#9b4d49] text-xs font-semibold hover:bg-[#FFD5CF]">Delete Video</button>
                    </div>
                  </div>
                </template>
              </div>
              <!-- Right column: guidance -->
              <div class="flex-1 text-[12px] text-[#555B6E] flex flex-col gap-4">
                <div class="rounded-xl bg-white/70 ring-1 ring-[#BEE3DB] p-4">
                  <h4 class="text-sm font-semibold text-[#116466] mb-2">Tips</h4>
                  <ul class="list-disc pl-4 space-y-1">
                    <li>Use a quiet, well-lit space.</li>
                    <li>Look at the camera and speak naturally.</li>
                    <li>Briefly share who you help and how.</li>
                    <li>Keep it authentic and warm.</li>
                  </ul>
                </div>
                <div class="rounded-xl bg-white/70 ring-1 ring-[#BEE3DB] p-4">
                  <h4 class="text-sm font-semibold text-[#116466] mb-2">Recording</h4>
                  <p>Recording uses your browser (WebM). You can instead upload a prepared MP4/WebM. We currently support a single intro video.</p>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
          <!-- Personal Statement 3 (Therapy Style) -->
          <div class="mt-8 relative z-10 rounded-xl p-3 bg-statement shadow-lg" style="box-shadow:0 4px 14px -4px #555B6E22;">
            <div class="group relative cursor-pointer" data-edit-wrapper data-field="personal_statement_q3" x-data="{can_edit: {{ editable|default:0|yesno:'true,false' }} }" role="button" tabindex="0"
                 @keydown.enter.prevent="can_edit && $dispatch('edit-rich-text',{field:'personal_statement_q3',current:$store.profileModal.therapist.personal_statement_q3||'', el: $el})"
                 @keydown.space.prevent="can_edit && $dispatch('edit-rich-text',{field:'personal_statement_q3',current:$store.profileModal.therapist.personal_statement_q3||'', el: $el})"
                 @click.stop="can_edit && $dispatch('edit-rich-text',{field:'personal_statement_q3',current:$store.profileModal.therapist.personal_statement_q3||'', el: $el})">
              <span class="absolute inset-0" aria-hidden="true"></span>
              <template x-if="$store.profileModal.therapist.personal_statement_q3">
                <div class="text-base md:text-lg leading-relaxed font-light text-[#2e4a49] prose prose-sm max-w-none" x-html="$store.profileModal.therapist.personal_statement_q3"></div>
              </template>
              <template x-if="!$store.profileModal.therapist.personal_statement_q3">
                <p class="italic text-[#89B0AE]" :class="can_edit ? 'animate-pulse' : ''" x-text="can_edit ? 'Tell us about your Therapy style' : 'No information provided.'"></p>
              </template>
              {% if editable %}
              <button type="button" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition text-[10px] px-2 py-1 rounded bg-[#116466] text-white"
                      @click.stop="$dispatch('edit-rich-text',{field:'personal_statement_q3',current:$store.profileModal.therapist.personal_statement_q3||'', el: $el})">Edit</button>
              {% endif %}
            </div>
          </div>
    </div>
  </section>
            {% if standalone %}{% else %}{% endif %}
  <!-- Restored Lower Sections -->
  <!-- Lower sections continue inside unified wrapper -->
              <div class="flex flex-col lg:flex-row gap-12 relative">
                <div class="flex-1 flex flex-col gap-12 min-w-0 order-1">
                  <!-- Content starts -->
  <!-- Locations -->
        {% if editable %}
  <section id="section-locations" class="tc-section relative px-4 md:px-5 py-5" x-data="locationManager()">
          <div class="flex items-start justify-between mb-5">
            <h2 class="text-2xl md:text-[25px] font-semibold tracking-tight text-[#555B6E]">Locations</h2>
            <button type="button" @click="startAdd()" class="text-[11px] px-3 py-1.5 rounded-full bg-[#116466] text-white font-semibold shadow hover:bg-[#0d4c4d] transition" x-show="!form.show">Add</button>
          </div>
          <!-- Delete Confirmation Modal -->
          <template x-if="confirmDelete.show">
            <div class="fixed inset-0 z-[6000] flex items-center justify-center">
              <div class="absolute inset-0 bg-[#2e4a49]/50 backdrop-blur-sm" @click="cancelDelete()"></div>
              <div class="relative w-full max-w-sm mx-auto bg-white rounded-2xl shadow-2xl ring-1 ring-[#BEE3DB] p-5 flex flex-col gap-4 animate-[fadeIn_.25s_ease]">
                <div class="flex items-start gap-3">
                  <div class="w-10 h-10 rounded-full bg-[#FFE8E5] flex items-center justify-center text-[#9b4d49]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v4m0 4h.01M5.07 19h13.86A2 2 0 0 0 21 17.07L12.93 3.64a2 2 0 0 0-3.86 0L3 17.07A2 2 0 0 0 5.07 19Z"/></svg>
                  </div>
                  <div class="flex-1">
                    <h4 class="text-sm font-semibold text-[#555B6E] tracking-wide">Delete Location?</h4>
                    <p class="mt-1 text-[12px] leading-snug text-[#555B6E]/80">You're about to remove <span class="font-semibold" x-text="confirmDelete.targetName"></span>. This will also delete any office hours associated with it. This action can't be undone.</p>
                  </div>
                </div>
                <div class="flex items-center justify-end gap-3 pt-1">
                  <button type="button" @click="cancelDelete()" class="px-4 py-1.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[11px] font-medium text-[#555B6E] hover:bg-[#E5F4F2]">Cancel</button>
                  <button type="button" @click="confirmDeleteAction()" class="px-4 py-1.5 rounded-full bg-[#9b4d49] text-white text-[11px] font-semibold hover:bg-[#7f3d39]">Delete</button>
                </div>
              </div>
            </div>
          </template>
          <div x-show="form.show" class="mb-6 rounded-xl p-4 bg-statement shadow-lg ring-1 ring-[#BEE3DB] flex flex-col gap-4" style="box-shadow:0 4px 14px -4px #555B6E22;">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <input type="text" x-model="form.practice_name" placeholder="Practice Name" class="tc-input" />
              <input type="text" x-model="form.street_address" placeholder="Street Address" class="tc-input" />
              <input type="text" x-model="form.address_line_2" placeholder="Address Line 2" class="tc-input" />
              <input type="text" x-model="form.city" placeholder="City" class="tc-input" />
              <div class="relative">
                <select x-model="form.state" class="tc-input appearance-none pr-9">
                  <template x-for="s in states" :key="s.code">
                    <option :value="s.code" x-text="s.name"></option>
                  </template>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-2 flex items-center text-[#116466] opacity-70">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6"/></svg>
                </div>
              </div>
              <input type="text" x-model="form.zip" placeholder="ZIP" class="tc-input" />
            </div>
            <label class="flex items-center gap-2 text-[11px] font-medium text-[#555B6E]"><input type="checkbox" x-model="form.is_primary_address" class="accent-[#116466]" /> Primary Location</label>
            <div class="flex gap-2 pt-1">
              <button type="button" @click="save()" class="px-4 py-1.5 rounded-full bg-[#116466] text-white text-[11px] font-semibold shadow disabled:opacity-50 disabled:cursor-not-allowed" x-text="form.mode==='add' ? 'Save Location' : 'Update Location'" :disabled="saving"></button>
              <button type="button" @click="cancel()" class="px-4 py-1.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[11px] font-medium hover:bg-[#E5F4F2]">Cancel</button>
              <template x-if="form.mode==='edit'"><button type="button" @click="remove()" class="ml-auto px-4 py-1.5 rounded-full bg-[#FFE8E5] text-[#9b4d49] text-[11px] font-semibold hover:bg-[#FFD5CF] shadow">Delete</button></template>
            </div>
            <template x-if="error"><div class="text-[11px] text-[#9b4d49]" x-text="error"></div></template>
          </div>
          <template x-if="!$store.profileModal.therapist.locations || !$store.profileModal.therapist.locations.length">
            <p class="text-[13px] italic text-[#89B0AE]">No locations added yet.</p>
          </template>
          <div class="space-y-6" x-show="$store.profileModal.therapist.locations && $store.profileModal.therapist.locations.length">
            <template x-for="loc in $store.profileModal.therapist.locations" :key="loc.id">
              <div class="text-sm text-[#2e4a49] flex flex-col gap-2 rounded-xl p-4 bg-statement shadow-lg ring-1 ring-[#BEE3DB] relative group transition hover:ring-[#116466]" style="box-shadow:0 4px 14px -4px #555B6E22;">
                <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 focus-within:opacity-100 transition pointer-events-none group-hover:pointer-events-auto">
                  <button type="button" @click="edit(loc)" class="text-[10px] px-2 py-0.5 rounded-full bg-[#116466] text-white font-semibold hover:bg-[#0d4c4d] shadow">Edit</button>
                  <button type="button" @click="removeLoc(loc)" class="text-[10px] px-2 py-0.5 rounded-full bg-[#FFE8E5] text-[#9b4d49] font-semibold hover:bg-[#FFD5CF] shadow">Del</button>
                </div>
                <div class="font-semibold text-[#555B6E] tracking-tight" x-text="(loc.practice_name || 'Practice Location') + (loc.is_primary_address ? ' (Primary)' : '')"></div>
                <div class="text-[12px] opacity-90" x-text="[loc.street_address, loc.address_line_2].filter(Boolean).join(', ')"></div>
                <div class="text-[12px] opacity-90" x-text="[loc.city, loc.state, loc.zip].filter(Boolean).join(', ')"></div>
                <!-- Office Hours (editable) -->
                <div class="mt-2" x-data="{}">
                  <template x-if="hoursEdit.openFor !== loc.id">
                    <button type="button" @click="openHours(loc)" class="text-[10px] px-3 py-1 rounded-full bg-white ring-1 ring-[#BEE3DB] hover:bg-[#E5F4F2] font-semibold text-[#116466] shadow-sm">Edit Office Hours</button>
                  </template>
                  <template x-if="hoursEdit.openFor === loc.id">
                    <div class="mt-3 p-3 rounded-xl bg-white/80 ring-1 ring-[#BEE3DB] flex flex-col gap-3 shadow-inner">
                      <div class="flex items-center justify-between">
                        <span class="text-[12px] font-semibold text-[#116466] tracking-wide">Office Hours</span>
                        <div class="flex gap-2">
                          <button type="button" @click="saveHours()" :disabled="hoursEdit.saving" class="px-3 py-1 rounded-full bg-[#116466] text-white text-[10px] font-semibold disabled:opacity-50 shadow">Save</button>
                          <button type="button" @click="closeHours()" :disabled="hoursEdit.saving" class="px-3 py-1 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[10px] font-medium hover:bg-[#E5F4F2]">Close</button>
                        </div>
                      </div>
                      <template x-if="hoursEdit.error"><div class="text-[10px] text-[#9b4d49]" x-text="hoursEdit.error"></div></template>
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <template x-for="row in hoursEdit.rows" :key="row.weekday">
                          <div class="p-2 rounded-lg bg-statement ring-1 ring-[#BEE3DB]/70 flex flex-col gap-1">
                            <div class="flex items-center justify-between">
                              <span class="text-[11px] font-medium text-[#555B6E]" x-text="weekdayNames[row.weekday]"></span>
                              <div class="flex gap-1">
                                <button type="button" @click="toggleClosed(row)" class="text-[9px] px-1.5 py-0.5 rounded-full transition" :class="row.is_closed ? 'bg-[#116466] text-white' : 'bg-[#E5F4F2] text-[#116466]'">Closed</button>
                                <button type="button" @click="toggleAppt(row)" class="text-[9px] px-1.5 py-0.5 rounded-full transition" :class="row.by_appointment_only ? 'bg-[#116466] text-white' : 'bg-[#E5F4F2] text-[#116466]'">Appt</button>
                              </div>
                            </div>
                            <template x-if="!row.is_closed && !row.by_appointment_only">
                              <div class="flex flex-col gap-1">
                                <div class="flex items-center gap-1">
                                  <input type="time" x-model="row.start_time_1" class="flex-1 border rounded px-1 py-0.5 text-[10px]" />
                                  <span class="text-[10px] text-[#555B6E]">-</span>
                                  <input type="time" x-model="row.end_time_1" class="flex-1 border rounded px-1 py-0.5 text-[10px]" />
                                </div>
                                <div class="flex items-center gap-1">
                                  <input type="time" x-model="row.start_time_2" class="flex-1 border rounded px-1 py-0.5 text-[10px]" />
                                  <span class="text-[10px] text-[#555B6E]">-</span>
                                  <input type="time" x-model="row.end_time_2" class="flex-1 border rounded px-1 py-0.5 text-[10px]" />
                                </div>
                              </div>
                            </template>
                            <input type="text" maxlength="64" placeholder="Notes" x-model="row.notes" class="border rounded px-1 py-0.5 text-[10px]" />
                          </div>
                        </template>
                      </div>
                      <p class="text-[10px] text-[#555B6E] italic">Closed overrides times; Appt indicates by appointment only.</p>
                    </div>
                  </template>
                </div>
              </div>
            </template>
          </div>
        </section>
        {% else %}
        <template x-if="$store.profileModal?.therapist?.locations && $store.profileModal.therapist.locations.length">
          <section class="tc-section relative px-4 md:px-5 py-5" x-data="{ mapsInit:false }" x-effect="$store.profileModal && $store.profileModal.show && !$store.profileModal.loading && !mapsInit && (mapsInit=true, $nextTick(()=> window.initTherapistLocationMaps && window.initTherapistLocationMaps()))">
            <h2 class="text-2xl md:text-[25px] font-semibold tracking-tight text-[#555B6E] mb-5">Locations</h2>
            <div class="space-y-5">
              <template x-for="(loc, idx) in $store.profileModal.therapist.locations" :key="(loc.practice_name||'') + loc.city + loc.state + loc.zip + idx">
                <div class="text-xs text-[#555B6E] flex flex-col gap-3 border-b border-[#BEE3DB]/60 pb-5 last:border-b-0" :data-city="loc.city" :data-state="loc.state" :data-zip="loc.zip" x-data="{weekdayNames:['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],to12(t){ if(!t) return ''; const [h,m] = t.split(':').map(Number); const ampm = h>=12?'PM':'AM'; const hr = ((h+11)%12)+1; return `${hr}:${m.toString().padStart(2,'0')} ${ampm}`; },fmt(interval){ if(!interval) return ''; const {is_closed,by_appointment_only,start_time_1,end_time_1,start_time_2,end_time_2,notes}=interval; if(by_appointment_only) return 'By appointment'; if(is_closed) return 'Closed'; const seg = (a,b)=> (a&&b)? `${this.to12(a)} - ${this.to12(b)}`:''; const seg1 = seg(start_time_1,end_time_1); const seg2 = seg(start_time_2,end_time_2); const core = [seg1, seg2].filter(Boolean).join(', '); return core + (notes?` (${notes})`: ''); }}">
                  <!-- Header / Address -->
                  <div class="flex flex-col gap-0.5">
                    <div class="font-semibold" x-text="(loc.practice_name || 'Practice Location') + (loc.is_primary_address ? ' (Primary)' : '')"></div>
                    <div x-text="[loc.street_address, loc.address_line_2].filter(Boolean).join(', ')"></div>
                    <div x-text="[loc.city, loc.state, loc.zip].filter(Boolean).join(', ')"></div>
                  </div>
                  <!-- Map + Hours side by side on md+ -->
                  <div class="flex flex-col md:flex-row md:items-start gap-4 md:gap-6">
                    <!-- Map (expands) -->
                    <div class="h-40 md:h-44 md:flex-1 rounded-lg overflow-hidden ring-1 ring-[#BEE3DB] relative bg-[#F8FDFC]" :id="'profile-map-' + idx">
                      <div class="absolute inset-0 flex items-center justify-center text-[10px] text-[#555B6E]" style="letter-spacing:.5px;" x-show="!loc.lat || !loc.lng">Loading map…</div>
                    </div>
                    <!-- Hours + Actions (narrow, right aligned on md+) -->
          <div class="w-full md:w-60 md:ml-auto flex flex-col">
                      <template x-if="loc.office_hours && loc.office_hours.length">
                        <div class="space-y-1 mb-2">
              <div class="font-semibold text-[#116466] text-[12px] tracking-wide uppercase">Office Hours</div>
              <div class="grid grid-cols-2 gap-x-3 gap-y-1 text-[11px] leading-snug tracking-wide">
                            <template x-for="oh in loc.office_hours" :key="oh.weekday">
                              <div class="col-span-2 flex justify-between" x-show="oh">
                                <span class="font-semibold text-[#116466]" x-text="weekdayNames[oh.weekday] || oh.weekday"></span>
                                <span class="text-right" x-text="fmt(oh)"></span>
                              </div>
                            </template>
                          </div>
                        </div>
                      </template>
            <div class="mt-auto flex flex-wrap gap-3 text-[11px] pt-1">
                        <a :href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent([loc.street_address, loc.city, loc.state, loc.zip].filter(Boolean).join(', '))" target="_blank" rel="noopener" class="underline text-[#116466] font-semibold">Open in Maps</a>
                        <span x-show="loc.lat && loc.lng" class="text-[#89B0AE]">Lat: <span x-text="loc.lat && loc.lat.toFixed ? loc.lat.toFixed(3) : loc.lat"></span>, Lng: <span x-text="loc.lng && loc.lng.toFixed ? loc.lng.toFixed(3) : loc.lng"></span></span>
                      </div>
                    </div>
                  </div>
                </div>
              </template>
            </div>
            <div class="mt-4 rounded-lg bg-[#E5F4F2]/60 border border-[#BEE3DB] p-3 text-[10px] text-[#555B6E] italic flex items-center gap-2">
              <svg class="w-4 h-4 text-[#116466]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 11c1.657 0 3-1.343 3-3S13.657 5 12 5 9 6.343 9 8s1.343 3 3 3Zm0 0c2.386 0 7 1.193 7 3.571V18a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1v-3.429C5 12.193 9.614 11 12 11Z"/></svg>
              (Map markers approximate; verify exact address with therapist.)
            </div>
          </section>
  </template>
  {% endif %}
        <!-- Identity & Background -->
        <template x-if="$store.profileModal.currentUserId === $store.profileModal.therapist.id && ($store.profileModal.therapist.gender || ($store.profileModal.therapist.race_ethnicities && $store.profileModal.therapist.race_ethnicities.length) || ($store.profileModal.therapist.faiths && $store.profileModal.therapist.faiths.length) || ($store.profileModal.therapist.lgbtqia_identities && $store.profileModal.therapist.lgbtqia_identities.length) || ($store.profileModal.therapist.other_identities && $store.profileModal.therapist.other_identities.length))">
          <section class="tc-section p-4 md:p-5" x-cloak>
            <h3 class="text-sm font-bold tracking-wide text-[#555B6E] mb-2">Identity & Background</h3>
            <div class="flex flex-col gap-1 text-xs text-[#555B6E]">
              <div x-show="$store.profileModal.therapist.gender">Gender: <span class="font-semibold" x-text="$store.profileModal.therapist.gender"></span></div>
              <div x-show="$store.profileModal.therapist.race_ethnicities && $store.profileModal.therapist.race_ethnicities.length">Race / Ethnicity: <span class="font-semibold" x-text="$store.profileModal.therapist.race_ethnicities.join(', ')"></span></div>
              <div x-show="$store.profileModal.therapist.faiths && $store.profileModal.therapist.faiths.length">Faith: <span class="font-semibold" x-text="$store.profileModal.therapist.faiths.join(', ')" ></span></div>
              <div x-show="$store.profileModal.therapist.lgbtqia_identities && $store.profileModal.therapist.lgbtqia_identities.length">LGBTQIA+: <span class="font-semibold" x-text="$store.profileModal.therapist.lgbtqia_identities.join(', ')"/></div>
              <div x-show="$store.profileModal.therapist.other_identities && $store.profileModal.therapist.other_identities.length">Other: <span class="font-semibold" x-text="$store.profileModal.therapist.other_identities.join(', ')"/></div>
            </div>
          </section>
        </template>
  <!-- Therapy Types & Specialties (always visible before Fees & Insurance) -->
  <section id="section-therapy" class="tc-section p-4 md:p-5" x-data="therapySpecialtiesManager({ editable: {{ editable|default:0|yesno:'true,false' }} })" x-init="init()">
          <h3 class="text-2xl md:text-[25px] font-semibold tracking-tight text-[#555B6E] mb-2">Therapy Types & Specialties</h3>
          <p class="text-xs md:text-sm text-[#555B6E] mb-6 leading-relaxed max-w-2xl">Add two kinds of information here: <span class="font-semibold text-[#116466]">(1) a short note</span> giving context, and <span class="font-semibold text-[#116466]">(2) structured lists</span> of your therapy modalities and clinical specialties. Star up to 5 specialties to highlight them.</p>
          <!-- Therapy Types -->
          <div class="mb-10">
            <!-- Note Panel -->
            <div class="mb-4" data-edit-wrapper data-field="therapy_types_note">
              <div class="flex items-center gap-2 mb-2">
                <h4 class="text-xs md:text-sm font-semibold tracking-wide text-[#116466] flex items-center gap-2"><span class="px-2 py-0.5 rounded-md bg-[#E5F4F2] text-[#116466] text-[10px] font-bold uppercase">Note</span> Therapy Types Context</h4>
                <button type="button" x-show="editable===true" class="text-[10px] px-2 py-0.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[#116466] hover:bg-[#E5F4F2] font-semibold" @click.stop="$dispatch('edit-rich-text',{field:'therapy_types_note',current:$store.profileModal.therapist.therapy_types_note||'', el:$el})">Edit</button>
              </div>
              <template x-if="$store.profileModal.therapist.therapy_types_note">
                <div class="text-sm md:text-base leading-relaxed font-light text-[#2e4a49] whitespace-pre-line bg-white/70 rounded-lg border border-[#BEE3DB] p-3" x-html="$store.profileModal.therapist.therapy_types_note"></div>
              </template>
              <template x-if="!$store.profileModal.therapist.therapy_types_note">
                <button type="button" x-show="editable" @click.stop="$dispatch('edit-rich-text',{field:'therapy_types_note',current:'', el:$el})" class="w-full text-left group">
                  <div class="p-4 rounded-lg border-2 border-dashed border-[#BEE3DB] bg-white/40 hover:bg-white/70 transition">
                    <p class="text-[12px] text-[#89B0AE] group-hover:text-[#555B6E]">Add a brief note describing how you apply these modalities (e.g., integration style, client fit, populations).</p>
                  </div>
                </button>
                <p x-show="!editable" class="italic text-[12px] text-[#89B0AE]">No therapy types note.</p>
              </template>
            </div>
            <!-- List / Input Panel -->
            <div class="rounded-xl border border-[#BEE3DB] bg-[#F8FBFA] p-4" data-edit-wrapper data-field="therapy_types">
              <div class="flex items-center justify-between mb-3">
                <h4 class="text-xs md:text-sm font-semibold uppercase tracking-wide text-[#555B6E]">Your Therapy Modalities</h4>
                <p class="text-[10px] text-[#89B0AE]" x-show="editable">Add each modality once (e.g., CBT, EMDR, ACT)</p>
              </div>
              <template x-if="$store.profileModal.therapist.therapy_types && $store.profileModal.therapist.therapy_types.length">
                <div class="flex flex-wrap gap-2 mb-4">
                  <template x-for="t in $store.profileModal.therapist.therapy_types" :key="'tt-chip-display-' + t">
                    <span x-show="!editable" class="px-2 py-1 rounded-full bg-[#E5F4F2] text-[#116466] text-[11px] font-medium shadow-sm" x-text="t"></span>
                  </template>
                  <template x-for="t in $store.profileModal.therapist.therapy_types" :key="'tt-chip-editable-' + t">
                    <span x-show="editable" class="group flex items-center gap-1 px-2 py-1 rounded-full bg-white text-[#116466] text-[11px] font-medium shadow-sm ring-1 ring-[#BEE3DB] pr-2">
                      <span x-text="t"></span>
                      <button type="button" @click.stop="removeTherapyType(t)" class="opacity-60 group-hover:opacity-100 text-[#116466] hover:text-[#9b4d49]" aria-label="Remove">✕</button>
                    </span>
                  </template>
                </div>
              </template>
              <template x-if="!($store.profileModal.therapist.therapy_types && $store.profileModal.therapist.therapy_types.length)">
                <p class="italic text-[12px] text-[#89B0AE] mb-4">No therapy types added yet.</p>
              </template>
              <div x-show="editable" class="relative" @keydown="therapyKeydown($event)" @click.outside="clickAwayTherapy()" x-cloak>
                <div class="flex items-center gap-2">
                  <div class="relative flex-1">
                    <input type="text" x-model="therapyQuery" @input="onTherapyInput()" placeholder="Search or add a therapy modality" class="w-full tc-input px-3 py-2 text-sm border border-[#BEE3DB] rounded-md focus:border-[#116466] focus:ring-1 focus:ring-[#116466] bg-white" aria-label="Therapy Type" @focus="onTherapyFocus()" />
                    <div x-show="therapyLoading" class="absolute top-1/2 -translate-y-1/2 right-2 animate-spin rounded-full h-4 w-4 border-[2px] border-[#89B0AE] border-t-transparent"></div>
                    <template x-if="therapyOpen && therapyResults.length">
                      <ul class="absolute z-30 mt-1 max-h-56 w-full overflow-auto rounded-md border border-[#BEE3DB] bg-white shadow-lg text-sm" role="listbox">
                        <template x-for="(p,i) in therapyResults" :key="p.id">
                          <li :id="'tt-opt2-'+i" @mousedown.prevent="selectTherapy(i)" :class="i===therapySelectedIndex ? 'bg-[#E5F4F2] text-[#116466]' : 'hover:bg-[#F1F8F7]'" class="px-3 py-1.5 cursor-pointer flex items-center justify-between">
                            <span x-text="p.name"></span>
                            <span class="text-[10px] text-[#89B0AE]" x-show="caseEq(p.name, therapyQuery)">match</span>
                          </li>
                        </template>
                      </ul>
                    </template>
                  </div>
                  <button type="button" @click="addTherapyType()" :disabled="!therapyQuery.trim()" class="px-3 py-2 rounded-full text-[11px] font-semibold disabled:opacity-30 disabled:cursor-not-allowed bg-[#116466] text-white hover:bg-[#0d4c4d]">Add</button>
                </div>
                <p class="text-[10px] text-[#555B6E] leading-snug mt-2">Press Enter or click Add. Auto-saves shortly after changes.</p>
              </div>
            </div>
          </div>
          <!-- Specialties -->
          <div class="mb-2">
            <!-- Specialties Note Panel -->
            <div class="mb-4" data-edit-wrapper data-field="specialties_note">
              <div class="flex items-center gap-2 mb-2">
                <h4 class="text-xs md:text-sm font-semibold tracking-wide text-[#116466] flex items-center gap-2"><span class="px-2 py-0.5 rounded-md bg-[#FFE8E5] text-[#9b4d49] text-[10px] font-bold uppercase">Note</span> Specialties Context</h4>
                <button type="button" x-show="editable===true" class="text-[10px] px-2 py-0.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[#116466] hover:bg-[#E5F4F2] font-semibold" @click.stop="$dispatch('edit-rich-text',{field:'specialties_note',current:$store.profileModal.therapist.specialties_note||'', el:$el})">Edit</button>
              </div>
              <template x-if="$store.profileModal.therapist.specialties_note">
                <div class="text-sm md:text-base leading-relaxed font-light text-[#2e4a49] whitespace-pre-line bg-white/70 rounded-lg border border-[#BEE3DB] p-3" x-html="$store.profileModal.therapist.specialties_note"></div>
              </template>
              <template x-if="!$store.profileModal.therapist.specialties_note">
                <button type="button" x-show="editable" @click.stop="$dispatch('edit-rich-text',{field:'specialties_note',current:'', el:$el})" class="w-full text-left group">
                  <div class="p-4 rounded-lg border-2 border-dashed border-[#BEE3DB] bg-white/40 hover:bg-white/70 transition">
                    <p class="text-[12px] text-[#89B0AE] group-hover:text-[#555B6E]">Give a short narrative about your focus areas, client populations, or theoretical lens.</p>
                  </div>
                </button>
                <p x-show="!editable" class="italic text-[12px] text-[#89B0AE]">No specialties note.</p>
              </template>
            </div>
            <!-- Specialties List / Input Panel -->
            <div class="rounded-xl border border-[#BEE3DB] bg-[#FDF9F7] p-4" data-edit-wrapper data-field="specialties">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 mb-3">
                <div class="flex items-center gap-3">
                  <h4 class="text-xs md:text-sm font-semibold uppercase tracking-wide text-[#555B6E]">Your Specialties</h4>
                  <template x-if="$store.profileModal.therapist.top_specialties && $store.profileModal.therapist.top_specialties.length">
                    <span class="text-[10px] font-medium text-[#D94F04]">★ <span x-text="$store.profileModal.therapist.top_specialties.length"></span>/5 highlighted</span>
                  </template>
                </div>
                <p class="text-[10px] text-[#89B0AE]" x-show="editable">Star up to 5 to feature at the top</p>
              </div>
              <template x-if="$store.profileModal.therapist.specialties && $store.profileModal.therapist.specialties.length">
                <div class="flex flex-wrap gap-2 mb-4">
                  <template x-for="sp in ($store.profileModal.therapist.specialties || []).filter(s => s.is_top)" :key="'sp-top-chip2-' + (sp.name||sp)">
                    <span class='group flex items-center gap-1 px-2 py-1 rounded-full bg-[#FFDDD0] text-[#444] text-[11px] font-medium shadow-sm pr-2'>
                      <span x-text="sp.name || sp"></span>
                      <button x-show="editable" type="button" @click.stop="toggleTop(sp.name||sp)" class="opacity-60 group-hover:opacity-100 text-[#D94F04]" aria-label="Unmark Top">★</button>
                      <button x-show="editable" type="button" @click.stop="removeSpecialty(sp.name||sp)" class="opacity-60 group-hover:opacity-100 text-[#116466] hover:text-[#9b4d49]" aria-label="Remove">✕</button>
                    </span>
                  </template>
                  <template x-for="sp in ($store.profileModal.therapist.specialties || []).filter(s => !s.is_top)" :key="'sp-rest-chip2-' + (sp.name||sp)">
                    <span class='group flex items-center gap-1 px-2 py-1 rounded-full bg-white text-[#444] text-[11px] font-medium shadow-sm ring-1 ring-[#BEE3DB] pr-2'>
                      <button x-show="editable" type="button" @click.stop="toggleTop(sp.name||sp)" :disabled="($store.profileModal.therapist.specialties||[]).filter(x=>x.is_top).length>=5" :class="(($store.profileModal.therapist.specialties||[]).filter(x=>x.is_top).length>=5) ? 'opacity-30 cursor-not-allowed' : 'opacity-60 group-hover:opacity-100'" class="text-[#F0B429]" aria-label="Mark Top">☆</button>
                      <span x-text="sp.name || sp"></span>
                      <button x-show="editable" type="button" @click.stop="removeSpecialty(sp.name||sp)" class="opacity-60 group-hover:opacity-100 text-[#116466] hover:text-[#9b4d49]" aria-label="Remove">✕</button>
                    </span>
                  </template>
                </div>
              </template>
              <template x-if="!($store.profileModal.therapist.specialties && $store.profileModal.therapist.specialties.length)">
                <p class="italic text-[12px] text-[#89B0AE] mb-4">No specialties added yet.</p>
              </template>
              <div x-show="editable" class="relative" @keydown="specialtyKeydown($event)" @click.outside="clickAwaySpecialty()" x-cloak>
                <div class="flex items-center gap-2">
                  <div class="relative flex-1">
                    <input type="text" x-model="specialtyQuery" @input="onSpecialtyInput()" placeholder="Search or add a specialty" class="w-full tc-input px-3 py-2 text-sm border border-[#BEE3DB] rounded-md focus:border-[#116466] focus:ring-1 focus:ring-[#116466] bg-white" aria-label="Specialty" @focus="onSpecialtyFocus()" />
                    <div x-show="specialtyLoading" class="absolute top-1/2 -translate-y-1/2 right-2 animate-spin rounded-full h-4 w-4 border-[2px] border-[#89B0AE] border-t-transparent"></div>
                    <template x-if="specialtyOpen && specialtyResults.length">
                      <ul class="absolute z-30 mt-1 max-h-56 w-full overflow-auto rounded-md border border-[#BEE3DB] bg-white shadow-lg text-sm" role="listbox">
                        <template x-for="(p,i) in specialtyResults" :key="p.id">
                          <li :id="'sp-opt2-'+i" @mousedown.prevent="selectSpecialty(i)" :class="i===specialtySelectedIndex ? 'bg-[#E5F4F2] text-[#116466]' : 'hover:bg-[#F1F8F7]'" class="px-3 py-1.5 cursor-pointer flex items-center justify-between">
                            <span x-text="p.name"></span>
                            <span class="text-[10px] text-[#89B0AE]" x-show="caseEq(p.name, specialtyQuery)">match</span>
                          </li>
                        </template>
                      </ul>
                    </template>
                  </div>
                  <button type="button" @click="addSpecialty()" :disabled="!specialtyQuery.trim()" class="px-3 py-2 rounded-full text-[11px] font-semibold disabled:opacity-30 disabled:cursor-not-allowed bg-[#116466] text-white hover:bg-[#0d4c4d]">Add</button>
                </div>
                <p class="text-[10px] text-[#555B6E] leading-snug mt-2">Add and (optionally) star up to 5 specialties to feature them. Auto-saves shortly after changes.</p>
              </div>
              <div class="mt-3 flex flex-wrap items-center gap-3 text-[10px] text-[#555B6E]">
                <span class="flex items-center gap-1"><span class="text-[#D94F04]">★</span> Highlighted Specialty</span>
                <span class="flex items-center gap-1"><span class="text-[#F0B429]">☆</span> Click to highlight</span>
                <span class="flex items-center gap-1"><span class="text-[#9b4d49] font-semibold">✕</span> Remove</span>
              </div>
              <p class="text-[10px] text-[#9b4d49] mt-2" x-show="error" x-text="error"></p>
              <p class="text-[10px] text-[#89B0AE] mt-1" x-show="saving">Saving…</p>
            </div>
          </div>
        </section>
        <!-- Details Grid -->
  <section class="grid grid-cols-1 md:grid-cols-2 gap-5 mt-2">
          <!-- Fees & Insurance (Enhanced) -->
  <div id="section-fees" class="tc-section p-4 md:p-5 md:col-span-2 mb-6 md:mb-8" {% if editable %}x-data="feesInsuranceManager()" x-init="init()"{% else %}x-data="{ editable:false, fees:{individual:'',couples:''}, insuranceForm:{provider:''}, providerResults:[], providerOpen:false, providerLoading:false, insError:'', fmt(v){ if(v==null||v==='') return ''; const num=parseFloat((''+v).replace(/[^0-9.]/g,'')); if(isNaN(num)) return v; return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:0,maximumFractionDigits:0}).format(num); }, formatFeeInput(){return '';} }"{% endif %} aria-labelledby="fees-insurance-heading">
    <div class="mb-4">
      <h3 id="fees-insurance-heading" class="text-2xl md:text-[25px] font-semibold tracking-tight text-[#555B6E]">Fees & Insurance</h3>
      <p class="text-[11px] text-[#89B0AE]" x-show="editable">Keep fees transparent; clients value clarity.</p>
    </div>
    <!-- Finance & No-Show side-by-side on larger screens -->
    <div class="mb-6 grid gap-6 md:grid-cols-2">
      <!-- Finance Note (moved to top) -->
      <div data-edit-wrapper data-field="finance_note">
        <div class="flex items-center gap-2 mb-2">
          <h4 class="text-xs font-semibold uppercase tracking-wide text-[#555B6E]">Finance Note</h4>
          <button type="button" x-show="editable" class="text-[10px] px-2 py-0.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[#116466] hover:bg-[#E5F4F2] font-semibold" @click.stop="$dispatch('edit-rich-text',{field:'finance_note',current:$store.profileModal.therapist.finance_note||'', el:$el})">Edit</button>
        </div>
        <template x-if="$store.profileModal.therapist.finance_note">
          <div class="text-base md:text-lg leading-relaxed font-light text-[#2e4a49] whitespace-pre-line" x-html="$store.profileModal.therapist.finance_note"></div>
        </template>
        <template x-if="!$store.profileModal.therapist.finance_note">
          <p class="italic text-[12px] text-[#89B0AE]" x-text="editable ? 'Add a helpful note about fees, policies, or superbills…' : 'No additional fee information.'"></p>
        </template>
      </div>
      <!-- No-Show Policy -->
      <div data-edit-wrapper data-field="no_show_policy">
        <div class="flex items-center gap-2 mb-2">
          <h4 class="text-xs font-semibold uppercase tracking-wide text-[#555B6E]">No-Show Policy</h4>
          <button type="button" x-show="editable" class="text-[10px] px-2 py-0.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[#116466] hover:bg-[#E5F4F2] font-semibold" @click.stop="$dispatch('edit-rich-text',{field:'no_show_policy',current:$store.profileModal.therapist.no_show_policy||'', el:$el})">Edit</button>
        </div>
        <template x-if="$store.profileModal.therapist.no_show_policy">
          <div class="text-base md:text-lg leading-relaxed font-light text-[#2e4a49] whitespace-pre-line" x-html="$store.profileModal.therapist.no_show_policy"></div>
        </template>
        <template x-if="!$store.profileModal.therapist.no_show_policy">
          <p class="italic text-[12px] text-[#89B0AE]" x-text="editable ? 'Describe your cancellation window, fees, and what counts as a no-show…' : 'No no-show policy provided.'"></p>
        </template>
      </div>
    </div>
    <!-- Two-column responsive layout -->
    <div class="grid md:grid-cols-2 gap-8">
      <!-- Fees Column -->
      <div class="flex flex-col gap-5" aria-labelledby="fees-col-heading">
        <h4 id="fees-col-heading" class="text-xs font-semibold uppercase tracking-wide text-[#555B6E]">Session Fees</h4>
  <ul class="space-y-2" role="list">
          <!-- Individual Fee Row -->
          <li class="p-2 rounded-lg transition ring-1 ring-transparent hover:ring-[#BEE3DB] hover:bg-white/60" x-data="{editing:false}" data-edit-wrapper data-field="individual_session_cost">
            <div class="flex items-start justify-between gap-4">
              <div class="flex flex-col cursor-pointer select-none" @click="editable && !editing && (editing=true, $nextTick(()=> $refs.individualInput && $refs.individualInput.focus()))">
                <span class="text-sm font-semibold text-[#116466] flex items-center gap-1">
                  Individual
                  <svg x-show="editable && !editing" class="w-3.5 h-3.5 text-[#89B0AE] group-hover:text-[#116466]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232a2.5 2.5 0 113.536 3.536L8.75 18.786a4 4 0 01-1.414.94l-2.357.786.786-2.357a4 4 0 01.94-1.414l10.527-10.51z"/></svg>
                </span>
                <template x-if="!editing && $store.profileModal.therapist.individual_session_cost">
                  <span class="text-base font-light text-[#2e4a49]" x-text="fmt($store.profileModal.therapist.individual_session_cost)"></span>
                </template>
                <template x-if="!editing && !$store.profileModal.therapist.individual_session_cost">
                  <span class="italic text-[12px] text-[#89B0AE]">Not provided</span>
                </template>
                <div x-show="editing" class="flex items-center gap-2 mt-1" x-cloak>
                  <input x-ref="individualInput" type="text" x-model="fees.individual" placeholder="$0" inputmode="decimal" class="flex-1 rounded-md border border-[#BEE3DB] bg-white px-2 py-1 text-sm focus:border-[#116466] focus:ring-1 focus:ring-[#116466]" @keydown.enter.prevent="saveFee('individual_session_cost', fees.individual); editing=false" @keydown.escape.prevent="fees.individual = formatFeeInput('individual_session_cost'); editing=false" />
                  <button type="button" @click.stop="saveFee('individual_session_cost', fees.individual); editing=false" class="text-[10px] px-2 py-1 rounded bg-[#116466] text-white font-semibold hover:bg-[#0d4c4d]">Save</button>
                  <button type="button" @click.stop="fees.individual = formatFeeInput('individual_session_cost'); editing=false" class="text-[10px] px-2 py-1 rounded bg-white ring-1 ring-[#BEE3DB] text-[#116466] font-semibold hover:bg-[#E5F4F2]">Cancel</button>
                </div>
              </div>
              <div x-show="editable && !editing" class="flex items-center">
                <button type="button" @click.stop="editing=true; $nextTick(()=> $refs.individualInput && $refs.individualInput.focus())" class="text-[10px] px-2 py-1 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[#116466] hover:bg-[#E5F4F2] font-semibold">Edit</button>
              </div>
            </div>
          </li>
          <!-- Couples Fee Row -->
          <li class="p-2 rounded-lg transition ring-1 ring-transparent hover:ring-[#BEE3DB] hover:bg-white/60" x-data="{editing:false}" data-edit-wrapper data-field="couples_session_cost">
            <div class="flex items-start justify-between gap-4">
              <div class="flex flex-col cursor-pointer select-none" @click="editable && !editing && (editing=true, $nextTick(()=> $refs.couplesInput && $refs.couplesInput.focus()))">
                <span class="text-sm font-semibold text-[#116466] flex items-center gap-1">
                  Couples
                  <svg x-show="editable && !editing" class="w-3.5 h-3.5 text-[#89B0AE] group-hover:text-[#116466]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232a2.5 2.5 0 113.536 3.536L8.75 18.786a4 4 0 01-1.414.94l-2.357.786.786-2.357a4 4 0 01.94-1.414l10.527-10.51z"/></svg>
                </span>
                <template x-if="!editing && $store.profileModal.therapist.couples_session_cost">
                  <span class="text-base font-light text-[#2e4a49]" x-text="fmt($store.profileModal.therapist.couples_session_cost)"></span>
                </template>
                <template x-if="!editing && !$store.profileModal.therapist.couples_session_cost">
                  <span class="italic text-[12px] text-[#89B0AE]">Not provided</span>
                </template>
                <div x-show="editing" class="flex items-center gap-2 mt-1" x-cloak>
                  <input x-ref="couplesInput" type="text" x-model="fees.couples" placeholder="$0" inputmode="decimal" class="flex-1 rounded-md border border-[#BEE3DB] bg-white px-2 py-1 text-sm focus:border-[#116466] focus:ring-1 focus:ring-[#116466]" @keydown.enter.prevent="saveFee('couples_session_cost', fees.couples); editing=false" @keydown.escape.prevent="fees.couples = formatFeeInput('couples_session_cost'); editing=false" />
                  <button type="button" @click.stop="saveFee('couples_session_cost', fees.couples); editing=false" class="text-[10px] px-2 py-1 rounded bg-[#116466] text-white font-semibold hover:bg-[#0d4c4d]">Save</button>
                  <button type="button" @click.stop="fees.couples = formatFeeInput('couples_session_cost'); editing=false" class="text-[10px] px-2 py-1 rounded bg-white ring-1 ring-[#BEE3DB] text-[#116466] font-semibold hover:bg-[#E5F4F2]">Cancel</button>
                </div>
              </div>
              <div x-show="editable && !editing" class="flex items-center">
                <button type="button" @click.stop="editing=true; $nextTick(()=> $refs.couplesInput && $refs.couplesInput.focus())" class="text-[10px] px-2 py-1 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[#116466] hover:bg-[#E5F4F2] font-semibold">Edit</button>
              </div>
            </div>
          </li>
        </ul>
        <!-- Sliding Scale Yes/No -->
        <div class="pt-3 mt-4 border-t border-[#BEE3DB]/60" data-edit-wrapper data-field="sliding_scale_pricing_available">
          <div class="flex items-center justify-between mb-2">
            <div class="flex flex-col">
              <span class="text-sm font-semibold text-[#116466] flex items-center gap-2">Sliding Scale
                <template x-if="$store.profileModal.therapist.sliding_scale_pricing_available && !editable"><span class="px-2 py-0.5 rounded-full bg-[#E5F4F2] text-[#116466] text-[10px] font-semibold">Offered</span></template>
                <template x-if="!$store.profileModal.therapist.sliding_scale_pricing_available && !editable"><span class="px-2 py-0.5 rounded-full bg-[#ECEBE8] text-[#555B6E] text-[10px] font-semibold">Not Offered</span></template>
              </span>
              <p class="text-[11px] text-[#555B6E] leading-snug max-w-sm mt-1">Discounted rates based on a client's income and ability to pay. Indicate if you currently offer this.</p>
            </div>
            <div x-show="editable" class="flex items-center gap-2">
              <button type="button" @click="setSliding(true)" :class="$store.profileModal.therapist.sliding_scale_pricing_available ? 'bg-[#116466] text-white' : 'bg-white text-[#116466]'" class="px-3 py-1.5 rounded-full ring-1 ring-[#BEE3DB] text-[11px] font-semibold hover:bg-[#E5F4F2]">Yes</button>
              <button type="button" @click="setSliding(false)" :class="!$store.profileModal.therapist.sliding_scale_pricing_available ? 'bg-[#116466] text-white' : 'bg-white text-[#116466]'" class="px-3 py-1.5 rounded-full ring-1 ring-[#BEE3DB] text-[11px] font-semibold hover:bg-[#E5F4F2]">No</button>
            </div>
          </div>
        </div>
      </div>
      <!-- Insurance Column -->
      <div class="flex flex-col gap-5" aria-labelledby="insurance-col-heading">
        <h4 id="insurance-col-heading" class="text-xs font-semibold uppercase tracking-wide text-[#555B6E]">Insurance</h4>
        <template x-if="$store.profileModal.therapist.insurance_details && $store.profileModal.therapist.insurance_details.length">
          <ul class="space-y-2" role="list">
            <template x-for="(ins, idx) in $store.profileModal.therapist.insurance_details" :key="ins.provider + idx">
              <li class="flex items-start justify-between gap-3 group" :aria-label="'Insurance Provider ' + ins.provider">
                <div class="flex flex-col">
                  <span class="text-sm font-semibold text-[#116466]" x-text="ins.provider"></span>
                  <span class="text-[11px] text-[#555B6E]" x-show="ins.out_of_network">Out of Network</span>
                </div>
                <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition" x-show="editable">
                  <button type="button" class="text-[10px] px-2 py-0.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[#116466] hover:bg-[#E5F4F2]" @click="toggleOON(idx)" x-text="ins.out_of_network ? 'Mark In' : 'Mark OON'"></button>
                  <button type="button" class="text-[10px] px-2 py-0.5 rounded-full bg-[#FFE8E5] text-[#9b4d49] font-semibold hover:bg-[#FFD5CF]" @click="removeInsurance(idx)">Del</button>
                </div>
              </li>
            </template>
          </ul>
        </template>
        <template x-if="!($store.profileModal.therapist.insurance_details && $store.profileModal.therapist.insurance_details.length)">
          <p class="italic text-[12px] text-[#89B0AE]">No insurance providers listed.</p>
        </template>
        <!-- Editor -->
        <div x-show="editable" class="mt-2 rounded-xl bg-statement p-3 ring-1 ring-[#BEE3DB] flex flex-col gap-3" data-edit-wrapper data-field="insurance_details" aria-label="Edit Insurance Providers">
          <div class="flex flex-col gap-2 relative" @keydown="providerKeydown($event)" @click.outside="clickAway()">
            <div class="flex items-center gap-2">
              <div class="relative flex-1">
                <input type="text" x-model="insuranceForm.provider" @input="onProviderInput()" placeholder="Search provider" class="w-full tc-input px-3 py-2 text-sm border border-[#BEE3DB] rounded-md focus:border-[#116466] focus:ring-1 focus:ring-[#116466] bg-white" aria-label="Insurance Provider" @focus="onProviderFocus ? onProviderFocus() : (insuranceForm.provider ? onProviderInput() : (providerResults.length ? (providerOpen=true) : onProviderInput()))" />
                <div x-show="providerLoading" class="absolute top-1/2 -translate-y-1/2 right-2 animate-spin rounded-full h-4 w-4 border-[2px] border-[#89B0AE] border-t-transparent"></div>
                <template x-if="providerOpen && providerResults.length">
                  <ul class="absolute z-20 mt-1 max-h-56 w-full overflow-auto rounded-md border border-[#BEE3DB] bg-white shadow-lg text-sm" role="listbox">
                    <template x-for="(p,i) in providerResults" :key="p.id">
                      <li :id="'prov-opt-'+i" @mousedown.prevent="selectProvider(i)" :class="i===providerSelectedIndex ? 'bg-[#E5F4F2] text-[#116466]' : 'hover:bg-[#F1F8F7]'" class="px-3 py-1.5 cursor-pointer flex items-center justify-between">
                        <span x-text="p.name"></span>
                        <span class="text-[10px] text-[#89B0AE]" x-show="p.name.toLowerCase() === insuranceForm.provider.toLowerCase()">match</span>
                      </li>
                    </template>
                  </ul>
                </template>
              </div>
              <button type="button" @click="addInsurance()" :disabled="!insuranceForm.provider.trim()" class="px-3 py-2 rounded-full text-[11px] font-semibold disabled:opacity-30 disabled:cursor-not-allowed bg-[#116466] text-white hover:bg-[#0d4c4d]">Add</button>
            </div>
            <p class="text-[10px] text-[#555B6E] leading-snug">Type a provider then click Add or press Enter. Suggestions appear as you type. Auto-saves.</p>
          </div>
          <template x-if="insError"><p class="text-[11px] text-[#9b4d49]" x-text="insError"></p></template>
          <p class="text-[10px] text-[#89B0AE]" x-show="providerLoading">Searching...</p>
        </div>
      </div>
    </div>
    <!-- Accessibility Summary List (hidden) -->
    <ul class="sr-only" aria-hidden="true">
      <li>Individual fee: <span x-text="fmt($store.profileModal.therapist.individual_session_cost)"></span></li>
      <li>Couples fee: <span x-text="fmt($store.profileModal.therapist.couples_session_cost)"></span></li>
      <li x-show="$store.profileModal.therapist.sliding_scale_pricing_available">Sliding scale offered</li>
    </ul>
  </div>
          <!-- Qualifications (owner only) -->
          <!-- Client Focus & Approaches -->
           <div id="section-client-focus" class="tc-section p-4 md:p-5 md:col-span-2 mb-6 md:mb-8" x-data="{ editable: {{ editable|default:0|yesno:'true,false' }} }">
            <h3 class="text-2xl md:text-[25px] font-semibold tracking-tight text-[#555B6E] mb-3">Client Focus & Approaches</h3>
            <div class="text-sm md:text-base text-[#555B6E] space-y-6">
              <!-- Participant Types (popover edit) -->
              <div data-edit-wrapper data-field="participant_types" class="space-y-1">
                <div class="flex items-start flex-wrap gap-1" x-show="$store.profileModal.therapist.participant_types && $store.profileModal.therapist.participant_types.length">
                  <span class="font-semibold text-[#116466] mr-1">Participant Types:</span>
                  <template x-for="pt in $store.profileModal.therapist.participant_types" :key="'pt-tag-'+pt">
                    <span class="px-2 py-0.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[#116466] text-[11px] font-medium" x-text="pt"></span>
                  </template>
                  <button x-show="editable" type="button" class="text-[10px] px-2 py-0.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[#116466] hover:bg-[#E5F4F2] transition" @click.stop="$dispatch('edit-participant-types',{ el:$el, current:[...($store.profileModal.therapist.participant_types||[])] })">Edit</button>
                </div>
                <div x-show="!($store.profileModal.therapist.participant_types && $store.profileModal.therapist.participant_types.length)" class="flex items-center gap-2">
                  <p class="italic text-[12px] text-[#89B0AE]">No participant types yet.</p>
                  <button x-show="editable" type="button" class="px-2 py-0.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[#116466] hover:bg-[#E5F4F2] text-[11px] font-semibold" @click.stop="$dispatch('edit-participant-types',{ el:$el, current:[] })">Add Participant Types</button>
                </div>
              </div>
              <!-- Age Groups (popover edit) -->
              <div data-edit-wrapper data-field="age_groups" class="space-y-1">
                <div class="flex items-start flex-wrap gap-1" x-show="$store.profileModal.therapist.age_groups && $store.profileModal.therapist.age_groups.length">
                  <span class="font-semibold text-[#116466] mr-1">Age Groups:</span>
                  <template x-for="ag in $store.profileModal.therapist.age_groups" :key="'ag-tag-'+ag">
                    <span class="px-2 py-0.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[#116466] text-[11px] font-medium" x-text="ag"></span>
                  </template>
                  <button x-show="editable" type="button" class="text-[10px] px-2 py-0.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[#116466] hover:bg-[#E5F4F2] transition" @click.stop="$dispatch('edit-age-groups',{ el:$el, current:[...($store.profileModal.therapist.age_groups||[])] })">Edit</button>
                </div>
                <div x-show="!($store.profileModal.therapist.age_groups && $store.profileModal.therapist.age_groups.length)" class="flex items-center gap-2">
                  <p class="italic text-[12px] text-[#89B0AE]">No age groups yet.</p>
                  <button x-show="editable" type="button" class="px-2 py-0.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[#116466] hover:bg-[#E5F4F2] text-[11px] font-semibold" @click.stop="$dispatch('edit-age-groups',{ el:$el, current:[] })">Add Age Groups</button>
                </div>
              </div>
              <div x-show="$store.profileModal.therapist.mental_health_role">Role: <span class="font-light text-base md:text-lg leading-relaxed text-[#2e4a49]" x-text="$store.profileModal.therapist.mental_health_role"></span></div>
              <div x-show="$store.profileModal.therapist.therapy_types && $store.profileModal.therapist.therapy_types.length">Therapy Modalities: <span class="font-light text-base md:text-lg leading-relaxed text-[#2e4a49]" x-text="($store.profileModal.therapist.therapy_types || []).join(', ')"></span></div>
              <!-- Top Specialties -->
              <div x-show="($store.profileModal.therapist.specialties||[]).some(s=>s.is_top)">Top Specialties: <span class="font-light text-base md:text-lg leading-relaxed text-[#2e4a49]" x-text="($store.profileModal.therapist.specialties||[]).filter(s=>s.is_top).map(s=>s.name).join(', ')"></span></div>
              <!-- Other Specialties -->
              <div x-show="($store.profileModal.therapist.specialties||[]).filter(s=>!s.is_top).length">Other Specialties: <span class="font-light text-base md:text-lg leading-relaxed text-[#2e4a49]" x-text="($store.profileModal.therapist.specialties||[]).filter(s=>!s.is_top).map(s=>s.name).join(', ')"></span></div>
              <!-- Areas of Expertise -->
              <div x-show="$store.profileModal.therapist.areas_of_expertise && $store.profileModal.therapist.areas_of_expertise.length">Areas of Expertise: <span class="font-light text-base md:text-lg leading-relaxed text-[#2e4a49]" x-text="($store.profileModal.therapist.areas_of_expertise || []).join(', ')"></span></div>
            </div>
          </div>
          {% if standalone and editable %}
      <!-- Contact & Web (moved after Client Focus & Approaches, full width) -->
  <div id="section-contact" class="tc-section p-4 md:p-5 md:col-span-2 mb-6 md:mb-8" x-data="contactWebManager()" x-init="init()" x-cloak>
            <div class="flex items-start justify-between mb-4">
              <div>
        <h3 class="text-2xl md:text-[25px] font-semibold tracking-tight text-[#555B6E] mb-3">Contact & Web</h3>
                <p class="text-[10px] text-[#89B0AE] leading-snug max-w-lg">This section is only visible to you while editing. Provide at least one contact method for prospective clients.</p>
              </div>
              <div class="flex items-center gap-2" x-show="!editing">
                <button type="button" @click="startEdit()" class="px-3 py-1.5 rounded-full bg-[#116466] text-white text-[11px] font-semibold shadow hover:bg-[#0d4c4d]">Edit</button>
              </div>
            </div>
            <!-- Read View -->
            <div x-show="!editing" class="text-xs text-[#555B6E] space-y-2">
              <div class="grid sm:grid-cols-2 gap-x-6 gap-y-2">
                <div x-show="$store.profileModal.therapist.phone_number">Phone: <span class="font-semibold" x-text="$store.profileModal.therapist.phone_number"></span><span x-show="$store.profileModal.therapist.phone_extension"> x<span x-text="$store.profileModal.therapist.phone_extension"></span></span></div>
                <div x-show="$store.profileModal.therapist.mobile_number">Mobile: <span class="font-semibold" x-text="$store.profileModal.therapist.mobile_number"></span></div>
                <div x-show="$store.profileModal.therapist.practice_email">Practice Email: <span class="font-semibold" x-text="$store.profileModal.therapist.practice_email"></span></div>
                <div x-show="$store.profileModal.therapist.office_email">Office Email: <span class="font-semibold" x-text="$store.profileModal.therapist.office_email"></span></div>
                <div x-show="$store.profileModal.therapist.practice_website_url">Website: <a :href="$store.profileModal.therapist.practice_website_url" class="text-[#116466] underline font-semibold" target="_blank" rel="noopener">Visit Site</a></div>
              </div>
              <div class="flex flex-wrap gap-2 pt-2" x-show="socialList().length">
                <template x-for="soc in socialList()" :key="soc.key">
                  <a :href="soc.url" target="_blank" class="text-[10px] px-2 py-1 rounded bg-[#E5F4F2] text-[#116466] font-semibold" x-text="soc.label"></a>
                </template>
              </div>
              <div class="pt-2 grid sm:grid-cols-2 gap-2 text-[10px] text-[#555B6E]">
                <div x-show="$store.profileModal.therapist.receive_calls_from_client">Accepting Client Calls</div>
                <div x-show="$store.profileModal.therapist.receive_texts_from_clients">Can Receive Texts</div>
                <div x-show="$store.profileModal.therapist.receive_emails_from_clients">Can Receive Client Emails</div>
                <div x-show="$store.profileModal.therapist.receive_emails_when_client_calls">Email Notification on Calls</div>
              </div>
            </div>
            <!-- Edit Form -->
            <form x-show="editing" @submit.prevent="save()" class="space-y-5" x-transition>
              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-[11px] font-semibold text-[#555B6E] mb-1">Phone Number</label>
                  <input type="text" x-model="form.phone_number" maxlength="32" class="w-full border border-[#BEE3DB] rounded-md px-3 py-2 text-sm bg-white focus:border-[#116466] focus:ring-[#116466]" placeholder="(###) ###-####" />
                </div>
                <div>
                  <label class="block text-[11px] font-semibold text-[#555B6E] mb-1">Phone Extension</label>
                  <input type="text" x-model="form.phone_extension" maxlength="8" class="w-full border border-[#BEE3DB] rounded-md px-3 py-2 text-sm bg-white focus:border-[#116466] focus:ring-[#116466]" placeholder="Ext" />
                </div>
                <div>
                  <label class="block text-[11px] font-semibold text-[#555B6E] mb-1">Mobile Number</label>
                  <input type="text" x-model="form.mobile_number" maxlength="32" class="w-full border border-[#BEE3DB] rounded-md px-3 py-2 text-sm bg-white focus:border-[#116466] focus:ring-[#116466]" placeholder="(###) ###-####" />
                </div>
                <div class="flex items-center gap-2 pt-6">
                  <label class="inline-flex items-center gap-1 text-[11px] font-medium text-[#555B6E]"><input type="checkbox" x-model="form.receive_texts_from_clients" class="accent-[#116466]" /> Allow Texts</label>
                </div>
                <div>
                  <label class="block text-[11px] font-semibold text-[#555B6E] mb-1">Practice Email</label>
                  <input type="email" x-model="form.practice_email" maxlength="128" class="w-full border border-[#BEE3DB] rounded-md px-3 py-2 text-sm bg-white focus:border-[#116466] focus:ring-[#116466]" placeholder="you@practice.com" />
                </div>
                <div>
                  <label class="block text-[11px] font-semibold text-[#555B6E] mb-1">Office Email</label>
                  <input type="email" x-model="form.office_email" maxlength="128" class="w-full border border-[#BEE3DB] rounded-md px-3 py-2 text-sm bg-white focus:border-[#116466] focus:ring-[#116466]" placeholder="office@practice.com" />
                </div>
                <div>
                  <label class="block text-[11px] font-semibold text-[#555B6E] mb-1">Website URL</label>
                  <input type="url" x-model="form.practice_website_url" maxlength="256" class="w-full border border-[#BEE3DB] rounded-md px-3 py-2 text-sm bg-white focus:border-[#116466] focus:ring-[#116466]" placeholder="https://" />
                </div>
                <div class="flex flex-col gap-2 pt-6">
                  <label class="inline-flex items-center gap-1 text-[11px] font-medium text-[#555B6E]"><input type="checkbox" x-model="form.receive_calls_from_client" class="accent-[#116466]" /> Accept Calls</label>
                  <label class="inline-flex items-center gap-1 text-[11px] font-medium text-[#555B6E]"><input type="checkbox" x-model="form.receive_emails_from_clients" class="accent-[#116466]" /> Accept Client Emails</label>
                  <label class="inline-flex items-center gap-1 text-[11px] font-medium text-[#555B6E]"><input type="checkbox" x-model="form.receive_emails_when_client_calls" class="accent-[#116466]" /> Email When Client Calls</label>
                </div>
              </div>
              <div class="border-t border-[#BEE3DB] pt-4 grid md:grid-cols-3 gap-4">
                <template x-for="f in socialFields" :key="f.key">
                  <div>
                    <label class="block text-[11px] font-semibold text-[#555B6E] mb-1" x-text="f.label"></label>
                    <input :type="f.type" x-model="form[f.key]" maxlength="256" class="w-full border border-[#BEE3DB] rounded-md px-2 py-2 text-sm bg-white focus:border-[#116466] focus:ring-[#116466]" :placeholder="f.placeholder" />
                  </div>
                </template>
              </div>
              <div class="flex items-center gap-3 pt-2">
                <button type="submit" :disabled="saving" class="px-4 py-2 rounded-full bg-[#116466] text-white text-[12px] font-semibold shadow disabled:opacity-40" x-text="saving ? 'Saving…' : 'Save Changes'"></button>
                <button type="button" @click="cancel()" :disabled="saving" class="px-4 py-2 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[12px] font-medium hover:bg-[#E5F4F2]">Cancel</button>
                <p class="text-[11px] text-[#9b4d49]" x-show="error" x-text="error"></p>
                <p class="text-[11px] text-[#89B0AE]" x-show="success">Saved</p>
              </div>
            </form>
          </div>
          {% endif %}
          {% if standalone %}
          <!-- Qualifications & Education (final section - edit page only) -->
          <div id="section-qualifications" class="tc-section p-4 md:p-5 md:col-span-2 mb-6 md:mb-8" x-data="qualificationsManager()" x-init="init()" x-cloak>
            <div class="flex items-start justify-between mb-4">
              <h3 class="text-2xl md:text-[25px] font-semibold tracking-tight text-[#555B6E]">Qualifications &amp; Education</h3>
            </div>
            <div class="text-sm text-[#555B6E] space-y-8">
              <!-- License (detailed editable) -->
              <div x-data="{ editing:false, showLicenseNameOverride:false, form:{ license_type:'', license_number:'', license_state:'', license_expiration:'', license_first_name:'', license_last_name:'' }, states:['AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'], init(){ this.sync(); }, sync(){ const t=$store.profileModal.therapist||{}; this.form.license_type=t.license_type||''; this.form.license_number=t.license_number||''; this.form.license_state=t.license_state||''; this.form.license_expiration=t.license_expiration||''; this.form.license_first_name=t.license_first_name||''; this.form.license_last_name=t.license_last_name||''; this.showLicenseNameOverride = !!(this.form.license_first_name || this.form.license_last_name); }, save(){ if(this.saving) return; this.error=''; const payload={}; for(const k in this.form){ if(this.form[k]!==($store.profileModal.therapist[k]||'')) payload[k]=this.form[k]; } if(!this.showLicenseNameOverride){ // ensure cleared if not overriding
                  if(this.form.license_first_name || this.form.license_last_name){ this.form.license_first_name=''; this.form.license_last_name=''; payload.license_first_name=''; payload.license_last_name=''; }
                }
                if(Object.keys(payload).length===0){ this.editing=false; return; } this.saving=true; fetch('/users/api/profile/update/', {method:'PATCH', headers:{'Content-Type':'application/json','X-CSRFToken': TC_CSRF}, body: JSON.stringify(payload)}).then(r=>r.json().then(d=>[r,d])).then(([r,d])=>{ if(!r.ok){ this.error=(d.errors && Object.values(d.errors)[0]) || d.error || 'Save failed'; return; } if(window.__profileEdit){ window.__profileEdit.applyData(d); window.__profileEdit.notify('Saved'); } this.editing=false; this.sync(); }).catch(()=> this.error='Network error').finally(()=> this.saving=false); }, cancel(){ this.editing=false; this.sync(); }, editing:false, error:'', saving:false, differentName(){ const t=$store.profileModal.therapist||{}; return this.showLicenseNameOverride || ( (t.first_name||'').trim() !== (t.license_first_name||'').trim() ) || ( (t.last_name||'').trim() !== (t.license_last_name||'').trim() ); } }" class="space-y-2">
                <div class="flex items-center justify-between">
                  <div class="font-semibold text-[#116466]">Professional License</div>
                  <div class="flex items-center gap-2" x-show="!editing">
                    <button type="button" @click="editing=true" class="px-3 py-1.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[11px] font-semibold text-[#116466] hover:bg-[#E5F4F2]">Edit</button>
                  </div>
                </div>
                <!-- Display Mode -->
                <div x-show="!editing" class="text-[#2e4a49] text-sm space-y-0.5">
                  <p>
                    <span x-text="$store.profileModal.therapist.license_type || '—'"></span>
                    <span x-show="$store.profileModal.therapist.license_number"> • <span x-text="$store.profileModal.therapist.license_number"></span></span>
                    <span class="opacity-70" x-show="$store.profileModal.therapist.license_state"> (<span x-text="$store.profileModal.therapist.license_state"></span>)</span>
                  </p>
                  <p class="text-[11px] text-[#555B6E]/70" x-show="$store.profileModal.therapist.license_expiration">Expires <span x-text="$store.profileModal.therapist.license_expiration"></span></p>
                  <template x-if="$store.profileModal.therapist.license_first_name || $store.profileModal.therapist.license_last_name">
                    <p class="text-[11px] text-[#555B6E]/80">Licensed As: <span x-text="$store.profileModal.therapist.license_first_name || $store.profileModal.therapist.first_name"></span> <span x-text="$store.profileModal.therapist.license_last_name || $store.profileModal.therapist.last_name"></span></p>
                  </template>
                </div>
                <!-- Edit Mode -->
                <form x-show="editing" @submit.prevent="save()" class="bg-white/60 rounded-lg p-3 ring-1 ring-[#BEE3DB] space-y-3">
                  <div class="grid md:grid-cols-6 gap-3">
                    <div class="md:col-span-2">
                      <label class="block text-[11px] font-semibold mb-1">License Type</label>
                      <button type="button" @click="$dispatch('edit-select',{field:'license_type', value: form.license_type, el:$el})" class="w-full text-left border border-[#BEE3DB] rounded-md px-2 py-1.5 text-[13px] bg-white hover:bg-[#F5F4F3]" x-text="form.license_type || 'Select License Type'" ></button>
                    </div>
                    <div>
                      <label class="block text-[11px] font-semibold mb-1">Number</label>
                      <input type="text" x-model="form.license_number" maxlength="32" class="w-full border border-[#BEE3DB] rounded-md px-2 py-1.5 text-sm focus:border-[#116466] focus:ring-[#116466]" />
                    </div>
                    <div>
                      <label class="block text-[11px] font-semibold mb-1">State</label>
                      <div class="relative">
                        <select x-model="form.license_state" class="w-full appearance-none border border-[#BEE3DB] rounded-md px-3 pr-9 py-2 text-[13px] leading-tight bg-white text-[#2e4a49] focus:outline-none focus:border-[#116466] focus:ring-2 focus:ring-[#116466]/30 uppercase transition shadow-sm">
                          <option value="">--</option>
                          <template x-for="st in states" :key="st">
                            <option :value="st" x-text="st"></option>
                          </template>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-2 flex items-center">
                          <svg class="w-4 h-4 text-[#116466] opacity-80" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6"/></svg>
                        </div>
                      </div>
                    </div>
                    <div>
                      <label class="block text-[11px] font-semibold mb-1">Expiration (MM/YYYY)</label>
                      <input type="text" x-model="form.license_expiration" maxlength="7" placeholder="08/2026" class="w-full border border-[#BEE3DB] rounded-md px-2 py-1.5 text-sm focus:border-[#116466] focus:ring-[#116466]" />
                    </div>
                    <div class="md:col-span-2">
                      <label class="block text-[11px] font-semibold mb-1" x-text="(() => { const fn=$store.profileModal.therapist.first_name||''; const ln=$store.profileModal.therapist.last_name||''; const full=[fn,ln].filter(Boolean).join(' '); return 'Name On License Matches Profile' + (full ? ' ('+ full +')' : '') + '?'; })()"></label>
                      <div class="flex items-center gap-3 text-[11px]">
                        <label class="inline-flex items-center gap-1"><input type="radio" name="licname" :checked="!showLicenseNameOverride" @change="showLicenseNameOverride=false; form.license_first_name=''; form.license_last_name='';" class="accent-[#116466]" /> <span>Yes</span></label>
                        <label class="inline-flex items-center gap-1"><input type="radio" name="licname" :checked="showLicenseNameOverride" @change="showLicenseNameOverride=true; if(!(form.license_first_name||form.license_last_name)){ form.license_first_name=''; form.license_last_name=''; }" class="accent-[#116466]" /> <span>No</span></label>
                      </div>
                    </div>
                    <template x-if="showLicenseNameOverride">
                      <div class="md:col-span-3 flex gap-3">
                        <div class="flex-1">
                          <label class="block text-[11px] font-semibold mb-1">Licensed First Name</label>
                          <input type="text" x-model="form.license_first_name" :placeholder="$store.profileModal.therapist.first_name || 'First'" maxlength="64" class="w-full border border-[#BEE3DB] rounded-md px-2 py-1.5 text-sm focus:border-[#116466] focus:ring-[#116466]" />
                        </div>
                        <div class="flex-1">
                          <label class="block text-[11px] font-semibold mb-1">Licensed Last Name</label>
                          <input type="text" x-model="form.license_last_name" :placeholder="$store.profileModal.therapist.last_name || 'Last'" maxlength="64" class="w-full border border-[#BEE3DB] rounded-md px-2 py-1.5 text-sm focus:border-[#116466] focus:ring-[#116466]" />
                        </div>
                      </div>
                    </template>
                  </div>
                  <div class="flex items-center gap-2 pt-1">
                    <button type="submit" :disabled="saving" class="px-3 py-1.5 rounded-full bg-[#116466] text-white text-[11px] font-semibold disabled:opacity-40" x-text="saving ? 'Saving…' : 'Save License'"></button>
                    <button type="button" @click="cancel()" class="px-3 py-1.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[11px] font-medium hover:bg-[#E5F4F2]">Cancel</button>
                    <p class="text-[11px] text-[#9b4d49]" x-show="error" x-text="error"></p>
                  </div>
                </form>
              </div>
              <!-- Additional Credentials -->
              <div>
                <div class="flex items-center justify-between mb-2">
                  <div class="font-semibold text-[#116466]">Additional Credentials</div>
                  <div class="flex items-center gap-2" x-show="!addingCredential && !addingEducation">
                    <button type="button" @click="startAddCredential()" class="px-3 py-1.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[11px] font-semibold text-[#116466] hover:bg-[#E5F4F2]">Add Credential</button>
                  </div>
                </div>
                <template x-if="!($store.profileModal.therapist.additional_credentials && $store.profileModal.therapist.additional_credentials.length)">
                  <p class="text-xs italic text-[#89B0AE]">No credentials added.</p>
                </template>
                <ul class="space-y-1 text-sm" x-show="$store.profileModal.therapist.additional_credentials && $store.profileModal.therapist.additional_credentials.length">
                  <template x-for="c in $store.profileModal.therapist.additional_credentials" :key="c.id">
                    <li class="group flex flex-wrap items-center gap-1 px-2 py-1 rounded-md hover:bg-[#F5F4F3]">
                      <span class="font-medium" x-text="c.type || 'Credential'"></span>
                      <span class="opacity-70">—</span>
                      <span x-text="c.organization_name"></span>
                      <span x-show="c.id_number">(<span x-text="c.id_number"></span>)</span>
                      <span class="opacity-70" x-show="c.year_issued">,</span>
                      <span x-text="c.year_issued"></span>
                      <button type="button" @click="editCredential(c)" class="opacity-0 group-hover:opacity-100 ml-2 text-[10px] px-2 py-0.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[#116466] hover:bg-[#E5F4F2]">Edit</button>
                      <button type="button" @click="deleteCredential(c)" class="opacity-0 group-hover:opacity-100 text-[10px] px-2 py-0.5 rounded-full bg-white ring-1 ring-[#FFB3A8] text-[#9b4d49] hover:bg-[#FFE8E5]">Delete</button>
                    </li>
                  </template>
                </ul>
                <!-- Credential Form -->
                <form x-show="addingCredential" @submit.prevent="saveCredential()" class="mt-3 space-y-3 bg-white/60 rounded-lg p-3 ring-1 ring-[#BEE3DB]">
                  <div class="grid md:grid-cols-4 gap-3">
                    <div class="md:col-span-2">
                      <label class="block text-[11px] font-semibold mb-1">Organization</label>
                      <input type="text" x-model="credForm.organization_name" maxlength="64" class="w-full border border-[#BEE3DB] rounded-md px-2 py-1.5 text-sm focus:border-[#116466] focus:ring-[#116466]" required />
                    </div>
                    <div>
                      <label class="block text-[11px] font-semibold mb-1">Type</label>
                      <input type="text" x-model="credForm.type" maxlength="16" class="w-full border border-[#BEE3DB] rounded-md px-2 py-1.5 text-sm focus:border-[#116466] focus:ring-[#116466]" placeholder="Membership" />
                    </div>
                    <div>
                      <label class="block text-[11px] font-semibold mb-1">Year Issued</label>
                      <input type="text" x-model="credForm.year_issued" maxlength="4" class="w-full border border-[#BEE3DB] rounded-md px-2 py-1.5 text-sm focus:border-[#116466] focus:ring-[#116466]" required />
                    </div>
                    <div>
                      <label class="block text-[11px] font-semibold mb-1">ID Number</label>
                      <input type="text" x-model="credForm.id_number" maxlength="32" class="w-full border border-[#BEE3DB] rounded-md px-2 py-1.5 text-sm focus:border-[#116466] focus:ring-[#116466]" />
                    </div>
                  </div>
                  <div class="flex items-center gap-2 pt-1">
                    <button type="submit" :disabled="saving" class="px-3 py-1.5 rounded-full bg-[#116466] text-white text-[11px] font-semibold disabled:opacity-40" x-text="credForm.id ? 'Update Credential' : 'Add Credential'"></button>
                    <button type="button" @click="cancelCredential()" class="px-3 py-1.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[11px] font-medium hover:bg-[#E5F4F2]">Cancel</button>
                    <p class="text-[11px] text-[#9b4d49]" x-show="error" x-text="error"></p>
                  </div>
                </form>
              </div>
              <!-- Education History -->
              <div>
                <div class="flex items-center justify-between mb-2">
                  <div class="font-semibold text-[#116466]">Education</div>
                  <div class="flex items-center gap-2" x-show="!addingEducation && !addingCredential">
                    <button type="button" @click="startAddEducation()" class="px-3 py-1.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[11px] font-semibold text-[#116466] hover:bg-[#E5F4F2]">Add Education</button>
                  </div>
                </div>
                <template x-if="!($store.profileModal.therapist.educations && $store.profileModal.therapist.educations.length)">
                  <p class="text-xs italic text-[#89B0AE]">No education records added.</p>
                </template>
                <ul class="space-y-1 text-sm" x-show="$store.profileModal.therapist.educations && $store.profileModal.therapist.educations.length">
                  <template x-for="e in $store.profileModal.therapist.educations" :key="e.id">
                    <li class="group flex flex-wrap items-center gap-1 px-2 py-1 rounded-md hover:bg-[#F5F4F3]">
                      <span class="font-medium" x-text="e.degree_diploma"></span>
                      <span class="opacity-70">—</span>
                      <span x-text="e.school"></span>
                      <span class="opacity-70" x-show="e.year_graduated">(<span x-text="e.year_graduated"></span>)</span>
                      <span class="text-[11px] ml-1 opacity-60" x-show="e.year_began_practice">• Began Practice <span x-text="e.year_began_practice"></span></span>
                      <button type="button" @click="editEducation(e)" class="opacity-0 group-hover:opacity-100 ml-2 text-[10px] px-2 py-0.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[#116466] hover:bg-[#E5F4F2]">Edit</button>
                      <button type="button" @click="deleteEducation(e)" class="opacity-0 group-hover:opacity-100 text-[10px] px-2 py-0.5 rounded-full bg-white ring-1 ring-[#FFB3A8] text-[#9b4d49] hover:bg-[#FFE8E5]">Delete</button>
                    </li>
                  </template>
                </ul>
                <!-- Education Form -->
                <form x-show="addingEducation" @submit.prevent="saveEducation()" class="mt-3 space-y-3 bg-white/60 rounded-lg p-3 ring-1 ring-[#BEE3DB]">
                  <div class="grid md:grid-cols-5 gap-3">
                    <div class="md:col-span-2">
                      <label class="block text-[11px] font-semibold mb-1">School</label>
                      <input type="text" x-model="eduForm.school" maxlength="64" class="w-full border border-[#BEE3DB] rounded-md px-2 py-1.5 text-sm focus:border-[#116466] focus:ring-[#116466]" required />
                    </div>
                    <div>
                      <label class="block text-[11px] font-semibold mb-1">Degree</label>
                      <input type="text" x-model="eduForm.degree_diploma" maxlength="32" class="w-full border border-[#BEE3DB] rounded-md px-2 py-1.5 text-sm focus:border-[#116466] focus:ring-[#116466]" required />
                    </div>
                    <div>
                      <label class="block text-[11px] font-semibold mb-1">Year Graduated</label>
                      <input type="text" x-model="eduForm.year_graduated" maxlength="4" class="w-full border border-[#BEE3DB] rounded-md px-2 py-1.5 text-sm focus:border-[#116466] focus:ring-[#116466]" required />
                    </div>
                    <div>
                      <label class="block text-[11px] font-semibold mb-1">Year Began Practice</label>
                      <input type="text" x-model="eduForm.year_began_practice" maxlength="4" class="w-full border border-[#BEE3DB] rounded-md px-2 py-1.5 text-sm focus:border-[#116466] focus:ring-[#116466]" />
                    </div>
                  </div>
                  <div class="flex items-center gap-2 pt-1">
                    <button type="submit" :disabled="saving" class="px-3 py-1.5 rounded-full bg-[#116466] text-white text-[11px] font-semibold disabled:opacity-40" x-text="eduForm.id ? 'Update Education' : 'Add Education'"></button>
                    <button type="button" @click="cancelEducation()" class="px-3 py-1.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[11px] font-medium hover:bg-[#E5F4F2]">Cancel</button>
                    <p class="text-[11px] text-[#9b4d49]" x-show="error" x-text="error"></p>
                  </div>
                </form>
              </div>
              <!-- Years in Practice -->
              <!-- Year Started Practice (explicit override) -->
              <div x-data="{
                  editing:false,
                  years:[],
                  sel:'',
                  init(){ const now=new Date().getFullYear(); const start=now-69; const out=[]; for(let y=now; y>=start; y--){ out.push(''+y); } this.years=out; const cur=$store.profileModal.therapist.year_started_practice||''; this.sel = cur && this.years.includes(cur) ? cur : ''; },
                  startEdit(){ this.editing=true; const cur=$store.profileModal.therapist.year_started_practice||''; this.sel = cur; },
                  cancel(){ this.editing=false; },
                  save(){ const v=this.sel||''; window.__tcSaveProfileField('year_started_practice', v); this.editing=false; },
                  clear(){ this.sel=''; window.__tcSaveProfileField('year_started_practice',''); this.editing=false; }
                }" class="space-y-1">
                <div class="flex items-center justify-between">
                  <div class="font-semibold text-[#116466]">Year Started Practice</div>
                  <div class="flex items-center gap-2" x-show="!editing">
                    <button type="button" @click="startEdit()" class="px-3 py-1 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[11px] font-semibold text-[#116466] hover:bg-[#E5F4F2]">Edit</button>
                    <button type="button" @click="clear()" x-show="$store.profileModal.therapist.year_started_practice" class="px-3 py-1 rounded-full bg-white ring-1 ring-[#FFB3A8] text-[11px] font-medium text-[#9b4d49] hover:bg-[#FFE8E5]">Clear</button>
                  </div>
                </div>
                <!-- Display Mode -->
                <p class="text-[#2e4a49] text-sm" x-show="!editing && $store.profileModal.therapist.year_started_practice" x-text="$store.profileModal.therapist.year_started_practice"></p>
                <p class="text-xs italic text-[#89B0AE]" x-show="!editing && !$store.profileModal.therapist.year_started_practice">Not set (will be inferred from earliest education record)</p>
                <!-- Edit Mode -->
                <form x-show="editing" @submit.prevent="save()" class="bg-white/60 rounded-lg p-3 ring-1 ring-[#BEE3DB] flex flex-wrap items-end gap-3">
                  <div class="relative">
                    <label class="block text-[11px] font-semibold mb-1">Select Year</label>
                    <div class="relative">
                      <select x-model="sel" class="w-36 appearance-none border border-[#BEE3DB] rounded-md px-3 pr-8 py-2 text-[13px] leading-tight bg-white text-[#2e4a49] focus:outline-none focus:border-[#116466] focus:ring-2 focus:ring-[#116466]/30 transition shadow-sm">
                        <option value="">-- Not Set --</option>
                        <template x-for="y in years" :key="y">
                          <option :value="y" x-text="y"></option>
                        </template>
                      </select>
                      <div class="pointer-events-none absolute inset-y-0 right-2 flex items-center">
                        <svg class="w-4 h-4 text-[#116466] opacity-80" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6"/></svg>
                      </div>
                    </div>
                  </div>
                  <div class="flex items-center gap-2 pb-1">
                    <button type="submit" class="px-3 py-1.5 rounded-full bg-[#116466] text-white text-[11px] font-semibold">Save</button>
                    <button type="button" @click="cancel()" class="px-3 py-1.5 rounded-full bg-white ring-1 ring-[#BEE3DB] text-[11px] font-medium hover:bg-[#E5F4F2]">Cancel</button>
                  </div>
                </form>
              </div>
              <div x-show="$store.profileModal.therapist.years_in_practice">
                <div class="font-semibold text-[#116466] mb-1">Years in Practice</div>
                <p class="text-[#2e4a49] text-sm"><span x-text="$store.profileModal.therapist.years_in_practice"></span></p>
              </div>
            </div>
          </div>
          {% endif %}
        </section>
        {% if standalone and editable %}
        <!-- Right Sidebar after content -->
  <aside x-data="profileProgressTracker()" x-init="init()" class="hidden lg:flex flex-col w-64 fixed top-28 right-6 xl:right-10 z-40 h-max" aria-label="Profile Progress">
          <div class="rounded-2xl bg-white/70 ring-1 ring-[#BEE3DB] p-4 shadow-lg flex flex-col gap-4">
            <div>
              <h4 class="text-sm font-semibold text-[#116466] tracking-wide mb-1">Profile Progress</h4>
              <div class="w-full h-2 bg-[#E5F4F2] rounded-full overflow-hidden"><div class="h-full bg-[#116466] transition-all" :style="'width:' + overall.percent + '%'" aria-hidden="true"></div></div>
              <p class="mt-1 text-[11px] text-[#555B6E]"><span x-text="overall.completedFields"></span>/<span x-text="overall.totalFields"></span> Fields (<span x-text="Math.round(overall.percent)"></span>%)</p>
            </div>
            <ul class="flex flex-col gap-2 text-[12px]" role="list">
              <template x-for="sec in sections" :key="sec.id">
                <li>
                  <button @click="scrollTo(sec.id)" class="group w-full text-left flex items-center gap-2 px-2 py-1.5 rounded-lg transition" :class="sec.active ? 'bg-[#E5F4F2] text-[#116466]' : 'hover:bg-[#F5F4F3] text-[#555B6E]'">
                    <span class="flex-1 truncate" x-text="sec.label"></span>
                    <span class="text-[10px] font-semibold tabular-nums" :class="sec.completed===sec.total ? 'text-[#116466]' : 'text-[#89B0AE]'" x-text="sec.completed + '/' + sec.total">0/0</span>
                    <span class="w-3 h-3 rounded-full ring-1 ring-[#BEE3DB]" :class="sec.completed===sec.total ? 'bg-[#116466]' : (sec.completed>0 ? 'bg-[#F0B429]' : 'bg-white')" aria-hidden="true"></span>
                  </button>
                </li>
              </template>
            </ul>
            <div class="pt-1 border-t border-[#BEE3DB]/60">
              <button @click="focusFirstIncomplete()" class="w-full mt-3 px-3 py-2 rounded-full bg-[#116466] text-white text-[11px] font-semibold hover:bg-[#0d4c4d] transition">Go To Next Incomplete</button>
            </div>
          </div>
        </aside>
  <script src="{% static 'profile_helpers.js' %}"></script>
        {% endif %}
  </div><!-- end lower sections group -->
  </div><!-- Unified Sections Wrapper END -->
  <!-- Error State -->
        <div x-show="$store.profileModal.error" class="bg-red-100 text-red-700 text-xs rounded-md px-3 py-2">Failed to load profile: <span x-text="$store.profileModal.error"></span></div>
        <!-- Debug: All Fields Raw Listing -->
  <section x-show="showAllFields && $store.profileModal.currentUserId === $store.profileModal.therapist.id" x-transition.opacity x-cloak class="border border-dashed border-[#89B0AE] rounded-xl p-4 bg-white/70 -mt-4">
          <h3 class="text-sm font-bold tracking-wide text-[#555B6E] mb-3 flex items-center gap-2">
            <svg class="w-4 h-4 text-[#116466]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6l4 2"/></svg>
            All Profile Fields (Debug View)
          </h3>
          <div class="grid md:grid-cols-2 gap-4 mb-4 max-h-72 overflow-auto pr-2">
            <template x-for="field in expectedFields" :key="field">
              <div class="text-[11px] leading-snug flex flex-col gap-0.5 p-2 rounded-lg" :class="$store.profileModal.therapist[field] === undefined ? 'bg-[#FFE8E5] border border-[#FFB3A8]' : 'bg-[#F2FAF9] border border-[#BEE3DB]'">
                <div class="font-semibold text-[#555B6E]" x-text="displayName(field)"></div>
                <template x-if="$store.profileModal.therapist[field] !== undefined">
                  <div class="text-[#116466] break-words" x-text="(typeof $store.profileModal.therapist[field] === 'object') ? JSON.stringify($store.profileModal.therapist[field]) : $store.profileModal.therapist[field]"></div>
                </template>
                <template x-if="$store.profileModal.therapist[field] === undefined">
                  <div class="text-[#9b4d49] italic">(missing)</div>
                </template>
              </div>
            </template>
          </div>
          <details class="mt-2">
            <summary class="cursor-pointer text-xs font-semibold text-[#116466]">Raw Therapist JSON</summary>
            <pre class="mt-2 p-3 bg-[#1e2727] text-[#E5F4F2] text-[10px] rounded-lg overflow-auto max-h-72" x-text="JSON.stringify($store.profileModal.therapist, null, 2)"></pre>
          </details>
        </section>
        {% if not standalone %}
        <!-- Footer Actions (modal only) -->
        <div class="pt-6 pb-8 px-6 md:px-10 flex flex-wrap gap-4">
          <button @click="$store.profileModal && $store.profileModal.close()" class="px-5 py-2.5 rounded-lg font-semibold bg-[#116466] text-white text-sm hover:bg-[#0d4c4d] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#89B0AE] transition">Close</button>
          <a :href="'/users/contact/' + $store.profileModal.therapist.id + '/'" target="_blank" class="px-5 py-2.5 rounded-lg font-semibold bg-[#FF9950] text-white text-sm hover:bg-[#555B6E] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#89B0AE] transition">Contact</a>
        </div>
        {% endif %}
      </div>
  </div>
  </div> <!-- end clipping wrapper -->
    </div> <!-- gradient content wrapper -->
  </div>
 </div>
<!-- Fallback inline lightbox if global mediaLightbox store not available -->
<div x-cloak x-show="$store.profileModal.lightboxImage && !$store.mediaLightbox" class="fixed inset-0 z-[115] flex items-center justify-center bg-black/80" @click.self="$store.profileModal.lightboxImage=null" @keydown.escape.window="$store.profileModal.lightboxImage=null">
  <div class="relative max-w-5xl w-[92vw]">
  <button @click="$store.profileModal.lightboxImage=null" class="absolute -top-12 right-0 bg-[#FF9950] hover:bg-[#555B6E] text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg" aria-label="Close image">
      <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2.4' class='w-7 h-7'><path stroke-linecap='round' stroke-linejoin='round' d='M6 18L18 6M6 6l12 12'/></svg>
    </button>
  <img :src="$store.profileModal.lightboxImage" class="w-full max-h-[78vh] object-contain rounded-xl shadow-2xl" />
  </div>
</div>
