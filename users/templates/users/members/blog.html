{% extends 'base.html' %}
{% load static %}
{% block content %}
<div id="members-blog" class="w-full max-w-none py-4 px-0">
  <style>
    .scaffold-layout{display:block}
    .scaffold-layout__inner{max-width:1128px;margin:0 auto;padding:0 16px}
    .scaffold-layout__row{display:flex;gap:16px;align-items:flex-start}
    .scaffold-layout__content{flex:1 1 auto;min-width:0}
    .scaffold-layout__aside{display:none}
    @media(min-width:1024px){ .scaffold-layout__aside{display:block;position:relative;flex:0 0 300px} }
    @media(min-width:1280px){ .scaffold-layout__content{flex:0 0 65%;max-width:65%} }
    .artdeco-card{background:#fff;border:1px solid #BEE3DB;border-radius:8px}

  /* Emoji picker */
  .emoji-btn{border:1px solid #BEE3DB;background:#fff;border-radius:6px;line-height:1;padding:6px;cursor:pointer}
  .emoji-btn:hover{background:#F6FFF8}
  .emoji-popover{position:fixed;z-index:520;background:#fff;border:1px solid #BEE3DB;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:6px;width:260px}
  .emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:4px}
  .emoji-cell{display:flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:6px;cursor:pointer}
  .emoji-cell:hover{background:#F6FFF8}
  /* Tiny spinner for uploading */
  .tc-spinner{width:16px;height:16px;border:2px solid #BEE3DB;border-top-color:#89B0AE;border-radius:9999px;animation:tcspin .7s linear infinite}
  @keyframes tcspin{to{transform:rotate(360deg)}}
  /* Rich text editor */
  .tc-toolbar{display:flex;flex-wrap:wrap;gap:6px;padding:6px;border:1px solid #BEE3DB;border-bottom:0;border-top-left-radius:8px;border-top-right-radius:8px;background:#fff}
  .tc-tool{border:1px solid #BEE3DB;background:#fff;border-radius:6px;padding:4px 8px;font-size:12px;color:#555B6E;cursor:pointer}
  .tc-tool:hover{background:#F6FFF8}
  .tc-editor{min-height:180px;border:1px solid #BEE3DB;border-bottom-left-radius:8px;border-bottom-right-radius:8px;background:#FAF9F9;padding:10px;outline:none}
  .tc-editor:empty:before{content:attr(data-placeholder); color:#9AA5B1}
  /* Media preview grid */
  .tc-media-tile{position:relative;border:1px solid #BEE3DB;border-radius:8px;overflow:hidden;background:#FAF9F9}
  .tc-media-tile img{display:block;width:100%;height:100%;object-fit:cover}
  .tc-media-cover{position:absolute;left:6px;top:6px;background:rgba(255,255,255,.92);border:1px solid #BEE3DB;border-radius:6px;padding:3px 6px;font-size:11px;color:#555B6E;display:flex;align-items:center;gap:6px}
  .tc-media-video{display:flex;align-items:center;justify-content:center;color:#555B6E;height:100%;font-size:12px}
  .tc-media-remove{position:absolute;right:6px;top:6px;background:rgba(255,255,255,.92);border:1px solid #BEE3DB;border-radius:9999px;width:22px;height:22px;display:flex;align-items:center;justify-content:center;color:#555B6E;cursor:pointer}
  .tc-media-remove:hover{background:#F6FFF8}
  /* Modal panel scroll */
  .tc-modal-panel{max-height:85vh;overflow-y:auto;overscroll-behavior:contain}
  </style>

  <div class="scaffold-layout scaffold-layout--content-aside">
    <div class="scaffold-layout__inner">
      <div class="scaffold-layout__row">
        <!-- Main (center) -->
        <main class="scaffold-layout__content" aria-label="Members Blog">
          <!-- Composer card -->
      <div class="artdeco-card p-4 mb-3">
            <div class="flex items-center gap-3">
              {% if me_avatar_url %}
                <img src="{{ me_avatar_url }}" alt="" class="w-10 h-10 rounded-full object-cover" />
              {% else %}
                <div class="w-10 h-10 rounded-full bg-[#BEE3DB]"></div>
              {% endif %}
        <a href="#" id="open-blog-create" class="flex-1 text-left border border-[#BEE3DB] rounded-full px-4 py-2 text-[#555B6E]/80 hover:bg-[#F6FFF8]">Start a post</a>
            </div>
          </div>

          <!-- Search + Sort -->
          <div class="mb-2 flex flex-col md:flex-row md:items-center md:justify-between gap-2 px-1">
            <form method="get" class="flex-1 md:max-w-md">
              <div class="flex items-stretch border border-[#BEE3DB] rounded-full overflow-hidden bg-white focus-within:ring-1 focus-within:ring-[#89B0AE]">
                <input type="text" name="q" value="{{ q|default:'' }}" placeholder="Search blog posts" class="flex-1 px-4 py-2 text-sm text-[#555B6E] outline-none" />
                {% if current_sort %}<input type="hidden" name="sort" value="{{ current_sort }}" />{% endif %}
                <button class="px-4 py-2 text-sm font-semibold text-white" style="background:#89B0AE" type="submit">Search</button>
              </div>
            </form>
            <details class="relative" role="listbox">
              <summary class="list-none cursor-pointer flex items-center gap-2 select-none">
                <span class="text-sm text-[#555B6E]/70">Sort by</span>
                <span class="inline-flex items-center gap-1 border border-[#BEE3DB] rounded-full px-3 py-1.5 bg-white text-sm text-[#555B6E] hover:bg-[#F6FFF8]">
                  {% if current_sort == 'oldest' %}Oldest{% else %}Newest{% endif %}
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M7 10l5 5 5-5" stroke="#555B6E" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </span>
              </summary>
              <div class="absolute right-0 mt-2 w-40 artdeco-card py-1 shadow-lg z-20">
                <a href="?sort=recent{% if q %}&q={{ q|urlencode }}{% endif %}" role="option" aria-selected="{% if current_sort == 'recent' %}true{% else %}false{% endif %}" class="block px-3 py-2 text-sm hover:bg-[#F6FFF8] text-[#555B6E] {% if current_sort == 'recent' %}bg-[#F6FFF8] font-semibold{% endif %}">Newest</a>
                <a href="?sort=oldest{% if q %}&q={{ q|urlencode }}{% endif %}" role="option" aria-selected="{% if current_sort == 'oldest' %}true{% else %}false{% endif %}" class="block px-3 py-2 text-sm hover:bg-[#F6FFF8] text-[#555B6E] {% if current_sort == 'oldest' %}bg-[#F6FFF8] font-semibold{% endif %}">Oldest</a>
              </div>
            </details>
          </div>

          <!-- Blog cards -->
          <div class="space-y-3">
            {% for post in page_obj %}
              <article class="artdeco-card p-4">
                <a href="{% url 'members_blog_detail' slug=post.slug %}" class="block">
                  {% if post.image %}
                    <img src="{{ post.image.url }}" alt="" class="w-full h-48 object-cover rounded mb-3" />
                  {% endif %}
                  <div class="font-semibold text-lg text-[#555B6E] mb-1">{{ post.title }}</div>
                  <div class="text-xs text-[#555B6E]/70 mb-2">{{ post.created_at|date:'M d, Y' }} ‚Ä¢ {{ post.visibility }}</div>
                  <div class="text-sm text-[#555B6E] line-clamp-3">{{ post.content|striptags|truncatewords:40 }}</div>
                  <div class="mt-2 flex flex-wrap gap-2">
                    {% for tag in post.tags.all %}
                      <span class="bg-[#BEE3DB] text-[#555B6E] px-2 py-0.5 rounded-full text-[11px] font-semibold">{{ tag.name }}</span>
                    {% endfor %}
                  </div>
                </a>
                <div class="mt-3 pt-3 border-t border-[#E6F2F0] flex flex-col sm:flex-row gap-2 sm:items-center sm:justify-between">
                  <div class="text-xs text-[#555B6E]/70">Visibility: <strong>{{ post.visibility }}</strong> ‚Ä¢ {% if post.published %}<span class="text-[#2E7D32]">Published</span>{% else %}<span class="text-[#AF4448]">Draft</span>{% endif %}</div>
                  {% if post.author_id == request.user.id %}
                  <form method="post" action="{% url 'user_blog_update_visibility' pk=post.pk %}" class="flex items-center gap-2 relative">
                    {% csrf_token %}
                    <input type="hidden" name="q" value="{{ q }}"/>
                    <input type="hidden" name="sort" value="{{ current_sort }}"/>
                    <input type="hidden" name="page" value="{{ page_obj.number }}"/>
                    <details class="relative" role="listbox">
                      <summary class="list-none cursor-pointer">
                        <span class="inline-flex items-center gap-2 border border-[#BEE3DB] rounded-full px-3 py-1.5 bg-white text-sm text-[#555B6E] hover:bg-[#F6FFF8]">
                          {{ post.visibility|title }}
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M7 10l5 5 5-5" stroke="#555B6E" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </span>
                      </summary>
                      <div class="absolute right-0 mt-2 w-44 artdeco-card py-1 shadow-lg z-20">
                        <button type="submit" name="visibility" value="members" class="block w-full text-left px-3 py-2 text-sm hover:bg-[#F6FFF8] text-[#555B6E] {% if post.visibility == 'members' %}bg-[#F6FFF8] font-semibold{% endif %}">Members</button>
                        <button type="submit" name="visibility" value="public" class="block w-full text-left px-3 py-2 text-sm hover:bg-[#F6FFF8] text-[#555B6E] {% if post.visibility == 'public' %}bg-[#F6FFF8] font-semibold{% endif %}">Public</button>
                        <button type="submit" name="visibility" value="both" class="block w-full text-left px-3 py-2 text-sm hover:bg-[#F6FFF8] text-[#555B6E] {% if post.visibility == 'both' %}bg-[#F6FFF8] font-semibold{% endif %}">Everywhere</button>
                      </div>
                    </details>
                    <label class="inline-flex items-center gap-1 text-sm text-[#555B6E]">
                      <input type="checkbox" name="published" {% if post.published %}checked{% endif %}/> Published
                    </label>
                  </form>
                    <form id="tc-del-form-{{ post.pk }}" method="post" action="{% url 'user_blog_delete' pk=post.pk %}" class="sm:ml-auto tc-delete-post-form">
                      {% csrf_token %}
                      <input type="hidden" name="q" value="{{ q }}"/>
                      <input type="hidden" name="sort" value="{{ current_sort }}"/>
                      <input type="hidden" name="page" value="{{ page_obj.number }}"/>
                      <button type="button" data-form-id="tc-del-form-{{ post.pk }}" data-title="{{ post.title|escape }}" class="tc-delete-post-btn px-3 py-1.5 rounded-full border border-[#AF4448] text-[#AF4448] text-sm hover:bg-[#FFF5F5]">Delete</button>
                    </form>
                  {% endif %}
                </div>
              </article>
            {% empty %}
              <article class="artdeco-card p-4 text-[#555B6E]">No posts yet.</article>
            {% endfor %}
          </div>

          {% if page_obj.paginator.num_pages > 1 %}
          <nav class="flex justify-center items-center mt-4" aria-label="Pagination">
            <ul class="flex gap-4 items-center">
              <li>
                {% if page_obj.has_previous %}
                  <a href="?q={{ q }}&sort={{ current_sort }}&page={{ page_obj.previous_page_number }}" class="rounded-full px-5 py-2 text-sm font-semibold bg-[#89B0AE] text-white hover:bg-[#555B6E]">Previous</a>
                {% else %}
                  <span class="rounded-full px-5 py-2 text-sm font-semibold bg-[#BEE3DB] text-[#555B6E] opacity-60">Previous</span>
                {% endif %}
              </li>
              <li><span class="text-[#555B6E] font-medium text-sm bg-white rounded-full px-4 py-2 border border-[#BEE3DB]">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span></li>
              <li>
                {% if page_obj.has_next %}
                  <a href="?q={{ q }}&sort={{ current_sort }}&page={{ page_obj.next_page_number }}" class="rounded-full px-5 py-2 text-sm font-semibold bg-[#89B0AE] text-white hover:bg-[#555B6E]">Next</a>
                {% else %}
                  <span class="rounded-full px-5 py-2 text-sm font-semibold bg-[#BEE3DB] text-[#555B6E] opacity-60">Next</span>
                {% endif %}
              </li>
            </ul>
          </nav>
          {% endif %}
        </main>

        <!-- Aside (right) -->
        <aside class="scaffold-layout__aside" aria-label="Blog sidebar">
          <div class="space-y-3">
            <div class="artdeco-card p-4">
              <div class="font-semibold text-[#555B6E] mb-2">Recent Posts</div>
              <ul class="divide-y divide-[#E6F2F0]">
                {% for p in recent_posts %}
                  <li class="py-2 first:pt-0 last:pb-0">
                    <a href="{% url 'members_blog_detail' slug=p.slug %}" class="block">
                      <div class="text-sm text-[#116466] font-medium line-clamp-2 hover:underline">{{ p.title }}</div>
                      <div class="text-[10px] text-[#555B6E]/60 mt-0.5">{{ p.created_at|date:'M d, Y' }}</div>
                    </a>
                  </li>
                {% empty %}
                  <li class="py-2 text-xs text-[#555B6E]/60">No posts yet.</li>
                {% endfor %}
              </ul>
            </div>
            <div class="artdeco-card p-4" x-data="{ expanded: false }">
              <div class="font-semibold text-[#555B6E] mb-2">Tags</div>
              <div class="flex flex-wrap gap-2">
                {% if tags_top %}
                  {% for t in tags_top %}
                    <a href="?q={{ t.name|urlencode }}&sort={{ current_sort }}" class="px-3 py-1 rounded-full bg-[#BEE3DB] text-[#555B6E] text-[11px] font-semibold">{{ t.name }}</a>
                  {% endfor %}
                  {% if tags_rest %}
                    <template x-if="expanded">
                      <div class="contents">
                        {% for t in tags_rest %}
                          <a href="?q={{ t.name|urlencode }}&sort={{ current_sort }}" class="px-3 py-1 rounded-full bg-[#BEE3DB] text-[#555B6E] text-[11px] font-semibold">{{ t.name }}</a>
                        {% endfor %}
                      </div>
                    </template>
                    <button type="button" class="mt-2 px-3 py-1.5 rounded-full border border-[#BEE3DB] text-[#555B6E] text-xs hover:bg-[#F6FFF8]" @click="expanded = !expanded" x-text="expanded ? 'Show less' : 'Load more'"></button>
                  {% endif %}
                {% else %}
                  <span class="text-xs text-[#555B6E]/60">No tags yet.</span>
                {% endif %}
              </div>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <!-- New: Blog Create Modal (clean start) -->
  <div id="blog-create-modal" class="fixed inset-0 bg-black/40 hidden z-[500]">
    <div class="tc-modal-panel max-w-2xl mx-auto my-10 bg-white rounded-xl shadow border border-[#BEE3DB] overflow-hidden">
      <form method="post" action="{% url 'user_blog_create' %}" enctype="multipart/form-data" id="blog-create-form">
        {% csrf_token %}
  <input type="hidden" name="media_meta" id="blog-media-meta" value="{}" />
        <div class="px-4 py-3 border-b border-[#BEE3DB] flex items-center justify-between">
          <div class="font-semibold text-[#555B6E]">Create a blog post</div>
          <button type="button" id="blog-create-close" class="text-[#555B6E]">‚úï</button>
        </div>
        <div class="p-4 space-y-4">
          <div>
            <label class="block text-sm text-[#555B6E]/80 mb-1">Title</label>
            <div class="flex items-center gap-2">
              <input id="blog-title-input" type="text" name="title" class="flex-1 w-full border border-[#BEE3DB] rounded px-3 py-2 bg-[#FAF9F9] text-[#555B6E]" placeholder="Add a title" />
              <button type="button" class="emoji-btn" data-emoji-target="#blog-title-input" title="Insert emoji" aria-label="Insert emoji">üòä</button>
            </div>
          </div>
          <div>
            <label class="block text-sm text-[#555B6E]/80 mb-1">Content</label>
            <div class="flex items-start gap-2">
              <div class="flex-1 w-full">
                <div class="tc-toolbar" aria-label="Formatting toolbar">
                  <button type="button" class="tc-tool" data-cmd="bold"><strong>B</strong></button>
                  <button type="button" class="tc-tool" data-cmd="italic"><em>I</em></button>
                  <button type="button" class="tc-tool" data-cmd="underline"><u>U</u></button>
                  <span class="mx-1 w-px h-5 bg-[#E6F2F0]"></span>
                  <button type="button" class="tc-tool" data-block="p">P</button>
                  <button type="button" class="tc-tool" data-block="h2">H2</button>
                  <button type="button" class="tc-tool" data-block="h3">H3</button>
                  <span class="mx-1 w-px h-5 bg-[#E6F2F0]"></span>
                  <button type="button" class="tc-tool" data-cmd="insertUnorderedList">‚Ä¢ List</button>
                  <button type="button" class="tc-tool" data-cmd="insertOrderedList">1. List</button>
                  <button type="button" class="tc-tool" data-cmd="formatBlock" data-arg="blockquote">‚Äú Quote‚Äù</button>
                  <button type="button" class="tc-tool" data-link>Link</button>
                  <button type="button" class="tc-tool" data-clear>Clear</button>
                </div>
                <div id="blog-content-editor" class="tc-editor" contenteditable="true" data-placeholder="Write your post..."></div>
                <p class="text-xs text-[#555B6E]/60 mt-1">Tip: After you add images below, drag any image thumbnail from ‚ÄúAttach media‚Äù into this editor to place it inline.</p>
                <textarea id="blog-content-textarea" name="content" class="sr-only"></textarea>
              </div>
              <button type="button" class="emoji-btn" data-emoji-target="#blog-content-editor" title="Insert emoji" aria-label="Insert emoji">üòä</button>
            </div>
          </div>
          <!-- Hidden cover input kept for JS-driven cover selection -->
          <input id="blog-cover-input" type="file" name="image" accept="image/*" class="sr-only" />
          <div class="mt-1 flex items-center flex-wrap gap-4">
            <div class="flex items-center gap-2">
              <span class="text-sm text-[#555B6E]/70">Visibility</span>
              <input type="hidden" name="visibility" id="blog-visibility" value="members" />
              <details class="relative" id="blog-visibility-dd" role="listbox">
                <summary class="list-none cursor-pointer">
                  <span class="inline-flex items-center gap-2 border border-[#BEE3DB] rounded px-3 py-2 bg-[#FAF9F9] text-sm text-[#555B6E]">
                    <span id="blog-visibility-text">Members</span>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M7 10l5 5 5-5" stroke="#555B6E" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  </span>
                </summary>
                <div class="absolute right-0 mt-2 w-44 artdeco-card py-1 shadow-lg z-20">
                  <button type="button" data-value="members" class="block w-full text-left px-3 py-2 text-sm hover:bg-[#F6FFF8] text-[#555B6E]">Members</button>
                  <button type="button" data-value="public" class="block w-full text-left px-3 py-2 text-sm hover:bg-[#F6FFF8] text-[#555B6E]">Public</button>
                  <button type="button" data-value="both" class="block w-full text-left px-3 py-2 text-sm hover:bg-[#F6FFF8] text-[#555B6E]">Everywhere</button>
                </div>
              </details>
            </div>
            <label class="inline-flex items-center gap-2 text-sm text-[#555B6E] ml-auto"><input type="checkbox" name="published" class="h-4 w-4 text-[#89B0AE] focus:ring-[#89B0AE] border-[#BEE3DB] rounded" checked /> Publish now</label>
          </div>
          <div>
            <div class="flex items-center justify-between mb-1">
              <label for="blog-media-input" class="block text-sm text-[#555B6E]/80">Attach media (up to 8)</label>
              <div class="flex items-center gap-2">
                <button type="button" id="blog-camera-btn" class="px-3 py-2 rounded border border-[#BEE3DB] text-[#555B6E] text-sm bg-[#FAF9F9]" aria-label="Capture from camera">Camera</button>
                <button type="button" id="blog-media-add-btn" class="px-3 py-2 rounded border border-[#BEE3DB] text-[#555B6E] text-sm bg-[#FAF9F9]">Add media</button>
              </div>
            </div>
            <input id="blog-media-input" type="file" name="media" multiple accept="image/*" class="sr-only" />
            <input id="blog-camera-input" type="file" accept="image/*" capture="environment" class="sr-only" />
            <div id="blog-media-preview" class="grid grid-cols-3 sm:grid-cols-4 gap-2"></div>
            <p class="text-xs text-[#555B6E]/60 mt-1">You can add images. Only the featured image is used in previews. Choose one image as the featured image below.</p>
            <div class="mt-3">
              <div class="flex items-stretch gap-2">
                <input id="blog-stock-q" type="text" class="flex-1 border border-[#BEE3DB] rounded px-3 py-2 bg-[#FAF9F9] text-[#555B6E]" placeholder="Search stock images (e.g., mindfulness, coffee)" />
                <button type="button" id="blog-stock-search" class="px-3 py-2 rounded border border-[#BEE3DB] bg-[#FAF9F9] text-[#555B6E] text-sm">Search</button>
              </div>
              <div id="blog-stock-status" class="text-xs text-[#555B6E]/60 mt-1"></div>
              <div id="blog-stock-results" class="mt-2 grid grid-cols-3 sm:grid-cols-4 gap-2"></div>
              <div id="blog-stock-selected" class="hidden mt-2">
                <div class="flex items-center gap-3 p-2 border border-[#E6F2F0] rounded">
                  <img id="blog-stock-selected-thumb" alt="" class="w-20 h-14 object-cover rounded bg-[#BEE3DB]" />
                  <div class="min-w-0 flex-1">
                    <div id="blog-stock-selected-meta" class="text-xs text-[#555B6E]/70 truncate"></div>
                    <div class="mt-1 flex items-center gap-2">
                      <div id="blog-stock-uploading" class="hidden flex items-center gap-2 text-xs text-[#555B6E]/70">
                        <span class="tc-spinner"></span>
                        <span>Uploading‚Ä¶</span>
                      </div>
                      <button type="button" id="blog-stock-clear" class="px-2 py-1 text-xs rounded border border-[#BEE3DB] text-[#555B6E]">Clear</button>
                      <button type="button" id="blog-stock-change" class="px-2 py-1 text-xs rounded bg-[#BEE3DB] text-[#555B6E]">Change</button>
                    </div>
                  </div>
                </div>
              </div>
              <div id="blog-stock-note" class="hidden text-xs text-[#555B6E]/60 mt-1">Images are provided under the provider‚Äôs license. Attribution is added automatically.</div>
            </div>
          </div>
        </div>
        <div class="px-4 py-3 border-t border-[#BEE3DB] flex items-center justify-end gap-2 bg-[#F6FFF8]">
          <div id="blog-submit-status" class="mr-auto text-xs text-[#AF4448] hidden"></div>
          <button type="button" id="blog-create-cancel" class="px-4 py-2 rounded border border-[#BEE3DB] text-[#555B6E]">Cancel</button>
          <button type="submit" id="blog-submit-btn" class="px-4 py-2 rounded bg-[#89B0AE] text-white font-semibold">Post</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Camera Capture Modal (desktop) -->
  <div id="blog-camera-modal" class="fixed inset-0 bg-black/60 hidden z-[600]">
    <div class="tc-modal-panel max-w-lg mx-auto my-10 bg-white rounded-xl shadow border border-[#BEE3DB] overflow-hidden">
      <div class="px-4 py-3 border-b border-[#BEE3DB] flex items-center justify-between">
        <div class="font-semibold text-[#555B6E]">Capture photo</div>
        <button type="button" id="tc-cam-close" class="text-[#555B6E]">‚úï</button>
      </div>
      <div class="p-3">
        <div class="relative rounded-lg overflow-hidden border border-[#BEE3DB] bg-black">
          <video id="tc-cam-video" class="w-full h-64 object-cover" autoplay playsinline muted></video>
          <canvas id="tc-cam-canvas" class="hidden"></canvas>
          <img id="tc-cam-preview" alt="" class="hidden w-full h-64 object-cover" />
        </div>
        <div class="mt-3 flex items-center justify-end gap-2">
          <button type="button" id="tc-cam-retake" class="hidden px-4 py-2 rounded border border-[#BEE3DB] text-[#555B6E]">Retake</button>
          <button type="button" id="tc-cam-capture" class="px-4 py-2 rounded bg-[#89B0AE] text-white font-semibold">Capture</button>
          <button type="button" id="tc-cam-use" class="hidden px-4 py-2 rounded bg-[#89B0AE] text-white font-semibold">Add</button>
        </div>
        <div id="tc-cam-error" class="text-xs text-[#AF4448] mt-2"></div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      var modal = document.getElementById('blog-create-modal');
      var openBtn = document.getElementById('open-blog-create');
      var closeBtn = document.getElementById('blog-create-close');
      var cancelBtn = document.getElementById('blog-create-cancel');
  function lockBody(){ document.documentElement.style.overflow='hidden'; document.body.style.overflow='hidden'; }
  function unlockBody(){ document.documentElement.style.overflow=''; document.body.style.overflow=''; }
  function open(){ if(modal){ modal.classList.remove('hidden'); lockBody(); } }
  function close(){ if(modal){ modal.classList.add('hidden'); unlockBody(); } }
      if (openBtn) openBtn.addEventListener('click', function(e){ e.preventDefault(); open(); });
      if (closeBtn) closeBtn.addEventListener('click', close);
      if (cancelBtn) cancelBtn.addEventListener('click', close);
      if (modal) modal.addEventListener('click', function(e){ if (e.target === modal) close(); });
      document.addEventListener('keydown', function(e){ if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) close(); });

      // Visibility dropdown wiring
      var visInput = document.getElementById('blog-visibility');
      var visText = document.getElementById('blog-visibility-text');
      var visDd = document.getElementById('blog-visibility-dd');
      if (visDd && visInput && visText){
        visDd.querySelectorAll('button[data-value]').forEach(function(btn){
          btn.addEventListener('click', function(){
            var val = btn.getAttribute('data-value');
            var label = btn.textContent.trim();
            visInput.value = val;
            visText.textContent = label;
            visDd.open = false;
          });
        });
      }
    })();

    // Media preview and cover selection
    (function(){
  var mediaInput = document.getElementById('blog-media-input');
  var cameraBtn = document.getElementById('blog-camera-btn');
  var cameraInput = document.getElementById('blog-camera-input');
  var camModal = document.getElementById('blog-camera-modal');
  var camVideo = document.getElementById('tc-cam-video');
  var camCanvas = document.getElementById('tc-cam-canvas');
  var camPreview = document.getElementById('tc-cam-preview');
  var camCapture = document.getElementById('tc-cam-capture');
  var camUse = document.getElementById('tc-cam-use');
  var camRetake = document.getElementById('tc-cam-retake');
  var camClose = document.getElementById('tc-cam-close');
  var camError = document.getElementById('tc-cam-error');
  var camStream = null;
      var coverInput = document.getElementById('blog-cover-input');
      var addBtn = document.getElementById('blog-media-add-btn');
      var grid = document.getElementById('blog-media-preview');
      var pendingPrev = null;
      var metaField = document.getElementById('blog-media-meta');
      function fileKey(f){ return [f.name, f.size, f.type || '', f.lastModified||0].join('|'); }
      function getCoverKey(){
        if (!coverInput || !coverInput.files || !coverInput.files.length) return null;
        var f = coverInput.files[0];
        return fileKey(f);
      }
      function setCoverFile(file){
        if (!coverInput) return;
        var dt = new DataTransfer();
        if (file) dt.items.add(file);
        coverInput.files = dt.files;
      }
      function readMeta(){ try{ return JSON.parse(metaField && metaField.value || '{}'); }catch(_){ return {}; } }
      function writeMeta(obj){ if(metaField) metaField.value = JSON.stringify(obj||{}); }
      function removeEditorImagesByName(name){
        var editor = document.getElementById('blog-content-editor');
        if (!editor || !name) return;
        editor.querySelectorAll('img[data-tc-media]')
          .forEach(function(img){ if (img.getAttribute('data-tc-media') === name){ img.remove(); } });
      }
      function removeFileFromMedia(keyToRemove, nameToRemove){
        if (!mediaInput) return;
        var current = mediaInput.files ? Array.from(mediaInput.files) : [];
        var dt = new DataTransfer();
        current.forEach(function(f){ if (fileKey(f) !== keyToRemove){ dt.items.add(f); } });
        mediaInput.files = dt.files;
        // Clear featured if it was this file
        var currentCover = getCoverKey();
        if (currentCover && currentCover === keyToRemove){ setCoverFile(null); }
        // Remove any stored meta (e.g., stock attribution)
        if (nameToRemove){ var meta = readMeta(); if (meta[nameToRemove]){ delete meta[nameToRemove]; writeMeta(meta); } }
        // Remove any inline images in editor that referenced this file
        removeEditorImagesByName(nameToRemove);
        render();
      }
      function render(){
        if (!grid) return;
        grid.innerHTML = '';
  var files = (mediaInput && mediaInput.files) ? Array.from(mediaInput.files).filter(function(f){ return (f.type||'').startsWith('image/'); }) : [];
        var currentCover = getCoverKey();
        var keys = new Set(files.map(fileKey));
        // If cover no longer present in media files, clear it
        if (currentCover && !keys.has(currentCover)) setCoverFile(null), currentCover = null;
        files.forEach(function(f, idx){
          var tile = document.createElement('div');
          tile.className = 'tc-media-tile';
          tile.style.height = '110px';
          if ((f.type||'').startsWith('image/')){
            var img = document.createElement('img');
            img.src = URL.createObjectURL(f);
            img.alt = '';
            img.draggable = true;
            img.dataset.filename = f.name || ('image-'+idx);
            img.addEventListener('dragstart', function(ev){ try{ ev.dataTransfer.setData('text/x-tc-media-filename', img.dataset.filename); ev.dataTransfer.effectAllowed='copy'; }catch(_){ } });
            tile.appendChild(img);
            // Cover checkbox (images only)
            var coverWrap = document.createElement('label');
            coverWrap.className = 'tc-media-cover cursor-pointer';
            var cb = document.createElement('input'); cb.type='checkbox'; cb.className='h-3 w-3';
            var span = document.createElement('span'); span.textContent = 'Featured';
            coverWrap.appendChild(cb); coverWrap.appendChild(span);
            tile.appendChild(coverWrap);
            var key = fileKey(f);
            if (currentCover && currentCover === key){ cb.checked = true; }
            cb.addEventListener('change', function(){
              if (cb.checked){
                // Uncheck all others and set cover input
                grid.querySelectorAll('input[type="checkbox"]').forEach(function(other){ if (other !== cb) other.checked = false; });
                setCoverFile(f);
              } else {
                // If unchecked and it was the cover, clear cover input
                var ckey = getCoverKey();
                if (ckey && ckey === key){ setCoverFile(null); }
              }
            });
            // Remove button
            var rm = document.createElement('button');
            rm.type = 'button';
            rm.className = 'tc-media-remove';
            rm.setAttribute('aria-label', 'Remove image');
            rm.innerHTML = '&times;';
            rm.addEventListener('click', function(e){ e.preventDefault(); removeFileFromMedia(key, f.name || null); });
            tile.appendChild(rm);
          }
          grid.appendChild(tile);
        });
      }
  function openCamModal(){ if (camModal){ camModal.classList.remove('hidden'); document.documentElement.style.overflow='hidden'; document.body.style.overflow='hidden'; } }
  function closeCamModal(){ if (camModal){ camModal.classList.add('hidden'); document.documentElement.style.overflow=''; document.body.style.overflow=''; } stopStream(); resetPreview(); }
      function isLikelyDesktop(){ try{ return window.matchMedia && window.matchMedia('(pointer: fine)').matches; }catch(_){ return true; } }
      function stopStream(){ try{ if (camStream){ camStream.getTracks().forEach(function(t){ try{ t.stop(); }catch(_){ } }); camStream = null; } }catch(_){ }
        if (camVideo) camVideo.srcObject = null; }
      function resetPreview(){ if (camPreview) camPreview.classList.add('hidden'); if (camRetake) camRetake.classList.add('hidden'); if (camUse) camUse.classList.add('hidden'); if (camCapture) camCapture.classList.remove('hidden'); if (camError) camError.textContent=''; }
      async function startCamera(){
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){ throw new Error('unsupported'); }
        var constraints = { video: { width: { ideal: 1280 }, height: { ideal: 720 } }, audio: false };
        try{
          camStream = await navigator.mediaDevices.getUserMedia(constraints);
          if (camVideo){ camVideo.srcObject = camStream; }
        }catch(e){ throw e; }
      }
      function dataURLtoFile(dataUrl, fileName){ var arr = dataUrl.split(','), mime = arr[0].match(/:(.*?);/)[1], bstr = atob(arr[1]); var n = bstr.length, u8arr = new Uint8Array(n); while(n--){ u8arr[n]=bstr.charCodeAt(n); } return new File([u8arr], fileName, {type:mime}); }
      // Camera capture: open camera input on mobile, modal with getUserMedia on desktop
      if (addBtn && mediaInput){
        addBtn.addEventListener('click', function(){
          // Snapshot existing files to allow append semantics on next change
          pendingPrev = mediaInput.files ? Array.from(mediaInput.files) : [];
          mediaInput.click();
        });
      }
      // Camera capture: open camera input and merge into media input
      function mergeIntoMedia(filesToAdd){
        if (!mediaInput) return;
        var current = mediaInput.files ? Array.from(mediaInput.files) : [];
        var dt = new DataTransfer();
        current.concat(Array.from(filesToAdd||[])).filter(function(f){ return (f.type||'').startsWith('image/'); }).slice(0,8).forEach(function(f){ dt.items.add(f); });
        mediaInput.files = dt.files;
        render();
      }
      if (cameraBtn && cameraInput){
        cameraBtn.addEventListener('click', async function(){
          // Prefer desktop camera via getUserMedia; fallback to input capture
          if (isLikelyDesktop() && navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
            try{
              openCamModal();
              await startCamera();
            }catch(e){
              if (camError) camError.textContent = 'Unable to access camera. Falling back to file picker.';
              closeCamModal();
              cameraInput.value = '';
              cameraInput.click();
            }
          } else {
            cameraInput.value = '';
            cameraInput.click();
          }
        });
        cameraInput.addEventListener('change', function(){
          if (cameraInput.files && cameraInput.files.length){ mergeIntoMedia(cameraInput.files); }
        });
      }
      // Camera modal controls
      if (camClose){ camClose.addEventListener('click', closeCamModal); }
      if (camModal){ camModal.addEventListener('click', function(e){ if (e.target === camModal) closeCamModal(); }); }
      if (camCapture){ camCapture.addEventListener('click', function(){
        if (!camVideo) return;
        try{
          var vw = camVideo.videoWidth || 1280, vh = camVideo.videoHeight || 720;
          if (camCanvas){ camCanvas.width = vw; camCanvas.height = vh; var ctx = camCanvas.getContext('2d'); ctx.drawImage(camVideo, 0, 0, vw, vh); }
          var dataUrl = camCanvas.toDataURL('image/jpeg', 0.92);
          if (camPreview){ camPreview.src = dataUrl; camPreview.classList.remove('hidden'); }
          if (camCapture) camCapture.classList.add('hidden'); if (camUse) camUse.classList.remove('hidden'); if (camRetake) camRetake.classList.remove('hidden');
          stopStream();
        }catch(_){ if (camError) camError.textContent='Capture failed. Try again.'; }
      }); }
      if (camRetake){ camRetake.addEventListener('click', async function(){ resetPreview(); try{ await startCamera(); }catch(e){ if (camError) camError.textContent='Unable to access camera.'; } }); }
      if (camUse){ camUse.addEventListener('click', function(){
        if (!camPreview || !camPreview.src) return;
        var name = 'camera-' + new Date().toISOString().replace(/[:.]/g,'-') + '.jpg';
        try{ var file = dataURLtoFile(camPreview.src, name); mergeIntoMedia([file]); }catch(_){ if (camError) camError.textContent='Unable to add photo.'; }
        closeCamModal();
      }); }
      if (mediaInput){
        mediaInput.addEventListener('change', function(){
          // If we have a previous snapshot, merge it with new selection, enforce max=8
          if (pendingPrev && pendingPrev.length){
            var dt = new DataTransfer();
            var now = Array.from(mediaInput.files || []);
            pendingPrev.concat(now).slice(0,8).forEach(function(f){ dt.items.add(f); });
            mediaInput.files = dt.files;
            pendingPrev = null;
          } else {
            // Enforce max=8 if user selected many
            var cur = Array.from(mediaInput.files || []);
            if (cur.length > 8){
              var dt2 = new DataTransfer();
              cur.slice(0,8).forEach(function(f){ dt2.items.add(f); });
              mediaInput.files = dt2.files;
            }
          }
          render();
        });
      }
      // Expose render so other scripts (stock attach) can refresh the grid
      window.__tcBlogRenderMediaPreview = render;
    })();

    // Emoji picker for blog create modal (fixed popover appended to body)
    (function(){
      var EMOJIS = ['üòÄ','üòÅ','üòÇ','ü§£','üòÖ','üòä','üôÇ','üòâ','üòç','üòò','ü§ó','ü§î','ü§©','üòé','üòá','üôå','üëç','üëè','üíØ','üî•','üåü','üéâ','‚úÖ','‚ùå','‚ö†Ô∏è','‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','ü§ç','ü§é','üñ§','üí™','üôè','ü§ù','üí°','üì£','üìù','üìÖ','üìç','üìà','üí¨','üßò','ü©∫','üß†','üåø','üåà','‚òÄÔ∏è','‚≠ê','‚òï','üçé'];
      var pop=null, activeInput=null;
      function makePopover(){
        var d=document.createElement('div'); d.className='emoji-popover'; d.style.display='none';
        var g=document.createElement('div'); g.className='emoji-grid';
        EMOJIS.forEach(function(e){ var b=document.createElement('button'); b.type='button'; b.className='emoji-cell'; b.textContent=e; b.addEventListener('click', function(){ insertEmoji(e); hide(); }); g.appendChild(b); });
        d.appendChild(g); document.body.appendChild(d); return d;
      }
      function showFor(btn){
        if(!pop) pop = makePopover();
        var rect = btn.getBoundingClientRect();
        pop.style.top = (rect.bottom + 6) + 'px';
        var left = Math.min(rect.left, window.innerWidth - pop.offsetWidth - 8);
        pop.style.left = Math.max(8, left) + 'px';
        pop.style.display='block';
        setTimeout(function(){ document.addEventListener('click', onDoc); }, 0);
      }
      function hide(){ if(pop){ pop.style.display='none'; document.removeEventListener('click', onDoc); } }
      function onDoc(ev){ if(pop && !pop.contains(ev.target)){ hide(); } }
      function insertEmoji(char){
        var el = activeInput; if(!el) return;
        if (el.isContentEditable){
          var sel = window.getSelection(); if(!sel) return;
          var range = sel.rangeCount ? sel.getRangeAt(0) : null;
          if (!range || !el.contains(range.startContainer)){
            el.focus(); sel = window.getSelection(); range = document.createRange();
            range.selectNodeContents(el); range.collapse(false); sel.removeAllRanges(); sel.addRange(range);
          }
          var node = document.createTextNode(char);
          range.insertNode(node);
          range.setStartAfter(node); range.setEndAfter(node);
          sel.removeAllRanges(); sel.addRange(range);
          el.focus();
        } else {
          var start = el.selectionStart || 0, end = el.selectionEnd || 0;
          var val = el.value || '';
          el.value = val.slice(0,start) + char + val.slice(end);
          var pos = start + char.length; el.setSelectionRange(pos,pos); el.focus();
        }
      }
      document.querySelectorAll('.emoji-btn[data-emoji-target]').forEach(function(btn){
        var targetSel = btn.getAttribute('data-emoji-target');
        var target = document.querySelector(targetSel);
        if(!target) return;
        btn.addEventListener('click', function(e){
          e.preventDefault(); e.stopPropagation();
          activeInput = target; showFor(btn);
        });
      });
    })();

    // Stock image search and attach (reuses the existing /users/api/feed/stock_images/ endpoint)
    (function(){
      var qEl = document.getElementById('blog-stock-q');
  var btn = document.getElementById('blog-stock-search');
      var resultsEl = document.getElementById('blog-stock-results');
      var statusEl = document.getElementById('blog-stock-status');
      var selectedWrap = document.getElementById('blog-stock-selected');
      var selThumb = document.getElementById('blog-stock-selected-thumb');
      var selMeta = document.getElementById('blog-stock-selected-meta');
      var uploading = document.getElementById('blog-stock-uploading');
      var noteEl = document.getElementById('blog-stock-note');
      var clearBtn = document.getElementById('blog-stock-clear');
      var changeBtn = document.getElementById('blog-stock-change');
  var mediaInput = document.getElementById('blog-media-input');
      var metaField = document.getElementById('blog-media-meta');
      var selectedFilename = null;
      function setStatus(msg){ if(statusEl) statusEl.textContent = msg || ''; }
      function readMeta(){ try{ return JSON.parse(metaField && metaField.value || '{}'); }catch(_){ return {}; } }
      function writeMeta(obj){ if(metaField) metaField.value = JSON.stringify(obj||{}); }
      async function searchStock(query, page){
        var u = new URL(window.location.origin + '/users/api/feed/stock_images/');
        u.searchParams.set('q', query);
        u.searchParams.set('page', page||1);
        u.searchParams.set('per_page', 18);
        try{ var r = await fetch(u.toString()); if(!r.ok) return {results:[], error:'http'}; return await r.json(); }catch(e){ return {results:[], error:'network'}; }
      }
      function showSelected(meta){
        if (!selectedWrap) return;
        if (resultsEl) resultsEl.classList.add('hidden');
        selectedWrap.classList.remove('hidden');
        if (selThumb) selThumb.src = meta && meta.thumb_url || '';
        if (selMeta) selMeta.textContent = ((meta && meta.attribution) || '') + ((meta && meta.provider) ? (' ‚Ä¢ ' + meta.provider) : '');
      }
      function hideSelected(){ if (selectedWrap) selectedWrap.classList.add('hidden'); if (resultsEl) resultsEl.classList.remove('hidden'); }
      function render(list){ if(!resultsEl) return; resultsEl.innerHTML='';
        list.forEach(function(it){
          var b = document.createElement('button'); b.type='button'; b.className='relative group border border-[#BEE3DB] rounded overflow-hidden'; b.style.height='110px';
          b.title = (it.attribution||'') + (it.provider ? ' ‚Ä¢ ' + it.provider : '');
          b.innerHTML = '<img src="'+(it.thumb_url||'')+'" alt="" class="w-full h-full object-cover"/>'+
                        '<div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition"></div>';
          b.addEventListener('click', async function(){
            if(!mediaInput) return; setStatus(''); b.disabled=true;
            try{
              // Close grid, show selected panel and spinner
              showSelected(it);
              if (uploading) uploading.classList.remove('hidden');
              // Fetch via proxy and attach
              var proxy = new URL('/users/api/proxy/image/', window.location.origin);
              proxy.searchParams.set('url', it.full_url);
              var r = await fetch(proxy.toString());
              if (!r.ok) throw new Error('proxy_http');
              var blob = await r.blob();
              var fname = (it.provider||'stock') + '-' + (it.id||Date.now()) + '.jpg';
              selectedFilename = fname;
              var file = new File([blob], fname, { type: blob.type||'image/jpeg' });
              var dt = new DataTransfer();
              var existing = mediaInput.files ? Array.from(mediaInput.files) : [];
              existing.concat([file]).slice(0,8).forEach(function(f){ dt.items.add(f); });
              mediaInput.files = dt.files;
              var meta = readMeta();
              meta[fname] = { provider: it.provider, attribution: it.attribution, attribution_url: it.attribution_url, license: it.license, license_url: it.license_url, thumb_url: it.thumb_url };
              writeMeta(meta);
              if (noteEl) noteEl.classList.remove('hidden');
              // refresh preview grid
              if (window.__tcBlogRenderMediaPreview) window.__tcBlogRenderMediaPreview();
            } catch(e){
              hideSelected(); setStatus('Unable to attach image. Please try again.');
            } finally { b.disabled=false; if (uploading) uploading.classList.add('hidden'); }
          });
          resultsEl.appendChild(b);
        });
      }
      function clearSelected(){
        // Remove the stock file from the input
        if (mediaInput){
          var files = mediaInput.files ? Array.from(mediaInput.files) : [];
          var dt = new DataTransfer();
          files.filter(function(f){ return f.name !== selectedFilename; }).forEach(function(f){ dt.items.add(f); });
          mediaInput.files = dt.files;
        }
        // Remove meta
        if (selectedFilename){ var meta = readMeta(); if (meta[selectedFilename]){ delete meta[selectedFilename]; writeMeta(meta);} }
        selectedFilename = null;
        hideSelected(); setStatus(''); if (noteEl) noteEl.classList.add('hidden');
      }
      if (clearBtn) clearBtn.addEventListener('click', clearSelected);
      if (changeBtn) changeBtn.addEventListener('click', function(){ clearSelected(); if (qEl) qEl.focus(); });
      if (btn){
        btn.addEventListener('click', async function(){
          var q = (qEl && qEl.value || '').trim(); if(!q) return;
          btn.disabled=true; var old = btn.textContent; btn.textContent='Searching‚Ä¶'; setStatus('');
          try{ hideSelected(); var data = await searchStock(q,1); if(data.error){ setStatus('Unable to fetch images.'); return; }
            var items = data.results||[]; if(!items.length) setStatus('No results.'); render(items); }
          finally{ btn.disabled=false; btn.textContent = old || 'Search'; }
        });
      }
      if (qEl){ qEl.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); btn && btn.click(); } }); }
    })();

    // Rich text: toolbar actions and form submission sync
    (function(){
      var editor = document.getElementById('blog-content-editor');
      var hidden = document.getElementById('blog-content-textarea');
      var form = document.getElementById('blog-create-form');
      var titleInput = document.getElementById('blog-title-input');
      var submitBtn = document.getElementById('blog-submit-btn');
      var statusEl = document.getElementById('blog-submit-status');
      function runCmd(cmd, arg){ try{ document.execCommand(cmd, false, arg || null); }catch(_){} editor && editor.focus(); }
      function setBlock(tag){ runCmd('formatBlock', tag); }
      document.querySelectorAll('.tc-toolbar .tc-tool').forEach(function(btn){
        btn.addEventListener('click', function(){
          if (!editor) return;
          if (btn.hasAttribute('data-link')){ var url = prompt('Enter URL'); if(url){ runCmd('createLink', url); } return; }
          if (btn.hasAttribute('data-clear')){ runCmd('removeFormat'); runCmd('unlink'); return; }
          var block = btn.getAttribute('data-block'); if (block){ setBlock(block); return; }
          var cmd = btn.getAttribute('data-cmd'); var arg = btn.getAttribute('data-arg'); if (cmd){ runCmd(cmd, arg); }
        });
      });
      // Allow dropping uploaded images into editor
      var mediaInput = document.getElementById('blog-media-input');
      function findFileByName(name){
        var files = mediaInput && mediaInput.files ? Array.from(mediaInput.files) : [];
        return files.find(function(f){ return (f && f.name) === name && (f.type||'').startsWith('image/'); });
      }
      function insertImageAtPoint(x, y, file){
        if (!editor || !file) return;
        var url = URL.createObjectURL(file);
        var img = document.createElement('img');
        img.src = url; img.alt = '';
        img.setAttribute('data-tc-media', file.name || '');
        var range = null;
        if (document.caretRangeFromPoint){ range = document.caretRangeFromPoint(x, y); }
        else if (document.caretPositionFromPoint){ var pos = document.caretPositionFromPoint(x, y); if(pos){ range = document.createRange(); range.setStart(pos.offsetNode, pos.offset); range.collapse(true);} }
        if (!range){ editor.focus(); var sel = window.getSelection(); range = document.createRange(); range.selectNodeContents(editor); range.collapse(false); sel.removeAllRanges(); sel.addRange(range); }
        range.insertNode(img);
      }
      if (editor){
        editor.addEventListener('dragover', function(e){
          var types = e.dataTransfer && e.dataTransfer.types ? Array.from(e.dataTransfer.types) : [];
          if (types.indexOf('text/x-tc-media-filename') !== -1){ e.preventDefault(); e.dataTransfer.dropEffect='copy'; }
        });
        editor.addEventListener('drop', function(e){
          var name = e.dataTransfer && e.dataTransfer.getData ? e.dataTransfer.getData('text/x-tc-media-filename') : '';
          if (name){ e.preventDefault(); var f = findFileByName(name); if (f && (f.type||'').startsWith('image/')){ insertImageAtPoint(e.clientX, e.clientY, f); } }
        });
      }
      async function submitViaAjax(e){
        e.preventDefault();
        if (!form) return;
  // Pre-validate: server requires both title and content
  var titleVal = (titleInput && titleInput.value || '').trim();
  var contentText = (editor && editor.innerText || '').trim();
  if (!titleVal){ if (statusEl){ statusEl.textContent = 'Please add a title.'; statusEl.classList.remove('hidden'); } return; }
  if (!contentText){ if (statusEl){ statusEl.textContent = 'Please add some content.'; statusEl.classList.remove('hidden'); } return; }
        // Build submission HTML from a clone to avoid mutating the live editor (prevents 404s from placeholder src)
        if (hidden){
          var htmlForSubmit = '';
          if (editor){
            var tmp = editor.cloneNode(true);
            tmp.querySelectorAll('img[data-tc-media]').forEach(function(img){
              var name = img.getAttribute('data-tc-media') || '';
              if (name){ img.setAttribute('src', '[[MEDIA:'+name+']]'); }
            });
            htmlForSubmit = (tmp.innerHTML || '').trim();
          }
          hidden.value = htmlForSubmit;
        }
        if (statusEl){ statusEl.textContent = ''; statusEl.classList.add('hidden'); }
        var origText = submitBtn ? submitBtn.textContent : '';
        if (submitBtn){ submitBtn.disabled = true; submitBtn.textContent = 'Posting‚Ä¶'; }
        try{
          var fd = new FormData(form);
          var csrfInput = form.querySelector('input[name="csrfmiddlewaretoken"]');
          var headers = { 'X-Requested-With': 'XMLHttpRequest' };
          if (csrfInput && csrfInput.value){ headers['X-CSRFToken'] = csrfInput.value; }
          var resp = await fetch(form.action, { method: 'POST', body: fd, headers: headers, redirect: 'follow' });
          // Follow normal redirect if provided by server
          if (resp.redirected){ window.location.href = resp.url; return; }
          // Try JSON body first for AJAX-aware responses
          var isJson = (resp.headers.get('Content-Type')||'').includes('application/json');
          if (isJson){
            var data = await resp.json().catch(function(){ return null; });
            if (data && data.redirect){ window.location.href = data.redirect; return; }
            if (!resp.ok){
              var msg = 'Unable to create post.';
              if (data && data.error === 'media_save_failed' && data.detail){ msg = 'Media upload failed: ' + data.detail; }
              else if (data && data.errors){ msg = 'Please fix the highlighted fields.'; }
              if (statusEl){ statusEl.textContent = msg; statusEl.classList.remove('hidden'); }
              return;
            }
            // Unknown JSON but OK status ‚Äì prompt user
            if (statusEl){ statusEl.textContent = 'Please check your inputs and try again.'; statusEl.classList.remove('hidden'); }
            return;
          }
          // Fallback: non-JSON OK likely returned a full HTML form (validation). Keep user here.
          if (resp.ok){ if (statusEl){ statusEl.textContent = 'Please check your inputs and try again.'; statusEl.classList.remove('hidden'); } }
          else { if (statusEl){ statusEl.textContent = 'Unable to create post right now. Please try again.'; statusEl.classList.remove('hidden'); } }
        } catch(_){
          if (statusEl){ statusEl.textContent = 'Network error. Please try again.'; statusEl.classList.remove('hidden'); }
        } finally {
          if (submitBtn){ submitBtn.disabled = false; submitBtn.textContent = origText || 'Post'; }
        }
      }
      if (form){ form.addEventListener('submit', submitViaAjax); }
    })();
  </script>
  <!-- Styled delete confirm modal -->
  <div id="tc-confirm-overlay" class="fixed inset-0 bg-black/40 hidden z-[650]">
    <div class="tc-modal-panel max-w-md mx-auto my-24 bg-white rounded-xl shadow border border-[#BEE3DB] overflow-hidden">
      <div class="px-4 py-3 border-b border-[#BEE3DB] flex items-center justify-between">
        <div class="font-semibold text-[#555B6E]">Delete post?</div>
        <button type="button" id="tc-confirm-close" class="text-[#555B6E]">‚úï</button>
      </div>
      <div class="p-4 text-[#555B6E]">
        Are you sure you want to delete ‚Äú<span id="tc-confirm-title" class="font-semibold"></span>‚Äù? This action cannot be undone.
      </div>
      <div class="px-4 py-3 border-t border-[#BEE3DB] bg-[#F6FFF8] flex items-center justify-end gap-2">
        <button type="button" id="tc-confirm-cancel" class="px-4 py-2 rounded border border-[#BEE3DB] text-[#555B6E]">Cancel</button>
        <button type="button" id="tc-confirm-ok" class="px-4 py-2 rounded border border-[#AF4448] bg-[#AF4448] text-white font-semibold">Delete</button>
      </div>
    </div>
  </div>
  <script>
    (function(){
      var overlay = document.getElementById('tc-confirm-overlay');
      var titleEl = document.getElementById('tc-confirm-title');
      var btnOk = document.getElementById('tc-confirm-ok');
      var btnCancel = document.getElementById('tc-confirm-cancel');
      var btnClose = document.getElementById('tc-confirm-close');
      var currentForm = null;
      function lock(){ document.documentElement.style.overflow='hidden'; document.body.style.overflow='hidden'; }
      function unlock(){ document.documentElement.style.overflow=''; document.body.style.overflow=''; }
      function open(title, form){ currentForm = form; if(titleEl) titleEl.textContent = title||''; if(overlay){ overlay.classList.remove('hidden'); lock(); } }
      function close(){ if(overlay){ overlay.classList.add('hidden'); unlock(); } currentForm=null; }
      document.querySelectorAll('.tc-delete-post-btn').forEach(function(btn){
        btn.addEventListener('click', function(){
          var id = btn.getAttribute('data-form-id');
          var title = btn.getAttribute('data-title') || '';
          var form = id ? document.getElementById(id) : btn.closest('form');
          open(title, form);
        });
      });
      if(btnCancel) btnCancel.addEventListener('click', close);
      if(btnClose) btnClose.addEventListener('click', close);
      if(overlay) overlay.addEventListener('click', function(e){ if(e.target===overlay) close(); });
      if(btnOk){
        btnOk.addEventListener('click', function(){
          if(!currentForm) return; btnOk.disabled=true; try{ currentForm.submit(); } finally { btnOk.disabled=false; }
        });
      }
      document.addEventListener('keydown', function(e){ if(e.key==='Escape' && overlay && !overlay.classList.contains('hidden')) close(); });
    })();
  </script>
</div>
{% endblock %}
