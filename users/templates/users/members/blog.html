{% extends 'base.html' %}
{% block content %}
<div id="members-blog" class="w-full max-w-none py-4 px-0">
  <style>
    .scaffold-layout{display:block}
    .scaffold-layout__inner{max-width:1128px;margin:0 auto;padding:0 16px}
    .scaffold-layout__row{display:flex;gap:16px;align-items:flex-start}
    .scaffold-layout__content{flex:1 1 auto;min-width:0}
    .scaffold-layout__aside{display:none}
    @media(min-width:1024px){ .scaffold-layout__aside{display:block;position:relative;flex:0 0 300px} }
    @media(min-width:1280px){ .scaffold-layout__content{flex:0 0 65%;max-width:65%} }
    .artdeco-card{background:#fff;border:1px solid #BEE3DB;border-radius:8px}
  </style>

  <div class="scaffold-layout scaffold-layout--content-aside">
    <div class="scaffold-layout__inner">
      <div class="scaffold-layout__row">
        <!-- Main (center) -->
        <main class="scaffold-layout__content" aria-label="Members Blog">
          <!-- Composer card -->
          <div class="artdeco-card p-4 mb-3">
            <div class="flex items-center gap-3">
              {% if me_avatar_url %}
                <img src="{{ me_avatar_url }}" alt="" class="w-10 h-10 rounded-full object-cover" />
              {% else %}
                <div class="w-10 h-10 rounded-full bg-[#BEE3DB]"></div>
              {% endif %}
              <button type="button" id="open-blog-composer" class="flex-1 text-left border border-[#BEE3DB] rounded-full px-4 py-2 text-[#555B6E]/80 hover:bg-[#F6FFF8]">Start a post</button>
            </div>
          </div>

          <!-- Search + Sort -->
          <div class="mb-2 flex flex-col md:flex-row md:items-center md:justify-between gap-2 px-1">
            <form method="get" class="flex-1 md:max-w-md">
              <div class="flex items-stretch border border-[#BEE3DB] rounded-full overflow-hidden bg-white focus-within:ring-1 focus-within:ring-[#89B0AE]">
                <input type="text" name="q" value="{{ q|default:'' }}" placeholder="Search blog posts" class="flex-1 px-4 py-2 text-sm text-[#555B6E] outline-none" />
                {% if current_sort %}<input type="hidden" name="sort" value="{{ current_sort }}" />{% endif %}
                <button class="px-4 py-2 text-sm font-semibold text-white" style="background:#89B0AE" type="submit">Search</button>
              </div>
            </form>
            <details class="relative" role="listbox">
              <summary class="list-none cursor-pointer flex items-center gap-2 select-none">
                <span class="text-sm text-[#555B6E]/70">Sort by</span>
                <span class="inline-flex items-center gap-1 border border-[#BEE3DB] rounded-full px-3 py-1.5 bg-white text-sm text-[#555B6E] hover:bg-[#F6FFF8]">
                  {% if current_sort == 'oldest' %}Oldest{% else %}Newest{% endif %}
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M7 10l5 5 5-5" stroke="#555B6E" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </span>
              </summary>
              <div class="absolute right-0 mt-2 w-40 artdeco-card py-1 shadow-lg z-20">
                <a href="?sort=recent{% if q %}&q={{ q|urlencode }}{% endif %}" role="option" aria-selected="{% if current_sort == 'recent' %}true{% else %}false{% endif %}" class="block px-3 py-2 text-sm hover:bg-[#F6FFF8] text-[#555B6E] {% if current_sort == 'recent' %}bg-[#F6FFF8] font-semibold{% endif %}">Newest</a>
                <a href="?sort=oldest{% if q %}&q={{ q|urlencode }}{% endif %}" role="option" aria-selected="{% if current_sort == 'oldest' %}true{% else %}false{% endif %}" class="block px-3 py-2 text-sm hover:bg-[#F6FFF8] text-[#555B6E] {% if current_sort == 'oldest' %}bg-[#F6FFF8] font-semibold{% endif %}">Oldest</a>
              </div>
            </details>
          </div>

          <!-- Blog cards -->
          <div class="space-y-3">
            {% for post in page_obj %}
              <article class="artdeco-card p-4">
                <a href="{% url 'members_blog_detail' slug=post.slug %}" class="block">
                  {% with first_media=post.media.all|first %}
                    {% if first_media %}
                      {% if first_media.type == 'image' %}
                        <img src="{{ first_media.file.url }}" alt="" class="w-full h-48 object-cover rounded mb-3" />
                      {% else %}
                        <video src="{{ first_media.file.url }}" class="w-full h-48 object-cover rounded mb-3" muted></video>
                      {% endif %}
                    {% elif post.image %}
                      <img src="{{ post.image.url }}" alt="" class="w-full h-48 object-cover rounded mb-3" />
                    {% endif %}
                  {% endwith %}
                  <div class="font-semibold text-lg text-[#555B6E] mb-1">{{ post.title }}</div>
                  <div class="text-xs text-[#555B6E]/70 mb-2">{{ post.created_at|date:'M d, Y' }} • {{ post.visibility }}</div>
                  <div class="text-sm text-[#555B6E] line-clamp-3">{{ post.content|truncatewords:40|safe }}</div>
                  <div class="mt-2 flex flex-wrap gap-2">
                    {% for tag in post.tags.all %}
                      <span class="bg-[#BEE3DB] text-[#555B6E] px-2 py-0.5 rounded-full text-[11px] font-semibold">{{ tag.name }}</span>
                    {% endfor %}
                  </div>
                </a>
                <div class="mt-3 pt-3 border-t border-[#E6F2F0] flex flex-col sm:flex-row gap-2 sm:items-center sm:justify-between">
                  <div class="text-xs text-[#555B6E]/70">Visibility: <strong>{{ post.visibility }}</strong> • {% if post.published %}<span class="text-[#2E7D32]">Published</span>{% else %}<span class="text-[#AF4448]">Draft</span>{% endif %}</div>
                  {% if post.author_id == request.user.id %}
                  <form method="post" action="{% url 'user_blog_update_visibility' pk=post.pk %}" class="flex items-center gap-2 relative">
                    {% csrf_token %}
                    <input type="hidden" name="q" value="{{ q }}"/>
                    <input type="hidden" name="sort" value="{{ current_sort }}"/>
                    <input type="hidden" name="page" value="{{ page_obj.number }}"/>
                    <details class="relative" role="listbox">
                      <summary class="list-none cursor-pointer">
                        <span class="inline-flex items-center gap-2 border border-[#BEE3DB] rounded-full px-3 py-1.5 bg-white text-sm text-[#555B6E] hover:bg-[#F6FFF8]">
                          {{ post.visibility|title }}
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M7 10l5 5 5-5" stroke="#555B6E" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </span>
                      </summary>
                      <div class="absolute right-0 mt-2 w-44 artdeco-card py-1 shadow-lg z-20">
                        <button type="submit" name="visibility" value="members" class="block w-full text-left px-3 py-2 text-sm hover:bg-[#F6FFF8] text-[#555B6E] {% if post.visibility == 'members' %}bg-[#F6FFF8] font-semibold{% endif %}">Members</button>
                        <button type="submit" name="visibility" value="public" class="block w-full text-left px-3 py-2 text-sm hover:bg-[#F6FFF8] text-[#555B6E] {% if post.visibility == 'public' %}bg-[#F6FFF8] font-semibold{% endif %}">Public</button>
                        <button type="submit" name="visibility" value="both" class="block w-full text-left px-3 py-2 text-sm hover:bg-[#F6FFF8] text-[#555B6E] {% if post.visibility == 'both' %}bg-[#F6FFF8] font-semibold{% endif %}">Everywhere</button>
                      </div>
                    </details>
                    <label class="inline-flex items-center gap-1 text-sm text-[#555B6E]">
                      <input type="checkbox" name="published" {% if post.published %}checked{% endif %}/> Published
                    </label>
                  </form>
                  {% endif %}
                </div>
              </article>
            {% empty %}
              <article class="artdeco-card p-4 text-[#555B6E]">No posts yet.</article>
            {% endfor %}
          </div>

          {% if page_obj.paginator.num_pages > 1 %}
          <nav class="flex justify-center items-center mt-4" aria-label="Pagination">
            <ul class="flex gap-4 items-center">
              <li>
                {% if page_obj.has_previous %}
                  <a href="?q={{ q }}&sort={{ current_sort }}&page={{ page_obj.previous_page_number }}" class="rounded-full px-5 py-2 text-sm font-semibold bg-[#89B0AE] text-white hover:bg-[#555B6E]">Previous</a>
                {% else %}
                  <span class="rounded-full px-5 py-2 text-sm font-semibold bg-[#BEE3DB] text-[#555B6E] opacity-60">Previous</span>
                {% endif %}
              </li>
              <li><span class="text-[#555B6E] font-medium text-sm bg-white rounded-full px-4 py-2 border border-[#BEE3DB]">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span></li>
              <li>
                {% if page_obj.has_next %}
                  <a href="?q={{ q }}&sort={{ current_sort }}&page={{ page_obj.next_page_number }}" class="rounded-full px-5 py-2 text-sm font-semibold bg-[#89B0AE] text-white hover:bg-[#555B6E]">Next</a>
                {% else %}
                  <span class="rounded-full px-5 py-2 text-sm font-semibold bg-[#BEE3DB] text-[#555B6E] opacity-60">Next</span>
                {% endif %}
              </li>
            </ul>
          </nav>
          {% endif %}
        </main>

        <!-- Aside (right) -->
        <aside class="scaffold-layout__aside" aria-label="Blog sidebar">
          <div class="space-y-3">
            <div class="artdeco-card p-4">
              <div class="font-semibold text-[#555B6E] mb-2">Recent Posts</div>
              <ul class="divide-y divide-[#E6F2F0]">
                {% for p in recent_posts %}
                  <li class="py-2 first:pt-0 last:pb-0">
                    <div class="text-sm text-[#116466] font-medium line-clamp-2">{{ p.title }}</div>
                    <div class="text-[10px] text-[#555B6E]/60 mt-0.5">{{ p.created_at|date:'M d, Y' }}</div>
                  </li>
                {% empty %}
                  <li class="py-2 text-xs text-[#555B6E]/60">No posts yet.</li>
                {% endfor %}
              </ul>
            </div>
            <div class="artdeco-card p-4" x-data="{ expanded: false }">
              <div class="font-semibold text-[#555B6E] mb-2">Tags</div>
              <div class="flex flex-wrap gap-2">
                {% if tags_top %}
                  {% for t in tags_top %}
                    <a href="?q={{ t.name|urlencode }}&sort={{ current_sort }}" class="px-3 py-1 rounded-full bg-[#BEE3DB] text-[#555B6E] text-[11px] font-semibold">{{ t.name }}</a>
                  {% endfor %}
                  {% if tags_rest %}
                    <template x-if="expanded">
                      <div class="contents">
                        {% for t in tags_rest %}
                          <a href="?q={{ t.name|urlencode }}&sort={{ current_sort }}" class="px-3 py-1 rounded-full bg-[#BEE3DB] text-[#555B6E] text-[11px] font-semibold">{{ t.name }}</a>
                        {% endfor %}
                      </div>
                    </template>
                    <button type="button" class="mt-2 px-3 py-1.5 rounded-full border border-[#BEE3DB] text-[#555B6E] text-xs hover:bg-[#F6FFF8]" @click="expanded = !expanded" x-text="expanded ? 'Show less' : 'Load more'"></button>
                  {% endif %}
                {% else %}
                  <span class="text-xs text-[#555B6E]/60">No tags yet.</span>
                {% endif %}
              </div>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <!-- Modal Composer (blog) -->
  <div id="blog-composer" class="fixed inset-0 bg-black/40 hidden z-[500]">
    <div class="max-w-2xl mx-auto mt-20 bg-white rounded-xl shadow border border-[#BEE3DB] overflow-hidden">
      <form method="post" action="{% url 'user_blog_create' %}" enctype="multipart/form-data" id="blog-composer-form">
        {% csrf_token %}
        <div class="px-4 py-3 border-b border-[#BEE3DB] flex items-center justify-between">
          <div class="font-semibold text-[#555B6E]">Create a blog post</div>
          <button type="button" id="blog-close" class="text-[#555B6E]">✕</button>
        </div>
        <div class="p-4 space-y-3">
          <div>
            <label class="block text-sm text-[#555B6E]/80 mb-1">Title</label>
            <input type="text" name="title" class="w-full border border-[#BEE3DB] rounded px-3 py-2 bg-[#FAF9F9] text-[#555B6E]" placeholder="Add a title" />
          </div>
          <div>
            <label class="block text-sm text-[#555B6E]/80 mb-1">Content</label>
            <textarea name="content" rows="8" class="w-full border border-[#BEE3DB] rounded px-3 py-2 bg-[#FAF9F9] text-[#555B6E]" placeholder="Write your post... Use [[media:1]] to place the first attached media inline."></textarea>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm text-[#555B6E]/80 mb-1">Cover image (optional)</label>
              <input type="file" name="image" accept="image/*" class="w-full border border-[#BEE3DB] rounded px-3 py-2 bg-white text-[#555B6E]" />
            </div>
            <div>
              <label class="block text-sm text-[#555B6E]/80 mb-1">Publish to</label>
              <select name="visibility" class="w-full border border-[#BEE3DB] rounded px-3 py-2 bg-[#FAF9F9] text-[#555B6E]"><option value="members">Members</option><option value="public">Public</option><option value="both">Everywhere</option></select>
              <label class="mt-2 inline-flex items-center gap-2 text-sm text-[#555B6E]"><input type="checkbox" name="published" class="h-4 w-4 text-[#89B0AE] focus:ring-[#89B0AE] border-[#BEE3DB] rounded" checked /> Publish now</label>
            </div>
          </div>
          <div>
            <label class="block text-sm text-[#555B6E]/80 mb-1">Attach media (up to 8)</label>
            <input id="blog-modal-media" type="file" name="media" multiple accept="image/*,video/*" class="w-full border border-[#BEE3DB] rounded px-3 py-2 bg-white text-[#555B6E]" />
            <input type="hidden" name="media_meta" id="blog-modal-media-meta" value="{}" />
            <div id="blog-modal-preview" class="mt-2 grid grid-cols-3 gap-2"></div>
          </div>
        </div>
        <div class="px-4 py-3 border-t border-[#BEE3DB] flex items-center justify-end gap-2 bg-[#F6FFF8]">
          <button type="button" id="blog-cancel" class="px-4 py-2 rounded border border-[#BEE3DB] text-[#555B6E]">Cancel</button>
          <button type="submit" class="px-4 py-2 rounded bg-[#89B0AE] text-white font-semibold">Post</button>
        </div>
      </form>
    </div>
  </div>

  <script>
  (function(){
    const modal = document.getElementById('blog-composer');
    const openBtn = document.getElementById('open-blog-composer');
    const closeBtn = document.getElementById('blog-close');
    const cancelBtn = document.getElementById('blog-cancel');
    const mediaInput = document.getElementById('blog-modal-media');
    const preview = document.getElementById('blog-modal-preview');
    function open(){ if(modal) modal.classList.remove('hidden'); }
    function close(){ if(modal) modal.classList.add('hidden'); }
    openBtn && openBtn.addEventListener('click', open);
    closeBtn && closeBtn.addEventListener('click', close);
    cancelBtn && cancelBtn.addEventListener('click', close);
    function render(){ if(!mediaInput||!preview) return; const files = mediaInput.files?Array.from(mediaInput.files):[]; preview.innerHTML=''; files.slice(0,8).forEach(f=>{ const url=URL.createObjectURL(f); const wrap=document.createElement('div'); wrap.className='relative border border-[#E6F2F0] rounded overflow-hidden'; wrap.style.height='90px'; if ((f.type||'').startsWith('video/')) wrap.innerHTML = `<video src="${url}" class="w-full h-full object-cover" muted></video>`; else wrap.innerHTML = `<img src="${url}" class="w-full h-full object-cover" alt=""/>`; preview.appendChild(wrap); }); }
    mediaInput && mediaInput.addEventListener('change', render);
  })();
  </script>
</div>
{% endblock %}
