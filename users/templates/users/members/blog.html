{% extends 'base.html' %}
{% block content %}
<div class="max-w-5xl mx-auto py-8 px-4">
  <h1 class="text-2xl font-bold text-[#555B6E] mb-4">My Blog</h1>

  <!-- Create Blog Composer (parity with feed, simplified) -->
  <div class="bg-white border border-[#BEE3DB] rounded-xl shadow p-4 mb-6">
    <form method="post" action="{% url 'user_blog_create' %}" enctype="multipart/form-data" id="blog-create-form" class="space-y-3">
      {% csrf_token %}
      <div>
        <label class="block text-sm text-[#555B6E]/80 mb-1">Title</label>
        <input type="text" name="title" class="w-full border border-[#BEE3DB] rounded px-3 py-2 bg-[#FAF9F9] text-[#555B6E]" placeholder="Add a title" />
      </div>
      <div>
        <label class="block text-sm text-[#555B6E]/80 mb-1">Content</label>
        <textarea name="content" rows="6" class="w-full border border-[#BEE3DB] rounded px-3 py-2 bg-[#FAF9F9] text-[#555B6E]" placeholder="Write your post... You can place images or videos inline later."></textarea>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm text-[#555B6E]/80 mb-1">Cover image (optional)</label>
          <input type="file" name="image" accept="image/*" class="w-full border border-[#BEE3DB] rounded px-3 py-2 bg-white text-[#555B6E]" />
        </div>
        <div>
          <label class="block text-sm text-[#555B6E]/80 mb-1">Publish to</label>
          <select name="visibility" class="w-full border border-[#BEE3DB] rounded px-3 py-2 bg-[#FAF9F9] text-[#555B6E]">
            <option value="public">Public</option>
            <option value="members">Members</option>
            <option value="both">Everywhere</option>
          </select>
        </div>
      </div>
      <div>
        <label class="block text-sm text-[#555B6E]/80 mb-1">Attach media (up to 8)</label>
        <input id="blog-media" type="file" name="media" multiple accept="image/*,video/*" class="w-full border border-[#BEE3DB] rounded px-3 py-2 bg-white text-[#555B6E]" />
        <input type="hidden" name="media_meta" id="blog-media-meta" value="{}" />
        <div id="blog-media-preview" class="mt-2 grid grid-cols-3 gap-2"></div>
      </div>
      <div class="flex items-center justify-between">
        <label class="inline-flex items-center gap-2 text-sm text-[#555B6E]"><input type="checkbox" name="published" class="h-4 w-4 text-[#89B0AE] focus:ring-[#89B0AE] border-[#BEE3DB] rounded" /> Publish now</label>
        <button class="px-4 py-2 rounded bg-[#89B0AE] text-white font-semibold">Create</button>
      </div>
    </form>
  </div>

  <!-- Existing posts list (styled similar to public index) -->
  <div class="space-y-6">
    {% for post in posts %}
      <div class="rounded-2xl shadow p-5 bg-[#FAF9F9] border border-[#BEE3DB]">
        <div class="flex flex-col sm:flex-row gap-4">
          <div class="sm:w-48 sm:flex-shrink-0">
            {% with first_media=post.media.all|first %}
              {% if first_media %}
                {% if first_media.type == 'image' %}
                  <img src="{{ first_media.file.url }}" alt="" class="w-full h-32 object-cover rounded" />
                {% else %}
                  <video src="{{ first_media.file.url }}" class="w-full h-32 object-cover rounded" muted></video>
                {% endif %}
              {% elif post.image %}
                <img src="{{ post.image.url }}" alt="" class="w-full h-32 object-cover rounded" />
              {% endif %}
            {% endwith %}
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-semibold text-lg text-[#555B6E]">{{ post.title }}</div>
                <div class="text-xs text-[#555B6E]/70">{{ post.created_at|date:'M d, Y' }} • {{ post.visibility }} • {% if post.published %}Published{% else %}Draft{% endif %}</div>
              </div>
              <div class="flex gap-3 text-sm">
                <a href="{% url 'user_blog_edit' pk=post.pk %}" class="text-[#FF9950] hover:underline">Edit</a>
                {% if post.slug and post.published and post.visibility != 'members' %}
                  <a href="{% url 'blog_detail' slug=post.slug %}" class="text-[#89B0AE] hover:underline">View</a>
                {% endif %}
              </div>
            </div>
            <div class="mt-2 text-sm text-[#555B6E] line-clamp-3">{{ post.content|truncatewords:50|safe }}</div>
            <div class="mt-3 flex flex-wrap gap-2">
              {% for tag in post.tags.all %}
                <span class="bg-[#BEE3DB] text-[#555B6E] px-2 py-0.5 rounded-full text-[11px] font-semibold">{{ tag.name }}</span>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    {% empty %}
      <div class="text-[#555B6E]">No posts yet.</div>
    {% endfor %}
  </div>
</div>

<script>
(function(){
  const input = document.getElementById('blog-media');
  const preview = document.getElementById('blog-media-preview');
  function render(){
    if (!input || !preview) return;
    const files = input.files ? Array.from(input.files) : [];
    preview.innerHTML = '';
    files.slice(0, 8).forEach(f => {
      const url = URL.createObjectURL(f);
      const wrap = document.createElement('div');
      wrap.className = 'relative border border-[#E6F2F0] rounded overflow-hidden';
      wrap.style.height = '90px';
      if ((f.type||'').startsWith('video/')){
        wrap.innerHTML = `<video src="${url}" class="w-full h-full object-cover" muted></video>`;
      } else {
        wrap.innerHTML = `<img src="${url}" class="w-full h-full object-cover" alt=""/>`;
      }
      preview.appendChild(wrap);
    });
  }
  input && input.addEventListener('change', render);
})();
</script>
{% endblock %}
