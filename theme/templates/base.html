{% load static tailwind_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Therapy Connected</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <script>
            // Polyfills for ChildNode/Element methods used by Alpine in older Safari
            (function(){
                var p = Element.prototype;
                if(!p.after){
                    p.after = function(){
                        var argArr = Array.prototype.slice.call(arguments);
                        var docFrag = document.createDocumentFragment();
                        argArr.forEach(function(argItem){
                            docFrag.appendChild(argItem instanceof Node ? argItem : document.createTextNode(String(argItem)));
                        });
                        if(this.parentNode){ this.parentNode.insertBefore(docFrag, this.nextSibling); }
                    };
                }
                if(!p.before){
                    p.before = function(){
                        var argArr = Array.prototype.slice.call(arguments);
                        var docFrag = document.createDocumentFragment();
                        argArr.forEach(function(argItem){
                            docFrag.appendChild(argItem instanceof Node ? argItem : document.createTextNode(String(argItem)));
                        });
                        if(this.parentNode){ this.parentNode.insertBefore(docFrag, this); }
                    };
                }
                if(!p.append){
                    p.append = function(){
                        var argArr = Array.prototype.slice.call(arguments);
                        var docFrag = document.createDocumentFragment();
                        argArr.forEach(function(argItem){
                            docFrag.appendChild(argItem instanceof Node ? argItem : document.createTextNode(String(argItem)));
                        });
                        this.appendChild(docFrag);
                    };
                }
                if(!p.prepend){
                    p.prepend = function(){
                        var argArr = Array.prototype.slice.call(arguments);
                        var docFrag = document.createDocumentFragment();
                        argArr.forEach(function(argItem){
                            docFrag.appendChild(argItem instanceof Node ? argItem : document.createTextNode(String(argItem)));
                        });
                        this.insertBefore(docFrag, this.firstChild);
                    };
                }
            })();
        </script>
        {% tailwind_css %}
        <link href="{% static 'css/dist/styles.css' %}" rel="stylesheet">
        <!-- Alpine.js (pinned version with fallback) -->
        <script 
            src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/cdn.min.js" 
            defer 
            onerror="console.warn('[Alpine] primary CDN failed, attempting fallback...');(function(){var s=document.createElement('script');s.src='https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js';s.defer=true;s.onerror=function(){console.error('[Alpine] fallback Alpine load failed');window.dispatchEvent(new CustomEvent('alpine-failed'));};document.head.appendChild(s);}())">
        </script>
        <style>
            /* Members header: darker corporate bar */
            .member-header{
                background: #555B6E; /* dark slate */
                border-bottom: 2px solid #BEE3DB;
                box-shadow: 0 1px 2px rgba(0,0,0,0.06);
            }
            /* Brand link colors */
            .public-header .brand-link{ color:#555B6E; }
            .member-header .brand-link{ color:#F7FAF9 !important; }
            /* Member nav: underline/active bar with high contrast */
            .member-header nav.member-nav{ gap: 1.25rem; background: transparent; border: 0; padding: 0; border-radius: 0; }
            .member-header nav a.nav-link{
                padding: 0.75rem 0.25rem;
                border-bottom: 2px solid transparent;
                color: #EAF7F4 !important; /* override inline */
                background: transparent;
                border-radius: 0;
                transition: color .15s ease, border-color .15s ease;
            }
            .member-header nav a.nav-link:hover{ color:#BEE3DB !important; border-bottom-color:#BEE3DB; }
            .member-header nav a.nav-link.active-nav{ color:#FF9950 !important; border-bottom-color:#FF9950; }
            /* Member header action button (e.g., Logout) */
            .member-header .action-btn{
                background-color: transparent;
                color: #EAF7F4;
                border: 1px solid #BEE3DB;
                padding: 0.5rem 0.75rem;
                border-radius: 0.5rem;
                font-weight: 600;
                font-size: 0.875rem; /* text-sm */
                transition: background .2s, color .2s, border-color .2s;
            }
            .member-header .action-btn:hover,
            .member-header .action-btn:focus{
                background-color: #BEE3DB;
                color: #555B6E;
                border-color: #BEE3DB;
            }
        </style>
        <script>
            // Safety guard: if Alpine fails to load, provide minimal shim to prevent hard breaks.
            window.addEventListener('alpine-failed', () => {
                if(!window.Alpine){
                    console.error('[Alpine] Not loaded. Installing minimal no-op shim.');
                    window.Alpine = { store(){ return {}; }, start(){}, version:'shim' };
                }
            });
        </script>
        <script>
            // Global profileModal store (display-only usage) so modal works site-wide.
            document.addEventListener('alpine:init', () => {
                if(Alpine.store('profileModal')) return; // already defined elsewhere
                Alpine.store('profileModal', {
                    currentUserId: {% if request.user.is_authenticated %}{{ request.user.id }}{% else %}null{% endif %},
                    show:false,
                    therapist:{},
                    loading:false,
                    error:null,
                    contentVisible:false,
                    open(id){
                        try { console.log('[profileModal] open', id); } catch(_){}
                        if(this.show && this.therapist && this.therapist.id===id){ return; }
                        this.error=null; this.loading=true; this.contentVisible=false; this.therapist={ id };
                        if(!this.show){ this.show=true; document.documentElement.classList.add('overflow-hidden'); document.body.classList.add('overflow-hidden'); }
                        fetch(`/users/api/therapists/${id}/profile_full/`)
                          .then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
                          .then(d=>{ this.therapist=d; window.initTherapistLocationMaps && window.initTherapistLocationMaps(); })
                          .catch(e=>{ this.error=e.message||'Load failed'; })
                          .finally(()=>{ this.loading=false; this.contentVisible=true; });
                    },
                    close(){ try { console.log('[profileModal] close'); } catch(_){}
                        this.show=false; this.contentVisible=false;
                        requestAnimationFrame(()=>{ document.documentElement.classList.remove('overflow-hidden'); document.body.classList.remove('overflow-hidden'); });
                    }
                });
            });
        </script>
    <style>[x-cloak]{display:none !important;}</style>
        <script>
            // Ensure mediaLightbox store exists as early as possible after Alpine loads
            document.addEventListener('alpine:init', () => {
                if(!Alpine.store('mediaLightbox')){
                    Alpine.store('mediaLightbox', {
                        open:false, type:null, src:null, caption:null,
                        openImage(src){ console.log('[mediaLightbox] openImage', src); this.type='image'; this.src=src; this.caption=''; this.open=true; this._lock(); },
                        openVideo(src, caption){ console.log('[mediaLightbox] openVideo', src); this.type='video'; this.src=src; this.caption=caption||''; this.open=true; this._lock(); },
                        close(){ console.log('[mediaLightbox] close'); this.open=false; this.src=null; this.caption=null; this.type=null; this._unlock(); },
                        _lock(){ document.documentElement.classList.add('overflow-hidden'); document.body.classList.add('overflow-hidden'); },
                        _unlock(){ document.documentElement.classList.remove('overflow-hidden'); document.body.classList.remove('overflow-hidden'); }
                    });
                    // Expose for quick console inspection
                    window.__mediaLightbox = Alpine.store('mediaLightbox');
                }
            });
        </script>
</head>
<body class="bg-gray-50 text-black font-serif leading-normal tracking-normal min-h-screen flex flex-col">
        {# When authenticated, hide only the header's marketing CTA, not other buttons that reuse this class #}
        {% if request.user.is_authenticated %}
    <style>
            .public-header .get-started-btn.signup-btn { display: none !important; }
        </style>
        {% endif %}
        <style>
            /* Reusable thin scrollbar for modal content */
            .custom-scrollbar { scrollbar-gutter: stable both-edge; }
            .custom-scrollbar::-webkit-scrollbar { width: 10px; }
            .custom-scrollbar::-webkit-scrollbar-track { background: #F1F5F4; border-radius: 8px; }
            .custom-scrollbar::-webkit-scrollbar-thumb { background: #BEE3DB; border-radius: 8px; border:2px solid #F1F5F4; }
            .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #89B0AE; }
            /* Members header: darker corporate bar (overrides) */
            .member-header{
                background: #555B6E; /* dark slate */
                border-bottom: 2px solid #BEE3DB;
                box-shadow: 0 1px 2px rgba(0,0,0,0.06);
            }
            /* Member nav: horizontal links with active underline and high contrast */
            .member-header nav.member-nav{ gap: 1.25rem; background: transparent; border: 0; padding: 0; border-radius: 0; }
            .member-header nav a.nav-link{
                padding: 0.75rem 0.25rem;
                border-bottom: 2px solid transparent;
                color: #EAF7F4 !important;
                background: transparent;
                border-radius: 0;
                transition: color .15s ease, border-color .15s ease;
            }
            .member-header nav a.nav-link:hover{ color:#BEE3DB !important; border-bottom-color:#BEE3DB; }
            .member-header nav a.nav-link.active-nav{ color:#FF9950 !important; border-bottom-color:#FF9950; }
            /* Member mobile menu background */
            .member-header #mobile-menu nav{ background-color:#F7FFFB; border:1px solid #D8EFE8; }
            /* Member mobile menu action button variant (on light background) */
            .member-header #mobile-menu .action-btn{
                background-color: #BEE3DB;
                color: #555B6E;
                border-color: #BEE3DB;
            }
            .member-header #mobile-menu .action-btn:hover,
            .member-header #mobile-menu .action-btn:focus{
                background-color: #89B0AE;
                color: #FFFFFF;
                border-color: #89B0AE;
            }
            /* Public login button styling */
            .public-header .login-btn{
                background-color: transparent;
                color: #89B0AE;
                border: 1px solid #89B0AE;
                transition: background .2s, color .2s, border-color .2s;
            }
            .public-header .login-btn:hover,
            .public-header .login-btn:focus{
                background-color: #89B0AE;
                color: #fff;
                border-color: #89B0AE;
            }
            /* Sticky header on desktop for both public and member headers */
            @media (min-width: 1024px){
                .public-header,
                .member-header{
                    position: sticky;
                    top: 0;
                    z-index: 60; /* below media lightbox (z-120), above content */
                }
            }
        </style>

        <header class="{% if request.user.is_authenticated %}member-header{% else %}public-header{% endif %} bg-white border-b">
            <div class="{% if request.user.is_authenticated %}px-4 py-3{% else %}max-w-7xl mx-auto px-4 py-3{% endif %}">
                <div class="flex items-center gap-4 xl:grid xl:grid-cols-3">
                    <div class="flex items-center">
                        <a href="/" class="brand-link text-xl font-semibold flex items-center">
                            Therapy Connected
                            {% if request.user.is_authenticated %}
                                <span class="ml-2 text-[11px] font-semibold px-2 py-0.5 rounded-full" style="background:#BEE3DB; color:#555B6E;">Member</span>
                            {% endif %}
                        </a>
                        {% if not request.user.is_authenticated %}
                        <!-- Desktop ZIP control (public only) -->
                        <div class="ml-3 hidden md:block relative" x-data="{open:false,newZip:'',error:'',saving:false, submit(){this.error=''; if(!/^\\d{5}$/.test(this.newZip)){ this.error='Enter 5 digit ZIP'; return;} this.saving=true; fetch(`/set_zip/?zip=${this.newZip}`).then(r=>r.json()).then(d=>{ if(d.status==='ok'){ window.location.reload(); } else { this.error='Could not update'; } }).catch(()=> this.error='Network error').finally(()=> this.saving=false); } }">
                            <button type="button" @click="open=!open; if(open){ $nextTick(()=> $refs.dZip && $refs.dZip.focus()) }" class="flex items-center gap-1 text-sm font-medium px-2 py-1 rounded border" style="border-color:#89B0AE; color:#555B6E; background:#FAF9F9;">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/></svg>
                                <span>
                                    {% if user_zip_city and user_zip_state %}
                                        {{ user_zip_city }}, {{ user_zip_state }}
                                    {% elif user_zip %}
                                        {{ user_zip }}
                                    {% else %}
                                        Set Location
                                    {% endif %}
                                </span>
                            </button>
                            <div x-cloak x-show="open" @click.outside="open=false" class="absolute z-50 mt-2 left-0 bg-white border rounded shadow p-3 w-64">
                                <form @submit.prevent="submit()" class="space-y-2">
                                    <input x-ref="dZip" x-model="newZip" type="text" inputmode="numeric" maxlength="5" placeholder="ZIP" aria-label="ZIP code" class="w-full border rounded px-3 py-2 text-sm" style="border-color:#89B0AE; color:#555B6E; background:#FAF9F9;" />
                                    <button type="button" @click="open=false; error=''; if(typeof setZipFromGeolocation==='function'){ setZipFromGeolocation(true); } else { error='Function not available'; }" class="text-xs underline font-medium" style="color:#89B0AE;">Use my location</button>
                                    <div class="flex gap-2 justify-end">
                                        <button type="button" @click="open=false; newZip=''; error=''" class="px-3 py-1 text-xs font-medium rounded" style="background:#BEE3DB; color:#555B6E;">Cancel</button>
                                        <button type="submit" :disabled="saving" class="px-3 py-1 text-xs font-semibold rounded" :class="saving ? 'opacity-60 cursor-not-allowed' : ''" style="background:#89B0AE; color:#FAF9F9;" x-text="saving ? 'Saving...' : 'Save'"></button>
                                    </div>
                                    <p x-show="error" x-text="error" class="text-xs font-semibold" style="color:#FF4D4F;"></p>
                                </form>
                            </div>
                        </div>
                        {% endif %}
                        <button id="mobile-menu-btn" class="ml-auto inline-flex xl:hidden items-center justify-center w-10 h-10 rounded-md" aria-label="Toggle menu">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-6 h-6" style="color:#555B6E;"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/></svg>
                        </button>
                    </div>
                    {% if request.user.is_authenticated %}
                    <nav class="hidden xl:flex items-center gap-2 member-nav xl:justify-self-center xl:ml-0">
                        <a href="/users/members/feed/" class="font-medium nav-link{% if request.path|slice:':20' == '/users/members/feed/' %} active-nav{% endif %}" style="color: {% if request.path|slice:':20' == '/users/members/feed/' %}#FF9950{% else %}#555B6E{% endif %};">Home</a>
                        <a href="/users/members/connections/" class="font-medium nav-link{% if request.path|slice:':27' == '/users/members/connections/' %} active-nav{% endif %}" style="color: {% if request.path|slice:':27' == '/users/members/connections/' %}#FF9950{% else %}#555B6E{% endif %};">Connections</a>
                        <a href="/users/members/blog/" class="font-medium nav-link{% if request.path|slice:':20' == '/users/members/blog/' %} active-nav{% endif %}" style="color: {% if request.path|slice:':20' == '/users/members/blog/' %}#FF9950{% else %}#555B6E{% endif %};">Blog</a>
                        <a href="/users/members/profile/" class="font-medium nav-link{% if request.path|slice:':23' == '/users/members/profile/' or request.path|slice:':20' == '/users/profile/edit/' %} active-nav{% endif %}" style="color: {% if request.path|slice:':23' == '/users/members/profile/' or request.path|slice:':20' == '/users/profile/edit/' %}#FF9950{% else %}#555B6E{% endif %};">Profile</a>
                        <a href="/users/members/stats/" class="font-medium nav-link{% if request.path|slice:':21' == '/users/members/stats/' %} active-nav{% endif %}" style="color: {% if request.path|slice:':21' == '/users/members/stats/' %}#FF9950{% else %}#555B6E{% endif %};">Stats</a>
                        <a href="/users/members/account/" class="font-medium nav-link{% if request.path|slice:':23' == '/users/members/account/' %} active-nav{% endif %}" style="color: {% if request.path|slice:':23' == '/users/members/account/' %}#FF9950{% else %}#555B6E{% endif %};">Account</a>
                    </nav>
                    <div class="hidden xl:flex items-center space-x-2 xl:space-x-4 xl:justify-self-end xl:ml-0">
                        <a href="/users/logout/" class="action-btn">Logout</a>
                    </div>
                    {% else %}
                    <nav class="hidden xl:flex items-center gap-6 xl:justify-self-center xl:ml-0">
                        <a href="/" class="font-medium nav-link{% if request.path == '/' %} active-nav{% endif %}" style="color: {% if request.path == '/' %}#FF9950{% else %}#555B6E{% endif %};">Home</a>
                        <a href="/therapists/" class="font-medium nav-link{% if request.path|slice:':12' == '/therapists/' or request.path|slice:':9' == '/users/t/' %} active-nav{% endif %}" style="color: {% if request.path|slice:':12' == '/therapists/' or request.path|slice:':9' == '/users/t/' %}#FF9950{% else %}#555B6E{% endif %};">Therapists</a>
                        <a href="{% url 'blog_index' %}" class="font-medium nav-link{% if request.path|slice:':6' == '/blog/' %} active-nav{% endif %}" style="color: {% if request.path|slice:':6' == '/blog/' %}#FF9950{% else %}#555B6E{% endif %};">Blog</a>
                        <a href="/features/" class="font-medium nav-link{% if request.path|slice:':9' == '/features' %} active-nav{% endif %}" style="color: {% if request.path|slice:':9' == '/features' %}#FF9950{% else %}#555B6E{% endif %};">Features</a>
                        <a href="/pricing/" class="font-medium nav-link{% if request.path|slice:':8' == '/pricing' %} active-nav{% endif %}" style="color: {% if request.path|slice:':8' == '/pricing' %}#FF9950{% else %}#555B6E{% endif %};">Pricing</a>
                        <a href="/about/" class="font-medium nav-link{% if request.path|slice:':6' == '/about' %} active-nav{% endif %}" style="color: {% if request.path|slice:':6' == '/about' %}#FF9950{% else %}#555B6E{% endif %};">About</a>
                    </nav>
                    <div class="hidden xl:flex items-center space-x-2 xl:space-x-4 xl:justify-self-end xl:ml-0">
                        <a href="/users/login/" class="login-btn px-4 py-2 rounded font-semibold text-sm">Login</a>
                        {% if request.path != '/users/register/' %}
                            <a href="/subscribe/" class="get-started-btn px-4 py-2 rounded font-semibold text-sm signup-btn">Get Started</a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                <!-- Mobile nav dropdown -->
                <div id="mobile-menu" class="xl:hidden hidden w-full mt-2">
                <nav class="flex flex-col gap-2 bg-white rounded shadow p-4 items-center text-center">
                    {% if not request.user.is_authenticated %}
                    <!-- Mobile ZIP control (public only) -->
                    <div x-data="{open:false,newZip:'',error:'',saving:false, submit(){this.error=''; if(!/^\d{5}$/.test(this.newZip)){ this.error='Enter 5 digit ZIP'; return;} this.saving=true; fetch(`/set_zip/?zip=${this.newZip}`).then(r=>r.json()).then(d=>{ if(d.status==='ok'){ window.location.reload(); } else { this.error='Could not update'; } }).catch(()=> this.error='Network error').finally(()=> this.saving=false); }}" class="w-full mb-2">
                        <button type="button" @click="open=!open; if(open){ $nextTick(()=> $refs.mZip.focus()) }" class="w-full flex items-center justify-center gap-1 text-sm font-medium px-2 py-2 rounded border" style="border-color:#89B0AE; color:#555B6E;">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/></svg>
                            <span>
                                {% if user_zip_city and user_zip_state %}
                                    {{ user_zip_city }}, {{ user_zip_state }}
                                {% elif user_zip %}
                                    {{ user_zip }}
                                {% else %}
                                    Set Location
                                {% endif %}
                            </span>
                        </button>
                        <div x-cloak x-show="open" class="mt-2 text-left">
                            <form @submit.prevent="submit()" class="space-y-2">
                                <input x-ref="mZip" x-model="newZip" type="text" inputmode="numeric" maxlength="5" placeholder="ZIP" aria-label="ZIP code" class="w-full border rounded px-3 py-2 text-sm" style="border-color:#89B0AE; color:#555B6E; background:#FAF9F9;" />
                                <button type="button" @click="open=false; error=''; if(typeof setZipFromGeolocation==='function'){ setZipFromGeolocation(true); } else { error='Function not available'; }" class="text-xs underline font-medium" style="color:#89B0AE;">Use my location</button>
                                <div class="flex gap-2 justify-end">
                                    <button type="button" @click="open=false; newZip=''; error=''" class="px-3 py-1 text-xs font-medium rounded" style="background:#BEE3DB; color:#555B6E;">Cancel</button>
                                    <button type="submit" :disabled="saving" class="px-3 py-1 text-xs font-semibold rounded" :class="saving ? 'opacity-60 cursor-not-allowed' : ''" style="background:#89B0AE; color:#FAF9F9;" x-text="saving ? 'Saving...' : 'Save'"></button>
                                </div>
                                <p x-show="error" x-text="error" class="text-xs font-semibold" style="color:#FF4D4F;"></p>
                            </form>
                        </div>
                    </div>
                    {% endif %}
                                        {% if request.user.is_authenticated %}
                                            <a href="/users/members/feed/" class="font-medium nav-link{% if request.path|slice:':20' == '/users/members/feed/' %} active-nav{% endif %}" style="color: {% if request.path|slice:':20' == '/users/members/feed/' %}#FF9950{% else %}#555B6E{% endif %};">Home</a>
                                            <a href="/users/members/connections/" class="font-medium nav-link{% if request.path|slice:':27' == '/users/members/connections/' %} active-nav{% endif %}" style="color: {% if request.path|slice:':27' == '/users/members/connections/' %}#FF9950{% else %}#555B6E{% endif %};">Connections</a>
                                            <a href="/users/members/blog/" class="font-medium nav-link{% if request.path|slice:':20' == '/users/members/blog/' %} active-nav{% endif %}" style="color: {% if request.path|slice:':20' == '/users/members/blog/' %}#FF9950{% else %}#555B6E{% endif %};">Blog</a>
                                            <a href="/users/members/profile/" class="font-medium nav-link{% if request.path|slice:':23' == '/users/members/profile/' or request.path|slice:':20' == '/users/profile/edit/' %} active-nav{% endif %}" style="color: {% if request.path|slice:':23' == '/users/members/profile/' or request.path|slice:':20' == '/users/profile/edit/' %}#FF9950{% else %}#555B6E{% endif %};">Profile</a>
                                            <a href="/users/members/stats/" class="font-medium nav-link{% if request.path|slice:':21' == '/users/members/stats/' %} active-nav{% endif %}" style="color: {% if request.path|slice:':21' == '/users/members/stats/' %}#FF9950{% else %}#555B6E{% endif %};">Stats</a>
                                            <a href="/users/members/account/" class="font-medium nav-link{% if request.path|slice:':23' == '/users/members/account/' %} active-nav{% endif %}" style="color: {% if request.path|slice:':23' == '/users/members/account/' %}#FF9950{% else %}#555B6E{% endif %};">Account</a>
                                            <div class="flex flex-col gap-2 mt-2">
                                                <a href="/users/logout/" class="action-btn text-center">Logout</a>
                                            </div>
                                        {% else %}
                                                <a href="/" class="font-medium nav-link{% if request.path == '/' %} active-nav{% endif %}" style="color: {% if request.path == '/' %}#FF9950{% else %}#555B6E{% endif %};">Home</a>
                                                <a href="/therapists/" class="font-medium nav-link{% if request.path|slice:':12' == '/therapists/' or request.path|slice:':9' == '/users/t/' %} active-nav{% endif %}" style="color: {% if request.path|slice:':12' == '/therapists/' or request.path|slice:':9' == '/users/t/' %}#FF9950{% else %}#555B6E{% endif %};">Therapists</a>
                                                <a href="{% url 'blog_index' %}" class="font-medium nav-link{% if request.path|slice:':6' == '/blog/' %} active-nav{% endif %}" style="color: {% if request.path|slice:':6' == '/blog/' %}#FF9950{% else %}#555B6E{% endif %};">Blog</a>
                                                <a href="/features/" class="font-medium nav-link{% if request.path|slice:':9' == '/features' %} active-nav{% endif %}" style="color: {% if request.path|slice:':9' == '/features' %}#FF9950{% else %}#555B6E{% endif %};">Features</a>
                                                <a href="/pricing/" class="font-medium nav-link{% if request.path|slice:':8' == '/pricing' %} active-nav{% endif %}" style="color: {% if request.path|slice:':8' == '/pricing' %}#FF9950{% else %}#555B6E{% endif %};">Pricing</a>
                                                <a href="/about/" class="font-medium nav-link{% if request.path|slice:':6' == '/about' %} active-nav{% endif %}" style="color: {% if request.path|slice:':6' == '/about' %}#FF9950{% else %}#555B6E{% endif %};">About</a>
                        <div class="flex flex-col gap-2 mt-2">
                            <a href="/users/login/" class="login-btn px-4 py-2 rounded font-semibold text-sm text-center">Login</a>
                                                        {% if request.path != '/users/register/' %}
                                                                <a href="/subscribe/" class="get-started-btn px-4 py-2 rounded font-semibold text-sm text-center signup-btn">Get Started</a>
                                                        {% endif %}
                                                        <style>
                                                            .get-started-btn {
                                                                background-color: #89B0AE;
                                                                color: #fff;
                                                                transition: background 0.2s, color 0.2s;
                                                            }
                                                            .get-started-btn:hover, .get-started-btn:focus {
                                                                background-color: #555B6E !important;
                                                                color: #fff !important;
                                                            }
                                                        </style>
                                                </div>
                                        {% endif %}
                </nav>
            </div>
        <script>
    // Simple mobile nav toggle
        document.addEventListener('DOMContentLoaded', function() {
            var btn = document.getElementById('mobile-menu-btn');
            var menu = document.getElementById('mobile-menu');
            if (btn && menu) {
                btn.addEventListener('click', function() {
                    menu.classList.toggle('hidden');
                });
            }
        });
        </script>
    </header>
    <main class="flex-1 flex flex-col">
        {% block content %}{% endblock %}
    </main>
    {% include "footer.html" %}
        <!-- Global site JS (modal logic + geolocation ZIP helper) -->
        <script src="{% static 'home.js' %}"></script>
                <script>
                    // Debug flag for delegated lightbox handler
                    window.TC_DEBUG_LIGHTBOX = true;
                    if(window.TC_DEBUG_LIGHTBOX){ try{ console.log('[tc] lightbox delegate installingâ€¦'); }catch(_){} }
                    // Fallback delegation: if direct Alpine binding failed, allow data-lightbox-image/video attributes to trigger.
                    document.addEventListener('click', function(e){
                        try{
                            let fig = e.target && e.target.closest ? e.target.closest('[data-lightbox-image], [data-lightbox-video]') : null;
                            let inferredSrc = null;
                            if(!fig && e.target && e.target.closest){
                                const zoomFig = e.target.closest('figure[data-gallery-zoom]');
                                if(zoomFig){
                                    const imgEl = zoomFig.querySelector('img');
                                    if(imgEl && imgEl.src){ inferredSrc = imgEl.src; fig = zoomFig; }
                                }
                            }
                            if(window.TC_DEBUG_LIGHTBOX){
                                try{ console.log('[tc] delegate click', { target:e.target && e.target.tagName, hasFig:!!fig, inferred:!!inferredSrc, src: inferredSrc || (fig && fig.dataset ? (fig.dataset.lightboxImage||fig.dataset.lightboxVideo||'') : '') }); }catch(_){ }
                            }
                            if(!fig && !inferredSrc) return;
                            const store = (window.Alpine && Alpine.store && Alpine.store('mediaLightbox')) ? Alpine.store('mediaLightbox') : window.__mediaLightbox;
                            if(!store){
                                // Minimal non-Alpine fallback
                                const src = inferredSrc || (fig && fig.dataset && fig.dataset.lightboxImage) || null;
                                if(window.TC_DEBUG_LIGHTBOX){ try{ console.log('[tc] using fallback overlay', src); }catch(_){} }
                                if(src){
                                    (function tcShowFallbackLightbox(s){
                                        let el=document.getElementById('tc-fallback-lightbox');
                                        if(!el){
                                            el=document.createElement('div');
                                            el.id='tc-fallback-lightbox';
                                            el.style.cssText='position:fixed;inset:0;z-index:8000;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;';
                                            const img=document.createElement('img');
                                            img.style.cssText='max-width:100vw;max-height:100vh;object-fit:contain;';
                                            el.appendChild(img);
                                            el.addEventListener('click', (ev)=>{ if(ev.target===el){ el.remove(); }});
                                            document.body.appendChild(el);
                                        }
                                        el.querySelector('img').src=s;
                                        el.style.display='flex';
                                    })(src);
                                }
                                return;
                            }
                            if(inferredSrc){ if(window.TC_DEBUG_LIGHTBOX){ try{ console.log('[tc] store.openImage (inferred)'); }catch(_){} } store.openImage(inferredSrc); }
                            else if(fig && fig.dataset && fig.dataset.lightboxImage){ if(window.TC_DEBUG_LIGHTBOX){ try{ console.log('[tc] store.openImage (data attr)'); }catch(_){} } store.openImage(fig.dataset.lightboxImage); }
                            else if(fig && fig.dataset && fig.dataset.lightboxVideo){ if(window.TC_DEBUG_LIGHTBOX){ try{ console.log('[tc] store.openVideo (data attr)'); }catch(_){} } store.openVideo(fig.dataset.lightboxVideo, fig.dataset.lightboxCaption||''); }
                        } catch(err){ try{ console.error('[tc] lightbox delegate error', err); }catch(_){} }
                    });
                    // Helper to test lightbox manually from console
                    window.__openLightboxTest = function(url){
                        const store = (window.Alpine && Alpine.store && Alpine.store('mediaLightbox')) ? Alpine.store('mediaLightbox') : null;
                        if(store){ store.openImage(url); return 'store.openImage called'; }
                        // fallback
                        const ev = new Event('click'); ev.target = document.body; // no-op
                        (function tcShowFallbackLightbox(s){
                            let el=document.getElementById('tc-fallback-lightbox');
                            if(!el){
                                el=document.createElement('div');
                                el.id='tc-fallback-lightbox';
                                el.style.cssText='position:fixed;inset:0;z-index:8000;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;';
                                const img=document.createElement('img');
                                img.style.cssText='max-width:100vw;max-height:100vh;object-fit:contain;';
                                el.appendChild(img);
                                el.addEventListener('click', (ev)=>{ if(ev.target===el){ el.remove(); }});
                                document.body.appendChild(el);
                            }
                            el.querySelector('img').src=s;
                            el.style.display='flex';
                        })(url);
                        return 'fallback overlay shown';
                    }
                </script>
        <!-- Leaflet (maps for profile modal locations) -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="" defer></script>
            <div x-cloak x-show="$store.mediaLightbox.open" x-transition class="fixed inset-0 z-[7000] flex items-center justify-center bg-black/90" @keydown.window.escape="$store.mediaLightbox.close()" @click.self="$store.mediaLightbox.close()">
                <div class="relative w-screen h-screen" x-trap.noscroll="$store.mediaLightbox.open">
                    <button @click="$store.mediaLightbox.close()" class="absolute top-6 right-6 bg-[#FF9950] hover:bg-[#555B6E] text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg" aria-label="Close media">
                        <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2.4' class='w-7 h-7'><path stroke-linecap='round' stroke-linejoin='round' d='M6 18L18 6M6 6l12 12'/></svg>
                    </button>
                    <template x-if="$store.mediaLightbox.type==='image'">
                        <img :src="$store.mediaLightbox.src" class="w-screen h-screen object-contain" />
                    </template>
                    <template x-if="$store.mediaLightbox.type==='video'">
                        <div class="w-screen h-screen bg-black">
                            <video :src="$store.mediaLightbox.src" controls autoplay class="w-full h-full object-contain"></video>
                        </div>
                    </template>
                    <div class="absolute bottom-6 left-1/2 -translate-x-1/2 text-center text-sm text-white/90 px-3 py-1 rounded" x-show="$store.mediaLightbox.caption" x-text="$store.mediaLightbox.caption"></div>
                </div>
            </div>
        <script>
            async function geocodeAddress(addr){
                if(!addr) return null;
                const url = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&q=' + encodeURIComponent(addr);
                try { const res = await fetch(url, { headers:{'Accept-Language':'en'} }); if(!res.ok) return null; const data = await res.json(); if(data && data.length){ return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) }; } } catch(e){ console.warn('Geocode failed', e); }
                return null;
            }
            window.initTherapistLocationMaps = async function(){
                const retry = ()=> setTimeout(window.initTherapistLocationMaps,120);
                if(!window.Alpine || !Alpine.store){ return retry(); }
                if(!window.L){ return retry(); }
                const store = Alpine.store('profileModal');
                if(!store || !store.therapist || !Array.isArray(store.therapist.locations)) return;
                const locs = store.therapist.locations;
                for(let i=0;i<locs.length;i++){
                    const loc = locs[i];
                    const el = document.getElementById('profile-map-' + i);
                    if(!el || el.dataset.mapInit) continue;
                    let { lat, lng } = loc;
                    if((lat==null || lng==null) && !loc.hide_address_from_public){
                        const addr = [loc.street_address, loc.city, loc.state, loc.zip].filter(Boolean).join(', ');
                        const geo = await geocodeAddress(addr);
                        if(geo){ lat = geo.lat; lng = geo.lng; loc.lat = lat; loc.lng = lng; }
                    }
                    if(lat!=null && lng!=null){
                        const map = L.map(el, { attributionControl:false, zoomControl:false }).setView([lat,lng], 13);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
                        L.marker([lat,lng]).addTo(map);
                    } else {
                        el.innerHTML = '<div class="absolute inset-0 flex items-center justify-center text-[10px] text-[#555B6E] px-2 text-center">Map unavailable for this address.</div>';
                    }
                    el.dataset.mapInit='1';
                }
            };
        </script>
</body>
</html>
