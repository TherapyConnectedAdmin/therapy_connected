{% load static tailwind_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Therapy Connected</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
        {% tailwind_css %}
        <link href="{% static 'css/dist/styles.css' %}" rel="stylesheet">
        <!-- Alpine.js (pinned version with fallback) -->
        <script 
            src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/cdn.min.js" 
            defer 
            onerror="console.warn('[Alpine] primary CDN failed, attempting fallback...');(function(){var s=document.createElement('script');s.src='https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js';s.defer=true;s.onerror=function(){console.error('[Alpine] fallback Alpine load failed');window.dispatchEvent(new CustomEvent('alpine-failed'));};document.head.appendChild(s);}())">
        </script>
        <script>
            // Safety guard: if Alpine fails to load, provide minimal shim to prevent hard breaks.
            window.addEventListener('alpine-failed', () => {
                if(!window.Alpine){
                    console.error('[Alpine] Not loaded. Installing minimal no-op shim.');
                    window.Alpine = { store(){ return {}; }, start(){}, version:'shim' };
                }
            });
        </script>
        <script>
            // Global profileModal store (display-only usage) so modal works site-wide.
            document.addEventListener('alpine:init', () => {
                if(Alpine.store('profileModal')) return; // already defined elsewhere
                Alpine.store('profileModal', {
                    currentUserId: {% if request.user.is_authenticated %}{{ request.user.id }}{% else %}null{% endif %},
                    show:false,
                    therapist:{},
                    loading:false,
                    error:null,
                    contentVisible:false,
                    open(id){
                        try { console.log('[profileModal] open', id); } catch(_){}
                        if(this.show && this.therapist && this.therapist.id===id){ return; }
                        this.error=null; this.loading=true; this.contentVisible=false; this.therapist={ id };
                        if(!this.show){ this.show=true; document.documentElement.classList.add('overflow-hidden'); document.body.classList.add('overflow-hidden'); }
                        fetch(`/users/api/therapists/${id}/profile_full/`)
                          .then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
                          .then(d=>{ this.therapist=d; window.initTherapistLocationMaps && window.initTherapistLocationMaps(); })
                          .catch(e=>{ this.error=e.message||'Load failed'; })
                          .finally(()=>{ this.loading=false; this.contentVisible=true; });
                    },
                    close(){ try { console.log('[profileModal] close'); } catch(_){}
                        this.show=false; this.contentVisible=false;
                        requestAnimationFrame(()=>{ document.documentElement.classList.remove('overflow-hidden'); document.body.classList.remove('overflow-hidden'); });
                    }
                });
            });
        </script>
    <style>[x-cloak]{display:none !important;}</style>
        <script>
            // Ensure mediaLightbox store exists as early as possible after Alpine loads
            document.addEventListener('alpine:init', () => {
                if(!Alpine.store('mediaLightbox')){
                    Alpine.store('mediaLightbox', {
                        open:false, type:null, src:null, caption:null,
                                openImage(src){ console.log('[mediaLightbox] openImage', src); this.type='image'; this.src=src; this.caption=''; this.open=true; this._lock(); },
                                openVideo(src, caption){ console.log('[mediaLightbox] openVideo', src); this.type='video'; this.src=src; this.caption=caption||''; this.open=true; this._lock(); },
                                close(){ console.log('[mediaLightbox] close'); this.open=false; this.src=null; this.caption=null; this.type=null; this._unlock(); },
                        _lock(){ document.documentElement.classList.add('overflow-hidden'); document.body.classList.add('overflow-hidden'); },
                        _unlock(){ document.documentElement.classList.remove('overflow-hidden'); document.body.classList.remove('overflow-hidden'); }
                    });
                            // Expose for quick console inspection
                            window.__mediaLightbox = Alpine.store('mediaLightbox');
                }
            });
        </script>
</head>
<body class="bg-gray-50 text-black font-serif leading-normal tracking-normal">
        <style>
            /* Reusable thin scrollbar for modal content */
            .custom-scrollbar { scrollbar-gutter: stable both-edge; }
            .custom-scrollbar::-webkit-scrollbar { width: 10px; }
            .custom-scrollbar::-webkit-scrollbar-track { background: #F1F5F4; border-radius: 8px; }
            .custom-scrollbar::-webkit-scrollbar-thumb { background: #BEE3DB; border-radius: 8px; border:2px solid #F1F5F4; }
            .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #89B0AE; }
            /* Ensure body lock prevents layout shift */
            html.overflow-hidden, body.overflow-hidden { height: 100%; overscroll-behavior: contain; }
        </style>
    <!-- Modals now included only in home.html; all showModal logic removed -->
    <!-- Header -->
    <div class="min-h-screen flex flex-col">
    <header class="shadow-sm sticky top-0 z-20" style="background-color: #FAF9F9;">
        <style>
        .nav-link {
            transition: color 0.2s;
        }
        .nav-link:hover {
            color: #FF9950 !important;
        }
        .signup-btn {
            transition: background 0.2s, color 0.2s;
        }
        .signup-btn:hover {
            color: #555B6E !important;
        }
        </style>
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative flex flex-col lg:flex-row items-center h-auto lg:h-16 py-2 lg:py-0">
            <!-- Logo and mobile menu button -->
            <div class="flex w-full lg:w-auto items-center justify-between lg:justify-start">
                <div class="flex items-center gap-4">
                    <a href="/" class="text-2xl font-bold" style="color: #555B6E;">Therapy Connected</a>
                    <!-- Compact ZIP control -->
                    <div x-data="{open:false,newZip:'',error:'',saving:false, submit(){this.error=''; if(!/^\d{5}$/.test(this.newZip)){ this.error='Enter 5 digit ZIP'; return;} this.saving=true; fetch(`/set_zip/?zip=${this.newZip}`).then(r=>r.json()).then(d=>{ if(d.status==='ok'){ window.location.reload(); } else { this.error='Could not update'; } }).catch(()=> this.error='Network error').finally(()=> this.saving=false); }}" class="relative hidden md:block">
                        <button type="button" @click="open=!open; if(open){ $nextTick(()=> $refs.zipInput.focus()) }" class="flex items-center gap-1 text-sm font-medium px-2 py-1 rounded hover:bg-[#BEE3DB] focus:outline-none focus:ring-2 focus:ring-[#89B0AE]" :aria-expanded="open.toString()" aria-haspopup="dialog" style="color:#555B6E;">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/></svg>
                            <span class="font-semibold">
                                {% if user_zip_city and user_zip_state %}
                                    {{ user_zip_city }}, {{ user_zip_state }}
                                {% elif user_zip %}
                                    {{ user_zip }}
                                {% else %}
                                    Set Location
                                {% endif %}
                            </span>
                        </button>
                        <div x-cloak x-show="open" x-transition @click.outside="open=false" class="absolute left-0 mt-2 w-60 bg-white border rounded shadow-lg p-4 z-30" style="border-color:#89B0AE;">
                            <h3 class="text-xs font-semibold mb-2 tracking-wide" style="color:#555B6E;">Change ZIP Code</h3>
                            <form @submit.prevent="submit()" class="space-y-2">
                                <input x-ref="zipInput" x-model="newZip" type="text" inputmode="numeric" maxlength="5" placeholder="ZIP" aria-label="ZIP code" class="w-full border rounded px-3 py-2 text-sm focus:ring-2" style="border-color:#89B0AE; color:#555B6E; background:#FAF9F9;" />
                                <button type="button" @click="open=false; error=''; if(typeof setZipFromGeolocation==='function'){ setZipFromGeolocation(true); } else { error='Function not available'; }" class="text-xs underline font-medium" style="color:#89B0AE;">Use my location</button>
                                <div class="flex gap-2 justify-end">
                                    <button type="button" @click="open=false; newZip=''; error=''" class="px-3 py-1 text-xs font-medium rounded" style="background:#BEE3DB; color:#555B6E;">Cancel</button>
                                    <button type="submit" :disabled="saving" class="px-3 py-1 text-xs font-semibold rounded" :class="saving ? 'opacity-60 cursor-not-allowed' : ''" style="background:#89B0AE; color:#FAF9F9;" x-text="saving ? 'Saving...' : 'Save'"></button>
                                </div>
                                <p x-show="error" x-text="error" class="text-xs font-semibold" style="color:#FF4D4F;"></p>
                                <p class="text-[10px] mt-1" style="color:#555B6E;">Current: <strong>
                                    {% if user_zip_city and user_zip_state %}
                                        {{ user_zip_city }}, {{ user_zip_state }} ({{ user_zip }})
                                    {% elif user_zip %}
                                        {{ user_zip }}
                                    {% else %}
                                        (none)
                                    {% endif %}
                                </strong></p>
                            </form>
                        </div>
                    </div>
                </div>
                <!-- Mobile menu button -->
                <button id="mobile-menu-btn" class="lg:hidden p-2 rounded focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#89B0AE] ml-2" aria-label="Open navigation">
                    <svg class="h-6 w-6 text-[#555B6E]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                </button>
            </div>
    
            <!-- Desktop nav centered via flex (prevents overlap with ZIP control) -->
            <nav class="hidden lg:flex flex-1 justify-center items-center gap-6">
                <a href="/" class="font-medium nav-link{% if request.path == '/' %} active-nav{% endif %}" style="color: {% if request.path == '/' %}#FF9950{% else %}#555B6E{% endif %};">Home</a>
                <a href="/therapists/" class="font-medium nav-link{% if request.path|slice:':12' == '/therapists/' or request.path|slice:':9' == '/users/t/' %} active-nav{% endif %}" style="color: {% if request.path|slice:':12' == '/therapists/' or request.path|slice:':9' == '/users/t/' %}#FF9950{% else %}#555B6E{% endif %};">Therapists</a>
                <a href="{% url 'blog_index' %}" class="font-medium nav-link{% if request.path|slice:':6' == '/blog/' %} active-nav{% endif %}" style="color: {% if request.path|slice:':6' == '/blog/' %}#FF9950{% else %}#555B6E{% endif %};">Blog</a>
                <a href="/features/" class="font-medium nav-link{% if request.path|slice:':9' == '/features' %} active-nav{% endif %}" style="color: {% if request.path|slice:':9' == '/features' %}#FF9950{% else %}#555B6E{% endif %};">Features</a>
                <a href="/pricing/" class="font-medium nav-link{% if request.path|slice:':8' == '/pricing' %} active-nav{% endif %}" style="color: {% if request.path|slice:':8' == '/pricing' %}#FF9950{% else %}#555B6E{% endif %};">Pricing</a>
                <a href="/about/" class="font-medium nav-link{% if request.path|slice:':6' == '/about' %} active-nav{% endif %}" style="color: {% if request.path|slice:':6' == '/about' %}#FF9950{% else %}#555B6E{% endif %};">About</a>
            </nav>
            <div class="hidden lg:flex items-center space-x-2 lg:space-x-4 ml-auto">
                {% if request.user.is_authenticated %}
                    <a href="/users/logout/" class="text-sm font-medium" style="color: #89B0AE;">Logout</a>
                    {% if request.path != '/users/profile-wizard/' %}
                        <a href="/users/dashboard/" class="get-started-btn px-4 py-2 rounded font-semibold text-sm">Dashboard</a>
                    {% endif %}
                {% else %}
                    <a href="/users/login/" class="text-sm font-medium" style="color: #89B0AE;">Login</a>
                    {% if request.path != '/users/register/' %}
                        <a href="/subscribe/" class="get-started-btn px-4 py-2 rounded font-semibold text-sm signup-btn">Get Started</a>
                    {% endif %}
                {% endif %}
            </div>
            <!-- Mobile nav dropdown -->
            <div id="mobile-menu" class="lg:hidden hidden w-full mt-2">
                <nav class="flex flex-col gap-2 bg-white rounded shadow p-4 items-center text-center">
                    <!-- Mobile ZIP control -->
                    <div x-data="{open:false,newZip:'',error:'',saving:false, submit(){this.error=''; if(!/^\d{5}$/.test(this.newZip)){ this.error='Enter 5 digit ZIP'; return;} this.saving=true; fetch(`/set_zip/?zip=${this.newZip}`).then(r=>r.json()).then(d=>{ if(d.status==='ok'){ window.location.reload(); } else { this.error='Could not update'; } }).catch(()=> this.error='Network error').finally(()=> this.saving=false); }}" class="w-full mb-2">
                        <button type="button" @click="open=!open; if(open){ $nextTick(()=> $refs.mZip.focus()) }" class="w-full flex items-center justify-center gap-1 text-sm font-medium px-2 py-2 rounded border" style="border-color:#89B0AE; color:#555B6E;">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/></svg>
                            <span>
                                {% if user_zip_city and user_zip_state %}
                                    {{ user_zip_city }}, {{ user_zip_state }}
                                {% elif user_zip %}
                                    {{ user_zip }}
                                {% else %}
                                    Set Location
                                {% endif %}
                            </span>
                        </button>
                        <div x-cloak x-show="open" class="mt-2 text-left">
                            <form @submit.prevent="submit()" class="space-y-2">
                                <input x-ref="mZip" x-model="newZip" type="text" inputmode="numeric" maxlength="5" placeholder="ZIP" aria-label="ZIP code" class="w-full border rounded px-3 py-2 text-sm" style="border-color:#89B0AE; color:#555B6E; background:#FAF9F9;" />
                                <button type="button" @click="open=false; error=''; if(typeof setZipFromGeolocation==='function'){ setZipFromGeolocation(true); } else { error='Function not available'; }" class="text-xs underline font-medium" style="color:#89B0AE;">Use my location</button>
                                <div class="flex gap-2 justify-end">
                                    <button type="button" @click="open=false; newZip=''; error=''" class="px-3 py-1 text-xs font-medium rounded" style="background:#BEE3DB; color:#555B6E;">Cancel</button>
                                    <button type="submit" :disabled="saving" class="px-3 py-1 text-xs font-semibold rounded" :class="saving ? 'opacity-60 cursor-not-allowed' : ''" style="background:#89B0AE; color:#FAF9F9;" x-text="saving ? 'Saving...' : 'Save'"></button>
                                </div>
                                <p x-show="error" x-text="error" class="text-xs font-semibold" style="color:#FF4D4F;"></p>
                            </form>
                        </div>
                    </div>
                    <a href="/" class="font-medium nav-link{% if request.path == '/' %} active-nav{% endif %}" style="color: {% if request.path == '/' %}#FF9950{% else %}#555B6E{% endif %};">Home</a>
                    <a href="/therapists/" class="font-medium nav-link{% if request.path|slice:':12' == '/therapists/' or request.path|slice:':9' == '/users/t/' %} active-nav{% endif %}" style="color: {% if request.path|slice:':12' == '/therapists/' or request.path|slice:':9' == '/users/t/' %}#FF9950{% else %}#555B6E{% endif %};">Therapists</a>
                    <a href="{% url 'blog_index' %}" class="font-medium nav-link{% if request.path|slice:':6' == '/blog/' %} active-nav{% endif %}" style="color: {% if request.path|slice:':6' == '/blog/' %}#FF9950{% else %}#555B6E{% endif %};">Blog</a>
                    <a href="#" class="font-medium nav-link" style="color: #555B6E;">Features</a>
                    <a href="#" class="font-medium nav-link" style="color: #555B6E;">Pricing</a>
                    <a href="#" class="font-medium nav-link" style="color: #555B6E;">About</a>
                    <div class="flex flex-col gap-2 mt-2">
                        {% if request.user.is_authenticated %}
                            <a href="/users/logout/" class="text-sm font-medium" style="color: #89B0AE;">Logout</a>
                            {% if request.path != '/users/profile-wizard/' %}
                                <a href="/users/profile/" class="px-4 py-2 rounded font-semibold text-sm text-center signup-btn" style="background-color: #FF9950; color: #fff;">Profile</a>
                                <a href="/users/profile/" class="get-started-btn px-4 py-2 rounded font-semibold text-sm text-center signup-btn">Profile</a>
                            {% endif %}
                        {% else %}
                            <a href="/users/login/" class="text-sm font-medium" style="color: #89B0AE;">Login</a>
                            {% if request.path != '/users/register/' %}
                                <a href="/subscribe/" class="get-started-btn px-4 py-2 rounded font-semibold text-sm text-center signup-btn">Get Started</a>
                            {% endif %}
        <style>
          .get-started-btn {
            background-color: #89B0AE;
            color: #fff;
            transition: background 0.2s, color 0.2s;
          }
          .get-started-btn:hover, .get-started-btn:focus {
            background-color: #555B6E !important;
            color: #fff !important;
          }
        </style>
                        {% endif %}
                    </div>
                </nav>
            </div>
        <script>
        // Simple mobile nav toggle
        document.addEventListener('DOMContentLoaded', function() {
            var btn = document.getElementById('mobile-menu-btn');
            var menu = document.getElementById('mobile-menu');
            if (btn && menu) {
                btn.addEventListener('click', function() {
                    menu.classList.toggle('hidden');
                });
            }
        });
        </script>
    </header>
    <main class="flex-1 flex flex-col">
        {% block content %}{% endblock %}
    </main>
    {% include "footer.html" %}
    </div>
        <!-- Global site JS (modal logic + geolocation ZIP helper) -->
        <script src="{% static 'home.js' %}"></script>
                <script>
                    // Fallback delegation: if direct Alpine binding failed, allow data-lightbox-image/video attributes to trigger.
                    document.addEventListener('click', function(e){
                        const fig = e.target.closest('[data-lightbox-image], [data-lightbox-video]');
                        if(!fig) return;
                        const store = (window.Alpine && Alpine.store && Alpine.store('mediaLightbox')) ? Alpine.store('mediaLightbox') : window.__mediaLightbox;
                        if(!store) return;
                        if(fig.dataset.lightboxImage){ store.openImage(fig.dataset.lightboxImage); }
                        else if(fig.dataset.lightboxVideo){ store.openVideo(fig.dataset.lightboxVideo, fig.dataset.lightboxCaption||''); }
                    });
                </script>
        <!-- Leaflet (maps for profile modal locations) -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="" defer></script>
            <div x-cloak x-show="$store.mediaLightbox.open" x-transition class="fixed inset-0 z-[120] flex items-center justify-center bg-black/80 backdrop-blur-sm" @keydown.window.escape="$store.mediaLightbox.close()" @click.self="$store.mediaLightbox.close()">
                <div class="relative max-w-5xl w-[92vw] mx-auto" x-trap.noscroll="$store.mediaLightbox.open">
                    <button @click="$store.mediaLightbox.close()" class="absolute -top-12 right-0 bg-[#FF9950] hover:bg-[#555B6E] text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg" aria-label="Close media">
                        <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2.4' class='w-7 h-7'><path stroke-linecap='round' stroke-linejoin='round' d='M6 18L18 6M6 6l12 12'/></svg>
                    </button>
                    <template x-if="$store.mediaLightbox.type==='image'">
                        <img :src="$store.mediaLightbox.src" class="w-full max-h-[78vh] object-contain rounded-xl shadow-2xl" />
                    </template>
                    <template x-if="$store.mediaLightbox.type==='video'">
                        <div class="w-full aspect-video bg-black rounded-xl overflow-hidden shadow-2xl">
                            <video :src="$store.mediaLightbox.src" controls autoplay class="w-full h-full object-contain"></video>
                        </div>
                    </template>
                    <div class="mt-4 text-center text-sm text-white/80" x-show="$store.mediaLightbox.caption" x-text="$store.mediaLightbox.caption"></div>
                </div>
            </div>
        <script>
            async function geocodeAddress(addr){
                if(!addr) return null;
                const url = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&q=' + encodeURIComponent(addr);
                try { const res = await fetch(url, { headers:{'Accept-Language':'en'} }); if(!res.ok) return null; const data = await res.json(); if(data && data.length){ return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) }; } } catch(e){ console.warn('Geocode failed', e); }
                return null;
            }
            window.initTherapistLocationMaps = async function(){
                const retry = ()=> setTimeout(window.initTherapistLocationMaps,120);
                if(!window.Alpine || !Alpine.store){ return retry(); }
                if(!window.L){ return retry(); }
                const store = Alpine.store('profileModal');
                if(!store || !store.therapist || !Array.isArray(store.therapist.locations)) return;
                const locs = store.therapist.locations;
                for(let i=0;i<locs.length;i++){
                    const loc = locs[i];
                    const el = document.getElementById('profile-map-' + i);
                    if(!el || el.dataset.mapInit) continue;
                    let { lat, lng } = loc;
                    if((lat==null || lng==null) && !loc.hide_address_from_public){
                        const addr = [loc.street_address, loc.city, loc.state, loc.zip].filter(Boolean).join(', ');
                        const geo = await geocodeAddress(addr);
                        if(geo){ lat = geo.lat; lng = geo.lng; loc.lat = lat; loc.lng = lng; }
                    }
                    if(lat!=null && lng!=null){
                        const map = L.map(el, { attributionControl:false, zoomControl:false }).setView([lat,lng], 13);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
                        L.marker([lat,lng]).addTo(map);
                    } else {
                        el.innerHTML = '<div class="absolute inset-0 flex items-center justify-center text-[10px] text-[#555B6E] px-2 text-center">Map unavailable for this address.</div>';
                    }
                    el.dataset.mapInit='1';
                }
            };
        </script>
</body>
</html>
